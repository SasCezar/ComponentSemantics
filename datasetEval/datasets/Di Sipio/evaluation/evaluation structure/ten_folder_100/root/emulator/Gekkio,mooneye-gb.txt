b'# Mooneye GB\n\nMooneye GB is a Game Boy research project and emulator written in Rust.\n\n[![Build Status](https://travis-ci.org/Gekkio/mooneye-gb.svg?branch=master)](https://travis-ci.org/Gekkio/mooneye-gb)\n\nThe main goals of this project are accuracy and documentation. Some existing\nemulators are very accurate (Gambatte, BGB >= 1.5) but are not documented very\nclearly, so they are not that good references for emulator developers. I want\nthis project to document as clearly as possible *why* certain behaviour is\nemulated in a certain way. This also means writing a lot of test ROMs to figure\nout corner cases and precise behaviour on real hardware.\n\nFor documentation about known behaviour, see [Game Boy: Complete Technical\nReference](https://github.com/Gekkio/gb-ctr)\n\n[Binary test ROMs are available here](https://gekkio.fi/files/mooneye-gb/latest/)\nin a zip package and also as individual .gb files. They are automatically\nbuilt and deployed whenever there\'s new changes in the master branch.\n\nNon-goals:\n\n* CGB (Game Boy Color) support. It would be nice, but I want to make the normal\n  Game Boy support extremely robust first.\n* A debugger\n* A good user interface. Building native UIs with Rust is a bit painful at the\n  moment.\n\n**Warning**:\n\n* Project is WIP\n* Doesn\'t work properly without a boot ROM\n* The emulator is lagging behind hardware research. I don\'t want to spend time\n  making short-lived and probably incorrect fixes to the emulator if I\'m not\n  sure about the hardware behaviour.\n\n## Hardware testing\n\nThere\'s tons of documentation and tons of emulators in the internet, but in the\nend I only trust real hardware. I follow a fairly "scientific" process when\ndeveloping emulation for a feature:\n\n1. Think of different ways how it might behave on real hardware\n2. Make a hypothesis based on the most probable behaviour\n3. Write a test ROM for such behaviour\n4. Run the test ROM on real hardware. If the test ROM made an invalid\n   hypothesis, go back to 1.\n5. Replicate the behaviour in the emulator\n\nAll test ROMs are manually run with these devices:\n\n| Device              | Model    | Mainboard    | CPU              | Detailed information                                                            |\n| ------------------- | -------- | ------------ | ---------------- | ---------------                                                                 |\n| Game Boy            | DMG-01   | DMG-CPU-01   | DMG-CPU          | [G01176542](https://gbhwdb.gekkio.fi/consoles/dmg/G01176542.html)               |\n| Game Boy            | DMG-01   | DMG-CPU-02   | DMG-CPU A        | [G02487032](https://gbhwdb.gekkio.fi/consoles/dmg/G02487032.html)               |\n| Game Boy            | DMG-01   | DMG-CPU-04   | DMG-CPU B        | [G10888299](https://gbhwdb.gekkio.fi/consoles/dmg/G10888299.html)               |\n| Game Boy            | DMG-01\xc2\xa0  | DMG-CPU-06   | DMG-CPU C        | [GM6058180](https://gbhwdb.gekkio.fi/consoles/dmg/GM6058180.html)               |\n| Super Game Boy      | SHVC-027 | SGB-R-10     | SGB-CPU-01       | [SGB Unit #2 \\[gekkio\\]](https://gbhwdb.gekkio.fi/consoles/sgb/gekkio-2.html)   |\n| Game Boy Pocket     | MGB-001  | MGB-CPU-01   | CPU MGB \xc2\xa0        | [M10280516](https://gbhwdb.gekkio.fi/consoles/mgb/M10280516.html)               |\n| Super Game Boy 2    | SHVC-042 | SHVC-SGB2-01 | CPU SGB2         | [SGB2 Unit #1 \\[gekkio\\]](https://gbhwdb.gekkio.fi/consoles/sgb2/gekkio-1.html) |\n| Game Boy Color      | CGB-001  | CGB-CPU-01   | CPU CGB          | [C10203977](https://gbhwdb.gekkio.fi/consoles/cgb/C10203977.html)               |\n| Game Boy Color      | CGB-001  | CGB-CPU-01   | CPU CGB A        | [C10400331](https://gbhwdb.gekkio.fi/consoles/cgb/C10400331.html)               |\n| Game Boy Color      | CGB-001  | CGB-CPU-02   | CPU CGB B        | [C11778414](https://gbhwdb.gekkio.fi/consoles/cgb/C11778414.html)               |\n| Game Boy Color      | CGB-001  | CGB-CPU-03   | CPU CGB C        | [CGB Unit #1 \\[gekkio\\]](https://gbhwdb.gekkio.fi/consoles/cgb/gekkio-1.html)   |\n| Game Boy Color      | CGB-001  | CGB-CPU-05   | CPU CGB D        | [CH20983903](https://gbhwdb.gekkio.fi/consoles/cgb/CH20983903.html)             |\n| Game Boy Color      | CGB-001  | CGB-CPU-06   | CPU CGB E        | [CH24224683](https://gbhwdb.gekkio.fi/consoles/cgb/CH24224683.html)             |\n| Game Boy Advance    | AGB-001  | AGB-CPU-01   | CPU AGB          | [AH10045235](https://gbhwdb.gekkio.fi/consoles/agb/AH10045235.html)             |\n| Game Boy Advance    | AGB-001  | AGB-CPU-10   | CPU AGB A        | [AH12465671](https://gbhwdb.gekkio.fi/consoles/agb/AH12465671.html)             |\n| Game Boy Player     | DOL-017  | DOL-GBS-20   | CPU AGB A E      | [GBS Unit #3 \\[gekkio\\]](https://gbhwdb.gekkio.fi/consoles/gbs/gekkio-3.html) |\n| Game Boy Advance SP | AGS-001\xc2\xa0 | C/AGS-CPU-01 | CPU AGB B        | [XJH10027945](https://gbhwdb.gekkio.fi/consoles/ags/XJH10027945.html)           |\n| Game Boy Advance SP | AGS-001\xc2\xa0 | C/AGS-CPU-21 | CPU AGB B E      | [XEH17807928](https://gbhwdb.gekkio.fi/consoles/ags/XEH17807928.html)           |\n\n### Additional devices\n\nI also have access to more devices with different mainboard revisions, but I\nthink the CPU revision is all that matters if we study the behaviour and not\nanalog characteristics (e.g. audio filtering). Even if audio sounded different\nbetween two units with the same CPU revision but different mainboard revisions,\nI\'d expect the difference to be caused by individual device variation or\ndifferent revisions of support chips (e.g. RAM/AMP/REG).\n\nThe main "test fleet" is already very big, so I will only use these devices if\nthere\'s evidence of behaviour that depends on mainboard revision or individual\nunits.\n\n| Device              | Model    | Mainboard    | CPU              | Detailed information                                                          |\n| ------------------- | -------- | ------------ | -----------      | ----                                                                          |\n| Game Boy            | DMG-01   | DMG-CPU-01   | DMG-CPU          | [G01036814](https://gbhwdb.gekkio.fi/consoles/dmg/G01036814.html)             |\n| Game Boy            | DMG-01   | DMG-CPU-03   | DMG-CPU B        | [G06551776](https://gbhwdb.gekkio.fi/consoles/dmg/G06551776.html)             |\n| Game Boy            | DMG-01   | DMG-CPU-05   | DMG-CPU B        | [G13289095](https://gbhwdb.gekkio.fi/consoles/dmg/G13289095.html)             |\n| Game Boy            | DMG-01   | DMG-CPU-06   | DMG-CPU B        |                                                                               |\n| Game Boy            | DMG-01   | DMG-CPU-07   | DMG-CPU B (blob) | [G38953646](https://gbhwdb.gekkio.fi/consoles/dmg/G38953646.html)             |\n| Game Boy            | DMG-01   | DMG-CPU-08   | DMG-CPU C (blob) |                                                                               |\n| Super Game Boy      | SNSP-027 | SGB-R-10     | SGB-CPU-01       | [SGB Unit #7 \\[gekkio\\]](https://gbhwdb.gekkio.fi/consoles/sgb/gekkio-7.html) |\n| Game Boy Pocket     | MGB-001  | MGB-ECPU-01  | CPU MGB \xc2\xa0        | [MH12573718](https://gbhwdb.gekkio.fi/consoles/mgb/MH12573718.html)           |\n| Game Boy Pocket     | MGB-001  | MGB-LCPU-01  | CPU MGB \xc2\xa0        | [M12827347](https://gbhwdb.gekkio.fi/consoles/mgb/M12827347.html)             |\n| Game Boy Pocket     | MGB-001  | MGB-LCPU-02  | CPU MGB \xc2\xa0        | [MH20284468](https://gbhwdb.gekkio.fi/consoles/mgb/MH20284468.html)           |\n| Game Boy Light      | MGB-101  | MGL-CPU-01   | CPU MGB          | [L10610653](https://gbhwdb.gekkio.fi/consoles/mgl/L10610653.html)             |\n| Game Boy Color      | CGB-001  | CGB-CPU-04   | CPU CGB D        | [C19220030](https://gbhwdb.gekkio.fi/consoles/cgb/C19220030.html)             |\n| Game Boy Advance    | AGB-001  | AGB-CPU-02   | CPU AGB          | [AJ12569062](https://gbhwdb.gekkio.fi/consoles/agb/AJ12569065.html)           |\n| Game Boy Advance    | AGB-001  | AGB-CPU-03   | CPU AGB A        | [AJ14804298](https://gbhwdb.gekkio.fi/consoles/agb/AJ14804298.html)           |\n| Game Boy Advance    | AGB-001  | AGB-CPU-04   | CPU AGB A        | [AJ15529163](https://gbhwdb.gekkio.fi/consoles/agb/AJ15529163.html)           |\n| Game Boy Player     | DOL-017  | DOL-GBS-10   | CPU AGB A        | [GBS Unit #1 \\[gekkio\\]](https://gbhwdb.gekkio.fi/consoles/gbs/gekkio-1.html) |\n| Game Boy Advance SP | AGS-001\xc2\xa0 | C/AGS-CPU-10 | CPU AGB B        | [XEH12776954](https://gbhwdb.gekkio.fi/consoles/ags/XEH12776954.html)         |\n| Game Boy Advance SP | AGS-001\xc2\xa0 | C/AGS-CPU-11 | CPU AGB B        | [XJF10485171](https://gbhwdb.gekkio.fi/consoles/ags/XJF10485171.html)         |\n| Game Boy Advance SP | AGS-001\xc2\xa0 | C/AGS-CPU-30 | CPU AGB B E      | [XEH20137204](https://gbhwdb.gekkio.fi/consoles/ags/XEH20137204.html)         |\n| Game Boy Advance SP | AGS-101\xc2\xa0 | C/AGT-CPU-01 | CPU AGB B E      | [XU72764025-1](https://gbhwdb.gekkio.fi/consoles/ags/XU72764025-1.html)       |\n\nI\'m still looking for the following mainboards, but these are probably not\nrequired for reverse engineering:\n\n* SGB-R-01\n* SGB-N-01\n* SGB-N-10\n* C/AGS-CPU-20\n* DOL-GBS-01\n\n**For now, the focus is on DMG/MGB/SGB/SGB2 emulation, so not all tests pass on\nCGB/AGB/AGS or emulators emulating those devices.**\n\n## Performance\n\n**Always compile in release mode if you care about performance!**\n\nOn a i7-3770K desktop machine I can usually run ROMs with 2000 - 4000% speed.\nWithout optimizations the speed drops to 150 - 200%, which is still fine for\ndevelopment purposes.\n\nRaspberry Pi with X11 desktop works but is too slow because there is no OpenGL\nacceleration.\n\nThe emulator is runnable on Android, but cross-compiling and packaging is a\nhuge pain and touch controls would have to be implemented, so I\'m not\nsupporting Android at the moment.\n\n## Running the emulator\n\nRequirements:\n\n* Rust 1.26\n* SDL2 development libraries for your platform must be installed\n\n### GUI\n\n1. `cargo run --release`\n2. Follow the instructions\n\n### Command-line\n1. Acquire a Game Boy bootrom, and put it to `$HOME/.local/share/mooneye-gb/bootroms/dmg_boot.bin`\n2. `cargo build --release`\n3. `cargo run --release -- PATH_TO_GAMEBOY_ROM`\n\nOn Windows, also download an SDL2 package containing SDL2.dll, and put it to\n`target/debug` and `target/release`.\n\n### Game Boy keys\n\n| Game Boy | Key        |\n| -------- | ---------- |\n| Dpad     | Arrow keys |\n| A        | Z          |\n| B        | X          |\n| Start    | Return     |\n| Select   | Backspace  |\n\n### Other keys\n\n| Function                   | Key       |\n| -------------------------- | --------- |\n| Fast forward               | Shift     |\n| Toggle performance overlay | F2        |\n\n## Test suite\n\n### Blargg\'s tests\n\n| Test              | mooneye-gb |\n| ----------------- | ---------- |\n| cpu instrs        | :+1:       |\n| dmg sound 2       | :x:        |\n| instr timing      | :+1:       |\n| mem timing 2      | :+1:       |\n| oam bug 2         | :x:        |\n| cgb sound 2       |            |\n\nNotes:\n\n* cpu_instrs fails on MGB/SGB2 hardware and emulators emulating them correctly.\n  The ROM incorrectly detects the device as CGB, and attempts to perform a CPU\n  speed change which causes a freeze (STOP instruction with joypad disabled)\n* dmg_sound-2 test #10 can fail randomly on real hardware and seems to depend\n  on non-deterministic behaviour.\n* oam_bug-2 fails on all CGB, AGB, and AGS devices\n* cgb_sound-2 test #03 fails on CPU CGB, CPU CGB A, and CPU CGB B\n\n### Mooneye GB acceptance tests\n\n| Test                    | mooneye-gb |\n| ----------------------- | ---------- |\n| add sp e timing         | :+1:       |\n| boot div dmg0           | :x:        |\n| boot div dmgABCmgb      | :x:        |\n| boot div S              | :x:        |\n| boot div2 S             | :x:        |\n| boot hwio dmg0          | :x:        |\n| boot hwio dmgABCmgb     | :x:        |\n| boot hwio S             | :+1:       |\n| boot regs dmg0          | :+1:       |\n| boot regs dmgABC        | :+1:       |\n| boot regs mgb           | :+1:       |\n| boot regs sgb           | :+1:       |\n| boot regs sgb2          | :+1:       |\n| call timing             | :+1:       |\n| call timing2            | :+1:       |\n| call cc_timing          | :+1:       |\n| call cc_timing2         | :+1:       |\n| di timing GS            | :+1:       |\n| div timing              | :+1:       |\n| ei sequence             | :+1:       |\n| ei timing               | :+1:       |\n| halt ime0 ei            | :+1:       |\n| halt ime0 nointr_timing | :+1:       |\n| halt ime1 timing        | :+1:       |\n| halt ime1 timing2 GS    | :+1:       |\n| if ie registers         | :+1:       |\n| intr timing             | :+1:       |\n| jp timing               | :+1:       |\n| jp cc timing            | :+1:       |\n| ld hl sp e timing       | :+1:       |\n| oam dma_restart         | :+1:       |\n| oam dma start           | :+1:       |\n| oam dma timing          | :+1:       |\n| pop timing              | :+1:       |\n| push timing             | :+1:       |\n| rapid di ei             | :+1:       |\n| ret timing              | :+1:       |\n| ret cc timing           | :+1:       |\n| reti timing             | :+1:       |\n| reti intr timing        | :+1:       |\n| rst timing              | :+1:       |\n\n#### Bits (unusable bits in memory and registers)\n\n| Test           | mooneye-gb |\n| -------------- | ---------- |\n| mem oam        | :+1:       |\n| reg f          | :+1:       |\n| unused_hwio GS | :+1:       |\n\n#### Instructions\n\n| Test                        | mooneye-gb |\n| --------------------------- | ---------- |\n| daa                         | :+1:       |\n\n#### Interrupt handling\n\n| Test                        | mooneye-gb |\n| --------------------------- | ---------- |\n| ie push                     | :+1:       |\n\n#### OAM DMA\n\n| Test                        | mooneye-gb |\n| --------------------------- | ---------- |\n| basic                       | :+1:       |\n| reg_read                    | :+1:       |\n| sources GS                  | :+1:       |\n\n#### PPU\n\n| Test                        | mooneye-gb |\n| --------------------------- | ---------- |\n| hblank ly scx timing GS     | :+1:       |\n| intr 1 2 timing GS          | :+1:       |\n| intr 2 0 timing             | :+1:       |\n| intr 2 mode0 timing         | :+1:       |\n| intr 2 mode3 timing         | :+1:       |\n| intr 2 oam ok timing        | :+1:       |\n| intr 2 mode0 timing sprites | :x:        |\n| lcdon timing GS             | :x:        |\n| lcdon write timing GS       | :x:        |\n| stat irq blocking           | :x:        |\n| stat lyc onoff              | :x:        |\n| vblank stat intr GS         | :+1:       |\n\n#### Serial\n\n| Test                        | mooneye-gb |\n| --------------------------- | ---------- |\n| boot sclk align dmgABCmgb   | :x:        |\n\n#### Timer\n\n| Test                 | mooneye-gb |\n| -------------------- | ---------- |\n| div write            | :+1:       |\n| rapid toggle         | :+1:       |\n| tim00 div trigger    | :+1:       |\n| tim00                | :+1:       |\n| tim01 div trigger    | :+1:       |\n| tim01\xc2\xa0               | :+1:       |\n| tim10 div trigger    | :+1:       |\n| tim10                | :+1:       |\n| tim11 div trigger    | :+1:       |\n| tim11                | :+1:       |\n| tima reload          | :+1:       |\n| tima write reloading | :+1:       |\n| tma write reloading  | :+1:       |\n\n### Mooneye GB emulator-only tests\n\n#### MBC1\n\n| Test              | mooneye-gb |\n| ----------------- | ---------- |\n| bits bank1        | :+1:       |\n| bits bank2        | :+1:       |\n| bits mode         | :+1:       |\n| bits ramg         | :+1:       |\n| rom 512kb         | :+1:       |\n| rom 1Mb           | :+1:       |\n| rom 2Mb           | :+1:       |\n| rom 4Mb           | :+1:       |\n| rom 8Mb           | :+1:       |\n| rom 16Mb          | :+1:       |\n| ram 64kb          | :+1:       |\n| ram 256kb         | :+1:       |\n| multicart rom 8Mb | :+1:       |\n\n#### MBC2\n\n| Test              | mooneye-gb |\n| ----------------- | ---------- |\n| bits ramg         | :+1:       |\n| bits romb         | :+1:       |\n| bits unused       | :+1:       |\n| rom 512kb         | :+1:       |\n| rom 1Mb           | :+1:       |\n| rom 2Mb           | :+1:       |\n| ram               | :+1:       |\n\n#### MBC5\n\n| Test              | mooneye-gb |\n| ----------------- | ---------- |\n| rom 512kb         | :+1:       |\n| rom 1Mb           | :+1:       |\n| rom 2Mb           | :+1:       |\n| rom 4Mb           | :+1:       |\n| rom 8Mb           | :+1:       |\n| rom 16Mb          | :+1:       |\n| rom 32Mb          | :+1:       |\n| rom 64Mb          | :+1:       |\n\n### Mooneye GB manual tests\n\n| Test            | mooneye-gb |\n| --------------- | ---------- |\n| sprite priority | :+1:       |\n\n### Mooneye GB misc tests\n\n| Test              | mooneye-gb |\n| ---------------   | ---------- |\n| boot div A        |            |\n| boot div cgb0     |            |\n| boot div cgbABCDE |            |\n| boot hwio C       |            |\n| boot regs A       |            |\n| boot regs cgb     |            |\n\n#### Bits\n\n| Test          | mooneye-gb |\n| ------------- | ---------- |\n| unused hwio C |            |\n\n#### PPU\n\n| Test               | mooneye-gb |\n| ------------------ | ---------- |\n| vblank stat intr C |            |\n\n### Test naming\n\nSome tests are expected to pass only a single model:\n\n* dmg = Game Boy\n* mgb = Game Boy Pocket\n* sgb = Super Game Boy\n* sgb2 = Super Game Boy 2\n* cgb = Game Boy Color\n* agb = Game Boy Advance\n* ags = Game Boy Advance SP\n\nIn addition to model differences, CPU revisions can affect the behaviour.\nRevision 0 refers always to the initial version of a CPU (e.g. CPU CGB). AGB\nand AGS use the same CPU models.  The following CPU models have several\nrevisions:\n\n* DMG: 0, A, B, C\n* CGB: 0, A, B, C, D, E\n* AGB: 0, A, A E, B, B E. Revision E also exists, but only in Game Boy Micro\n  (OXY) so it is out of this project\'s scope. However, A E and B E are most\n  likely actually just E revision in A or B-compatible package.\n\nIn general, hardware can be divided to a couple of groups based on their\nbehaviour. Some tests are expected to pass on a single or multiple groups:\n\n* G = dmg+mgb\n* S = sgb+sgb2\n* C = cgb+agb+ags\n* A = agb+ags\n\nFor example, a test with GS in the name is expected to pass on dmg+mgb +\nsgb+sgb2.\n\n# License and copyright\n\nMooneye GB is licensed under GPLv3+.\nCopyright (C) 2014-2019 Joonas Javanainen <joonas.javanainen@gmail.com>\n\nThe test framework and hardware tests under `tests/` are licensed\nunder MIT.\nCopyright (C) 2014-2019 Joonas Javanainen <joonas.javanainen@gmail.com>\n'