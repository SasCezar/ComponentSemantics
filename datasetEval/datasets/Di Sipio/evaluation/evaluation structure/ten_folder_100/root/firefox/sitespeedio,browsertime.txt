b'# Browsertime - Your browser, your page, your scripts!\n[![Build status][travis-image]][travis-url]\n[![Downloads][downloads-image]][downloads-url]\n[![Downloads total][downloads-total-image]][downloads-url]\n[![Stars][stars-image]][stars-url]\n\n[Documentation](https://www.sitespeed.io/documentation/browsertime/) | [Changelog](https://github.com/sitespeedio/browsertime/blob/master/CHANGELOG.md)\n\n![Browsertime](browsertime.png)\n\nAccess the Web Performance Timeline, from your browser, in your terminal!\n\n## Introduction\n\n**Browsertime lets you *automate running JavaScript in your browser* primary used to collect performance metrics. What exactly does that mean?**\n\nWe think of a Browsertime as having four key capabilities:\n\n - It handles everything with the browser (Firefox/Chrome).\n - It executes a batch of default and configurable JavaScript when the URL has finished loading in the browser.\n - It records a video of the Browser screen used to calculate Visual Metrics.\n - It lets you run Selenium scripts before and after the browser access the URL (to login a user etc).\n\n**What is Browsertime good for?**\n\nIt is usually used for two different things:\n\n - You run it as a standalone tool to collect performance timing metrics of your web site.\n - You integrate it in your tool as a JavaScript runner that collects whatever JavaScript metrics/information you want.\n\nTo understand how Browsertime does these things, let\'s talk about how it works. Here\'s an example of what happens when you give Browsertime a URL to test:\n\n1. You give your configuration to Browsertime.\n2. Browsertime uses the [WebDriver](https://www.w3.org/TR/webdriver/) (through [Selenium](http://seleniumhq.github.io/selenium/docs/api/javascript/index.html)) to start Firefox and Chrome (the implementations for the Webdriver is [Chromedriver](https://sites.google.com/a/chromium.org/chromedriver/)/[Geckodriver](https://github.com/mozilla/geckodriver/)).\n3. Browsertime starts FFMPEG to record a video of the browser screen\n4. The browser access the URL.\n5. When the page is finished loading (you can define yourself when that happens), Browsertime executes the default JavaScript timing metrics and collects:\n   - [Navigation Timing metrics](http://kaaes.github.io/timing/info.html)\n   - [User Timing metrics](http://www.html5rocks.com/en/tutorials/webperformance/usertiming/)\n   - First paint\n   - [RUM Speed Index](https://github.com/WPO-Foundation/RUM-SpeedIndex).\n6. It also collects a [HAR](http://www.softwareishard.com/blog/har-12-spec/) file that shows all requests/responses on the page.\n7. FFMpeg is stopped and the video is analysed. Browsertime collect Visual Metrics like Speed Index.\n\nThe result of the run is a JSON file with all the JavaScript metrics collected, a HAR file, a video recording of the screen and a screenshot.\n\n## A simple example\n\nUse our Docker image (with Chrome, Firefox, XVFB and the dependencies needed to record a video):\n<pre>\n$ docker run --rm -v "$(pwd)":/browsertime sitespeedio/browsertime https://www.sitespeed.io/\n</pre>\n\nOr using node:\n<pre>\n$ npm install browsertime -g\n$ browsertime https://www.sitespeed.io/\n</pre>\n\nLoad https://www.sitespeed.io/ in Chrome three times. Results are stored in a JSON file (browsertime.json) with the timing data, and a HAR file (browsertime.har) in browsertime-results/www.sitespeed.io/$date/\n\n## I want more examples\nCheckout the [examples](docs/examples/README.md).\n\n## Browsers\nBrowsertime supports Firefox and Chrome on desktop. On Android we support Chrome.\n\nBut we want to [support Opera (on Android)](https://github.com/tobli/browsertime/issues/150)  and when(?!) iOS Safari supports WebDriver we will add that too.\n\n## How does it work\nBrowsertime uses Selenium NodeJS to drive the browser. It starts the browser, load a URL, executes configurable Javascripts to collect metrics, collect a HAR file.\n\nTo get the HAR from Firefox we use the [HAR Export Trigger](https://github.com/firebug/har-export-trigger) and Chrome we use [Chrome-HAR](https://github.com/sitespeedio/chrome-har) to parse the timeline log and generate the HAR file.\n\n# Speed Index and video\nIt\'s easiest to run [our ready made Docker container](https://hub.docker.com/r/sitespeedio/browsertime/) to be able to record a video and calculate SpeedIndex because then you get all dependencies needed for free to run [VisualMetrics](https://github.com/WPO-Foundation/visualmetrics).\n\nThe default video will include a timer and showing when the metrics happens, but you can turn that off using <code>--video.addTimer false</code>.\n\n<img src="https://raw.githubusercontent.com/sitespeedio/sitespeed.io/master/docs/img/video-example.gif">\n\n## Test using Docker\nYou can build and test changes using Docker locally.\n\n<pre>\n$ docker build -t sitespeedio/browsertime .\n$ docker run --rm -v "$(pwd)":/browsertime sitespeedio/browsertime -n 1 https://www.sitespeed.io/\n</pre>\n\n## Connectivity\n\nYou can throttle the connection to make the connectivity slower to make it easier to catch regressions. The best way to do that is to setup a network bridge in Docker or use our connectivity engine Throttle.\n\nHere\'s an full example to setup up Docker network bridges on a server that has tc installed:\n\n~~~bash\n#!/bin/bash\necho \'Starting Docker networks\'\ndocker network create --driver bridge --subnet=192.168.33.0/24 --gateway=192.168.33.10 --opt "com.docker.network.bridge.name"="docker1" 3g\ntc qdisc add dev docker1 root handle 1: htb default 12\ntc class add dev docker1 parent 1:1 classid 1:12 htb rate 1.6mbit ceil 1.6mbit\ntc qdisc add dev docker1 parent 1:12 netem delay 150ms\n\ndocker network create --driver bridge --subnet=192.168.34.0/24 --gateway=192.168.34.10 --opt "com.docker.network.bridge.name"="docker2" cable\ntc qdisc add dev docker2 root handle 1: htb default 12\ntc class add dev docker2 parent 1:1 classid 1:12 htb rate 5mbit ceil 5mbit\ntc qdisc add dev docker2 parent 1:12 netem delay 14ms\n\ndocker network create --driver bridge --subnet=192.168.35.0/24 --gateway=192.168.35.10 --opt "com.docker.network.bridge.name"="docker3" 3gfast\ntc qdisc add dev docker3 root handle 1: htb default 12\ntc class add dev docker3 parent 1:1 classid 1:12 htb rate 1.6mbit ceil 1.6mbit\ntc qdisc add dev docker3 parent 1:12 netem delay 75ms\n\ndocker network create --driver bridge --subnet=192.168.36.0/24 --gateway=192.168.36.10 --opt "com.docker.network.bridge.name"="docker4" 3gem\ntc qdisc add dev docker4 root handle 1: htb default 12\ntc class add dev docker4 parent 1:1 classid 1:12 htb rate 0.4mbit ceil 0.4mbit\ntc qdisc add dev docker4 parent 1:12 netem delay 200ms\n~~~\n\nThen when you run your container you add the network with <code>--network cable</code>. You should also tell Browsertime that you set the connectivity external from BT. A full example running running with cable:\n\n~~~bash\n$ docker run --network=cable --rm sitespeedio/browsertime -c cable --connectivity.engine external https://www.sitespeed.io/\n~~~\n\nAnd using the 3g network:\n\n~~~bash\n$ docker run --network=3g --rm sitespeedio/browsertime -c 3g --connectivity.engine external https://www.sitespeed.io/\n~~~\n\nAnd if you want to remove the networks:\n\n~~~bash\n#!/bin/bash\necho \'Stopping Docker networks\'\ndocker network rm 3g\ndocker network rm 3gfast\ndocker network rm 3gem\ndocker network rm cable\n~~~\n\nThrottle uses *tc* on Linux and *pfctl* on Mac to change the connectivity. Throttle will need sudo rights for the user running sitespeed.io to work.\n\nTo use throttle, use set the connectivity engine by *--connectivity.engine throttle*.\n\n~~~bash\nbrowsertime --connectivity.engine throttle -c cable https://www.sitespeed.io/\n~~~\n\nYou can also use Throttle inside of Docker but then the host need to be the same OS as in Docker. In practice you can only use it on Linux. And then make sure to run *sudo modprobe ifb numifbs=1* first and give the container the right privileges *--cap-add=NET_ADMIN*.\n\nIf you are running Browsertime in Kubernetes you need to use [TSProxy](https://github.com/WPO-Foundation/tsproxy).\n\n~~~bash\nbrowsertime --connectivity.engine tsproxy -c cable https://www.sitespeed.io/\n~~~\n\n## Upgrade from 3.x to 4.0\nThere are a couple of breaking changes introduce in 4.0.\n\n1. New structure of the result JSON. In 4.0 we introduce the ability to test multiple pages. That means that instead of returning one result object, we return an array. In 3.x the result looks like this:\n  ``` \n  {\n  "info": {\n      "browsertime": {\n          "version": "3.0.0"\n      }, ...\n  ```\n  And the new one returns a array, where each tested page is an result in that array.  \n  ``` \n  [{\n  "info": {\n      "browsertime": {\n          "version": "4.0.0"\n      }, ...\n  }}]\n  ``` \n2. New naming of result files. Before files was named by iteration: 1-video.mp4. In the latest version all extra files are stored in a folder structure and referenced in the JSON, starting with /pages/ (following the same pattern as sitespeed.io). If you just want to test one URL at each time, you can keep the old structure with  ```--useSameDir```.\n3. New layout of Selenium scripting. We simplified the layout of the script. The new version will be able to do the exact same thing as older versions but with a simpler layout:\n~~~javascript\n  module.exports = async function(context, commands) {\n  // code\n  }\n~~~\n4. Pre/post scripts follow the new format as of the script in the third point.\n\n## Navigate in a script [in 4.0 or later]\nIf you need a more complicated test scenario, you can define your own (Selenium)test script that will do the testing. Use your own test script when you want to test your page as a logged in user, the login page or if you want to add things to your cart.\n\nWe have a full section in the documentation about [scripting](https://www.sitespeed.io/documentation/sitespeed.io/scripting/).\n\n## Test on your mobile device\nBrowsertime supports Chrome on Android: Collecting SpeedIndex, HAR and video! \n\nYou need to [install adb](https://www.sitespeed.io/documentation/sitespeed.io/mobile-phones/#desktop) and [prepare your phone](https://www.sitespeed.io/documentation/sitespeed.io/mobile-phones/#on-your-phone) before you start.\n\nIf you want to set connectivity you need to use something like [Micro device lab](https://github.com/phuedx/micro-device-lab) or [TSProxy](https://github.com/WPO-Foundation/tsproxy).\n\n<pre>\n$ browsertime --chrome.android.package com.android.chrome https://www.sitespeed.io --video --visualMetrics\n</pre>\n\nIf you are on Linux (we have tested Ubuntu 18) you can use our Docker container to drive your Android phone. A couple of things to remember:\n * You need to run in privileged mode *--privileged* if you share the full usb bus\n * You need to share the USB ports *-v /dev/bus/usb:/dev/bus/usb* or share a specific port with *--device=/dev/bus/usb/001/017* (use *lsusb* to find the right mapping)\n * Add *-e START_ADB_SERVER=true* to start the adb server\n\nIf you use Docker you will automatically get support for video and SpeedIndex. You can get that without Docker but then need to [install VisualMetrics dependencies](https://github.com/sitespeedio/docker-visualmetrics-deps/blob/master/Dockerfile) yourself.\n\n<pre>\n$ docker run --privileged -v /dev/bus/usb:/dev/bus/usb -e START_ADB_SERVER=true --rm -v "$(pwd)":/browsertime-results sitespeedio/browsertime -n 1 --android --visualMetrics --video https://en.m.wikipedia.org/wiki/Barack_Obama\n</pre>\n\n## Configuration\nRun <code>$ bin/browsertime.js --help</code> and you can see the configuration options.\n\n## Using WebPageReplay\nOur Docker container now included [WebPageReplay](https://github.com/catapult-project/catapult/blob/master/web_page_replay_go/README.md).\n\nWebPageReplay will let you replay your page locally (getting rid of server latency etc) and makes it easier to find front end regressions.\n\nIt works like this:\n1. The start script starts WebPageReplay in record mode\n2. Then starts Browsertime accessing the URL you choose one time (so it is recorded)\n3. WebPageReplay is closed down\n4. WebPageReplay in replay mode is started\n5. Browsertime access the URL so many times you choose\n6. WebPageReplay in replay mode is closed down\n\nYou can change latency by setting a Docker environment variable. Use REPLAY to turn on the reply functionality.\n\nDefault browser is Chrome:\n\n```\ndocker run --cap-add=NET_ADMIN --rm -v "$(pwd)":/browsertime -e REPLAY=true -e LATENCY=100 sitespeedio/browsertime:4.0.0 https://en.wikipedia.org/wiki/Barack_Obama\n```\n\nUse Firefox:\n\n```\ndocker run --cap-add=NET_ADMIN --rm -v "$(pwd)":/browsertime -e REPLAY=true -e LATENCY=100 sitespeedio/browsertime:4.0.0 -b firefox -n 11 https://en.wikipedia.org/wiki/Barack_Obama\n```\n\nAnd Chrome on your Android phone. This will only work on Linux because you need to be able to mount the usb port in Docker:\n\n```\ndocker run --privileged -v /dev/bus/usb:/dev/bus/usb -e START_ADB_SERVER=true --cap-add=NET_ADMIN --rm -v \xe2\x80\x9c$(pwd)\xe2\x80\x9c:/browsertime -e REPLAY=true -e LATENCY=100 sitespeedio/browsertime https://en.m.wikipedia.org/wiki/Barack_Obama --android --chrome.args ignore-certificate-errors-spki-list=PhrPvGIaAMmd29hj8BCZOq096yj7uMpRNHpn5PDxI6I= -n 11 --chrome.args user-data-dir=/data/tmp/chrome\n```\n\n## Send metrics to Graphite\nThe easiest way to send metrics is to install [jq](https://stedolan.github.io/jq/) and use it to pick the values you wanna track.\n\nHere\'s an example on how you can pickup the median SpeedIndex from Browsertime and send it to your Graphite instance.\n<pre>\necho "browsertime.your.key.SpeedIndex.median" $(cat /tmp/browsertime/browsertime.json | jq .[0].statistics.visualMetrics.SpeedIndex.median) "`date +%s`" | nc -q0 my.graphite.com 2003\n</pre>\n\n[travis-image]: https://img.shields.io/travis/sitespeedio/browsertime.svg?style=flat-square\n[travis-url]: https://travis-ci.org/sitespeedio/browsertime\n[stars-url]: https://github.com/tobli/sitespeedio/stargazers\n[stars-image]: https://img.shields.io/github/stars/sitespeedio/browsertime.svg?style=flat-square\n[downloads-total-image]: https://img.shields.io/npm/dt/browsertime.svg?style=flat-square\n[downloads-image]: https://img.shields.io/npm/dm/browsertime.svg?style=flat-square\n[downloads-url]: https://npmjs.org/package/browsertime\n'