b'# Consul\n\n[![Build Status](https://travis-ci.org/brianshumate/ansible-consul.svg?branch=master)](https://travis-ci.org/brianshumate/ansible-consul)\n[![Ansible Galaxy](https://img.shields.io/badge/galaxy-brianshumate.consul-blue.svg)](https://galaxy.ansible.com/brianshumate/consul/)\n[![Average time to resolve an issue](http://isitmaintained.com/badge/resolution/brianshumate/ansible-consul.svg)](http://isitmaintained.com/project/brianshumate/ansible-consul "Average time to resolve an issue")\n[![Percentage of issues still open](http://isitmaintained.com/badge/open/brianshumate/ansible-consul.svg)](http://isitmaintained.com/project/brianshumate/ansible-consul "Percentage of issues still open")\n\nThis Ansible role installs [Consul](https://consul.io/), including establishing a filesystem structure and server or client agent configuration with support for some common operational features.\n\nIt can also bootstrap a development or evaluation cluster of 3 server agents running in a Vagrant and VirtualBox based environment. See [README_VAGRANT.md](https://github.com/brianshumate/ansible-consul/blob/master/examples/README_VAGRANT.md) and the associated [Vagrantfile](https://github.com/brianshumate/ansible-consul/blob/master/examples/Vagrantfile) for more details.\n\n## Role Philosophy\n\n> \xe2\x80\x9cAnother flaw in the human character is that everybody wants to build and nobody wants to do maintenance.\xe2\x80\x9d<br>\n> \xe2\x80\x95 Kurt Vonnegut, Hocus Pocus\n\nPlease note that the original design goal of this role was more concerned with the initial installation and bootstrapping of a Consul server cluster environment and so it does not currently concern itself (all that much) with performing ongoing maintenance of a cluster.\n\nMany users have expressed that the Vagrant based environment makes getting a working local Consul server cluster environment up and running an easy process \xe2\x80\x94 so this role will target that experience as a primary motivator for existing.\n\nIf you get some mileage from it in other ways, then all the better!\n\n## Requirements\n\nThis role requires a FreeBSD, Debian, or Red Hat Enterprise Linux distribution or Windows Server 2012 R2.\n\nThe role might work with other OS distributions and versions, but is known to function well with the following software versions:\n\n* Consul: 1.6.2\n* Ansible: 2.8.2\n* Alpine Linux: 3.8\n* CentOS: 7\n* Debian: 9\n* FreeBSD: 11\n* RHEL: 7\n* OracleLinux: 7\n* Ubuntu: 16.04\n* Windows: Server 2012 R2\n\nNote that for the "local" installation mode (the default), this role will locally download only one instance of the Consul archive, unzip it and install the resulting binary on all desired Consul hosts.\n\nTo do so requires that `unzip` is available on the Ansible control host and the role will fail if it doesn\'t detect `unzip` in the PATH.\n\n## Caveats\n\nThis role does not fully support the limit option (`ansible -l`) to limit the hosts, as this will break populating required host variables. If you do use the limit option with this role, you can encounter template errors like:\n\n```\nUndefined is not JSON serializable.\n```\n\n## Role Variables\n\nThe role uses variables defined in these 3 places:\n\n- Hosts inventory file (see `examples/vagrant_hosts` for an example)\n- `vars/*.yml` (primarily OS/distributions specific variables)\n- `defaults/main.yml` (everything else)\n\n> **NOTE**: The label for servers in the hosts inventory file must be `[consul_instances]` as shown in the example. The role will not properly function if the label name is anything other value.\n\nMany role variables can also take their values from environment variables as well; those are noted in the description where appropriate.\n\n### `consul_version`\n\n- Version to install\n- Default value: 1.6.2\n\n### `consul_architecture_map`\n\n- Dictionary for translating _ansible_architecture_ values to Go architecture values\n  naming convention\n- Default value: dict\n\n### `consul_architecture`\n\n- System architecture as determined by `{{ consul_architecture_map[ansible_architecture] }}`\n- Default value (determined at runtime): amd64, arm, or arm64\n\n### `consul_os`\n\n- Operating system name in lowercase representation\n- Default value: `{{ ansible_os_family | lower }}`\n\n### `consul_zip_url`\n\n- Consul archive file download URL\n- Default value: `https://releases.hashicorp.com/consul/{{ consul_version }}/consul_{{ consul_version }}_{{ consul_os }}_{{ consul_architecture }}.zip`\n\n### `consul_checksum_file_url`\n\n- Package SHA256 summaries file URL\n- Default value: `https://releases.hashicorp.com/consul/{{ consul_version }}/{{ consul_version }}_SHA256SUMS`\n\n### `consul_bin_path`\n\n- Binary installation path\n- Default Linux value: `/usr/local/bin`\n- Default Windows value: `C:\\ProgramData\\consul\\bin`\n\n### `consul_config_path`\n\n- Base configuration file path\n- Default Linux value: `/etc/consul`\n- Default Windows value: `C:\\ProgramData\\consul\\config`\n\n### `consul_configd_path`\n\n- Additional configuration directory\n- Default Linux value: `{{ consul_config_path }}/consul.d`\n- Default Windows value: `C:\\ProgramData\\consul\\config.d`\n\n### `consul_data_path`\n\n- Data directory path as defined in [data_dir or -data-dir](https://www.consul.io/docs/agent/options.html#_data_dir)\n- Default Linux value: `/var/consul`\n- Default Windows value: `C:\\ProgramData\\consul\\data`\n\n### `consul_configure_syslogd`\n\n- Enable configuration of rsyslogd or syslog-ng on Linux. If disabled, Consul will still log to syslog if `consul_syslog_enable` is true, but the syslog daemon won\'t be configured to write Consul logs to their own logfile.\n  - Override with `CONSUL_CONFIGURE_SYSLOGD` environment variable\n- Default Linux value: *false*\n\n### `consul_log_path`\n- If `consul_syslog_enable` is false\n  - Log path for use in [log_file or -log-file](https://www.consul.io/docs/agent/options.html#_log_file)\n- If `consul_syslog_enable` is true\n  - Log path for use in rsyslogd configuration on Linux. Ignored if `consul_configure_syslogd` is false.\n- Default Linux value: `/var/log/consul`\n  - Override with `CONSUL_LOG_PATH` environment variable\n- Default Windows value: `C:\\ProgramData\\consul\\log`\n\n### `consul_log_file`\n\n- If `consul_syslog_enable` is false\n  - Log file for use in [log_file or -log-file](https://www.consul.io/docs/agent/options.html#_log_file)\n- If `consul_syslog_enable` is true\n  - Log file for use in rsyslogd configuration on Linux. Ignored if `consul_configure_syslogd` is false.\n- Override with `CONSUL_LOG_FILE` environment variable\n- Default Linux value: `consul.log`\n\n### `consul_log_rotate_bytes`\n\n- Log rotate bytes as defined in [log_rotate_bytes or -log-rotate-bytes](https://www.consul.io/docs/agent/options.html#_log_rotate_bytes)\n  - Override with `CONSUL_LOG_ROTATE_BYTES` environment variable\n- Ignored if `consul_syslog_enable` is true\n- Default value: 0\n\n### `consul_log_rotate_duration`\n\n- Log rotate bytes as defined in [log_rotate_duration or -log-rotate-duration](https://www.consul.io/docs/agent/options.html#_log_rotate_duration)\n  - Override with `CONSUL_LOG_ROTATE_DURATION` environment variable\n- Ignored if `consul_syslog_enable` is true\n- Default value: 24h\n\n### `consul_log_rotate_max_files`\n\n- Log rotate bytes as defined in [log_rotate_max_files or -log-rotate-max-files](https://www.consul.io/docs/agent/options.html#_log_rotate_max_files)\n  - Override with `CONSUL_LOG_ROTATE_MAX_FILES` environment variable\n- Ignored if `consul_syslog_enable` is true\n- Default value: 0\n\n### `consul_syslog_facility`\n\n- Syslog facility as defined in [syslog_facility](https://www.consul.io/docs/agent/options.html#syslog_facility)\n  - Override with `CONSUL_SYSLOG_FACILITY` environment variable\n- Default Linux value: local0\n\n### `syslog_user`\n\n- Owner of `rsyslogd` process on Linux. `consul_log_path`\'s ownership is set to this user on Linux. Ignored if `consul_configure_syslogd` is false.\n  - Override with `SYSLOG_USER` environment variable\n- Default Linux value: syslog\n\n### `syslog_group`\n\n- Group of user running `rsyslogd` process on Linux. `consul_log_path`\'s group ownership is set to this group on Linux. Ignored if `consul_configure_syslogd` is false.\n  - Override with `SYSLOG_GROUP` environment variable\n- Default value: adm\n\n### `consul_run_path`\n\n- Run path for process identifier (PID) file\n- Default Linux value: `/var/run/consul`\n- Default Windows value: `C:\\ProgramData\\consul`\n\n### `consul_user`\n\n- OS user\n- Default Linux value: consul\n- Default Windows value: LocalSystem\n\n### `consul_group`\n\n- OS group\n- Default value: bin\n\n### `consul_group_name`\n\n- Inventory group name\n  - Override with `CONSUL_GROUP_NAME` environment variable\n- Default value: consul_instances\n\n### `consul_retry_interval`\n\n- Interval for reconnection attempts to LAN servers\n- Default value: 30s\n\n### `consul_retry_interval_wan`\n\n- Interval for reconnection attempts to WAN servers\n- Default value: 30s\n\n### `consul_retry_join_skip_hosts`\n\n- If true, the config value for retry_join won\'t be populated by the default hosts servers. The value can be initialized using consul_join\n- Default value: false\n\n### `consul_retry_max`\n\n- Max reconnection attempts to LAN servers before failing (0 = infinite)\n- Default value: 0\n\n### `consul_retry_max_wan`\n\n- Max reconnection attempts to WAN servers before failing (0 = infinite)\n- Default value: *0*\n\n### `consul_join`\n\n- List of LAN servers, not managed by this role, to join (IPv4 IPv6 or DNS addresses)\n- Default value: []\n\n### `consul_join_wan`\n\n- List of WAN servers, not managed by this role, to join (IPv4 IPv6 or DNS addresses)\n- Default value: []\n\n### `consul_servers`\n\nIt\'s typically not necessary to manually alter this list.\n\n- List of server nodes\n- Default value: List of all nodes in `consul_group_name` with\n  `consul_node_role` set to server or bootstrap\n\n### `consul_bootstrap_expect`\n\n- Boolean that adds bootstrap_expect value on Consul servers\'s config file\n- Default value: false\n\n### `consul_bootstrap_expect_value`\n\n- Integer to define the minimum number of consul servers joined to the cluster in order to elect the leader.\n- Default value: Calculated at runtime based on the number of nodes\n\n### `consul_gather_server_facts`\n\nThis feature makes it possible to gather the `consul_advertise_address(_wan)` from servers that are currently not targeted by the playbook.\n\nTo make this possible the `delegate_facts` option is used; note that his option has been problematic.\n\n- Gather facts from servers that are not currently targeted\n- Default value: false\n\n### `consul_datacenter`\n\n- Datacenter label\n  - Override with `CONSUL_DATACENTER` environment variable- Default value: *dc1*\n- Default value: dc1\n\n### `consul_domain`\n\n- Consul domain name as defined in [domain or -domain](https://www.consul.io/docs/agent/options.html#_domain)\n  - Override with `CONSUL_DOMAIN` environment variable\n- Default value: consul\n\n### `consul_alt_domain`\n\n- Consul domain name as defined in [alt_domain or -alt-domain](https://www.consul.io/docs/agent/options.html#_alt_domain)\n  - Override with `CONSUL_ALT_DOMAIN` environment variable\n- Default value: Empty string\n\n### `consul_node_meta`\n\n- Consul node meta data (key-value)\n- Supported in Consul version 0.7.3 or later\n- Default value: *{}*\n- Example:\n```yaml\nconsul_node_meta:\n    node_type: "my-custom-type"\n    node_meta1: "metadata1"\n    node_meta2: "metadata2"\n```\n\n### `consul_log_level`\n\n- Log level as defined in [log_level or -log-level](https://www.consul.io/docs/agent/options.html#_log_level)\n  - Override with `CONSUL_LOG_LEVEL` environment variable\n- Default value: INFO\n\n### `consul_syslog_enable`\n\n- Log to syslog as defined in [enable_syslog or -syslog](https://www.consul.io/docs/agent/options.html#_syslog)\n  - Override with `CONSUL_SYSLOG_ENABLE` environment variable\n- Default Linux value: false\n- Default Windows value: false\n\n### `consul_iface`\n\n- Consul network interface\n  - Override with `CONSUL_IFACE` environment variable\n- Default value: `{{ ansible_default_ipv4.interface }}`\n\n### `consul_bind_address`\n\n- Bind address\n  - Override with `CONSUL_BIND_ADDRESS` environment variable\n- Default value: default ipv4 address, or address of interface configured by\n  `consul_iface`\n\n### `consul_advertise_address`\n\n- LAN advertise address\n- Default value: `consul_bind_address`\n\n### `consul_advertise_address_wan`\n\n- Wan advertise address\n- Default value: `consul_bind_address`\n\n### `consul_translate_wan_address`\n\n- Prefer a node\'s configured WAN address when serving DNS\n- Default value: false\n\n### `consul_advertise_addresses`\n\n- Advanced advertise addresses settings\n- Individual addresses can be overwritten using the `consul_advertise_addresses_*` variables\n- Default value:\n  ```yaml\n  consul_advertise_addresses:\n    serf_lan: "{{ consul_advertise_addresses_serf_lan | default(consul_advertise_address+\':\'+consul_ports.serf_lan) }}"\n    serf_wan: "{{ consul_advertise_addresses_serf_wan | default(consul_advertise_address_wan+\':\'+consul_ports.serf_wan) }}"\n    rpc: "{{ consul_advertise_addresses_rpc | default(consul_bind_address+\':\'+consul_ports.server) }}"\n  ```\n\n### `consul_client_address`\n\n- Client address\n- Default value: 127.0.0.1\n\n### `consul_addresses`\n\n- Advanced address settings\n- Individual addresses kan be overwritten using the `consul_addresses_*` variables\n- Default value:\n  ```yaml\n  consul_addresses:\n    dns: "{{ consul_addresses_dns | default(consul_client_address, true) }}"\n    http: "{{ consul_addresses_http | default(consul_client_address, true) }}"\n    https: "{{ consul_addresses_https | default(consul_client_address, true) }}"\n    rpc: "{{ consul_addresses_rpc | default(consul_client_address, true) }}"\n    grpc: "{{ consul_addresses_grpc | default(consul_client_address, true) }}"\n  ```\n\n### `consul_ports`\n\n- The official documentation on the [Ports Used](https://www.consul.io/docs/agent/options.html#ports)\n- The ports mapping is a nested dict object that allows setting the bind ports for the following keys:\n  - dns - The DNS server, -1 to disable. Default 8600.\n  - http - The HTTP API, -1 to disable. Default 8500.\n  - https - The HTTPS API, -1 to disable. Default -1 (disabled).\n  - rpc - The CLI RPC endpoint. Default 8400. This is deprecated in Consul 0.8 and later.\n  - grpc - The gRPC endpoint, -1 to disable. Default -1 (disabled).\n  - serf_lan - The Serf LAN port. Default 8301.\n  - serf_wan - The Serf WAN port. Default 8302.\n  - server - Server RPC address. Default 8300.\n\nFor example, to enable the consul HTTPS API it is possible to set the variable as follows:\n\n- Default values:\n```yaml\n  consul_ports:\n    dns: "{{ consul_ports_dns | default(\'8600\', true) }}"\n    http: "{{ consul_ports_http | default(\'8500\', true) }}"\n    https: "{{ consul_ports_https | default(\'-1\', true) }}"\n    rpc: "{{ consul_ports_rpc | default(\'8400\', true) }}"\n    serf_lan: "{{ consul_ports_serf_lan | default(\'8301\', true) }}"\n    serf_wan: "{{ consul_ports_serf_wan | default(\'8302\', true) }}"\n    server: "{{ consul_ports_server | default(\'8300\', true) }}"\n    grpc: "{{ consul_ports_grpc | default(\'-1\', true) }}"\n```\n\nNotice that the dict object has to use precisely the names stated in the documentation! And all ports must be specified. Overwriting one or multiple ports can be done using the `consul_ports_*` variables.\n\n### `consul_node_name`\n\n- Node name (should not include dots)\n- Default value: `{{ inventory_hostname_short }}`\n\n### `consul_recursors`\n\n- List of upstream DNS servers\n  See [recursors](https://www.consul.io/docs/agent/options.html#recursors)\n  - Override with `CONSUL_RECURSORS` environment variable\n- Default value: Empty list\n\n### `consul_iptables_enable`\n\n- Whether to enable iptables rules for DNS forwarding to Consul\n  - Override with `CONSUL_IPTABLES_ENABLE` environment variable\n- Default value: false\n\n### `consul_acl_policy`\n\n- Add basic ACL config file\n  - Override with `CONSUL_ACL_POLICY` environment variable\n- Default value: false\n\n### `consul_acl_enable`\n\n- Enable ACLs\n  - Override with `CONSUL_ACL_ENABLE` environment variable\n- Default value: false\n\n### `consul_acl_ttl`\n\n- TTL for ACL\'s\n  - Override with `CONSUL_ACL_TTL` environment variable\n- Default value: 30s\n\n### `consul_acl_datacenter`\n\n- ACL authoritative datacenter name\n  - Override with `CONSUL_ACL_DATACENTER` environment variable\n- Default value: dc1\n\n### `consul_acl_down_policy`\n\n- Default ACL down policy\n  - Override with `CONSUL_ACL_DOWN_POLICY` environment variable\n- Default value: allow\n\n### `consul_acl_token`\n\n- Default ACL token, only set if provided\n  - Override with `CONSUL_ACL_TOKEN` environment variable\n- Default value: \'\'\n\n### `consul_acl_agent_token`\n\n- Used for clients and servers to perform internal operations to the service catalog. See: [acl_agent_token](https://www.consul.io/docs/agent/options.html#acl_agent_token)\n  - Override with `CONSUL_ACL_AGENT_TOKEN` environment variable\n- Default value: \'\'\n\n### `consul_acl_agent_master_token`\n\n- A [special access token](https://www.consul.io/docs/agent/options.html#acl_agent_master_token) that has agent ACL policy write privileges on each agent where it is configured\n  - Override with `CONSUL_ACL_AGENT_MASTER_TOKEN` environment variable\n- Default value: \'\'\n\n### `consul_acl_default_policy`\n\n- Default ACL policy\n  - Override with `CONSUL_ACL_DEFAULT_POLICY` environment variable\n- Default value: allow\n\n### `consul_acl_master_token`\n\n- ACL master token\n  - Override with `CONSUL_ACL_MASTER_TOKEN` environment variable\n- Default value: UUID\n\n### `consul_acl_master_token_display`\n\n- Display generated ACL Master Token\n  - Override with `CONSUL_ACL_MASTER_TOKEN_DISPLAY` environment variable\n- Default value: false\n\n### `consul_acl_replication_enable`\n\n- Enable ACL replication without token (makes it possible to set the token\n  trough the API)\n  - Override with `CONSUL_ACL_REPLICATION_TOKEN_ENABLE` environment variable\n- Default value: \'\'\n\n### `consul_acl_replication_token`\n\n- ACL replication token\n  - Override with `CONSUL_ACL_REPLICATION_TOKEN_DISPLAY` environment variable\n- Default value: *SN4K3OILSN4K3OILSN4K3OILSN4K3OIL*\n\n### `consul_tls_enable`\n\n- Enable TLS\n  - Override with `CONSUL_ACL_TLS_ENABLE` environment variable\n- Default value: false\n\n### `consul_src_def`\n\n- Default source directory for TLS files\n  - Override with `CONSUL_ACL_TLS_ENABLE` environment variable\n- Default value: `{{ role_path }}/files`\n\n### `consul_tls_src_files`\n\n- User-specified source directory for TLS files\n  - Override with `CONSUL_TLS_SRC_FILES` environment variable\n- Default value: `{{ role_path }}/files`\n\n### `consul_tls_dir`\n\n- Target directory for TLS files\n  - Override with `CONSUL_TLS_DIR` environment variable\n- Default value: `/etc/consul/ssl`\n\n### `consul_tls_ca_crt`\n\n- CA certificate filename\n  - Override with `CONSUL_TLS_CA_CRT` environment variable\n- Default value: `ca.crt`\n\n### `consul_tls_server_crt`\n\n- Server certificate\n  - Override with `CONSUL_TLS_SERVER_CRT` environment variable\n- Default value: `server.crt`\n\n### `consul_tls_server_key`\n\n- Server key\n  - Override with `CONSUL_TLS_SERVER_KEY` environment variable\n- Default value: `server.key`\n\n### `consul_tls_files_remote_src`\n\n- Copy from remote source if TLS files are already on host\n- Default value: false\n\n### `consul_encrypt_enable`\n\n- Enable Gossip Encryption\n- Default value: true\n\n### `consul_disable_keyring_file`\n\n- If set, the keyring will not be persisted to a file. Any installed keys will be lost on shutdown, and only the given -encrypt key will be available on startup.\n- Default value: false\n\n### `consul_raw_key`\n\n- Set the encryption key; should be the same across a cluster. If not present the key will be generated & retrieved from the bootstrapped server.\n- Default value: \'\'\n\n### `consul_tls_verify_incoming`\n\n- Verify incoming connections\n  - Override with `CONSUL_TLS_VERIFY_INCOMING` environment variable\n- Default value: false\n\n### `consul_tls_verify_outgoing`\n\n- Verify outgoing connections\n  - Override with `CONSUL_TLS_VERIFY_OUTGOING` environment variable\n- Default value: true\n\n### `consul_tls_verify_incoming_https`\n- Verify incoming connections on HTTPS endpoints (client certificates)\n  - Override with `CONSUL_TLS_VERIFY_INCOMING_HTTPS` environment variable\n- Default value: false\n\n### `consul_tls_verify_server_hostname`\n\n- Verify server hostname\n  - Override with `CONSUL_TLS_VERIFY_SERVER_HOSTNAME` environment variable\n- Default value: false\n\n### `consul_tls_min_version`\n\n- [Minimum acceptable TLS version](https://www.consul.io/docs/agent/options.html#tls_min_version)\n  - Can be overridden with `CONSUL_TLS_MIN_VERSION` environment variable\n- Default value: tls12\n\n### `consul_tls_cipher_suites`\n\n- [Comma-separated list of supported ciphersuites](https://www.consul.io/docs/agent/options.html#tls_cipher_suites)\n- Default value: ""\n\n### `consul_tls_prefer_server_cipher_suites`\n\n- [Prefer server\'s cipher suite over client cipher suite](https://www.consul.io/docs/agent/options.html#tls_prefer_server_cipher_suites)\n  - Can be overridden with `CONSUL_TLS_PREFER_SERVER_CIPHER_SUITES` environment variable\n- Default value: false\n\n### `consul_install_remotely`\n\n- Whether to download the files for installation directly on the remote hosts\n- This is the only option on Windows as WinRM is somewhat limited in this scope\n- Default value: false\n\n### `consul_install_upgrade`\n\n- Whether to [upgrade consul](https://www.consul.io/docs/upgrading.html) when a new version is specified\n- The role does not handle the orchestration of a rolling update of servers followed by client nodes\n- This option is not available for Windows, yet. (PR welcome)\n- Default value: false\n\n### `consul_ui`\n\n- Enable the consul ui?\n- Default value: true\n\n### `consul_ui_legacy`\n\n- Enable legacy consul ui mode\n- Default value: false\n\n### `consul_disable_update_check`\n\n- Disable the consul update check?\n- Default value: false\n\n### `consul_enable_script_checks`\n\n- Enable script based checks?\n- Default value: false\n- This is discouraged in favor of `consul_enable_local_script_checks`.\n\n### `consul_enable_local_script_checks`\n\n- Enable locally defined script checks?\n- Default value: false\n\n### `consul_raft_protocol`\n\n- Raft protocol to use.\n- Default value:\n  - Consul versions <= 0.7.0: 1\n  - Consul versions > 0.7.0: 3\n\n### `consul_node_role`\n\n- The Consul role of the node, one of: *bootstrap*, *server*, or *client*\n- Default value: client\n\nOne server should be designated as the bootstrap server, and the other\nservers will connect to this server. You can also specify *client* as the\nrole, and Consul will be configured as a client agent instead of a server.\n\nThere are two methods to setup a cluster, the first one is to explicitly choose the bootstrap server, the other one is to let the servers elect a leader among\nthemselves.\n\nHere is an example of how the hosts inventory could be defined for a simple\ncluster of 3 servers, the first one being the designated bootstrap / leader:\n\n```yaml\n[consul_instances]\nconsul1.consul consul_node_role=bootstrap\nconsul2.consul consul_node_role=server\nconsul3.consul consul_node_role=server\nconsul4.local consul_node_role=client\n```\n\nOr you can use the simpler method of letting them do their election process:\n\n```yaml\n[consul_instances]\nconsul1.consul consul_node_role=server consul_bootstrap_expect=true\nconsul2.consul consul_node_role=server consul_bootstrap_expect=true\nconsul3.consul consul_node_role=server consul_bootstrap_expect=true\nconsul4.local consul_node_role=client\n```\n\n> Note that this second form is the preferred one, because it is simpler.\n\n### `consul_autopilot_enable`\n\nAutopilot is a set of new features added in Consul 0.8 to allow for automatic operator-friendly management of Consul servers. It includes cleanup of dead servers, monitoring the state of the Raft cluster, and stable server introduction.\n\nhttps://www.consul.io/docs/guides/autopilot.html\n\n- Enable Autopilot config (will be written to bootsrapper node)\n  - Override with `CONSUL_AUTOPILOT_ENABLE` environment variable\n- Default value: false\n\n#### `consul_autopilot_cleanup_dead_Servers`\n\nDead servers will periodically be cleaned up and removed from the Raft peer set, to prevent them from interfering with the quorum size and leader elections. This cleanup will also happen whenever a new server is successfully added to the cluster.\n\n- Enable Autopilot config (will be written to bootsrapper node)\n  - Override with `CONSUL_AUTOPILOT_CLEANUP_DEAD_SERVERS` environment variable\n- Default value: false\n\n#### `consul_autopilot_last_contact_threshold`\n\nUsed in the serf health check to determine node health.\n\n- Sets the threshold for time since last contact\n  - Override with `CONSUL_AUTOPILOT_LAST_CONTACT_THRESHOLD` environment variable\n- Default value: 200ms\n\n#### `consul_autopilot_max_trailing_logs`\n\n- Used in the serf health check to set a max-number of log entries nodes can trail the leader\n  - Override with `CONSUL_AUTOPILOT_MAX_TRAILING_LOGS` environment variable\n- Default value: 250\n\n\n#### `consul_autopilot_server_stabilization_time`\n\n- Time to allow a new node to stabilize\n  - Override with `CONSUL_AUTOPILOT_SERVER_STABILIZATION_TIME` environment variable\n- Default value: 10s\n\n#### `consul_autopilot_redundancy_zone_tag`\n\n_Consul Enterprise Only (requires that CONSUL_ENTERPRISE is set to true)_\n\n- Override with `CONSUL_AUTOPILOT_REDUNDANCY_ZONE_TAG` environment variable\n- Default value: az\n\n#### `consul_autopilot_disable_upgrade_migration`\n\n_Consul Enterprise Only (requires that CONSUL_ENTERPRISE is set to true)_\n\n- Override with `CONSUL_AUTOPILOT_DISABLE_UPGRADE_MIGRATION` environment variable\n- Default value: *false*\n\n#### `consul_autopilot_upgrade_version_tag`\n\n_Consul Enterprise Only (requires that CONSUL_ENTERPRISE is set to true)_\n\n- Override with `CONSUL_AUTOPILOT_UPGRADE_VERSION_TAG` environment variable\n- Default value: \'\'\n\n#### Custom Configuration Section\n\nAs Consul loads the configuration from files and directories in lexical order, typically merging on top of previously parsed configuration files, you may set custom configurations via `consul_config_custom`, which will be expanded into a file named `config_z_custom.json` within your `consul_config_path` which will be loaded after all other configuration by default.\n\nAn example usage for enabling `telemetry`:\n\n```yaml\n  vars:\n    consul_config_custom:\n      telemetry:\n        dogstatsd_addr: "localhost:8125"\n        dogstatsd_tags:\n          - "security"\n          - "compliance"\n        disable_hostname: true\n```\n\n## Consul Snapshot Agent\n\n_Consul snapshot agent takes backup snaps on a set interval and stores them. Must have enterprise_\n\n### `consul_snapshot`\n\n- Bool, true will setup and start snapshot agent (enterprise only)\n- Default value: false\n\n### `consul_snapshot_storage`\n\n- Location snapshots will be stored. NOTE: path must end in snaps\n- Default value: `{{ consul_config_path }}/snaps`\n\n### `consul_snapshot_interval`\n\n- Default value: 1h\n\n### `consul_snapshot_retain`\n\n## OS and Distribution Variables\n\nThe `consul` binary works on most Linux platforms and is not distribution\nspecific. However, some distributions require installation of specific OS\npackages with different package names.\n\n### `consul_centos_pkg`\n\n- Consul package filename\n- Default value: `{{ consul_version }}_linux_amd64.zip`\n\n### `consul_centos_url`\n\n- Consul package download URL\n- Default value: `{{ consul_zip_url }}`\n\n### `consul_centos_sha256`\n\n- Consul download SHA256 summary\n- Default value: SHA256 summary\n\n### `consul_centos_os_packages`\n\n- List of OS packages to install\n- Default value: list\n\n### `consul_debian_pkg`\n\n- Consul package filename\n- Default value: `{{ consul_version }}_linux_amd64.zip`\n\n### `consul_debian_url`\n\n- Consul package download URL\n- Default value: `{{ consul_zip_url }}`\n\n### `consul_debian_sha256`\n\n- Consul download SHA256 summary\n- Default value: SHA256 SUM\n\n### `consul_debian_os_packages`\n\n- List of OS packages to install\n- Default value: list\n\n### `consul_redhat_pkg`\n\n- Consul package filename\n- Default value: `{{ consul_version }}_linux_amd64.zip`\n\n### `consul_redhat_url`\n\n- Consul package download URL\n- Default value: `{{ consul_zip_url }}`\n\n### `consul_redhat_sha256`\n\n- Consul download SHA256 summary\n- Default value: SHA256 summary\n\n### `consul_redhat_os_packages`\n\n- List of OS packages to install\n- Default value: list\n\n### consul_systemd_restart_sec\n\n- Integer value for systemd unit `RestartSec` option\n- Default value: 42\n\n### consul_systemd_limit_nofile\n\n- Integer value for systemd unit `LimitNOFILE` option\n- Default value: 65536\n\n### `consul_ubuntu_pkg`\n\n- Consul package filename\n- Default value: `{{ consul_version }}_linux_amd64.zip`\n\n### `consul_ubuntu_url`\n\n- Consul package download URL\n- Default value: `{{ consul_zip_url }}`\n\n### `consul_ubuntu_sha256`\n\n- Consul download SHA256 summary\n- Default value: SHA256 summary\n\n### `consul_ubuntu_os_packages`\n\n- List of OS packages to install\n- Default value: list\n\n### `consul_windows_pkg`\n\n- Consul package filename\n- Default value: `{{ consul_version }}_windows_amd64.zip`\n\n### `consul_windows_url`\n\n- Consul package download URL\n- Default value: `{{ consul_zip_url }}`\n\n### `consul_windows_sha256`\n\n- Consul download SHA256 summary\n- Default value: SHA256 summary\n\n### `consul_windows_os_packages`\n\n- List of OS packages to install\n- Default value: list\n\n### `consul_performance`\n\n- List of Consul performance tuning items\n- Default value: list\n\n#### `raft_multiplier`\n\n- [Raft multiplier](https://www.consul.io/docs/agent/options.html#raft_multiplier) scales key Raft timing parameters\n- Default value: 1\n\n#### `leave_drain_time`\n\n- [Node leave drain time](https://www.consul.io/docs/agent/options.html#leave_drain_time) is the dwell time for a server to honor requests while gracefully leaving\n\n- Default value: 5s\n\n#### `rpc_hold_timeout`\n\n- [RPC hold timeout](https://www.consul.io/docs/agent/options.html#rpc_hold_timeout) is the duration that a client or server will retry internal RPC requests during leader elections\n- Default value: 7s\n\n## Dependencies\n\nAnsible requires GNU tar and this role performs some local use of the unarchive module for efficiency, so ensure that your system has `gtar` and `unzip` installed and in the PATH. If you don\'t this role will install `unzip` on the remote machines to unarchive the ZIP files.\n\nIf you\'re on system with a different (i.e. BSD) `tar`, like macOS and you see odd errors during unarchive tasks, you could be missing `gtar`.\n\nInstalling Ansible on Windows requires the PowerShell Community Extensions. These already installed on Windows Server 2012 R2 and onward. If you\'re attempting this role on Windows Server 2008 or earlier, you\'ll want to install the extensions [here](https://pscx.codeplex.com/).\n\n## Example Playbook\n\nBasic installation is possible using the included `site.yml` playbook:\n\n```\nansible-playbook -i hosts site.yml\n```\n\nYou can also pass variables in using the `--extra-vars` option to the\n`ansible-playbook` command:\n\n```\nansible-playbook -i hosts site.yml --extra-vars "consul_datacenter=maui"\n```\n\nBe aware that for clustering, the included `site.yml` does the following:\n\n1. Executes consul role (installs Consul and bootstraps cluster)\n2. Reconfigures bootstrap node to run without bootstrap-expect setting\n3. Restarts bootstrap node\n\n### ACL Support\n\nBasic support for ACLs is included in the role. You can set the environment variables `CONSUL_ACL_ENABLE` to true, and also set the `CONSUL_ACL_DATACENTER` environment variable to its correct value for your environment prior to executing your playbook; for example:\n\n```\nCONSUL_ACL_ENABLE=true CONSUL_ACL_DATACENTER=maui \\\nCONSUL_ACL_MASTER_TOKEN_DISPLAY=true ansible-playbook -i uat_hosts aloha.yml\n```\n\nIf you want the automatically generated ACL Master Token value emitted to standard out during the play, set the environment variable `CONSUL_ACL_MASTER_TOKEN_DISPLAY` to true as in the above example.\n\nIf you want to use existing tokens, set the environment variables `CONSUL_ACL_MASTER_TOKEN` and `CONSUL_ACL_REPLICATION_TOKEN` as well, for example:\n\n```\nCONSUL_ACL_ENABLE=true CONSUL_ACL_DATACENTER=stjohn \\\nCONSUL_ACL_MASTER_TOKEN=0815C55B-3AD2-4C1B-BE9B-715CAAE3A4B2 \\\nCONSUL_ACL_REPLICATION_TOKEN=C609E56E-DD0B-4B99-A0AD-B079252354A0 \\\nCONSUL_ACL_MASTER_TOKEN_DISPLAY=true ansible-playbook -i uat_hosts sail.yml\n```\n\nThere are a number of Ansible ACL variables you can override to further refine your initial ACL setup. They are not all currently picked up from environment variables, but do have some sensible defaults.\n\nCheck `defaults/main.yml` to see how some of he defaults (i.e. tokens) are automatically generated.\n\n### Dnsmasq DNS Forwarding Support\n\nThe role now includes support for [DNS forwarding](https://www.consul.io/docs/guides/forwarding.html) with [Dnsmasq](http://www.thekelleys.org.uk/dnsmasq/doc.html).\n\nEnable like this:\n\n```\nansible-playbook -i hosts site.yml --extra-vars "consul_dnsmasq_enable=true"\n```\n\nThen, you can query any of the agents via DNS directly via port 53,\nfor example:\n\n```\ndig @consul1.consul consul3.node.consul\n\n; <<>> DiG 9.8.3-P1 <<>> @consul1.consul consul3.node.consul\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 29196\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0\n\n;; QUESTION SECTION:\n;consul3.node.consul.   IN  A\n\n;; ANSWER SECTION:\nconsul3.node.consul.  0 IN  A 10.1.42.230\n\n;; Query time: 42 msec\n;; SERVER: 10.1.42.210#53(10.1.42.210)\n;; WHEN: Sun Aug  7 18:06:32 2016\n;;\n```\n\n### `consul_delegate_datacenter_dns`\n- Whether to delegate Consul datacenter DNS domain to Consul\n- Default value: false\n\n### `consul_dnsmasq_enable`\n\n- Whether to install and configure DNS API forwarding on port 53 using DNSMasq\n  - Override with `CONSUL_DNSMASQ_ENABLE` environment variable\n- Default value: false\n\n### `consul_dnsmasq_bind_interfaces`\n\n- Setting this option to _true_ prevents DNSmasq from binding by default 0.0.0.0, but instead instructs it to bind to the specific network interfaces that correspond to the `consul_dnsmasq_listen_addresses` option\n- Default value: false\n\n### `consul_dnsmasq_consul_address`\n\n- Address used by DNSmasq to query consul\n- Default value: `consul_address.dns`\n- Defaults to 127.0.0.1 if consul\'s DNS is bound to all interfaces (eg `0.0.0.0`)\n\n### `consul_dnsmasq_cache`\n\n- dnsmasq cache-size\n- If smaller then 0, the default dnsmasq setting will be used.\n- Default value: *-1*\n\n### `consul_dnsmasq_servers`\n\n- Upstream DNS servers used by dnsmasq\n- Default value: *8.8.8.8* and *8.8.4.4*\n\n### `consul_dnsmasq_revservers`\n\n- Reverse lookup subnets\n- Default value: *[]*\n\n### `consul_dnsmasq_no_poll`\n\n- Do not poll /etc/resolv.conf\n- Default value: false\n\n### `consul_dnsmasq_no_resolv`\n\n- Ignore /etc/resolv.conf file\n- Default value: false\n\n### `consul_dnsmasq_local_service`\n\n- Only allow requests from local subnets\n- Default value: false\n\n### `consul_dnsmasq_listen_addresses`\n\n- Custom list of addresses to listen on.\n- Default value: *[]*\n\n### `consul_connect_enabled`\n\n- Enable Consul Connect feature on servers\n- Default value: false\n\n### iptables DNS Forwarding Support\n\nThis role can also use iptables instead of Dnsmasq for forwarding DNS queries to Consul. You can enable it like this:\n\n```\nansible-playbook -i hosts site.yml --extra-vars "consul_iptables_enable=true"\n```\n\n> Note that iptables forwarding and DNSmasq forwarding cannot be used\n> simultaneously and the execution of the role will stop with error if such\n> a configuration is specified.\n\n### TLS Support\n\nYou can enable TLS encryption by dropping a CA certificate, server certificate, and server key into the role\'s `files` directory.\n\nBy default these are named:\n\n- `ca.crt` (can be overridden by {{ consul_tls_ca_crt }})\n- `server.crt` (can be overridden by {{ consul_tls_server_crt }})\n- `server.key` (can be overridden by {{ consul_tls_server_key }})\n\nThen either set the environment variable `CONSUL_TLS_ENABLE=true` or use the Ansible variable `consul_tls_enable=true` at role runtime.\n\n### Service management Support\n\nYou can create a configuration file for [consul services](https://www.consul.io/docs/agent/services.html).\nAdd a list of service in the `consul_services`.\n\n| name            | Required | Type | Default | Comment                            |\n| --------------- | -------- | ---- | ------- | ---------------------------------- |\n| consul_services | False    | List | `[]`    | List of service object (see below) |\n\nServices object:\n\n| name                | Required | Type   | Default | Comment                                                                                                    |\n| ------------------- | -------- | ------ | ------- | ---------------------------------------------------------------------------------------------------------- |\n| name                | True     | string |         | Name of the service                                                                                        |\n| id                  | False    | string |         | Id of the service                                                                                          |\n| tags                | False    | list   |         | List of string tags                                                                                        |\n| address             | False    | string |         | service-specific IP address                                                                                |\n| meta                | False    | dict   |         | Dict of 64 key/values with string semantics                                                                |\n| port                | False    | int    |         | Port of the service                                                                                        |\n| enable_tag_override | False    | bool   |         | enable/disable the anti-entropy feature for the service                                                    |\n| kind                | False    | string |         | identify the service as a Connect proxy instance                                                           |\n| proxy               | False    | dict   |         | [proxy configuration](https://www.consul.io/docs/connect/proxies.html#complete-configuration-example)      |\n| checks              | False    | list   |         | List of [checks configuration](https://www.consul.io/docs/agent/checks.html)                               |\n| connect             | False    | dict   |         | [Connect object configuration](https://www.consul.io/docs/connect/index.html)                              |\n| weights             | False    | dict   |         | [Weight of a service in DNS SRV responses](https://www.consul.io/docs/agent/services.html#dns-srv-weights) |\n| token               | False    | string |         | ACL token to use to register this service                                                                  |\n\n\nConfiguration example:\n```yaml\nconsul_services:\n  - name: "openshift"\n    tags: [\'production\']\n  - name: "redis"\n    id: "redis"\n    tags: [\'primary\']\n    address: ""\n    meta:\n      meta: "for my service"\n    proxy:\n      destination_service_name: "redis"\n      destination_service_id: "redis1"\n      local_service_address: "127.0.0.1"\n      local_service_port: 9090\n      config: {}\n      upstreams:  []\n    checks:\n      - args: ["/home/consul/check.sh"]\n        interval: "10s"\n```\n\nThen you can check that the service is well added to the catalog\n```\n> consul catalog services\nconsul\nopenshift\nredis\n```\n\n>**Note:** to delete a service that has been added from this role, remove it from the `consul_services` list and apply the role again.\n\n### Vagrant and VirtualBox\n\nSee [examples/README_VAGRANT.md](https://github.com/brianshumate/ansible-consul/blob/master/examples/README_VAGRANT.md) for details on quick Vagrant deployments under VirtualBox for development, evaluation, testing, etc.\n\n## License\n\nBSD\n\n## Author Information\n\n[Brian Shumate](http://brianshumate.com)\n\n## Contributors\n\nSpecial thanks to the folks listed in [CONTRIBUTORS.md](https://github.com/brianshumate/ansible-consul/blob/master/CONTRIBUTORS.md) for their contributions to this project.\n\nContributions are welcome, provided that you can agree to the terms outlined in [CONTRIBUTING.md](https://github.com/brianshumate/ansible-consul/blob/master/CONTRIBUTING.md).\n'