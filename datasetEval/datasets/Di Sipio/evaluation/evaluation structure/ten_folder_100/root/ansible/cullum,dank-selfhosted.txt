b'# dank-selfhosted\n\n<img src="https://i.imgur.com/A46hkpd.gif" width="300">\n\nHi! This is my ansible playbook for self-hosting your own email, web hosting, XMPP chat,\nMatrix Homeserver, Tiny Tiny RSS, Git repos, and and DNS records using [OpenBSD](https://www.openbsd.org/).\nI use it to host everything on [c0ffee.net](https://www.c0ffee.net), but you can easily adapt \nit for your own domain by setting a few variables in `vars.yml`.\n\n**NEW:** Read the [changelog](CHANGELOG.md) before running this playbook after updates! There are often breaking changes!!\n\n## TLDR\n\n1. Configure a [secondary DNS provider](https://cp.dnsmadeeasy.com/u/122648) and set them as your nameservers at your registrar. Set up reverse DNS for your server.\n2. `./scripts/bootstrap_openbsd.sh`\n3. `cp vars-sample.yml vars.yml && vi vars.yml`\n4. `ansible-playbook site.yml`\n5. `./scripts/ds_records.sh YOURDOMAIN` and set DS records at your registrar for DNSSEC.\n6. Create your user account with `dankctl useradd`.\n\n## Assumptions\n\n- You have a public-facing server (probably a VPS) running OpenBSD, with an IPv4 and IPv6 address. I recommend [Vultr](https://www.vultr.com/?ref=6845125).\n- You have your own domain name, and a registrar that supports DNSSEC. I recommend [Namecheap](https://affiliate.namecheap.com/?affId=108349).\n- You have a secondary DNS provider that supports DNSSEC. I recommend [DNS Made Easy](https://cp.dnsmadeeasy.com/u/122648). ([Why do I need this?](https://www.c0ffee.net/blog/dns-hidden-master/))\n- You\'re crazy enough to run your own mail server :-)\n\n## Goals\n\n- A small and secure OpenBSD platform to host email, DNS, XMPP chat, Matrix, TTRSS, Git, and some web sites.\n    - **Scale:** you and your family members, and maybe a few technically oriented friends.\n    - Really not suited for the general public, no automated password reset, no web GUIs...\n\n- Use as much of the OpenBSD base system as possible:\n    - [acme-client(1)](https://man.openbsd.org/acme-client.1) for [LetsEncrypt](https://letsencrypt.org/) certificates\n    - [smtpd(8)](https://man.openbsd.org/smtpd.8) for mail handling\n    - [spamd(8)](https://man.openbsd.org/spamd) for spam filtering\n    - [nsd(8)](https://man.openbsd.org/nsd.8) for authoritative DNS server\n    - [httpd(8)](https://man.openbsd.org/httpd.8) for web server\n    - [ldapd(8)](https://man.openbsd.org/ldapd.8) authentication for UNIX accounts and all services (except Matrix...I\'m working on it!)\n\n- Of course, some packages from the ports tree will be necessary:\n    - [nginx](https://nginx.org) for TLS reverse proxy\n    - [prosody](http://prosody.im/) for XMPP chat\n    - [postgresql](https://www.postgresql.org/) for Prosody data storage\n    - [ldns-utils](https://www.nlnetlabs.nl/projects/ldns/about/) for DNSSEC zone signing\n    - [dovecot](https://dovecot.org/) for IMAP access\n    - [dkimproxy](http://dkimproxy.sourceforge.net/) for [DKIM](http://www.dkim.org/) signing of outgoing mail\n\n- And some third-party projects not currently in packages:\n    - [synapse](https://github.com/matrix-org/synapse) for running your own [Matrix](https://matrix.org) homeserver\n    - [Tiny Tiny RSS](https://tt-rss.org) as a personal RSS aggregator\n    - [Gitea](https://gitea.io) for your Git repositiories.\n\n- Encryption Everywhere:\n    - Automated DNSSEC with `nsd` and cron tasks using `ldns-signzone` for daily zone re-signing and slave `NOTIFYs`\n    - TLS for all public-facing services using LetsEncrypt certificates with automated renewal and daemon reload hooks\n    - Automatic publishing of [SSHFP](https://tools.ietf.org/html/rfc4255) records for authoritative SSH fingerprints\n    - Automatic publishing of [TLSA](https://tools.ietf.org/html/rfc6698) records for [DANE email encryption](https://halon.io/blog/what-is-dane/)\n    - Automatic publishing of DKIM records for outgoing email verification\n\n- Keep it Simple\n    - Unopinionated baseline for what most people want from a personal domain\n    - Keep dependencies to a minimum and stick to UNIX conventions\n    - Automate the tedious stuff, so you can focus on hacking!\n\n## Usage\n\n1. Boot up your OpenBSD server.\n2. Create a user account for provisioning the system. Make sure to add the account to the `wheel` group. Don\'t use your preferred username for this account - save that for your LDAP username.\n3. Run `scripts/bootstrap_openbsd.sh` as root to add a package repo URL and set up [doas](http://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man1/doas.1) for your user (required for Ansible).\n4. Configure your secondary DNS provider to accept `NOTIFYs` and perform zone transfers from your server\'s IP address.\n5. `cp vars-sample.yml vars.yml` and edit the configuration to your liking.\n6. Run the playbook! `ansible-playbook site.yml`\n7. Ensure you have reverse DNS in place for your server\'s IP address. This is a critical step to avoid your outgoing mail being flagged as spam. At Vultr, this is configured under "Settings > IPv4". You should set one for your primary IPv6 address as well.\n8. The last step is to configure DS records for DNSSEC at your domain registrar. Run `scripts/ds_records.sh YOURDOMAIN` to generate the records. At Namecheap, this is configured under "Advanced DNS > DNSSEC" in the web portal.\n9. Create your "real" user account in LDAP via `dankctl useradd your_username -c "Your Name" -G ssh,sudo -r admin -k "your ssh key"`\n10. Yell at me via [email](mailto:cullum@c0ffee.net), [xmpp](xmpp:cullum@c0ffee.net?message), or [matrix](https://matrix.to/#/@cullum:c0ffee.net) when you inevitably find bugs in my code.\n\n## Operational Notes\n\n- **Login info:** the credentials for SMTP (STARTTLS, port 587) and IMAP (SSL, port 993) are simply your username (*without* the @domain.com portion) and login password. XMPP uses the `username@domain.com` syntax for logins, but the password is the same. Mail is stored under `~/Maildir` in each user\'s home directory for easy access using local clients like `mutt`.\n\n- **Email Filtering**: any [sieve script](https://wiki2.dovecot.org/Pigeonhole/Sieve/Examples) located at `~/.dovecot.sieve` will automatically apply filters to your incoming mail. You can compile the sieve script and check for syntax errors using `sievec ~/.dovecot.sieve`. For example, to filter all your cron emails into a folder called `Logs`:\n\n````\nrequire ["regex", "fileinto", "imap4flags", "mailbox", "envelope", "variables"];\n\nif allof ( address :is "from" "root@hostname.example.com",\n           anyof ( header :contains "subject" "cron",\n                   header :contains "subject" "output" )) {\n  fileinto :create "Logs";\n  stop;\n}\n````\n\n- **XMPP Chat:** the XMPP server, Prosody, is really slick. As configured here, it supports HTTP file upload for image sharing, delivery to multiple devices via carbons, push notifications, group chats, message history, and basically everything you\'d expect from a modern chat solution. XMPP isn\'t all that bad! The best clients are [ChatSecure](https://chatsecure.org/) for iOS, [Conversations](https://conversations.im/) for Android, and [Gajim](https://gajim.org/) for *nix and Windows. No decent clients for OS X, sadly. All those clients support end-to-end crypto via [OMEMO](https://conversations.im/omemo/). Easily federate with others on separate XMPP servers for truly decentralized, open communication!\n\n- **Account Maintenance**: to add, remove, and modify accounts and groups, use the `dankctl` command. It\'s help output should be quite self-explanatory.\n\n- **IPv6:** `spamd` does not currently support IPv6, so don\'t go adding a AAAA record for `mail` in the zonefile!\n\n- **Monitoring spamd:** just run `spamdb` to see a list of senders currently greylisted/whitelisted.\n\n- **Virtual Hosts:** a default vhost will be created for `www.domain.com`, with a bare domain redirect. Shove HTML files into `/var/www/htdocs/www.domain.com` to start sharing your worthless opinions with the internet! To add more vhosts, just put a configuration file in `/etc/sites` and include it in `/etc/httpd.d/sites.conf`.\n\n- **Greylisting pitfalls:** `spamd` works by [greylisting](https://www.greylisting.org/). Unfortunately, big mailers like GMail often don\'t retry delivery from the same address, resulting in a greylist black hole described [here](https://poolp.org/posts/2018-01-08/spfwalk/). To alleviate this, I included a daily cron job that whitelists the IP addresses found in the SPF records for some of the big mailers like GMail and Yahoo. If you notice any other problematic domains, override the to the `bigmailers` list defined in [roles/spamd/deaults/main.yml](roles/spamd/defaults/main.yml) to have their IP ranges whitelisted. (And be sure to send me a pull request!)\n\n- **Password Resets:** Passwords can be reset using `dankctl resetpass`. Currently, only an administrator can do this, since giving users write access to their LDAP user entry could allow them to write a non-hashed password into their `userPassword` field. It\'s on my todo list to make some kind of web interface for this.\n\n- **SSH:** SSH keys are stored in LDAP and can be added/removed using `dankctl usermod`. If a user has a shell on the box, he can run this command with his own credentials. Users must be in the `ssh` group to connect.\n\n- **Backups**: another thing I\'m leaving up to you, since your requirements will almost certainly be unique. Shouldn\'t be too difficult:\n    - **Maildirs**: tar them up, maybe encrypt them, and scp them offsite periodically.\n    - **User accounts**: back up `/etc/{passwd,master.passwd,group}`\n    - **Backup MX records:** I don\'t bother with a backup MX. They are a massive target for spammers, and legit mail servers will keep retrying delivery for multiple days if your primary MX goes down.\n    - **Prosody:** periodically tar up the HTTP upload dir and do a `pg_dump` to save user info and message archives.\n    - **Keys:** tar up your DNSSEC keys (`/var/nsd/keys`) and DKIM keys (`/etc/mail/dkim`)\n    - **LDAP**: you can either tar up `/var/db/ldap` or save the output of `ldap search` as the root DN.\n    - Assuming you copy all these items back to their original locations, the playbook won\'t generate new keys if they already exist.\n\n## Resources\n\n- [How to Run Your Own Mail Server](https://www.c0ffee.net/blog/mail-server-guide/): my original email guide. Written for FreeBSD, but still lots of great info about mail hosting. [HN Discussion](https://news.ycombinator.com/item?id=16238937)\n\n- [DNS Hosting Guide: Hidden Master with DNSSEC](https://www.c0ffee.net/blog/dns-hidden-master/): my original guide for running your own DNS. Again, written for FreeBSD, but gives a lot of details about why you\'d want a hidden master setup.\n'