b'Heroku WP\n=========\n\nThis is a template for installing and running [WordPress](http://wordpress.org/) on [Heroku](http://www.heroku.com/) with a focus on speed and security while using the official Heroku stack.\n\nSpin Up a Demo\n--------------\n\nWant to give it a try first? Deploy a demo to your account:\n\n[![Deploy](https://www.herokucdn.com/deploy/button.svg)](https://heroku.com/deploy?template=https://github.com/xyu/heroku-wp/tree/button)\n\n_For production setups it\'s highly recommended to follow the instructions below to properly install and version control with your own repo._\n\nAbout\n-----\n\nThe repository is built on top of the standard Heroku PHP buildpack so you don\'t need to trust some sketchy 3rd party s3 bucket.\n* [NGINX](http://nginx.org) - Fast scalable webserver.\n* [PHP 7](http://php.net) - Latest and greatest with performance on par with HHVM.\n* [Composer](https://getcomposer.org) - A dependency manager to make installing and managing plugins easier.\n\nHeroku WP uses the following addons:\n* [MariaDB](https://mariadb.org) / [jawsdb-maria](https://elements.heroku.com/addons/jawsdb-maria) - A binary compatible MySQL replacement with even better performance.\n* [Redis](http://redis.io) / [heroku-redis](https://elements.heroku.com/addons/heroku-redis) - An in-memory datastore for fast persistant object cache.\n* [New Relic](https://newrelic.com) / [newrelic](https://elements.heroku.com/addons/newrelic) - SaaS application performance monitoring.\n\nAnd optionally the following addons:\n* [SendGrid](https://sendgrid.com) / [sendgrid](https://elements.heroku.com/addons/sendgrid) - SaaS email delivery service.\n* [IronWorker](https://www.iron.io) / [iron_worker](https://elements.heroku.com/addons/iron_worker) - SaaS external jobs queue\n\nIn additon repository comes bundled with the following tools and must use plugins.\n* [WP-CLI](http://wp-cli.org) - For simple management of your WP install.\n* [Batcache](http://wordpress.org/plugins/batcache) - For full page output caching.\n* [Redis Object Cache](http://wordpress.org/plugins/redis-cache) - For using Redis as a persistant, shared, object cache.\n* [Secure DB Connection](http://wordpress.org/plugins/secure-db-connection) - For ensuring connections to the database are secure and encrypted.\n\nFinally these plugins are pre-installed as they are highly recommended but not activated.\n* [Jetpack](http://jetpack.me/)\n* [S3 Uploads](https://github.com/humanmade/S3-Uploads)\n* [SendGrid](http://wordpress.org/plugins/sendgrid-email-delivery-simplified/)\n\nWordPress and most included plugins are installed by Composer on build. To add new plugins or upgrade versions of plugins simply update the `composer.json` file and then generate the `composer.lock` file with the following command locally:\n\n```bash\n$ bin/composer update --ignore-platform-reqs\n```\n\nTo add local plugins and themes, you can create ```plugins/``` and ```themes/``` folders inside `/public/wp-content` which upon deploy to Heroku will be copied on top of the standard WordPress install, themes, and plugins specified by Composer.\n\nInstallation\n------------\n\nMake sure you have the [Heroku Toolbelt](https://toolbelt.heroku.com/) installed and configured for your account. This provides the `heroku` CLI tool for creating and managing your Heroku apps.\n\nClone the repository from Github\n\n    $ git clone https://github.com/xyu/heroku-wp.git\n\nRun the included init script\n\n    $ cd heroku-wp && bin/init.sh my-app-name\n\nUse WP-CLI to install the DB and set intial settings\n\n    $ heroku run wp core install \\\n        --url=my-app-name.herokuapp.com \\\n        --title="WordPress on Heroku" \\\n        --admin_user="admin" \\\n        --admin_password="correct-horse-battery-staple" \\\n        --admin_email="info@example.com"\n\nOptional Installation\n---------------------\n\nInstalling and configuring the items below are not essential to get a working WordPress install but will make your site more functional and secure.\n\n### Sending Email\n\n[SendGrid](http://wordpress.org/plugins/sendgrid-email-delivery-simplified) plugin is included in the repository and preconfigured to work with the [SendGrid addon](https://elements.heroku.com/addons/sendgrid). It has recently been updated, and support for *Username & Password* authentication has been dropped. It now requires an API key.\n\nTo activate this plugin, just run the included init script and follow the instructions.\n\n    $ bin/init-sendgrid.sh my-app-name\n\n### Media Uploads\n\n[S3 Uploads](https://github.com/humanmade/S3-Uploads) is a lightweight "drop-in" for storing WordPress uploads on [Amazon S3](http://aws.amazon.com/s3) instead of the local filesystem. If you want media uploads you must activate this plugin and configure a S3 bucket because the local filesystem for Heroku Dynos are ephemeral.\n\nTo activate this plugin:\n\n1.  First set your S3 credentials via Heroku configs with AWS S3 path-style URLs. It\'s best practices to URL encode your AWS key and secret, (e.g. use `%2B` for `+` and `%2F` for `/`,) however non URL encoded values should still work even if they are invalid URLs.\n\n    ```\n    $ heroku config:set \\\n        AWS_S3_URL="s3://{AWS_KEY}:{AWS_SECRET}@s3.amazonaws.com/{AWS_BUCKET}"\n    ```\n\n    If you would like to set the optional region for your S3 bucket use the region-specific endpoint.\n\n    ```\n    $ heroku config:set \\\n        AWS_S3_URL="s3://{AWS_KEY}:{AWS_SECRET}@s3-{AWS_REGION}.amazonaws.com/{AWS_BUCKET}"\n    ```\n\n    For example, if your bucket is in the South America (S\xc3\xa3o Paulo) region use:\n\n    ```\n    $ heroku config:set \\\n        AWS_S3_URL="s3://my-key:my-secret@s3-sa-east-1.amazonaws.com/my-bucket"\n    ```\n\n    If you would like to use a custom bucket URL either because you are proxying the requests or if you are using a domain for the bucket name you can do so by setting a custom url param:\n\n    ```\n    $ heroku config:set \\\n        AWS_S3_URL="s3://{AWS_KEY}:{AWS_SECRET}@s3-{AWS_REGION}.amazonaws.com/{AWS_BUCKET}?url={BUCKET_URL}"\n    ```\n\n    The `BUCKET_URL` should have a scheme attached, e.g.:\n\n    ```\n    $ heroku config:set \\\n        AWS_S3_URL="s3://my-key:my-secret@s3-sa-east-1.amazonaws.com/my-bucket?url=https://static.example.com"\n    ```\n\n2.  Then activate the plugin in WP Admin.\n\n### Securing Your MySQL Connection (X509 auth or custom CAs only)\n\nThis repo already comes with both the ClearDB and Amazon RDS root CAs installed for secure DB connections. To turn on SSL simply set the `WP_DB_SSL` config. (We default to secured so this is already set to `ON` by `init.sh`.)\n\n    $ heroku config:set \\\n        WP_DB_SSL="ON"\n\nIf you use another MySQL database and have a self signed cert you can add the self signed CA to the trusted store by committing it to `/support/mysql-certs` and setting the filenames or explicitly setting it in the ENV config itself:\n\n    $ heroku config:set \\\n        MYSQL_SSL_CA="$(cat /path/to/server-ca.pem)"\n\nIn addition if your MySQL server requires X509 auth in addition to the username/password you can set the client cert and private key through the use of ENV vars like so (be sure to use RSA keys):\n\n    $ heroku config:set \\\n        MYSQL_SSL_CERT="$(cat /path/to/client-cert.pem)" \\\n        MYSQL_SSL_KEY="$(cat /path/to/client-key.pem)"\n\n### Offloaded WP Cron\n\nWP Cron relies on visitors to the site to trigger scheduled jobs to run which can be a problem for lightly trafficked sites. Instead we can have an external jobs system (IronWorker) run WP Cron on schedule to provide consistency.\n\nJust run the included init script to install an IronWorker task with an execution schedule of every 15 minutes.\n\n    $ bin/init-ironworker.sh my-app-name\n\nUsage\n-----\n\nBecause a file cannot be written to Heroku\'s file system, updating and installing plugins or themes should be done locally and then pushed to Heroku. Even better would be to use Composer to install plugins so that version control and upgrading is simply a matter of editing the `composer.json` file and bumping the version number.\n\nInternationalization\n--------------------\n\nIn most cases you may want to have your WordPress blog in a language different than its default (US English). In that case all you need to do is download the .mo and .po files for your language from [wpcentral.io/internationalization](http://wpcentral.io/internationalization/) and place them in the\n`languages` directory you\'ll create under `public/wp-content`. Then you should commit changes to your local branch and push them to your heroku remote. After that, you\'ll be able to select the new language from the WP admin panel.\n\nUpdating\n--------\n\nUpdating your WordPress version is just a matter of merging the updates into\nthe branch created from the installation.\n\n    $ git pull                                    # Get the latest updates\n    $ git checkout {SLUG}                         # Checkout the site branch\n    $ git merge origin/master                     # Merge in latest\n    $ bin/composer update --ignore-platform-reqs  # Update composer.lock file\n    $ git push heroku {SLUG}:master               # Deploy to Heroku\n\nAfter pushing changes update the WordPress database via WP-CLI:\n\n    $ heroku run wp core update-db\n\nWordPress will prompt for updating the database. After that you\'ll be good\nto go.\n\nCustom Domains\n--------------\n\nHeroku allows you to add custom domains to your site hosted with them.  To add your custom domain, enter in the follow commands.\n\n    $ heroku domains:add www.example.com\n    > Added www.example.com as a custom domain name to myapp.heroku.com\n\nFAQ\n---\n\n#### Q. Help, nothing is showing up / I\'ve polluted my cache!\n\nOne of the most common problems is if you make a DB change but still have stale cache refering to the old configs the easiest way to fix this is to use the included WP-CLI tool to flush your Redis cache:\n\n    $ heroku run wp cache flush\n\n#### Q. Why are you hacking Batcache?\n\nPHP 7 support for Batcache has been merged into master however a new version has not been tagged yet. Also some bug fixes that help make sure caching headers are valid have not been merged in yet. Finally, displaying caching information in HTTP headers is a lot easier then HTML comments however it\'s a rather large change so I\'m forking the plugin for now.\n\nAs with all external code you should trust but verify, here\'s the diff for the forked version against Automattic\'s head:\n\nhttps://github.com/Automattic/batcache/compare/master...xyu:master\n\nRunning Locally\n---------------\n\nA Vagrant instance to run Heroku WP is included. To get up and running:\n* Install Vagrant http://www.vagrantup.com/downloads\n* Install VirtualBox https://www.virtualbox.org/wiki/Downloads\n\nTo make your life easier a Vagrant plugin can be used to manage the hosts file.\n\n    $ vagrant plugin install vagrant-hostmanager\n\nIf you don\'t have vagrant-hostmanager installed you\'ll have to manually update\nyour hostfile.\n\nOnce installed `cd` into app root directory and run `$ vagrant up` (should start setting up virtual env. go grab some \xe2\x98\x95, takes about 10 minutes)\n\nOnce Vagrant provisions the VM you will have Heroku WP running locally at `http://herokuwp.local/`. On first load, it should bring you to the WordPress install page. If the site is not accessible in the browser, you might need to add `192.168.50.100 herokuwp.local` to your hosts file manually.\n\nAs a convenience both the `/public` dir and `/composer.lock` file will be monitored by the VM. Any changes to either triggers a rebuild process which will result in `/public.built` (the web root) being updated. `/app/support` is also monitored by the VM, changes here will cause Nginx to reload with the new configs.\n\nConnecting to MySQL on Vagrant Machine\n--------------------------------------\n\nIn order to connect you will need to change the MySQL config to work with 0.0.0.0 IP address instead of localhost.\n* SSH into the vm `$ vagrant ssh`\n* Open the config file `$ sudo vim /etc/mysql/my.cnf`\n* Change the IP address from 127.0.0.1 to 0.0.0.0\n\nThen you can connect using SSH with the following parameters:\n* SSH hostname: 127.0.0.1:2222\n* SSH username: vagrant\n* SSH password: vagrant\n* MySQL hostname: 127.0.0.1\n* MySQL port: 3306\n* mysql user: herokuwp\n* mysql password: password\n\nIf your computer goes to sleep and vagrant is suspended abruptly\n----------------\n\nSometimes after `vagrant up` from an aborted state, the vm does not start correctly and the site is not accessible. When this happens force a re-provision of the machine with\n\n    $ vagrant provision\n'