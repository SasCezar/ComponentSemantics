b'# pico8-table-string\n\nStore a nested Lua data table as one giant string. Functions run in PICO-8 and in standard Lua environments. Works for flat and nested tables.\n\n*NOTE!*: This can be helpful if you have a really large amount of data whose token count you want to cut down, but there are [other techniques you can try first](https://github.com/seleb/PICO-8-Token-Optimizations/blob/master/README.md) which may be more effective generally.\n\n### *Before*\n\n```lua\nmy_table = {\n  hello=\'world\',\n  nested={\n    some=\'data\\\'s nested\',\n    inside_of=\'here\'\n  },\n  \'and\',\n  \'indexed\',\n  \'data\',\n  { as=\'well\' }\n}\n```\n\n### *After*\n\n```lua\nmy_table=\ntable_from_string(\n \'1\x1fand\x1f2\x1findexed\x1f3\x1fdata\x1f4\x1das\x1fwell\x1f\x1ehello\x1fworld\x1fnested\x1dinside_of\x1fhere\x1fsome\x1fdata\\\'s nested\x1f\x1e\'\n)\n```\n\n## Why?\n\nThere\'s only one good set of reasons (that I can think of) to store your data in this particular way:\n\n1. You\'re building a [PICO-8](https://www.lexaloffle.com/pico-8.php) game\n2. Your game is too big and your remaining token count is running low\n3. You have a lot of string data taking up a lot of tokens\n\nIf these are true (or even if not), you can take advantage of this to cut down on your number of tokens. Create your data in a separate Lua file, use this tool to turn it into a giant string, and deserialize your data back into a Lua table when your program boots up.\n\nNote that if the amount of data you\'re serializing is small, you\'ll actually add more tokens by including the library. The `table_from_string` function, which is required at runtime to rebuild the table, takes up 139 PICO-8 tokens. But now the actual declaration of the table takes only 5 tokens, so if you have a table taking up 145 or more tokens, this can give you some significant savings.\n\n## Usage\n\nFirst, clone this repository:\n\n```console\ngit clone https://github.com/benwiley4000/pico8-table-string.git\ncd pico8-table-string/\n```\n\n### Serializing\n\nAssuming you have [Lua](https://www.lua.org/start.html) installed, the easiest way to generate a string version of your data is to paste your table into the [print-table-data](/print-table-data) file and run it from the command line:\n\n```console\n$ ./print-table-data\nmy_table=\ntable_from_string(\n \'1\x1fand\x1f2\x1findexed\x1f3\x1fdata\x1f4\x1das\x1fwell\x1f\x1ehello\x1fworld\x1fnested\x1dinside_of\x1fhere\x1fsome\x1fdata\\\'s nested\x1f\x1e\'\n)\n```\n\nAlternatively, if you want to generate with PICO-8 directly, that\'s also possible.\n\nFirst, copy the contents from [stringify.lua](/stringify.lua) into your PICO-8 code editor (excluding the `return` statement at the bottom of the file).\n\nThen add this code:\n\n```lua\n-- replace with whatever your table is called\nlocal table_str = serialize_table(my_table)\n\nprinth(\'my_table=\',\'outfile\')\nprinth(\'table_from_string(\',\'outfile\')\nprinth(\' \'..table_str,\'outfile\')\nprinth(\')\',\'outfile\')\n```\n\nThen check the file `outfile.p8l`:\n\n```\nmy_table=\ntable_from_string(\n \'1\x1fand\x1f2\x1findexed\x1f3\x1fdata\x1f4\x1das\x1fwell\x1f\x1ehello\x1fworld\x1fnested\x1dinside_of\x1fhere\x1fsome\x1fdata\\\'s nested\x1f\x1e\'\n)\n```\n\nYou can take this and include it in your code.\n\n### Parsing at runtime\n\nNote that at runtime, the only function you need to include is `table_from_string` from [parse.lua](/parse.lua).\n\n## Serialization format\n\nInstead of using something like JSON or a string embedding Lua\'s own table format (which could have been ideal if we had access to an eval function in PICO-8), we essentially just concatenate all the keys and values from a table into a giant string, with a few ASCII control characters as token delimiters and structure indicators (to allow table nesting). By assuming everything will be a string (except those table keys which are able to be parsed as numbers), we are able to keep the parsing routine relatively simple, which is important since the goal is to save on tokens.\n\nBeyond the question of parsing complexity, the format is also smaller than the alternatives. Compare this output, taking up 91 characters:\n\n```lua\n\'1\x1fand\x1f2\x1findexed\x1f3\x1fdata\x1f4\x1das\x1fwell\x1f\x1ehello\x1fworld\x1fnested\x1dinside_of\x1fhere\x1fsome\x1fdata\\\'s nested\x1f\x1e\'\n```\n\nwith this JSON version which uses 126 characters (38% more!): \n\n```lua\n\'{"1":"and","2":"indexed","3":"data","4":{"as":"well"},"hello":"world","nested":{"some":"data\\\'s nested","inside_of":"here"}}\'\n```\n\nIt might be a moot comparison though, since the token cost of parsing JSON would be so great. Take this [pure-Lua JSON library](https://gist.github.com/tylerneylon/59f4bcf316be525b30ab), for example, which would take up nearly 750 PICO-8 tokens.\n\n## Notes\n\n### Types\n\nThe main current caveat is all the contained values must strings, since it\'s simpler to serialize and parse without embedding type information, and I only needed this for strings. I can imagine a use case where this could be useful for numeric information (e.g. large 3d models), so I\'d be open to a pull request to add that support, if the token count can stay pretty low. Alternatively, it could just be a separate function.\n\n### Error handling (or not)\n\nIn order to keep the token count low, there\'s no built-in error handling, so make sure any string you send to `table_from_string` was created with `serialize_table` or `stringify_table`.\n'