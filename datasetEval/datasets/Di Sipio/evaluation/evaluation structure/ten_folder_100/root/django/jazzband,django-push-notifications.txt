b'django-push-notifications\n=========================\n.. image:: https://travis-ci.org/jazzband/django-push-notifications.svg?branch=master\n\t:target: https://travis-ci.org/jazzband/django-push-notifications\n\n.. image:: https://jazzband.co/static/img/badge.svg\n\t:target: https://jazzband.co/\n\t:alt: Jazzband\n\nA minimal Django app that implements Device models that can send messages through APNS, FCM/GCM and WNS.\n\nThe app implements three models: ``GCMDevice``, ``APNSDevice`` and ``WNSDevice``. Those models share the same attributes:\n - ``name`` (optional): A name for the device.\n - ``active`` (default True): A boolean that determines whether the device will be sent notifications.\n - ``user`` (optional): A foreign key to auth.User, if you wish to link the device to a specific user.\n - ``device_id`` (optional): A UUID for the device obtained from Android/iOS/Windows APIs, if you wish to uniquely identify it.\n - ``registration_id`` (required): The FCM/GCM registration id or the APNS token for the device.\n\n\nThe app also implements an admin panel, through which you can test single and bulk notifications. Select one or more\nFCM/GCM, APNS or WNS devices and in the action dropdown, select "Send test message" or "Send test message in bulk", accordingly.\nNote that sending a non-bulk test message to more than one device will just iterate over the devices and send multiple\nsingle messages.\nUPDATE_ON_DUPLICATE_REG_ID: Transform create of an existing Device (based on registration id) into a update. See below Update of device with duplicate registration ID for more details.\n\nDependencies\n------------\n- Python 2.7 or 3.4+\n- Django 1.11+\n- For the API module, Django REST Framework 3.7+ is required.\n- For WebPush (WP), pywebpush 1.3.0+ is required. py-vapid 1.3.0+ is required for generating the WebPush private key; however this\n  step does not need to occur on the application server.\n\nSetup\n-----\nYou can install the library directly from pypi using pip:\n\n.. code-block:: shell\n\n\t$ pip install django-push-notifications\n\n\nEdit your settings.py file:\n\n.. code-block:: python\n\n\tINSTALLED_APPS = (\n\t\t...\n\t\t"push_notifications"\n\t)\n\n\tPUSH_NOTIFICATIONS_SETTINGS = {\n\t\t"FCM_API_KEY": "[your api key]",\n\t\t"GCM_API_KEY": "[your api key]",\n\t\t"APNS_CERTIFICATE": "/path/to/your/certificate.pem",\n\t\t"APNS_TOPIC": "com.example.push_test",\n\t\t"WNS_PACKAGE_SECURITY_ID": "[your package security id, e.g: \'ms-app://e-3-4-6234...\']",\n\t\t"WNS_SECRET_KEY": "[your app secret key, e.g.: \'KDiejnLKDUWodsjmewuSZkk\']",\n\t\t"WP_PRIVATE_KEY": "/path/to/your/private.pem",\n\t\t"WP_CLAIMS": {\'sub\': "mailto: development@example.com"}\n\t}\n\n.. note::\n    If you need to support multiple mobile applications from a single Django application, see `Multiple Application Support <https://github.com/jazzband/django-push-notifications/wiki/Multiple-Application-Support>`_ for details.\n\t\n.. note::\n\tIf you are planning on running your project with ``APNS_USE_SANDBOX=True``, then make sure you have set the\n\t*development* certificate as your ``APNS_CERTIFICATE``. Otherwise the app will not be able to connect to the correct host. See settings_ for details.\n\nFor more information about how to generate certificates, see `docs/APNS <https://github.com/jazzband/django-push-notifications/blob/master/docs/APNS.rst>`_.\n\nYou can learn more about APNS certificates `here <https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/APNSOverview.html>`_.\n\nNative Django migrations are in use. ``manage.py migrate`` will install and migrate all models.\n\n.. _settings:\n\nSettings list\n-------------\nAll settings are contained in a ``PUSH_NOTIFICATIONS_SETTINGS`` dict.\n\nIn order to use FCM/GCM, you are required to include ``FCM_API_KEY`` or ``GCM_API_KEY``.\nFor APNS, you are required to include ``APNS_CERTIFICATE``.\nFor WNS, you need both the ``WNS_PACKAGE_SECURITY_KEY`` and the ``WNS_SECRET_KEY``.\n\n**General settings**\n\n- ``USER_MODEL``: Your user model of choice. Eg. ``myapp.User``. Defaults to ``settings.AUTH_USER_MODEL``.\n- ``UPDATE_ON_DUPLICATE_REG_ID``: Transform create of an existing Device (based on registration id) into a update. See below `Update of device with duplicate registration ID`_ for more details.\n\n**APNS settings**\n\n- ``APNS_CERTIFICATE``: Absolute path to your APNS certificate file. Certificates with passphrases are not supported. Read more about `Generation of an APNS PEM file <https://github.com/jazzband/django-push-notifications/blob/master/docs/APNS.rst>`_.\n- ``APNS_TOPIC``: The topic of the remote notification, which is typically the bundle ID for your app. If you omit this header and your APNs certificate does not specify multiple topics, the APNs server uses the certificate\xe2\x80\x99s Subject as the default topic.\n- ``APNS_USE_ALTERNATIVE_PORT``: Use port 2197 for APNS, instead of default port 443.\n- ``APNS_USE_SANDBOX``: Use \'api.development.push.apple.com\', instead of default host \'api.push.apple.com\'.\n\n**FCM/GCM settings**\n\n- ``FCM_API_KEY``: Your API key for Firebase Cloud Messaging.\n- ``FCM_POST_URL``: The full url that FCM notifications will be POSTed to. Defaults to https://fcm.googleapis.com/fcm/send.\n- ``FCM_MAX_RECIPIENTS``: The maximum amount of recipients that can be contained per bulk message. If the ``registration_ids`` list is larger than that number, multiple bulk messages will be sent. Defaults to 1000 (the maximum amount supported by FCM).\n- ``FCM_ERROR_TIMEOUT``: The timeout on FCM POSTs.\n- ``GCM_API_KEY``, ``GCM_POST_URL``, ``GCM_MAX_RECIPIENTS``, ``GCM_ERROR_TIMEOUT``: Same parameters for GCM\n\n**WNS settings**\n\n- ``WNS_PACKAGE_SECURITY_KEY``: TODO\n- ``WNS_SECRET_KEY``: TODO  \n\n**WP settings**\n\n- Install:\n\n.. code-block:: python\n\n\tpip install pywebpush\n\tpip install py-vapid  (Only for generating key)\n\n- Getting keys:\n\n\t- Create file (claim.json) like this:\n\n.. code-block:: bash\n\n\t{\n\t\t"sub": "mailto: development@example.com",\n\t\t"aud": "https://android.googleapis.com"\n\t}\n\n\t- Generate public and private keys:\n\n.. code-block:: bash\n\n\tvapid --sign claim.json\n\n\tNo private_key.pem file found.\n\tDo you want me to create one for you? (Y/n)Y\n\tDo you want me to create one for you? (Y/n)Y\n\tGenerating private_key.pem\n\tGenerating public_key.pem\n\tInclude the following headers in your request:\n\n\tCrypto-Key: p256ecdsa=BEFuGfKKEFp-kEBMxAIw7ng8HeH_QwnH5_h55ijKD4FRvgdJU1GVlDo8K5U5ak4cMZdQTUJlkA34llWF0xHya70\n\n\tAuthorization: WebPush eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL2FuZHJvaWQuZ29vZ2xlYXBpcy5jb20iLCJleHAiOiIxNTA4NDkwODM2Iiwic3ViIjoibWFpbHRvOiBkZXZlbG9wbWVudEBleGFtcGxlLmNvbSJ9.r5CYMs86X3JZ4AEs76pXY5PxsnEhIFJ-0ckbibmFHZuyzfIpf1ZGIJbSI7knA4ufu7Hm8RFfEg5wWN1Yf-dR2A\n\n\t- Generate client public key (applicationServerKey)\n\n.. code-block:: bash\n\n\tvapid --applicationServerKey\n\n\tApplication Server Key = BEFuGfKKEFp-kEBMxAIw7ng8HeH_QwnH5_h55ijKD4FRvgdJU1GVlDo8K5U5ak4cMZdQTUJlkA34llWF0xHya70\n\n\n- Configure settings:\n\n- ``WP_PRIVATE_KEY``: Absolute path to your private certificate file: os.path.join(BASE_DIR, "private_key.pem")\n- ``WP_CLAIMS``: Dictionary with the same sub info like claims file: {\'sub\': "mailto: development@example.com"}\n- ``WP_ERROR_TIMEOUT``: The timeout on WebPush POSTs. (Optional)\n- ``WP_POST_URL``: A dictionary (key per browser supported) with the full url that webpush notifications will be POSTed to. (Optional)\n\n\n- Configure client (javascript):\n\n.. code-block:: javascript\n\n\t// Utils functions:\n\n\tfunction urlBase64ToUint8Array (base64String) {\n\t\tvar padding = \'=\'.repeat((4 - base64String.length % 4) % 4)\n\t\tvar base64 = (base64String + padding)\n\t\t\t.replace(/\\-/g, \'+\')\n\t\t\t.replace(/_/g, \'/\')\n\n\t\tvar rawData = window.atob(base64)\n\t\tvar outputArray = new Uint8Array(rawData.length)\n\n\t\tfor (var i = 0; i < rawData.length; ++i) {\n\t\t\toutputArray[i] = rawData.charCodeAt(i)\n\t\t}\n\t\treturn outputArray;\n\t}\n\tfunction loadVersionBrowser (userAgent) {\n\t\tvar ua = userAgent, tem, M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\\/))\\/?\\s*(\\d+)/i) || [];\n\t\tif (/trident/i.test(M[1])) {\n\t\t\ttem = /\\brv[ :]+(\\d+)/g.exec(ua) || [];\n\t\t\treturn {name: \'IE\', version: (tem[1] || \'\')};\n\t\t}\n\t\tif (M[1] === \'Chrome\') {\n\t\t\ttem = ua.match(/\\bOPR\\/(\\d+)/);\n\t\t\tif (tem != null) {\n\t\t\t\treturn {name: \'Opera\', version: tem[1]};\n\t\t\t}\n\t\t}\n\t\tM = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, \'-?\'];\n\t\tif ((tem = ua.match(/version\\/(\\d+)/i)) != null) {\n\t\t\tM.splice(1, 1, tem[1]);\n\t\t}\n\t\treturn {\n\t\t\tname: M[0],\n\t\t\tversion: M[1]\n\t\t};\n\t};\n\tvar applicationServerKey = "BEFuGfKKEFp-kEBMxAIw7ng8HeH_QwnH5_h55ijKD4FRvgdJU1GVlDo8K5U5ak4cMZdQTUJlkA34llWF0xHya70";\n\t....\n\n\t// In your ready listener\n\tif (\'serviceWorker\' in navigator) {\n\t\t// The service worker has to store in the root of the app\n\t\t// http://stackoverflow.com/questions/29874068/navigator-serviceworker-is-never-ready\n\t\tvar browser = loadVersionBrowser();\n\t\tnavigator.serviceWorker.register(\'navigatorPush.service.js?version=1.0.0\').then(function (reg) {\n\t\t\treg.pushManager.subscribe({\n\t\t\t\tuserVisibleOnly: true,\n\t\t\t\tapplicationServerKey: urlBase64ToUint8Array(applicationServerKey)\n\t\t\t}).then(function (sub) {\n\t\t\t\tvar endpointParts = sub.endpoint.split(\'/\');\n\t\t\t\tvar registration_id = endpointParts[endpointParts.length - 1];\n\t\t\t\tvar data = {\n\t\t\t\t\t\'browser\': browser.name.toUpperCase(),\n\t\t\t\t\t\'p256dh\': btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey(\'p256dh\')))),\n\t\t\t\t\t\'auth\': btoa(String.fromCharCode.apply(null, new Uint8Array(sub.getKey(\'auth\')))),\n\t\t\t\t\t\'name\': \'XXXXX\',\n\t\t\t\t\t\'registration_id\': registration_id\n\t\t\t\t};\n\t\t\t\trequestPOSTToServer(data);\n\t\t\t})\n\t\t}).catch(function (err) {\n\t\t\tconsole.log(\':^(\', err);\n\t\t});\n\n\n\n\n\t// Example navigatorPush.service.js file\n\n\tvar getTitle = function (title) {\n\t\tif (title === "") {\n\t\t\ttitle = "TITLE DEFAULT";\n\t\t}\n\t\treturn title;\n\t};\n\tvar getNotificationOptions = function (message, message_tag) {\n\t\tvar options = {\n\t\t\tbody: message,\n\t\t\ticon: \'/img/icon_120.png\',\n\t\t\ttag: message_tag,\n\t\t\tvibrate: [200, 100, 200, 100, 200, 100, 200]\n\t\t};\n\t\treturn options;\n\t};\n\n\tself.addEventListener(\'install\', function (event) {\n\t\tself.skipWaiting();\n\t});\n\n\tself.addEventListener(\'push\', function(event) {\n\t\ttry {\n\t\t\t// Push is a JSON\n\t\t\tvar response_json = event.data.json();\n\t\t\tvar title = response_json.title;\n\t\t\tvar message = response_json.message;\n\t\t\tvar message_tag = response_json.tag;\n\t\t} catch (err) {\n\t\t\t// Push is a simple text\n\t\t\tvar title = "";\n\t\t\tvar message = event.data.text();\n\t\t\tvar message_tag = "";\n\t\t}\n\t\tself.registration.showNotification(getTitle(title), getNotificationOptions(message, message_tag));\n\t\t// Optional: Comunicating with our js application. Send a signal\n\t\tself.clients.matchAll({includeUncontrolled: true, type: \'window\'}).then(function (clients) {\n\t\t\tclients.forEach(function (client) {\n\t\t\t\tclient.postMessage({\n\t\t\t\t\t"data": message_tag,\n\t\t\t\t\t"data_title": title,\n\t\t\t\t\t"data_body": message});\n\t\t\t\t});\n\t\t});\n\t});\n\n\t// Optional: Added to that the browser opens when you click on the notification push web.\n\tself.addEventListener(\'notificationclick\', function(event) {\n\t\t// Android doesn\'t close the notification when you click it\n\t\t// See http://crbug.com/463146\n\t\tevent.notification.close();\n\t\t// Check if there\'s already a tab open with this URL.\n\t\t// If yes: focus on the tab.\n\t\t// If no: open a tab with the URL.\n\t\tevent.waitUntil(clients.matchAll({type: \'window\', includeUncontrolled: true}).then(function(windowClients) {\n\t\t\t\tfor (var i = 0; i < windowClients.length; i++) {\n\t\t\t\t\tvar client = windowClients[i];\n\t\t\t\t\tif (\'focus\' in client) {\n\t\t\t\t\t\treturn client.focus();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t});\n\n\n\nSending messages\n----------------\nFCM/GCM and APNS services have slightly different semantics. The app tries to offer a common interface for both when using the models.\n\n.. code-block:: python\n\n\tfrom push_notifications.models import APNSDevice, GCMDevice\n\n\tdevice = GCMDevice.objects.get(registration_id=gcm_reg_id)\n\t# The first argument will be sent as "message" to the intent extras Bundle\n\t# Retrieve it with intent.getExtras().getString("message")\n\tdevice.send_message("You\'ve got mail")\n\t# If you want to customize, send an extra dict and a None message.\n\t# the extras dict will be mapped into the intent extras Bundle.\n\t# For dicts where all values are keys this will be sent as url parameters,\n\t# but for more complex nested collections the extras dict will be sent via\n\t# the bulk message api.\n\tdevice.send_message(None, extra={"foo": "bar"})\n\n\tdevice = APNSDevice.objects.get(registration_id=apns_token)\n\tdevice.send_message("You\'ve got mail") # Alert message may only be sent as text.\n\tdevice.send_message(None, badge=5) # No alerts but with badge.\n\tdevice.send_message(None, content_available=1, extra={"foo": "bar"}) # Silent message with custom data.\n\t# alert with title and body.\n\tdevice.send_message(message={"title" : "Game Request", "body" : "Bob wants to play poker"}, extra={"foo": "bar"})\n\tdevice.send_message("Hello again", thread_id="123", extra={"foo": "bar"}) # set thread-id to allow iOS to merge notifications\n\n.. note::\n\tAPNS does not support sending payloads that exceed 2048 bytes (increased from 256 in 2014).\n\tThe message is only one part of the payload, if\n\tonce constructed the payload exceeds the maximum size, an ``APNSDataOverflow`` exception will be raised before anything is sent.\n\tReference: `Apple Payload Documentation <https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/CreatingtheNotificationPayload.html#//apple_ref/doc/uid/TP40008194-CH10-SW1>`_\n\nSending messages in bulk\n------------------------\n.. code-block:: python\n\n\tfrom push_notifications.models import APNSDevice, GCMDevice\n\n\tdevices = GCMDevice.objects.filter(user__first_name="James")\n\tdevices.send_message("Happy name day!")\n\nSending messages in bulk makes use of the bulk mechanics offered by GCM and APNS. It is almost always preferable to send\nbulk notifications instead of single ones.\n\nIt\'s also possible to pass badge parameter as a function which accepts token parameter in order to set different badge\nvalue per user. Assuming User model has a method get_badge returning badge count for a user:\n\n.. code-block:: python\n\n\tdevices.send_message(\n\t\t"Happy name day!",\n\t\tbadge=lambda token: APNSDevice.objects.get(registration_id=token).user.get_badge()\n\t)\n\nFirebase vs Google Cloud Messaging\n----------------------------------\n\n``django-push-notifications`` supports both Google Cloud Messaging and Firebase Cloud Messaging (which is now the officially supported messaging platform from Google). When registering a device, you must pass the ``cloud_message_type`` parameter to set the cloud type that matches the device needs.\nThis is currently defaulting to ``\'GCM\'``, but may change to ``\'FCM\'`` at some point. You are encouraged to use the `officially supported library <https://developers.google.com/cloud-messaging/faq>`_.\n\nWhen using FCM, ``django-push-notifications`` will automatically use the `notification and data messages format <https://firebase.google.com/docs/cloud-messaging/concept-options#notifications_and_data_messages>`_ to be conveniently handled by Firebase devices. You may want to check the payload to see if it matches your needs, and review your notification statuses in `FCM Diagnostic console <https://support.google.com/googleplay/android-developer/answer/2663268?hl=en>`_.\n\n\n.. code-block:: python\n\n\t# Create a FCM device\n\tfcm_device = GCMDevice.objects.create(registration_id="token", cloud_message_type="FCM", user=the_user)\n\n\t# Send a notification message\n\tfcm_device.send_message("This is a message")\n\n\t# Send a notification message with additionnal payload\n\tfcm_device.send_message("This is a enriched message", extra={"title": "Notification title", "icon": "icon_ressource"})\n\n\t# Send a notification message with additionnal payload (alternative syntax)\n\tfcm_device.send_message("This is a enriched message", title="Notification title", badge=6)\n\n\t# Send a notification message with extra data\n\tfcm_device.send_message("This is a message with data", extra={"other": "content", "misc": "data"})\n\n\t# Send a notification message with options\n\tfcm_device.send_message("This is a message", time_to_live=3600)\n\n\t# Send a data message only\n\tfcm_device.send_message(None, extra={"other": "content", "misc": "data"})\n\nYou can disable this default behaviour by setting ``use_fcm_notifications`` to ``False``.\n\n.. code-block:: python\n\n\tfcm_device = GCMDevice.objects.create(registration_id="token", cloud_message_type="FCM", user=the_user)\n\n\t# Send a data message with classic format\n\tfcm_device.send_message("This is a message", use_fcm_notifications=False)\n\n\nSending FCM/GCM messages to topic members\n-----------------------------------------\nFCM/GCM topic messaging allows your app server to send a message to multiple devices that have opted in to a particular topic. Based on the publish/subscribe model, topic messaging supports unlimited subscriptions per app. Developers can choose any topic name that matches the regular expression, "/topics/[a-zA-Z0-9-_.~%]+".\nNote: gcm_send_bulk_message must be used when sending messages to topic subscribers, and setting the first param to any value other than None will result in a 400 Http error.\n\n.. code-block:: python\n\n\tfrom push_notifications.gcm import send_message\n\n        # First param is "None" because no Registration_id is needed, the message will be sent to all devices subscribed to the topic.\n        send_message(None, {"body": "Hello members of my_topic!"}, to="/topics/my_topic")\n\nReference: `FCM Documentation <https://firebase.google.com/docs/cloud-messaging/android/topic-messaging>`_\n\nExceptions\n----------\n\n- ``NotificationError(Exception)``: Base exception for all notification-related errors.\n- ``gcm.GCMError(NotificationError)``: An error was returned by GCM. This is never raised when using bulk notifications.\n- ``apns.APNSError(NotificationError)``: Something went wrong upon sending APNS notifications.\n- ``apns.APNSDataOverflow(APNSError)``: The APNS payload exceeds its maximum size and cannot be sent.\n\nDjango REST Framework (DRF) support\n-----------------------------------\n\nViewSets are available for both APNS and GCM devices in two permission flavors:\n\n- ``APNSDeviceViewSet`` and ``GCMDeviceViewSet``\n\n\t- Permissions as specified in settings (``AllowAny`` by default, which is not recommended)\n\t- A device may be registered without associating it with a user\n\n- ``APNSDeviceAuthorizedViewSet`` and ``GCMDeviceAuthorizedViewSet``\n\n\t- Permissions are ``IsAuthenticated`` and custom permission ``IsOwner``, which will only allow the ``request.user`` to get and update devices that belong to that user\n\t- Requires a user to be authenticated, so all devices will be associated with a user\n\nWhen creating an ``APNSDevice``, the ``registration_id`` is validated to be a 64-character or 200-character hexadecimal string. Since 2016, device tokens are to be increased from 32 bytes to 100 bytes.\n\nRoutes can be added one of two ways:\n\n- Routers_ (include all views)\n.. _Routers: http://www.django-rest-framework.org/tutorial/6-viewsets-and-routers#using-routers\n\n::\n\n\tfrom push_notifications.api.rest_framework import APNSDeviceAuthorizedViewSet, GCMDeviceAuthorizedViewSet\n\tfrom rest_framework.routers import DefaultRouter\n\n\trouter = DefaultRouter()\n\trouter.register(r\'device/apns\', APNSDeviceAuthorizedViewSet)\n\trouter.register(r\'device/gcm\', GCMDeviceAuthorizedViewSet)\n\n\turlpatterns = patterns(\'\',\n\t\t# URLs will show up at <api_root>/device/apns\n\t\turl(r\'^\', include(router.urls)),\n\t\t# ...\n\t)\n\n- Using as_view_ (specify which views to include)\n.. _as_view: http://www.django-rest-framework.org/tutorial/6-viewsets-and-routers#binding-viewsets-to-urls-explicitly\n\n::\n\n\tfrom push_notifications.api.rest_framework import APNSDeviceAuthorizedViewSet\n\n\turlpatterns = patterns(\'\',\n\t\t# Only allow creation of devices by authenticated users\n\t\turl(r\'^device/apns/?$\', APNSDeviceAuthorizedViewSet.as_view({\'post\': \'create\'}), name=\'create_apns_device\'),\n\t\t# ...\n\t)\n\nUpdate of device with duplicate registration ID\n-----------------------------------------------\n\nThe DRF viewset enforce the uniqueness of the registration ID. In same use case it\nmay cause issue: If an already registered mobile change its user and it will\nfail to register because the registration ID already exist.\n\nWhen option ``UPDATE_ON_DUPLICATE_REG_ID`` is set to True, then any creation of\ndevice with an already existing registration ID will be transformed into an update.\n\nThe ``UPDATE_ON_DUPLICATE_REG_ID`` only works with DRF.\n\n\n.. [1] Any devices which are not selected, but are not receiving notifications will not be deactivated on a subsequent call to "prune devices" unless another attempt to send a message to the device fails after the call to the feedback service.\n'