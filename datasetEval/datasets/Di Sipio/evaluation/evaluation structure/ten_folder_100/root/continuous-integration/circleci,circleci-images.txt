b'# CircleCI Images [![CircleCI Build Status](https://circleci.com/gh/circleci/circleci-images.svg?style=shield)](https://circleci.com/gh/circleci/circleci-images) [![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://raw.githubusercontent.com/circleci/circleci-docs/master/LICENSE) [![CircleCI Community](https://img.shields.io/badge/community-CircleCI%20Discuss-343434.svg)](https://discuss.circleci.com)\n\n## Stay informed about CircleCI image changes/announcements\nAs part of regular maintenance, changes are occassionally made to various images, from updating images\' contents, to changing how image variants are tagged. With the exception of bugfixes or security patches, these changes will always be announced in advance. Changes are posted in the Announcements section of CircleCI Discuss; relevant posts will always have a `convenience-images` tag:\n\n- https://discuss.circleci.com/c/announcements\n- https://discuss.circleci.com/tags/convenience-images\n\nBy creating a Discuss account, you can subscribe to these posts, in order to receive notifications via email:\n\nhttps://discuss.circleci.com\n\n## Overview\nA set of convenience images that work better in context of CI. This repo contains the official set of images that CircleCI maintains. It contains language as well as services images:\n\n* Language images (e.g. `ruby`, `python`, `node`) are images targeted for common programming languages with the common tools pre-installed. They primarily extend the [official images](#official-images) and install additional tools (e.g. browsers) that we find very useful in context of CI.\n* Service images (e.g. `mongo`, `postgres`) are images that have the services pre-configured with development/CI mode. They also primarily extend the corresponding [official images](#official-images) but with sensible development/CI defaults (e.g. disable production checks, default to nojournal to speed up tests)\n\n## Official images\nWe extend [Docker Official Repositories](https://docs.docker.com/docker-hub/official_repos/) in order to start with the same consistent set of images.\n\nThis allows us to make things more standardized. From our scripts for checking for updates, the type of OS on the base image, and so forth. We can recommend using `apt-get install` rather than documenting various constraints depending on which stack you\'re using.\n\nThe official images on Docker Hub are curated by Docker as their way to provide convenience images which address both development and production needs. Since Docker sponsors a dedicated team responsible for reviewing each of the official images, we can take advantage of the community maintaining them independently without trying to track all of the sources and building automations for each one. For now we can take a shortcut, without building this infrastructure.\n\nFinally, our convenience images are augmenting these official images, by adding some missing packages, that we install ourselves for common dependencies shared for the CI environment.\n\nAll of the official images on Docker Hub have an "_" for the username, for example:\nhttps://hub.docker.com/_/ruby\n\nYou can view all of the officially supported images here:\nhttps://hub.docker.com/explore/\n\nCircleCI supported images are here:\nhttps://hub.docker.com/r/circleci/\n\nTo view the Dockerfiles for CircleCI images, visit the [CircleCI-Public/circleci-dockerfiles](https://github.com/circleci-public/circleci-dockerfiles) repository.\n\n# How to add a bundle with images\nA bundle is a top-level subfolder in this repository (e.g. `postgres`).\n\nFor the image Dockerfiles, we use a WIP templating mechanism. Each bundle should contain a `generate-images` script for generating the Dockerfiles. You can use [`postgres/generate-images`](postgres/generate-images) and [`node/generate-images`](node/generate-images) for inspiration. The pattern is executable script of the following sample:\n\n\n```bash\n#!/bin/bash\n\n# the base image we should be tracking. It must be a Dockerhub official repo\nBASE_REPO=node\n\n# Specify the variants we need to publish.  Language stacks should have a\n# `browsers` variant to have an image with firefox/chrome pre-installed\nVARIANTS=(browsers)\n\n# By default, we don\'t build the alpine images, since they are typically not dev friendly\n# and makes our experience inconsistent.\n# However, it\'s reasonable for services to include the alpine image (e.g. psql)\n#\n# uncomment for services\n\n#INCLUDE_ALPINE=true\n\n# if the image needs some basic customizations, you can embed the Dockerfile\n# customizations by setting $IMAGE_CUSTOMIZATIONS. Like the following\n#\n\nIMAGE_CUSTOMIZATIONS=\'\nRUN apt-get update && apt-get install -y node\n\'\n\n# boilerplate\nsource ../shared/images/generate.sh\n```\n\nBy default, the script uses `./shared/images/Dockerfile-basic.template` template which is most appropriate for language based images. Language image variants (e.g. `-browsers` images that have language images with browsers installed) use the `./shared/images/Dockerfile-${variant}.template`.\n\nService image should have their own template. The template can be kept in `<bundle-name>/resources/Dockerfile-basic.template`\xe2\x80\x94like [`./mongo/resources/Dockerfile-basic.template`](./mongo/resources/Dockerfile-basic.template).\n\nTo build all images\xe2\x80\x94push a commit with `[build-images]` text appearing in the commit message.\n\nAlso, add the bundle name to in Makefile `BUNDLES` field.\n\n\n## Development\n*This section is a work in progress*\n\nThis project\'s build system is managed with `Make`. It generates Dockerfiles and builds images based off of upstream Docker Library base images, variant images that upstream may have, variant images that CircleCI provides, as well as tools common for testing projects in various programming languages.\n\n### Generate Dockerfiles\nUse `make <base-image>/generate_images` to generate of all of the Dockerfiles for a specific base image. For example, to generate all of the Dockerfils for the `circleci/golang` image, you would run `make golang/generate_images`.\n\nUse `make images` to generate Dockerfiles for **every** base image we have. This process is fairly fast with decent Internet connection.\n\nOnce generated, Dockerfiles for each image will be in the images folder for that base image (e.g. ./python/images/).\n\n### Build images\n\n#### Build a single Dockerfile\nYou can build a single image, with a throway name and the `docker build` command.\n\n`docker build -t <throw-away-img-name> <directory-containing-dockerfile>`\n\nHere\'s how you would build the "regular" Go v1.11 CircleCI image:\n\n`docker build -t test/golang:latest golang/images/1.11.0/`\n\nThe image name and tag (`test/golang:latest`) can be whatever name you want, it\'s just for local dev and can be deleted.\n\n#### Build all Dockerfiles for a base image\nUse `make <base-image>/publish_images` to `docker build` all of the Dockerfiles for that base image. There\'s a couple things to note here:\n\n1. Each base image has **a lot** of images. Building them will end up taking several GBs of disk space, and can take quite a while to run. Make sure you want to do this before you do it.\n1. The build script will also try to run `docker push`. If you don\'t work for CircleCI, this will fail and that\'s okay. It\'s safe to ignore.\n\n#### Build all Dockerfiles for every base image\nDon\'t do it. If you have an Ultrabook laptop, it won\'t be happy. If you really want to do it, look at the `Makefile`.\n\n### Testing\nThere is automated testing for every variant of every image!\n\nTests run with [dgoss](https://github.com/aelsabbahy/goss/tree/master/extras/dgoss).\n\nTests are platform-specific (e.g., PHP and Android have their own distinct sets of tests)\xe2\x80\x94see the `goss.yaml` file in each image directory.\n\nThe testing logic is currently in `shared/images/build.sh`, as it is nestled between the existing automated `docker build` and `docker push` functionality. In short, for a particular variant of an image, we make a copy of its Dockerfile, append some Dockerfile syntax to add a custom entrypoint that allows us to execute tests against the running container, build a special, temporary version of the image (added time is insignificant, as most of the Dockerfile steps are cached), and run the tests.\n\nA particular variant is pushed to Docker Hub only if tests pass; if not, the same process restarts for the next variant, etc.\n\nTests run twice: once for `stdout`, and again, with JUnit formatting, for `store_test_results` (after some post-processing [due to how goss outputs JUnit XML](https://github.com/aelsabbahy/goss/blob/master/outputs/junit.go)...). With test runtimes at essentially zero seconds, running everything twice has a negligible effect on job runtime.\n\nBy default, a given branch will push images to the [`ccitest` Docker Hub org](https://hub.docker.com/r/ccitest), with the branch name appended to all image tags. Once a given branch is merged to staging, staging will then push images to the [`ccistaging` Docker Hub org](https://hub.docker.com/r/ccistaging). Finally, we can rebuild those images on the [`circleci` Docker Hub org](https://hub.docker.com/r/circleci) by merging changes from `staging` into the `master` branch. See below for note on forked pull requests.\n\n#### Remaining work\n- Tests are very bare-bones right now and could use image-specific additions\xe2\x80\x94please add things to each image\'s `goss.yml` file and the existing logic will take care of the rest!\n- The testing code is spread across the repository and is a bit confusing; some refactoring would help\n\n## Limitations\n* We welcome and appreciate contributions (issues, PRs) from the community! However, for security reasons, forked pull requests will not push Dockerfiles to [CircleCI-Public/circleci-dockerfiles](https://github.com/CircleCI-Public/circleci-dockerfiles), example images to [CircleCI-Public/example-images](https://github.com/CircleCI-Public/example-images), or images to Docker Hub. All Dockerfiles, example image Dockerfiles/READMEs, and images will generate/build in forked PR jobs as expected; however, nothing will be pushed to external CircleCI resources.\n* The template language is a WIP\xe2\x80\x94it only supports `{{BASE_IMAGE}}` template. We should extend this.\n* We cannot support Oracle JDK for licensing reasons. See [Oracle\'s Binary Code License Agreement for the Java SE Platform](http://oracle.com/technetwork/java/javase/terms/license/index.html) and [Stack Exchange: Is there no Oracle JDK for docker?](https://devops.stackexchange.com/questions/433/is-there-no-oracle-jdk-for-docker) for details.\n\n\n## Licensing & Usage\n\nThe `circleci-images` repository is licensed under The MIT License.\nSee [LICENSE](https://github.com/circleci/circleci-images/blob/master/LICENSE) for the full license text.\n\nThe Docker images generated from this repository are designed to work with the CircleCI `docker` executor.\nWhile you may use the images anywhere Docker is available, your experience may vary.\n'