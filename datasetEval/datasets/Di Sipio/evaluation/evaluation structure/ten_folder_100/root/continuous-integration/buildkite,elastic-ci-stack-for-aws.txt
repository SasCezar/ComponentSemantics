b'<h1><img alt="Elastic CI Stack for AWS" src="https://cdn.rawgit.com/buildkite/elastic-ci-stack-for-aws/master/images/banner.png"></h1>\n\n![Build status](https://badge.buildkite.com/d178ab942e2f606a83e79847704648437d82a9c5fdb434b7ae.svg?branch=master)\n\nThe Buildkite Elastic CI Stack gives you a private, autoscaling [Buildkite Agent](https://buildkite.com/docs/agent) cluster. Use it to parallelize legacy tests across hundreds of nodes, run tests and deployments for all your Linux-based services and apps, or run AWS ops tasks.\n\n**For documentation on a [release](https://github.com/buildkite/elastic-ci-stack-for-aws/releases), such as [the latest stable release](https://github.com/buildkite/elastic-ci-stack-for-aws/releases/latest), please see its _Documentation_ section.**\n\nFeatures:\n\n- All major AWS regions\n- Configurable instance size\n- Configurable number of buildkite agents per instance\n- Configurable spot instance bid price\n- Configurable auto-scaling based on build activity\n- Docker and Docker Compose support\n- Per-pipeline S3 secret storage (with SSE encryption support)\n- Docker Registry push/pull support\n- CloudWatch logs for system and buildkite agent events\n- CloudWatch metrics from the Buildkite API\n- Support for stable, beta or edge Buildkite Agent releases\n- Create as many instances of the stack as you need\n- Rolling updates to stack instances to reduce interruption\n\n## Contents\n\n<!-- toc -->\n\n- [Getting Started](#getting-started)\n- [Build Secrets](#build-secrets)\n- [What\xe2\x80\x99s On Each Machine?](#whats-on-each-machine)\n- [What Type of Builds Does This Support?](#what-type-of-builds-does-this-support)\n- [Multiple Instances of the Stack](#multiple-instances-of-the-stack)\n- [Autoscaling](#autoscaling)\n- [Terminating the instance after job is complete](#terminating-the-instance-after-job-is-complete)\n- [Docker Registry Support](#docker-registry-support)\n- [Versions](#versions)\n- [Updating Your Stack](#updating-your-stack)\n- [CloudWatch Metrics](#cloudwatch-metrics)\n- [Reading Instance and Agent Logs](#reading-instance-and-agent-logs)\n- [Customizing Instances with a Bootstrap Script](#customizing-instances-with-a-bootstrap-script)\n- [Optimizing for Slow Docker Builds](#optimizing-for-slow-docker-builds)\n- [Security](#security)\n- [Development](#development)\n- [Questions and Support](#questions-and-support)\n- [Licence](#licence)\n\n<!-- tocstop -->\n\n## Getting Started\n\nSee the [Elastic CI Stack for AWS guide](https://buildkite.com/docs/guides/elastic-ci-stack-aws) for a step-by-step guide, or jump straight in:\n\n[![Launch AWS Stack](https://cdn.rawgit.com/buildkite/cloudformation-launch-stack-button-svg/master/launch-stack.svg)](https://console.aws.amazon.com/cloudformation/home#/stacks/new?stackName=buildkite&templateURL=https://s3.amazonaws.com/buildkite-aws-stack/latest/aws-stack.yml)\n\nCurrent release is ![](https://img.shields.io/github/release/buildkite/elastic-ci-stack-for-aws.svg). See [Releases](https://github.com/buildkite/elastic-ci-stack-for-aws/releases) for older releases, or [Versions](#versions) for development version\n\n> Although the stack will create it\'s own VPC by default, we highly recommend following best practice by setting up a separate development AWS account and using role switching and consolidated billing\xe2\x80\x94see the [Delegate Access Across AWS Accounts tutorial](http://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html) for more information.\n\nIf you\'d like to use the [AWS CLI](https://aws.amazon.com/cli/), download [`config.json.example`](config.json.example), rename it to `config.json`, and then run the below command:\n\n```bash\naws cloudformation create-stack \\\n  --output text \\\n  --stack-name buildkite \\\n  --template-url "https://s3.amazonaws.com/buildkite-aws-stack/latest/aws-stack.yml" \\\n  --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \\\n  --parameters $(cat config.json)\n```\n\n## Build Secrets\n\nThe stack will have created an S3 bucket for you (or used the one you provided as the `SecretsBucket` parameter). This will be where the agent will fetch your SSH private keys for source control, and environment hooks to provide other secrets to your builds.\n\nThe following s3 objects are downloaded and processed:\n\n* `/env` - An [agent environment hook](https://buildkite.com/docs/agent/hooks)\n* `/private_ssh_key` - A private key that is added to ssh-agent for your builds\n* `/git-credentials` - A [git-credentials](https://git-scm.com/docs/git-credential-store#_storage_format) file for git over https\n* `/{pipeline-slug}/env` - An [agent environment hook](https://buildkite.com/docs/agent/hooks), specific to a pipeline\n* `/{pipeline-slug}/private_ssh_key` - A private key that is added to ssh-agent for your builds, specific to the pipeline\n* `/{pipeline-slug}/git-credentials` - A [git-credentials](https://git-scm.com/docs/git-credential-store#_storage_format) file for git over https, specific to a pipeline\n\nThese files are encrypted using [Amazon\'s KMS Service](https://aws.amazon.com/kms/). See the [Security](#security) section for more details.\n\nHere\'s an example that shows how to generate a private SSH key, and upload it with KMS encryption to an S3 bucket:\n\n```bash\n# generate a deploy key for your project\nssh-keygen -t rsa -b 4096 -f id_rsa_buildkite\npbcopy < id_rsa_buildkite.pub # paste this into your github deploy key\n\naws s3 cp --acl private --sse aws:kms id_rsa_buildkite "s3://${SecretsBucket}/private_ssh_key"\n```\n\nIf you want to set secrets that your build can access, create a file that sets environment variables and upload it:\n\n```bash\necho "export MY_ENV_VAR=something secret" > myenv\naws s3 cp --acl private --sse aws:kms myenv "s3://${SecretsBucket}/env"\nrm myenv\n```\n\n**Note: Currently only using the default KMS key for s3 can be used, follow [#235](https://github.com/buildkite/elastic-ci-stack-for-aws/issues/235) for progress on using specific KMS keys**\n\nIf you really want to store your secrets unencrypted, you can disable it entirely with `BUILDKITE_USE_KMS=false`.\n\n## What\xe2\x80\x99s On Each Machine?\n\n* [Amazon Linux 2 LTS](https://aws.amazon.com/amazon-linux-2/)\n* [Buildkite Agent v3.16.0](https://buildkite.com/docs/agent)\n* [Docker 19.03.2](https://www.docker.com)\n* [Docker Compose 1.24.1](https://docs.docker.com/compose/)\n* [aws-cli](https://aws.amazon.com/cli/) - useful for performing any ops-related tasks\n* [jq](https://stedolan.github.io/jq/) - useful for manipulating JSON responses from cli tools such as aws-cli or the Buildkite API\n\n## What Type of Builds Does This Support?\n\nThis stack is designed to run your builds in a share-nothing pattern similar to the [12 factor application principals](http://12factor.net):\n\n* Each project should encapsulate it\'s dependencies via Docker and Docker Compose\n* Build pipeline steps should assume no state on the machine (and instead rely on [build meta-data](https://buildkite.com/docs/guides/build-meta-data), [build artifacts](https://buildkite.com/docs/guides/artifacts) or S3)\n* Secrets are configured via environment variables exposed using the S3 secrets bucket\n\nBy following these simple conventions you get a scaleable, repeatable and source-controlled CI environment that any team within your organization can use.\n\n## Multiple Instances of the Stack\n\nIf you need to different instances sizes and scaling characteristics between pipelines, you can create multiple stack. Each can run on a different [Agent Queue](https://buildkite.com/docs/agent/queues), with it\'s own configuration, or even in a different AWS account.\n\nExamples:\n\n* A `docker-builders` stack that provides always-on workers with hot docker caches (see [Optimizing for Slow Docker Builds](#optimizing-for-slow-docker-builds))\n* A `pipeline-uploaders` stack with tiny, always-on instances for lightning fast `buildkite-agent pipeline upload` jobs.\n* A `deploy` stack with added credentials and permissions specifically for deployment.\n\n## Autoscaling\n\nIf you have configured `MinSize` < `MaxSize`, the stack will automatically scale up and down based on the number of scheduled jobs.\n\nThis means you can scale down to zero when idle, which means you can use larger instances for the same cost.\n\nMetrics are collected with a Lambda function, polling every minute.\n\n## Terminating the instance after job is complete\n\nYou may set `BuildkiteTerminateInstanceAfterJob` to `true` to force the instance to terminate after it completes a job. Setting this value to `true` tells the stack to enable `disconnect-after-job` in the `buildkite-agent.cfg` file.\n\nWhile not enforced, it is highly recommended you also set your `AgentsPerInstance` value to `1`.\n\nWe strongly encourage you to find an alternative to this setting if at all possible. The turn around time for replacing these instances is currently slow (5-10 minutes depending on other stack configuration settings). If you need single use jobs, we suggest looking at our container plugins like `docker`, `docker-compose`, and `ecs`, all which can be found [here](https://buildkite.com/plugins).\n\n## Docker Registry Support\n\nIf you want to push or pull from registries such as [Docker Hub](https://hub.docker.com/) or [Quay](https://quay.io/) you can use the `environment` hook in your secrets bucket to export the following environment variables:\n\n* `DOCKER_LOGIN_USER="the-user-name"`\n* `DOCKER_LOGIN_PASSWORD="the-password"`\n* `DOCKER_LOGIN_SERVER=""` - optional. By default it will log into Docker Hub\n\nSetting these will perform a `docker login` before each pipeline step is run, allowing you to `docker push` to them from within your build scripts.\n\nIf you are using [Amazon ECR](https://aws.amazon.com/ecr/) you can set the `ECRAccessPolicy` parameter to the stack to either `readonly`, `poweruser`, or `full` depending on [the access level you want](http://docs.aws.amazon.com/AmazonECR/latest/userguide/ecr_managed_policies.html) your builds to have\n\nYou can disable this in individual pipelines by setting `AWS_ECR_LOGIN=false`.\n\nIf you want to login to an ECR server on another AWS account, you can set `AWS_ECR_LOGIN_REGISTRY_IDS="id1,id2,id3"`.\n\nThe AWS ECR options are powered by an embedded version of the [ECR plugin](https://github.com/buildkite-plugins/ecr-buildkite-plugin), so if you require options that aren\'t listed here, you can disable the embedded version as above and call the plugin directly. See [it\'s README](https://github.com/buildkite-plugins/ecr-buildkite-plugin) for more examples (requires Agent v3.x).\n\n## Versions\n\nWe recommend running the latest release, which is available at `https://s3.amazonaws.com/buildkite-aws-stack/aws-stack.yml`, or on the [releases page](https://github.com/buildkite/elastic-ci-stack-for-aws/releases).\n\nThe latest build of the stack is published to `https://s3.amazonaws.com/buildkite-aws-stack/master/aws-stack.yml`, along with a version for each commit in the form of `https://s3.amazonaws.com/buildkite-aws-stack/master/${COMMIT}.aws-stack.yml`.\n\nBranches are published in the form of `https://s3.amazonaws.com/buildkite-aws-stack/${BRANCH}/aws-stack.yml`.\n\n## Updating Your Stack\n\nTo update your stack to the latest version use CloudFormation\xe2\x80\x99s stack update tools with one of the urls in the [Versions](#versions) section.\n\nPrior to updating, it\'s a good idea to set the desired instance size on the AutoscalingGroup to 0 manually.\n\n## CloudWatch Metrics\n\nMetrics are calculated every minute from the Buildkite API using a lambda function.\n\n<img width="544" alt="cloudwatch" src="https://cloud.githubusercontent.com/assets/153/16836158/85abdbc6-49ff-11e6-814c-eaf2400e8333.png">\n\nYou\xe2\x80\x99ll find the stack\xe2\x80\x99s metrics under "Custom Metrics > Buildkite" within CloudWatch.\n\n## Reading Instance and Agent Logs\n\nEach instance streams both system messages and Buildkite Agent logs to CloudWatch Logs under two log groups:\n\n* `/var/log/messages` - System logs\n* `/var/log/buildkite-agent.log` - Buildkite Agent logs\n* `/var/log/docker` - Docker daemon logs\n* `/var/log/elastic-stack.log` - Boot process logs\n\nWithin each stream the logs are grouped by instance id.\n\nTo debug an agent first find the instance id from the agent in Buildkite, head to your [CloudWatch Logs Dashboard](https://console.aws.amazon.com/cloudwatch/home?#logs:), choose either the system or Buildkite Agent log group, and then search for the instance id in the list of log streams.\n\n## Customizing Instances with a Bootstrap Script\n\nYou can customize your stack\xe2\x80\x99s instances by using the `BootstrapScriptUrl` stack parameter to run a bash script on instance boot. To set up a bootstrap script, create an S3 bucket with the script, and set the `BootstrapScriptUrl` parameter, for example `s3://my_bucket_name/my_bootstrap.sh`.\n\nIf the file is private, you\'ll also need to create an IAM policy to allow the instances to read the file, for example:\n\n```json\n{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": [\n        "s3:GetObject",\n      ],\n      "Resource": ["arn:aws:s3:::my_bucket_name/my_bootstrap.sh"]\n    }\n  ]\n}\n```\n\nOnce you\xe2\x80\x99ve created the policy, you must specify the policy\xe2\x80\x99s ARN in the `ManagedPolicyARN` stack parameter.\n\n## Optimizing for Slow Docker Builds\n\nFor large legacy applications the Docker build process might take a long time on new instances. For these cases it\xe2\x80\x99s recommended to create an optimized "builder" stack which doesn\'t scale down, keeps a warm docker cache and is responsible for building and pushing the application to Docker Hub before running the parallel build jobs across your normal CI stack.\n\nAn example of how to set this up:\n\n1. Create a Docker Hub repository for pushing images to\n1. Update the pipeline\xe2\x80\x99s `env` hook in your secrets bucket to perform a `docker login`\n1. Create a builder stack with its own queue (i.e. `elastic-builders`)\n\nHere is an example build pipeline based on a production Rails application:\n\n```yaml\nsteps:\n  - name: ":docker: :package:"\n    plugins:\n      docker-compose:\n        build: app\n        image-repository: my-docker-org/my-repo\n    agents:\n      queue: elastic-builders\n  - wait\n  - name: ":hammer:"\n    command: ".buildkite/steps/tests"\n    plugins:\n      docker-compose:\n        run: app\n    agents:\n      queue: elastic\n    parallelism: 75\n```\n\nSee [Issue 81](https://github.com/buildkite/elastic-ci-stack-for-aws/issues/81) for ideas on other solutions (contributions welcome!).\n\n## Security\n\nThis repository hasn\'t been reviewed by security researchers so exercise caution and careful thought with what credentials you make available to your builds.\n\nAnyone with commit access to your codebase (including third-party pull-requests if you\'ve enabled them in Buildkite) will have access to your secrets bucket files.\n\nAlso keep in mind the EC2 HTTP metadata server is available from within builds, which means builds act with the same IAM permissions as the instance.\n\n## Development\n\nTo get started with customizing your own stack, or contributing fixes and features:\n\n```bash\n# Build all AMIs\nmake build\n\n# Or, to set things up locally and create the stack on AWS\nmake create-stack\n\n# You can use any of the AWS* environment variables that the aws-cli supports\nAWS_PROFILE="some-profile" make create-stack\n\n# You can also use aws-vault or similar\naws-vault exec some-profile -- make create-stack\n```\n\nIf you need to build your own AMI (because you\'ve changed something in the `packer` directory), run:\n\n```bash\nmake packer\n```\n\n## Questions and Support\n\nFeel free to drop an email to support@buildkite.com with questions. It helps us if you can provide the following details:\n\n```\n# List your stack parameters\naws cloudformation describe-stacks --stack-name MY_STACK_NAME \\\n  --query \'Stacks[].Parameters[].[ParameterKey,ParameterValue]\' --output table\n```\n\nProvide us with logs from Cloudwatch Logs:\n\n```\n/buildkite/elastic-stack/{instance-id}\n/buildkite/systemd/{instance-id}\n```\n\nAlternately, drop by `#aws-stack` and `#aws` channels in [Buildkite Community Slack](https://chat.buildkite.com/) and ask your question!\n\n## Licence\n\nSee [Licence.md](Licence.md) (MIT)\n'