b'# Stripe for Elixir\n\nAn Elixir library for working with [Stripe](https://stripe.com/).\n\n[![Hex.pm](https://img.shields.io/hexpm/v/stripity_stripe.svg?maxAge=2592000)](https://hex.pm/packages/stripity_stripe) [![Hex.pm](https://img.shields.io/hexpm/dt/stripity_stripe.svg?maxAge=2592000)](https://hex.pm/packages/stripity_stripe)\n\n## 2.x.x status\n\n[![Build Status](https://travis-ci.org/code-corps/stripity_stripe.svg?branch=master)](https://travis-ci.org/code-corps/stripity_stripe) [![Hex Docs](https://img.shields.io/badge/hex-docs-9768d1.svg)](https://hexdocs.pm/stripity_stripe) [![Inline docs](http://inch-ci.org/github/code-corps/stripity_stripe.svg?branch=master)](http://inch-ci.org/github/code-corps/stripity_stripe?branch=master) [![Coverage Status](https://coveralls.io/repos/github/code-corps/stripity_stripe/badge.svg?branch=master)](https://coveralls.io/github/code-corps/stripity_stripe?branch=master)\n\n## 1.x.x status\n\n[![Build Status](https://travis-ci.org/code-corps/stripity_stripe.svg?branch=1.x.x)](https://travis-ci.org/code-corps/stripity_stripe) [![Hex Docs](https://img.shields.io/badge/hex-docs-9768d1.svg)](https://hexdocs.pm/stripity_stripe/1.6.2) [![Inline docs](http://inch-ci.org/github/code-corps/stripity_stripe.svg?branch=1.x.x)](http://inch-ci.org/github/code-corps/stripity_stripe?branch=1.x.x) [![Coverage Status](https://coveralls.io/repos/github/code-corps/stripity_stripe/badge.svg?branch=1.x.x)](https://coveralls.io/github/code-corps/stripity_stripe?branch=1.x.x)\n\n# Which version should I use?\n\nThe old `1.x.x` line of releases has been kept and is being published separately for backwards compatibility, since `2.0` was a complete rewrite. To contribute to that line (bugfixes, mainly), create pull requests against the `1.x.x` branch.\n\nThe actively developed line of releases is `2.x.x` and is contained within the `master` branch. New features are being added to this line of releases, so to develop this library further, create pull requests against the master branch.\n\nBelow is a list of which Stripe API version recent releases of Stripity Stripe use. It only indicates the API version being called, not necessarily its compatibility. See the [Stripe API Upgrades page](https://stripe.com/docs/upgrades) for more details.\n\nStarting with stripity_stripe version 2.5.0, you can specify the Stripe API Version to use for a specific request by including the `:api_version` option. Note that while this will use a specific Stripe API Version to make the request, the library will still expect a response matching its corresponding default Stripe API Version. See the [Shared Options documentation](https://hexdocs.pm/stripity_stripe/2.7.0/Stripe.html#module-shared-options) for more details.\n\n| `:stripity_stripe` | Stripe API Version |\n| ------------------ | ------------------ |\n| `2.0.x`            | `2018-02-28`       |\n| `2.1.0 - 2.2.0`    | `2018-05-21`       |\n| `2.2.2`            | `2018-08-23`       |\n| `2.2.3 - 2.3.0`    | `2018-11-08`       |\n| `2.4.0`            | `2019-05-16`       |\n| `master`           | `2019-05-16`       |\n\n# Documentation\n\n- [Latest HexDocs](https://hexdocs.pm/stripity_stripe/)\n\n- [1.x.x](https://hexdocs.pm/stripity_stripe/1.6.1/)\n\n## Installation\n\nInstall the dependency by version:\n\n```ex\n{:stripity_stripe, "~> 2.0.0"}\n```\n\nOr by commit reference (still awaiting hex publish rights so this is your best best for now):\n\n```ex\n{:stripity_stripe, git: "https://github.com/code-corps/stripity_stripe", ref: "8c091d4278d29a917bacef7bb2f0606317fcc025"}\n```\n\nNext, add to your applications:\n\n_Not necessary if using elixir >= 1.4_\n\n```ex\ndefp application do\n  [applications: [:stripity_stripe]]\nend\n```\n\n## Configuration\n\nTo make API calls, it is necessary to configure your Stripe secret key.\n\n```ex\nuse Mix.Config\n\nconfig :stripity_stripe, api_key: System.get_env("STRIPE_SECRET")\n# OR\nconfig :stripity_stripe, api_key: "YOUR SECRET KEY"\n```\n\nIt\'s possible to use a function or a tuple to resolve the secret:\n\n```ex\nconfig :stripity_stripe, api_key: {MyApp.Secrets, :stripe_secret, []}\n# OR\nconfig :stripity_stripe, api_key: fn -> System.get_env("STRIPE_SECRET") end\n```\n\nMoreover, if you are using Poison instead of Jason, you can configure the library to use Poison like so:\n\n```ex\nconfig :stripity_stripe, json_library: Poison\n```\n\n### Timeout\n\nTo set timeouts, pass opts for the http client. The default one is Hackney.\n\n```ex\nconfig :stripity_stripe, hackney_opts: [{:connect_timeout, 1000}, {:recv_timeout, 5000}])\n```\n\n## Note: Object Expansion\n\nSome Stripe API endpoints support returning related objects via the object expansion query parameter. To take advantage of this feature, stripity_stripe accepts\na list of strings to be passed into `opts` under the `:expand` key indicating which objects should be expanded.\n\nFor example, calling `Charge.retrieve("ch_123")` would return a charge without expanding any objects.\n\n```elixir\n%Charge{\n  id: "ch_123",\n  balance_transaction: "txn_123",\n  ...\n}\n```\n\nHowever if we now include an expansion on the `balance_transaction` field using\n\n```elixir\nCharge.retrieve("ch_123", expand: ["balance_transaction"])\n```\n\nWe will get the full object back as well.\n\n```elixir\n%Charge{\n  id: "ch_123",\n  balance_transaction: %BalanceTransaction{\n    id: "txn_123",\n    fee: 125,\n    ...\n  },\n  ...\n}\n```\n\nFor details on which objects can be expanded check out the [stripe object expansion](https://stripe.com/docs/api#expanding_objects) docs.\n\n# Testing\n\nTo run the tests you\'ll need to install [`stripe-mock`](https://github.com/stripe/stripe-mock) It is a mock HTTP server that responds like the real Stripe API. It\'s powered by the [Stripe OpenAPI specification](https://github.com/stripe/openapi), which is generated from within Stripe\'s API.\n\nStart `stripe-mock` before running the tests with `mix test`.\n\n# Documentation for 1.x.x\n\n<details><summary>Click to expand</summary>\n<p>\n\n## Stripe API\n\nWorks with API version 2015-10-16\n\n## Installation\n\nInstall the dependency:\n\n```ex\n{:stripity_stripe, "~> 1.6"}\n```\n\nNext, add to your applications:\n\n```ex\ndefp application do\n  [applications: [:stripity_stripe]]\nend\n```\n\n## Configuration\n\nTo make API calls, it is necessary to configure your Stripe secret key (and optional platform client id if you are using Stripe Connect):\n\n```ex\nuse Mix.Config\n\nconfig :stripity_stripe, secret_key: "YOUR SECRET KEY"\nconfig :stripity_stripe, platform_client_id: "YOUR CONNECT PLATFORM CLIENT ID"\n```\n\n## Testing\n\nIf you start contributing and you want to run mix test, first you need to export STRIPE_SECRET_KEY environment variable in the same shell as the one you will be running mix test in. All tests have the @tag disabled: false and the test runner is configured to ignore disabled: true. This helps to turn tests on/off when working in them. Most of the tests depends on the order of execution (test random seed = 0) to minimize runtime. I\'ve tried having each tests isolated but this made it take ~10 times longer.\n\n```\nexport STRIPE_SECRET_KEY="yourkey"\nmix test\n```\n\n## The API\n\nI\'ve tried to make the API somewhat comprehensive and intuitive. If you\'d like to see things in detail be sure to have a look at the tests - they show (generally) the way the API goes together.\n\nIn general, if Stripe requires some information for a given API call, you\'ll find that as part of the arity of the given function. For instance if you want to delete a Customer, you\'ll find that you _must_ pass the id along:\n\n```ex\n{:ok, result} = Stripe.Customers.delete "some_id"\n```\n\nFor optional arguments, you can send in a Keyword list that will get translated to parameters. So if you want to update a Subscription, for instance, you must send in the `customer_id` and `subscription_id` with the list of changes:\n\n```ex\n# Change customer to the Premium subscription\n{:ok, result} = Stripe.Customers.change_subscription "customer_id", "sub_id", [plan: "premium"]\n```\n\nMetadata (metadata:) key is supported on most object type and allow the storage of extra information on the stripe platform. See [test](https://github.com/code-corps/stripity-stripe/blob/master/test/stripe/customer_test.exs) for an example.\n\nThat\'s the rule of thumb with this library. If there are any errors with your call, they will bubble up to you in the `{:error, message}` match.\n\n```ex\n# Example of paging through events\n{:ok, events} = Stripe.Events.list(key, "", 100) # second arg is a marker for paging\n\ncase events[:has_more] do\n  true ->\n    # retrieve marker\n    last = List.last( events[:data] )\n    case Stripe.Events.list key, last["id"], 100 do\n      {:ok, events} -> events[:data]\n      # ...\n    end\n  false -> events[:data]\nend\n```\n\n# Connect\n\nStripe Connect allows you to provide your customers with an easy onboarding to their own Stripe account. This is useful when you run an e-commerce as a service platform. Each merchant can transact using their own account using your platform. Then your platform uses Stripe\'s API with their own API key obtained in the onboarding process.\n\nFirst, you need to register your platform on Stripe Connect to obtain a `client_id`. In your account settings, there\'s a "Connect" tab, select it. Then fill the information to activate your connect platform settings. The select he `client_id` (notice there\'s one for dev and one for prod), stash this `client_id` in the config file under\n\n```ex\nconfig :stripity_stripe, platform_client_id: "ac_???"\n```\n\nor in an env var named `STRIPE_PLATFORM_CLIENT_ID`.\n\nThen you send your users to sign up for the stripe account using a link.\n\nHere\'s an example of a button to start the workflow:\n<a href="https://connect.stripe.com/oauth/authorize?response_type=code&client_id=ca_32D88BD1qLklliziD7gYQvctJIhWBSQ7&scope=read_write">Connect with Stripe</a>\n\nYou can generate this URL using:\n\n```ex\nurl = Stripe.Connect.generate_button_url csrf_token\n```\n\nWhen the user gets back to your platform, the following url (`redirect_uri` form item on your "Connect" settings) will be used:\n\n```\n//yoursvr/your_endpoint?scope=read_write&code=AUTHORIZATION_CODE\n```\n\nor\n\n```\n//yoursvr/your_endpoint?error=access_denied&error_description=The%20user%20denied%20your%20request\n```\n\nUsing the code request parameter, you make the following call:\n\n```ex\n{:ok, resp} -> Stripe.Connect.oauth_token_callback code\nresp[:access_token]\n```\n\n`resp` will look like this:\n\n```ex\n%{\n  token_type: "bearer",\n  stripe_publishable_key: PUBLISHABLE_KEY,\n  scope: "read_write",\n  livemode: false,\n  stripe_user_id: USER_ID,\n  refresh_token: REFRESH_TOKEN,\n  access_token: ACCESS_TOKEN\n}\n```\n\nYou can then pass the `access_token` to the other API modules to act on their behalf.\n\nSee a [demo](https://github.com/nicrioux/stripity-connect-phoenix) using the Phoenix framework with the bare minimum to get this working.\n\n## Testing Connect\n\nThe tests are currently manual as they require a unique OAuth authorization code per test. You need to obtain this code manually using the stripe connect workflow (that your user would go through using the above url).\n\nFirst, log in your account. Then go to the following url: https://dashboard.stripe.com/account/applications/settings\n\nCreate a connect standalone account. Grab your development `client_id`. Put it in your config file. Enter a redirect url to your endpoint. Capture the "code" request parameter. Pass it to `Stripe.Connect.oauth_token_callback` or `Stripe.Connect.get_token`.\n\n</p>\n</details>\n\n# Contributing\n\nFeedback, feature requests, and fixes are welcomed and encouraged. Please make appropriate use of [Issues](https://github.com/code-corps/stripity-stripe/issues) and [Pull Requests](https://github.com/code-corps/stripity-stripe/pulls). All code should have accompanying tests.\n\n# License\n\nPlease see [LICENSE](LICENSE) for licensing details.\n\n# History\n\n## Statement from original author\n\nWhy another Stripe Library? Currently there are a number of them in the Elixir world that are, well just not "done" yet. I started to fork/help but soon it became clear to me that what I wanted was\n\n- an existing/better test story\n- an API that didn\'t just mimic a REST interaction\n- a library that was up to date with Elixir > 1.0 and would, you know, actually _compile_.\n- function calls that returned a standard `{:ok, result}` or `{:error, message}` response\n\nAs I began digging things up with these other libraries it became rather apparent that I was not only tweaking the API, but also ripping out a lot of the existing code... and that usually means I should probably do my own thing. So I did.\n\n## Update\n\nAs of October 18th, Rob has graciously handed over the reins to the teams at [Code Corps](https://www.codecorps.org/) and [Strumber](https://strumber.com/). To address the concerns Rob mentioned above and update the high level api to work with all of the Stripe API Endpoints, they have since worked to release stripity_stripe 2.0, which is now the actively developed line of releases.\n'