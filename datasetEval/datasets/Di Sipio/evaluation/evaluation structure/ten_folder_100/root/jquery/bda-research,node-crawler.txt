b'\n<p align="center">\n  <a href="https://github.com/bda-research/node-crawler">\n    <img alt="Node.js" src="https://raw.githubusercontent.com/bda-research/node-crawler/master/crawler_primary.png" width="400"/>\n  </a>\n</p>\n\n\n#\n[![npm package](https://nodei.co/npm/crawler.png?downloads=true&downloadRank=true&stars=true)](https://nodei.co/npm/crawler/)\n\n[![build status](https://travis-ci.org/bda-research/node-crawler.svg?branch=master)](https://travis-ci.org/bda-research/node-crawler)\n[![Coverage Status](https://coveralls.io/repos/github/bda-research/node-crawler/badge.svg?branch=master)](https://coveralls.io/github/bda-research/node-crawler?branch=master)\n[![Dependency Status](https://david-dm.org/bda-research/node-crawler/status.svg)](https://david-dm.org/bda-research/node-crawler)\n[![NPM download][download-image]][download-url]\n[![NPM quality][quality-image]][quality-url]\n[![Gitter](https://img.shields.io/badge/gitter-join_chat-blue.svg?style=flat-square)](https://gitter.im/node-crawler/discuss?utm_source=badge)\n\n[quality-image]: http://npm.packagequality.com/shield/crawler.svg?style=flat-square\n[quality-url]: http://packagequality.com/#?package=crawler\n[download-image]: https://img.shields.io/npm/dm/crawler.svg?style=flat-square\n[download-url]: https://npmjs.org/package/crawler\n\n\nMost powerful, popular and production crawling/scraping package for Node, happy hacking :)\n\nFeatures:\n\n * server-side DOM & automatic jQuery insertion with Cheerio (default) or JSDOM\n * Configurable pool size and retries\n * Control rate limit\n * Priority queue of requests\n * forceUTF8 mode to let crawler deal for you with charset detection and conversion\n * Compatible with 4.x or newer version\n\nHere is the [CHANGELOG](https://github.com/bda-research/node-crawler/blob/master/CHANGELOG.md)\n\nThanks to [Authuir](https://github.com/authuir), we have a [Chinese](http://node-crawler.readthedocs.io/zh_CN/latest/) docs. Other languages are welcomed!\n\n# Table of Contents\n- [Get started](#get-started)\n  * [Install](#install)\n  * [Basic usage](#basic-usage)\n  * [Slow down](#slow-down)\n  * [Custom parameters](#custom-parameters)\n  * [Raw body](#raw-body)\n  * [preRequest](#prerequest)\n- [Advanced](#advanced)\n  * [Send request directly](#send-request-directly)\n  * [Work with bottleneck](#work-with-bottleneck)\n  * [Class:Crawler](#classcrawler)\n    + [Event: \'schedule\'](#event-schedule)\n    + [Event: \'limiterChange\'](#event-limiterchange)\n    + [Event: \'request\'](#event-request)\n    + [Event: \'drain\'](#event-drain)\n    + [crawler.queue(uri|options)](#crawlerqueueurioptions)\n    + [crawler.queueSize](#crawlerqueuesize)\n  * [Options reference](#options-reference)\n    + [Basic request options](#basic-request-options)\n    + [Callbacks](#callbacks)\n    + [Schedule options](#schedule-options)\n    + [Retry options](#retry-options)\n    + [Server-side DOM options](#server-side-dom-options)\n    + [Charset encoding](#charset-encoding)\n    + [Cache](#cache)\n    + [Http headers](#http-headers)\n  * [Work with Cheerio or JSDOM](#work-with-cheerio-or-jsdom)\n    + [Working with Cheerio](#working-with-cheerio)\n    + [Work with JSDOM](#work-with-jsdom)\n- [How to test](#how-to-test)\n  * [Alternative: Docker](#alternative-docker)\n- [Rough todolist](#rough-todolist)\n\n# Get started\n\n## Install\n\n```sh\n$ npm install crawler\n```\n\n## Basic usage\n\n```js\nvar Crawler = require("crawler");\n\nvar c = new Crawler({\n    maxConnections : 10,\n    // This will be called for each crawled page\n    callback : function (error, res, done) {\n        if(error){\n            console.log(error);\n        }else{\n            var $ = res.$;\n            // $ is Cheerio by default\n            //a lean implementation of core jQuery designed specifically for the server\n            console.log($("title").text());\n        }\n        done();\n    }\n});\n\n// Queue just one URL, with default callback\nc.queue(\'http://www.amazon.com\');\n\n// Queue a list of URLs\nc.queue([\'http://www.google.com/\',\'http://www.yahoo.com\']);\n\n// Queue URLs with custom callbacks & parameters\nc.queue([{\n    uri: \'http://parishackers.org/\',\n    jQuery: false,\n\n    // The global callback won\'t be called\n    callback: function (error, res, done) {\n        if(error){\n            console.log(error);\n        }else{\n            console.log(\'Grabbed\', res.body.length, \'bytes\');\n        }\n        done();\n    }\n}]);\n\n// Queue some HTML code directly without grabbing (mostly for tests)\nc.queue([{\n    html: \'<p>This is a <strong>test</strong></p>\'\n}]);\n```\n\n## Slow down\nUse `rateLimit` to slow down when you are visiting web sites.\n\n```js\nvar Crawler = require("crawler");\n\nvar c = new Crawler({\n    rateLimit: 1000, // `maxConnections` will be forced to 1\n    callback: function(err, res, done){\n        console.log(res.$("title").text());\n        done();\n    }\n});\n\nc.queue(tasks);//between two tasks, minimum time gap is 1000 (ms)\n```\n\n## Custom parameters\n\nSometimes you have to access variables from previous request/response session, what should you do is passing parameters as same as options:\n\n```js\nc.queue({\n    uri:"http://www.google.com",\n    parameter1:"value1",\n    parameter2:"value2",\n    parameter3:"value3"\n})\n```\n\nthen access them in callback via `res.options`\n\n```js\nconsole.log(res.options.parameter1);\n```\n\nCrawler picks options only needed by request, so don\'t worry about the redundance.\n\n## Raw body\n\nIf you are downloading files like image, pdf, word etc, you have to save the raw response body which means Crawler shouldn\'t convert it to string. To make it happen, you need to set encoding to null\n\n```js\nvar fs = require(\'fs\');\n\nvar c = new Crawler({\n    encoding:null,\n    jQuery:false,// set false to suppress warning message.\n    callback:function(err, res, done){\n        if(err){\n            console.error(err.stack);\n        }else{\n            fs.createWriteStream(res.options.filename).write(res.body);\n        }\n        \n        done();\n    }\n});\n\nc.queue({\n    uri:"https://nodejs.org/static/images/logos/nodejs-1920x1200.png",\n    filename:"nodejs-1920x1200.png"\n});\n\n```\n\n## preRequest\n\nIf you want to do something either synchronously or asynchronously before each request, you can try the code below. Note that direct requests won\'t trigger preRequest.\n\n```js\nvar c = new Crawler({\n    preRequest: function(options, done) {\n        // \'options\' here is not the \'options\' you pass to \'c.queue\', instead, it\'s the options that is going to be passed to \'request\' module \n        console.log(options);\n\t// when done is called, the request will start\n\tdone();\n    },\n    callback: function(err, res, done) {\n        if(err) {\n\t    console.log(err)\n\t} else {\n\t    console.log(res.statusCode)\n\t}\n    }\n});\n\nc.queue({\n    uri: \'http://www.google.com\',\n    // this will override the \'preRequest\' defined in crawler\n    preRequest: function(options, done) {\n        setTimeout(function() {\n\t    console.log(options);\n\t    done();\n\t}, 1000)\n    }\n});\n```\n# Advanced\n## Send request directly\n\nIn case you want to send a request directly without going through the scheduler in Crawler, try the code below. `direct` takes the same options as `queue`, please refer to [options](#options-reference) for detail. The difference is when calling `direct`, `callback` must be defined explicitly, with two arguments `error` and `response`, which are the same as that of `callback` of method `queue`.\n\n```js\ncrawler.direct({\n    uri: \'http://www.google.com\',\n    skipEventRequest: false, // default to true, direct requests won\'t trigger Event:\'request\'\n    callback: function(error, response) {\n        if(error) {\n            console.log(error)\n        } else {\n            console.log(response.statusCode);\n        }\n    }\n});\n```\n\n## Work with bottleneck\n\nControl rate limit for with limiter. All tasks submit to a limiter will abide the `rateLimit` and `maxConnections` restrictions of the limiter. `rateLimit` is the minimum time gap between two tasks. `maxConnections` is the maximum number of tasks that can be running at the same time. Limiters are independent of each other. One common use case is setting different limiters for different proxies. One thing is worth noticing, when `rateLimit` is set to a non-zero value, `maxConnections` will be forced to 1.\n\n```js\nvar crawler = require(\'crawler\');\n\nvar c = new Crawler({\n    rateLimit: 2000,\n    maxConnections: 1,\n    callback: function(error, res, done) {\n        if(error) {\n            console.log(error)\n        } else {\n            var $ = res.$;\n            console.log($(\'title\').text())\n        }\n        done();\n    }\n})\n\n// if you want to crawl some website with 2000ms gap between requests\nc.queue(\'http://www.somewebsite.com/page/1\')\nc.queue(\'http://www.somewebsite.com/page/2\')\nc.queue(\'http://www.somewebsite.com/page/3\')\n\n// if you want to crawl some website using proxy with 2000ms gap between requests for each proxy\nc.queue({\n    uri:\'http://www.somewebsite.com/page/1\',\n    limiter:\'proxy_1\',\n    proxy:\'proxy_1\'\n})\nc.queue({\n    uri:\'http://www.somewebsite.com/page/2\',\n    limiter:\'proxy_2\',\n    proxy:\'proxy_2\'\n})\nc.queue({\n    uri:\'http://www.somewebsite.com/page/3\',\n    limiter:\'proxy_3\',\n    proxy:\'proxy_3\'\n})\nc.queue({\n    uri:\'http://www.somewebsite.com/page/4\',\n    limiter:\'proxy_1\',\n    proxy:\'proxy_1\'\n})\n```\n\nNormally, all limiter instances in limiter cluster in crawler are instantiated with options specified in crawler constructor. You can change property of any limiter by calling the code below. Currently, we only support changing property \'rateLimit\' of limiter. Note that the default limiter can be accessed by `c.setLimiterProperty(\'default\', \'rateLimit\', 3000)`. We strongly recommend that you leave limiters unchanged after their instantiation unless you know clearly what you are doing.\n```js\nvar c = new Crawler({});\nc.setLimiterProperty(\'limiterName\', \'propertyName\', value)\n```\n\n \n## Class:Crawler\n\n### Event: \'schedule\'\n * `options` [Options](#options-reference)\n\nEmitted when a task is being added to scheduler.\n\n```js\ncrawler.on(\'schedule\',function(options){\n    options.proxy = "http://proxy:port";\n});\n```\n\n### Event: \'limiterChange\'\n * `options` [Options](#options-reference)\n * `limiter` [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)\n\nEmitted when limiter has been changed.\n\n### Event: \'request\'\n * `options` [Options](#options-reference)\n\nEmitted when crawler is ready to send a request.\n\nIf you are going to modify options at last stage before requesting, just listen on it.\n\n```js\ncrawler.on(\'request\',function(options){\n    options.qs.timestamp = new Date().getTime();\n});\n```\n\n### Event: \'drain\'\n\nEmitted when queue is empty.\n\n```js\ncrawler.on(\'drain\',function(){\n    // For example, release a connection to database.\n    db.end();// close connection to MySQL\n});\n```\n\n### crawler.queue(uri|options)\n * `uri` [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)\n * `options` [Options](#options-reference)\n\nEnqueue a task and wait for it to be executed.\n\n### crawler.queueSize\n * [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type)\n\nSize of queue, read-only\n\n\n## Options reference\n\n\nYou can pass these options to the Crawler() constructor if you want them to be global or as\nitems in the queue() calls if you want them to be specific to that item (overwriting global options)\n\nThis options list is a strict superset of [mikeal\'s request options](https://github.com/mikeal/request#requestoptions-callback) and will be directly passed to\nthe request() method.\n\n### Basic request options\n\n * `options.uri`: [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type) The url you want to crawl.\n * `options.timeout` : [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) In milliseconds (Default 15000).\n * [All mikeal\'s request options are accepted](https://github.com/mikeal/request#requestoptions-callback).\n\n### Callbacks\n\n * `callback(error, res, done)`: Function that will be called after a request was completed\n     * `error`: [Error](https://nodejs.org/api/errors.html)\n     * `res`: [http.IncomingMessage](https://nodejs.org/api/http.html#http_class_http_incomingmessage) A response of standard IncomingMessage includes `$` and `options`\n         * `res.statusCode`: [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) HTTP status code. E.G.`200`\n         * `res.body`: [Buffer](https://nodejs.org/api/buffer.html) | [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type) HTTP response content which could be a html page, plain text or xml document e.g.\n         * `res.headers`: [Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object) HTTP response headers\n         * `res.request`: [Request](https://github.com/request/request)  An instance of Mikeal\'s `Request` instead of [http.ClientRequest](https://nodejs.org/api/http.html#http_class_http_clientrequest)\n             * `res.request.uri`: [urlObject](https://nodejs.org/api/url.html#url_url_strings_and_url_objects) HTTP request entity of parsed url\n             * `res.request.method`: [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type) HTTP request method. E.G. `GET`\n             * `res.request.headers`: [Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object) HTTP request headers\n         * `res.options`: [Options](#options-reference) of this task\n         * `$`: [jQuery Selector](https://api.jquery.com/category/selectors/) A selector for  html or xml document.\n     * `done`: [Function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function) It must be called when you\'ve done your work in callback.\n\n### Schedule options\n\n * `options.maxConnections`: [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) Size of the worker pool (Default 10).\n * `options.rateLimit`: [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) Number of milliseconds to delay between each requests (Default 0).\n * `options.priorityRange`: [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) Range of acceptable priorities starting from 0 (Default 10).\n * `options.priority`: [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) Priority of this request (Default 5). Low values have higher priority.\n\n### Retry options\n\n * `options.retries`: [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) Number of retries if the request fails (Default 3),\n * `options.retryTimeout`: [Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type) Number of milliseconds to wait before retrying (Default 10000),\n\n### Server-side DOM options\n\n * `options.jQuery`: [Boolean](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type)|[String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object) Use `cheerio` with default configurations to inject document if true or "cheerio". Or use customized `cheerio` if an object with [Parser options](https://github.com/fb55/htmlparser2/wiki/Parser-options). Disable injecting jQuery selector if false. If you have memory leak issue in your project, use "whacko", an alternative parser,to avoid that. (Default true)\n\n### Charset encoding\n\n * `options.forceUTF8`: [Boolean](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type) If true crawler will get charset from HTTP headers or meta tag in html and convert it to UTF8 if necessary. Never worry about encoding anymore! (Default true),\n * `options.incomingEncoding`: [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type) With forceUTF8: true to set encoding manually (Default null) so that crawler will not have to detect charset by itself. For example, `incomingEncoding : \'windows-1255\'`. See [all supported encodings](https://github.com/ashtuchkin/iconv-lite/wiki/Supported-Encodings)\n\n### Cache\n\n * `options.skipDuplicates`: [Boolean](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type) If true skips URIs that were already crawled, without even calling callback() (Default false). __This is not recommended__, it\'s better to handle outside `Crawler` use [seenreq](https://github.com/mike442144/seenreq)\n\n### Http headers\n\n * `options.rotateUA`: [Boolean](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type) If true, `userAgent` should be an array and rotate it (Default false) \n * `options.userAgent`: [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type)|[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array), If `rotateUA` is false, but `userAgent` is an array, crawler will use the first one.\n * `options.referer`: [String](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type) If truthy sets the HTTP referer header\n * `options.removeRefererHeader`: [Boolean](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type) If true preserves the set referer during redirects\n * `options.headers`: [Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object) Raw key-value of http headers\n\n\n\n## Work with Cheerio or JSDOM\n\n\nCrawler by default use [Cheerio](https://github.com/cheeriojs/cheerio) instead of [JSDOM](https://github.com/tmpvar/jsdom). JSDOM is more robust, if you want to use JSDOM you will have to require it `require(\'jsdom\')` in your own script before passing it to crawler.\n\n### Working with Cheerio\n```js\njQuery: true //(default)\n//OR\njQuery: \'cheerio\'\n//OR\njQuery: {\n    name: \'cheerio\',\n    options: {\n        normalizeWhitespace: true,\n        xmlMode: true\n    }\n}\n```\nThese parsing options are taken directly from [htmlparser2](https://github.com/fb55/htmlparser2/wiki/Parser-options), therefore any options that can be used in `htmlparser2` are valid in cheerio as well. The default options are:\n\n```js\n{\n    normalizeWhitespace: false,\n    xmlMode: false,\n    decodeEntities: true\n}\n```\n\nFor a full list of options and their effects, see [this](https://github.com/fb55/DomHandler) and\n[htmlparser2\'s options](https://github.com/fb55/htmlparser2/wiki/Parser-options).\n[source](https://github.com/cheeriojs/cheerio#loading)\n\n### Work with JSDOM\n\nIn order to work with JSDOM you will have to install it in your project folder `npm install jsdom`, and pass it to crawler.\n\n```js\nvar jsdom = require(\'jsdom\');\nvar Crawler = require(\'crawler\');\n\nvar c = new Crawler({\n    jQuery: jsdom\n});\n```\n\n# How to test\n\nCrawler uses `nock` to mock http request, thus testing no longer relying on http server.\n\n```bash\n$ npm install\n$ npm test\n$ npm run cover # code coverage\n```\n\n## Alternative: Docker\n\nAfter [installing Docker](http://docs.docker.com/), you can run:\n\n```bash\n# Builds the local test environment\n$ docker build -t node-crawler .\n\n# Runs tests\n$ docker run node-crawler sh -c "npm install && npm test"\n\n# You can also ssh into the container for easier debugging\n$ docker run -i -t node-crawler bash\n```\n\n\n# Rough todolist\n\n * Introducing zombie to deal with page with complex ajax\n * Refactoring the code to be more maintainable\n * Make Sizzle tests pass (JSDOM bug? https://github.com/tmpvar/jsdom/issues#issue/81)\n * Promise support\n * Commander support\n * Middleware support\n'