b'# Terraform setup for S3 static site with CloudFront, Certificate Manager and Route53\n\nThis Git repository contains the required [Terraform](https://www.terraform.io/)\nscripts to setup a static website, hosted out of an S3 bucket.\nThe site is fronted by a CloudFront distribution, uses AWS Certificate Manager for HTTPS and allows\nfor configuring the required DNS entries in Route53.\n\nThe scripts also take care of:\n\n* Preventing the origin bucket being indexed by search bots.\n* Redirect other domains to the main site with proper rewriting.\n* Access logging\n* Redirect HTTP to HTTPS\n\nThese scripts suite my needs, but all evolution in the form of pull requests are welcome! To make\nthis process fluent, create [an issue](https://github.com/skyscrapers/terraform-website-s3-cloudfront-route53/issues)\nfirst describing what you want to contribute, then fork and create a branch with a clear name.\nSubmit your work as a pull request.\n\n## Introduction\n\nThis repository is split in 4 parts, each of which can be used as a separate module in your own root script.\nThe split is done because of the lack of conditional logic in Terraform 0.6.x. I leave the composition\nof the required setup to you, the user.\n\n* *site-main*: setup of the main S3 bucket with a CloudFront distribution\n* *site-redirect*: setup of the redirect S3 bucket with a CloudFront distribution\n* *r53-cname*: configuration of a Route53 CNAME record pointing to a CloudFront distribution\n* *r53-alias*: configuration of a Route53 ALIAS record pointing to a CloudFront distribution. Required\n  for naked domain (APEX) setups.\n\nWith the above 4 modules, you can pick yourself what you need for setups like:\n\n* single site on [https://sub.domain.com](https://sub.domain.com)\n* single site on [https://domain.com](https://domain.com)\n* main site on [https://www.domain.com](https://www.domain.com) and redirecting the naked domain to the www version.\n* main site on [https://domain.com](https://domain.com) and redirecting the www version to the naked domain.\n\nGiven the ease of setting up SSL secured sites with AWS Certificate Manager, the above modules do not offer\nthe option to set up non-SSL sites. But since AWS Certificate Manager requires manual intervention to\ncomplete the certificate setup, you must create your certificates first before using the modules below.\n\n_Note:_ AWS Certificate Manager supports multiple regions. To use CloudFront with ACM certificates, the\ncertificates must be requested in region us-east-1.\n\n## Configuring Terraform\n\nThe different modules do not define variables for the AWS provider. For ease of use, the configuration\nis done implicitly by setting the following environment variables:\n\n* `AWS_SECRET_ACCESS_KEY`\n* `AWS_ACCESS_KEY_ID`\n* `AWS_DEFAULT_REGION`\n\nThese variables are inherited by any Terraform modules and prevents passing too much TF variables\nfrom parent to module. This info was found\n[here](https://groups.google.com/d/msg/terraform-tool/GM1QisZ95qc/Pt8JqPVePHAJ).\n\n## Setting up the main site\n\nCreating all the resources for an S3 based static website, with a CloudFront distribution and using\nthe appropriate SSL certificates is as easy as using the `site-main` module and passing the\nappropriate variables:\n\n    module "site-main" {\n       source = "github.com/skyscrapers/terraform-website-s3-cloudfront-route53//site-main"\n\n       region = "eu-west-1"\n       domain = "my.domain.com"\n       bucket_name = "site_mydomain"\n       duplicate-content-penalty-secret = "some-secret-password"\n       deployer = "an-iam-username"\n       acm-certificate-arn = "arn:aws:acm:us-east-1:<id>:certificate/<cert-id>"\n       not-found-response-path = "/404.html"\n    }\n\nMention the double slash. This is to indicate to look into the subdirectory within the Github repository.\nSee the [Terraform Modules documentation](https://www.terraform.io/docs/modules/sources.html#github) for more info.\n\n### Inputs\n\n* `region`: the AWS region where the S3 bucket will be created. The source bucket can be created in any\n   of the available regions. The default value is `us-east-1`.\n* `domain`: the domain name by which you want to make the website available on the Internet. While we are not\n  at the point of setting up the DNS part, the CloudFront distribution needs to know for which domain it needs\n  to accept requests.\n* `bucket_name`: the name of the bucket to create for the S3 based static website.\n* `duplicate-content-penalty-secret`: Value that will be used in a custom header for a CloudFront distribution\n  to gain access to the origin S3 bucket. If you make an S3 bucket available as the source for a CloudFront\n  distribution, you have the risk of search bots to index both this source bucket and the distribution.\n  Google _punishes_ you for this as you can read in\n  [this article](https://support.google.com/webmasters/answer/66359?hl=en). We need to protect access to\n  the source bucket. There are 2 options to prevent this: using an Origin Access User between CloudFront\n  distribution and the source S3 bucket, or using custom headers between the distribution and the bucket.\n  The use of an Origin Access User prescribes accessing the source bucket in REST mode which results in\n  bucket redirects not being followed. As a result, this module will use the custom header option.\n* `deployer`: the name of an existing IAM user that will be used to push contents to the S3 bucket. This\n  user will get a role policy attached to it, configured to have read/write access to the bucket that\n  will be created.\n* `acm-certificate-arn`: the id of an certificate in AWS Certificate Manager. As this certificate will be\n  used on a CloudFront distribution, Amazon\'s documentation states the certificate must be generated\n  in the `us-east-1` region.\n* `default-root-object`: (Optional) default root object to be served by CloudFront. Defaults to `index.html`, but can be e.x. `v1.0.0/index.html` for versioned applications.\n* `not-found-response-path`: response path for the file that should be served on 404. Default to `/404.html`,\n  but can be e.x. `/index.html` for single page applications.\n* `trusted_signers`: (Optional) List of AWS account IDs that are allowed to create signed URLs for this\n  distribution. May contain `self` to indicate the account where the distribution is created in.\n* `tags`: (Optional) Additional key/value pairs to set as tags.\n* `forward-query-string`:  (Optional) Forward the query string to the origin. Default value = `false`\n* `price_class`: (Optional) The price class that corresponds with the maximum price that you want to pay for CloudFront service.\n  Read [pricing page](https://aws.amazon.com/cloudfront/pricing/) for more details.\n  Options: `PriceClass_100` | `PriceClass_200` | `PriceClass_All`. Default value = `PriceClass_200`\n\n### Outputs\n\n* `website_cdn_hostname`: the Amazon generated Cloudfront domain name. You can already test accessing your\n  website content by this hostname. This hostname is needed later on to create a `CNAME` record in Route53.\n* `website_cdn_zone_id`: the Hosted Zone ID of the Cloudfront distribution. This zone ID is needed\n  later on to create a Route53 `ALIAS` record.\n* `website_bucket_id`: The website bucket id\n* `website_bucket_arn`: The website bucket arn\n* `website_cdn_id`: The CDN ID of the Cloudfront distribution.\n* `website_cdn_arn`: The ARN of the CDN\n\n## Setting up the redirect site\n\n    module "site-redirect" {\n       source = "github.com/skyscrapers/terraform-website-s3-cloudfront-route53//site-redirect"\n       region = "eu-west-1"\n       domain = "my.domain.com"\n       target = "domain.com"\n       duplicate-content-penalty-secret = "some-secret-password"\n       deployer = "an-iam-username"\n       acm-certificate-arn = "arn:aws:acm:us-east-1:<id>:certificate/<cert-id>"\n    }\n\n### Inputs\n\n* `tags`: (Optional) Additional key/value pairs to set as tags.\n* `default_root_object`: (Optional) The object that you want CloudFront to return (for example, index.html) when an end user requests the root URL. Default value = `index.html`\n* `price_class`: (Optional) The price class that corresponds with the maximum price that you want to pay for CloudFront service.\n  Read [pricing page](https://aws.amazon.com/cloudfront/pricing/) for more details.\n  Options: `PriceClass_100` | `PriceClass_200` | `PriceClass_All`. Default value = `PriceClass_200`\n\n### Outputs\n\n* `website_cdn_hostname`: the Amazon generated Cloudfront domain name. You can already test accessing your\n  website content by this hostname. This hostname is needed later on to create a `CNAME` record in Route53.\n* `website_cdn_zone_id`: the Hosted Zone ID of the Cloudfront distribution. This zone ID is needed\n  later on to create a Route53 `ALIAS` record.\n\n## Setting up the Route 53 CNAME\n\nWhether it is a main site or a redirect site, a CNAME DNS record is needed for your site to be accessed on a\nnon-root domain.\n\n    module "dns-cname" {\n       source = "github.com/skyscrapers/terraform-website-s3-cloudfront-route53//r53-cname"\n\n       domain = "my.domain.com"\n       target = "${module.site-main.website_cdn_hostname}"\n       route53_zone_id = "<r53-zone-id>"\n    }\n\n### Inputs\n\n* `domain`: the domain name you want to use to access your static website. This should match the domain\n  name used in setting up either a main or a redirect site.\n* `target`: the domain name of the CloudFront distribution to which the domain name should point. You\n  usually pass the `website_cdn_hostname` output variable from the main or redirect site here.\n* `route53_zone_id`: the Route53 Zone ID where the CNAME entry must be created.\n\n## Setting up the Route 53 ALIAS\n\nWhether it is a main site or a redirect site, an ALIAS DNS record is needed for your site to be accessed on a\nroot domain.\n\n    module "dns-alias" {\n       source = "github.com/skyscrapers/terraform-website-s3-cloudfront-route53//r53-alias"\n\n       domain = "domain.com"\n       target = "${module.site-main.website_cdn_hostname}"\n       cdn_hosted_zone_id = "${module.site-main.website_cdn_zone_id}"\n       route53_zone_id = "<r53-zone-id>"\n    }\n\n### Inputs\n\n* `domain`: the domain name you want to use to access your static website. This should match the domain\n  name used in setting up either a main or a redirect site.\n* `target`: the domain name of the CloudFront distribution to which the domain name should point. You\n  usually pass the `website_cdn_hostname` output variable from the main or redirect site here.\n* `cdn_hosted_zone_id`: the Hosted Zone ID of the CloudFront distribution. You usually pass the\n  `website_cdn_zone_id` output variable from the main or redirect site here.\n* `route53_zone_id`: the Route53 Zone ID where the CNAME entry must be created.\n\n## Users\n\nIf you are using the modules in this Git repository to set up your static site and you want some\nvisibility, add your site and info below and submit a pull request:\n\n* [Skyscrapers](https://skyscrapers.eu) (Skyscrapers)\n\n**Enjoy!**\n'