b'**Warning**\n\n**Concourse-Up is being replaced with [Control Tower](https://github.com/EngineerBetter/control-tower). First-time users should deploy using `control-tower` and raise issues under that project. This repo will be deprecated in due course.**\n\n# Concourse-Up\n\n[![asciicast](https://asciinema.org/a/xVKD0dQuXdEmOcExt4A9WfbEN.svg)](https://asciinema.org/a/xVKD0dQuXdEmOcExt4A9WfbEN)\n\nA tool for easily deploying [Concourse](https://concourse-ci.org) in a single command.\n\n![](https://ci.engineerbetter.com/api/v1/teams/main/pipelines/concourse-up/jobs/system-test/badge)\n\n## TL;DR\n\n##### AWS\n\n```sh\n$ AWS_ACCESS_KEY_ID=<access-key-id> \\\n  AWS_SECRET_ACCESS_KEY=<secret-access-key> \\\n  concourse-up deploy <your-project-name>\n```\n\n##### GCP\n\n```sh\n$ GOOGLE_APPLICATION_CREDENTIALS=<path/to/googlecreds.json> \\\n  concourse-up deploy --iaas gcp <your-project-name> \n```\n\n## Why Concourse-Up?\n\nThe goal of Concourse-Up is to be the world\'s easiest way to deploy and operate Concourse CI in production. \n\nIn just one command you can deploy a new Concourse environment for your team, on either AWS or GCP. Your Concourse-Up deployment will *upgrade itself* and self-heal, restoring the underlying VMs if needed. Using the same command-line tool you can do things like manage DNS, scale your environment, or manage firewall policy. CredHub is provided for secrets management and Grafana for viewing your Concourse metrics.\n\nYou can keep up to date on Concourse-Up announcements by reading the [EngineerBetter Blog](http://www.engineerbetter.com/blog/)\n\n## Feature Summary\n\n- Deploys the latest version of Concourse CI on any region in AWS or GCP\n- Manual upgrade or automatic self-upgrade\n- Access your Concourse over https access by default, with auto-generated or self-provided cert.\n- Deploy on your own domain, if you have a zone in Route53 or Cloud DNS.\n- Scale your workers horizontally or vertically \n- Scale your Concourse database\n- Presents workers on a single public IP to simplify external security policy\n- Database encryption enabled by default\n- Includes Grafana metrics dashboard (check http://your-concourse-url:3000)\n- Includes CredHub for secret management (see: <https://concourse-ci.org/creds.html>)\n- Saves you money by using AWS spot or GCP preemptible instances where possible, restarting them when needed\n- Idempotent deployment and operations\n- Easy destroy and cleanup\n\n### Feature Table\n\n| **Feature** | **AWS** | **GCP** |\n|:------------|:-------:|:-------:|\n| Concourse IP whitelisting | **+** | **+** |\n| Credhub | **+** | **+** |\n| Custom domains | **+** | **+** |\n| Custom tagging | **BOSH only** | **BOSH only** |\n| Custom TLS certificates | **+** | **+** |\n| Database vertical scaling | **+** | **+** |\n| GitHub authentication | **+** | **+** |\n| Grafana | **+** | **+** |\n| Interruptable worker support | **+** | **+** |\n| Letsencrypt integration | **+** | **+** |\n| Namespace support | **+** | **+** |\n| Region selection | **+** | **+** |\n| Retrieving deployment information | **+** | **+** |\n| Retrieving deployment information as shell exports | **+** | **+** |\n| Retrieving deployment information in JSON | **+** | **+** |\n| Retrieving director NATS cert expiration | **+** | **+** |\n| Rotating director NATS cert | **+** | **+** |\n| Self-Update support | **+** | **+** |\n| Teardown deployment | **+** | **+** |\n| Web server vertical scaling | **+** | **+** |\n| Worker horizontal scaling | **+** | **+** |\n| Worker type selection | **+** | **N/A** |\n| Worker vertical scaling | **+** | **+** |\n| Zone selection | **+** | **+** |\n| Customised networking | **+** | **+** |\n\n## Prerequisites\n\n- One of:\n  - The environment variables `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` are set.\n  - Credentials for the default profile in `~/.aws/credentials` are present.\n  - Credentials for a profile in `~/.aws/credentials` are present.\n  - The environment variable `GOOGLE_APPLICATION_CREDENTIALS_CONTENTS` set to the path to a GCP credentials json file\n- Ensure your credentials are *long lived credentials* and not *temporary security credentials*\n- Ensure you have the correct local dependencies for [bootstrapping a BOSH VM](https://bosh.io/docs/cli-v2-install/#additional-dependencies)\n\n## Install\n\nDownload the [latest release](https://github.com/EngineerBetter/concourse-up/releases) and install it into your `PATH`\n\n## Usage\n\n### Global flags\n\n- `--region value`    AWS or GCP region (default: "eu-west-1" on AWS and "europe-west1" on GCP) [$AWS_REGION]\n- `--namespace value` Any valid string that provides a meaningful namespace of the deployment - Used as part of the configuration bucket name [$NAMESPACE].\n    >Note that if namespace has been provided in the initial `deploy` it will be required for any subsequent `concourse-up` calls against the same deployment.\n\n#### Choosing an IAAS\n\nThe default IAAS for Concourse-Up is AWS. To choose a different IAAS use the `--iaas` flag. For every IAAS provider apart from AWS this flag is required for all commands.\n\nSupported IAAS values: AWS, GCP\n\n- `--iaas value` (optional) IAAS, can be AWS or GCP (default: "AWS") [$IAAS]\n\n### Deploy\n\nDeploy a new Concourse with:\n\n```sh\nconcourse-up deploy <your-project-name>\n```\n\neg:\n\n```sh\n$ concourse-up deploy ci\n\n...\nDEPLOY SUCCESSFUL. Log in with:\nfly --target ci login --insecure --concourse-url https://10.0.0.0 --username  --password\n\nMetrics available at https://10.0.0.0:3000 using the same username and password\n\nLog into credhub with:\neval "$(concourse-up info ci --env)"\n```\n\nA new deploy from scratch takes approximately 20 minutes.\n\n#### Flags\n\nAll flags are optional. Configuration settings provided via flags will persist in later deployments unless explicitly overriden.\n\n- `--domain value`       Domain to use as endpoint for Concourse web interface (eg: ci.myproject.com) [$DOMAIN]\n    ```sh\n    $ concourse-up deploy --domain chimichanga.engineerbetter.com chimichanga\n    ```\n\n    In the example above `concourse-up` will search for a hosted zone that matches `chimichanga.engineerbetter.com` or `engineerbetter.com` and add a record to the longest match (`chimichanga.engineerbetter.com` in this example).\n\n- `--tls-cert value`     TLS cert to use with Concourse endpoint [$TLS_CERT]\n- `--tls-key value`      TLS private key to use with Concourse endpoint [$TLS_KEY]\n\n    By default `concourse-up` will generate a self-signed cert using the given domain. If you\'d like to provide your own certificate instead, pass the cert and private key as strings using the `--tls-cert` and `--tls-key` flags respectively. eg:\n\n    ```sh\n    $ concourse-up deploy \\\n      --domain chimichanga.engineerbetter.com \\\n      --tls-cert "$(cat chimichanga.engineerbetter.com.crt)" \\\n      --tls-key "$(cat chimichanga.engineerbetter.com.key)" \\\n      chimichanga\n    ```\n\n- `--workers value`      Number of Concourse worker instances to deploy (default: 1) [$WORKERS]\n- `--worker-type`        Specify a worker type for aws (m5 or m4) (default: "m4") [$WORKER_TYPE] (see comparison table below). **Note: this is an AWS-specific option**\n\n> AWS does not offer m5 instances in all regions, and even for regions that do offer m5 instances, not all zones within that region may offer them. To complicate matters further, each AWS account is assigned AWS zones at random - for instance, `eu-west-1a` for one account may be the same as `eu-west-1b` in another account. If m5s are available in your chosen region but _not_ the zone Concourse-Up has chosen, create a new deployment, this time specifying another `--zone`.\n\n- `--worker-size value`  Size of Concourse workers. Can be medium, large, xlarge, 2xlarge, 4xlarge, 10xlarge, 12xlarge, 16xlarge or 24xlarge depending on the worker-type (see above) (default: "xlarge") [$WORKER_SIZE]\n\n    | --worker-size | AWS m4 Instance type | AWS m5 Instance type* | GCP Instance type |\n    |---------------|----------------------|-----------------------|-------------------|\n    | medium        | t2.medium            | t2.medium             | n1-standard-1     |\n    | large         | m4.large             | m5.large              | n1-standard-2     |\n    | xlarge        | m4.xlarge            | m5.xlarge             | n1-standard-4     |\n    | 2xlarge       | m4.2xlarge           | m5.2xlarge            | n1-standard-8     |\n    | 4xlarge       | m4.4xlarge           | m5.4xlarge            | n1-standard-16    |\n    | 10xlarge      | m4.10xlarge          |                       | n1-standard-32    |\n    | 12xlarge      |                      | m5.12xlarge           |                   |\n    | 16xlarge      | m4.16xlarge          |                       | n1-standard-64    |\n    | 24xlarge      |                      | m5.24xlarge           |                   |\n\n    \\* _m5 instances not available in all regions and all zones. See `--worker-type` for more info._\n\n- `--web-size value`     Size of Concourse web node. Can be small, medium, large, xlarge, 2xlarge (default: "small") [$WEB_SIZE]\n\n    | --web-size | AWS Instance type | GCP Instance type |\n    |------------|-------------------|-------------------|\n    | small      | t2.small          | n1-standard-1     |\n    | medium     | t2.medium         | n1-standard-2     |\n    | large      | t2.large          | n1-standard-4     |\n    | xlarge     | t2.xlarge         | n1-standard-8     |\n    | 2xlarge    | t2.2xlarge        | n1-standard-16    |\n\n- `--db-size value`      Size of Concourse Postgres instance. Can be small, medium, large, xlarge, 2xlarge, or 4xlarge (default: "small") [$DB_SIZE]\n\n    >Note that when changing the database size on an existing concourse-up deployment, the SQL instance will scaled by terraform resulting in approximately 3 minutes of downtime.\n\n    The following table shows the allowed database sizes and the corresponding AWS RDS & CloudSQL instance types\n\n    | --db-size | AWS Instance type | GCP Instance type  |\n    |-----------|-------------------|--------------------|\n    | small     | db.t2.small       | db-g1-small        |\n    | medium    | db.t2.medium      | db-custom-2-4096   |\n    | large     | db.m4.large       | db-custom-2-8192   |\n    | xlarge    | db.m4.xlarge      | db-custom-4-16384  |\n    | 2xlarge   | db.m4.2xlarge     | db-custom-8-32768  |\n    | 4xlarge   | db.m4.4xlarge     | db-custom-16-65536 |\n\n- `--allow-ips value`    Comma separated list of IP addresses or CIDR ranges to allow access to (default: "0.0.0.0/0") [$ALLOW_IPS]\n\n    > Note: `allow-ips` governs what can access Concourse but not what can access the control plane (i.e. the BOSH director).\n\n- `--github-auth-client-id value`      Client ID for a github OAuth application - Used for Github Auth [$GITHUB_AUTH_CLIENT_ID]\n- `--github-auth-client-secret value`  Client Secret for a github OAuth application - Used for Github Auth [$GITHUB_AUTH_CLIENT_SECRET]\n- `--add-tag key=value` Add a tag to the VMs that form your `concourse-up` deployment. Can be used multiple times in a single `deploy` command.\n- `--spot=value` Use spot instances for workers. Can be true/false. Default is true.\n\n    > Concourse Up uses spot instances for workers as a cost saving measure. Users requiring lower risk may switch this feature off by setting --spot=false.\n- `--preemptible=value` Use preemptible instances for workers. Can be true/false. Default is true.\n\n    > Be aware the [preemptible instances](https://cloud.google.com/preemptible-vms/) _will_ go down at least once every 24 hours so deployments with only one worker _will_ experience downtime with this feature enabled. BOSH will ressurect falled workers automatically.\n\n    `spot` and `preemptible` are interchangeable so if either of them is set to false then interruptible instances will not be used regardless of your IaaS. i.e:\n\n    ```sh\n    # Results in an AWS deployment using non-spot workers\n    concourse-up deploy --spot=true --preemptible=false <your-project-name>\n    # Results in an AWS deployment using non-spot workers\n    concourse-up deploy --preemptible=false <your-project-name>\n    # Results in a GCP deployment using non-preemptible workers\n    concourse-up deploy --iaas gcp --spot=false <your-project-name>\n    ```\n\n- `--zone`            Specify an availability zone [$ZONE] (cannot be changed after the initial deployment)\n\nIf any of the following 5 flags is set, all the required ones from this group need to be set\n- `--vpc-network-range value`      Customise the VPC network CIDR to deploy into (required for AWS) [$VPC_NETWORK_RANGE]\n- `--public-subnet-range value`    Customise public network CIDR (if IAAS is AWS must be within --vpc-network-range) (required) [$PUBLIC_SUBNET_RANGE]\n- `--private-subnet-range value`   Customise private network CIDR (if IAAS is AWS must be within --vpc-network-range) (required) [$PRIVATE_SUBNET_RANGE]\n- `--rds-subnet-range1 value`      Customise first rds network CIDR (must be within --vpc-network-range) (required for AWS) [$RDS_SUBNET_RANGE1]\n- `--rds-subnet-range2 value`      Customise second rds network CIDR (must be within --vpc-network-range) (required for AWS) [$RDS_SUBNET_RANGE2]\n\n    > All the ranges above should be in the CIDR format of IPv4/Mask. The sizes can vary as long as `vpc-network-range` is big enough to contain all others (in case IAAS is AWS). The smallest CIDR for `public` and `private` subnets is a /28. The smallest CIDR for `rds1` and `rds2` subnets is a /29\n\n### Info\n\nTo fetch information about your `concourse-up` deployment:\n\n```sh\n$ concourse-up info --json <your-project-name>\n```\n\nTo load credentials into your environment from your `concourse-up` deployment:\n\n```sh\n$ eval "$(concourse-up info --env <your-project-name>)"\n```\n\nTo check the expiry of the BOSH Director\'s NATS CA certificate:\n\n```sh\n$ concourse-up info --cert-expiry <your-project-name>\n```\n\n**Warning: if your deployment is approaching a year old, it may stop working due to expired certificates. For information please see this issue https://github.com/EngineerBetter/concourse-up/issues/81.**\n\n#### Flags\n\nAll flags are optional\n\n`--json`          Output as json [$JSON]\n`--env`           Output environment variables\n`--cert-expiry`   Output the expiry of the BOSH director\'s NATS certificate\n\n### Destroy\n\nTo destroy your Concourse:\n\n```sh\n$ concourse-up destroy <your-project-name>\n```\n\n### Maintain\n\nHandles maintenance operations in concourse-up\n\n#### Flags\n\nAll flags are optional\n\n- `--renew-nats-cert` Rotate the NATS certificate on the director\n    >Note that the NATS certificate [is hardcoded to expire after 1 year](https://github.com/cloudfoundry/bosh-cli/blob/master/vendor/github.com/cloudfoundry/config-server/types/certificate_generator.go#L171). This command follows [the istructions on bosh.io](https://bosh.io/docs/nats-ca-rotation/) to rotate this certificate. **This operation _will_ cause downtime on your Concourse** as it performs multiple full recreates.\n- `--stage value` Specify a specific stage at which to start the NATS certificate renewal process. If not specified, the stage will be determined automatically. See the following table for details.\n\n    | Stage | Description |\n    |-------|-------------|\n    | 0     | Adding new CA (create-env) |\n    | 1     | Recreating VMs for the first time (recreate) |\n    | 2     | Removing old CA (create-env) |\n    | 3     | Recreating VMs for the second time (recreate) |\n    | 4     | Cleaning up director-creds.yml |\n\n## Self-update\n\nWhen Concourse-up deploys Concourse, it now adds a pipeline to the new Concourse called `concourse-up-self-update`. This pipeline continuously monitors our Github repo for new releases and updates Concourse in place whenever a new version of Concourse-up comes out.\n\nThis pipeline is paused by default, so just unpause it in the UI to enable the feature.\n\n## Upgrading manually\n\nPatch releases of `concourse-up` are compiled, tested and released automatically whenever a new stemcell or component release appears on [bosh.io](https://bosh.io).\n\nTo upgrade your Concourse, grab the [latest release](https://github.com/EngineerBetter/concourse-up/releases/latest) and run `concourse-up deploy <your-project-name>` again.\n\n## Metrics\n\nConcourse-up now automatically deploys Influxdb, Riemann, and Grafana on the web node. You can access Grafana on port 3000 of your regular concourse URL using the same username and password as your Concourse admin user. We put in a default dashboard that tracks\n\n- Build times\n- CPU usage\n- Containers\n- Disk usage\n\n## Credential Management\n\nConcourse-up deploys the [credhub](https://github.com/cloudfoundry-incubator/credhub) service alongside Concourse and configures Concourse to use it. More detail on how credhub integrates with Concourse can be found [here](https://concourse-ci.org/creds.html). You can log into credhub by running `$ eval "$(concourse-up info --env --region $region $deployment)"`.\n\n## Firewall\n\nConcourse-up normally allows incoming traffic from any address to reach your web node. You can use the `--allow-ips` flag to add firewall rules to prevent this.\nFor example to deploy Concourse-up and only allow traffic from your local machine, you could use the command `concourse-up deploy --allow-ips $(dig +short myip.opendns.com @resolver1.opendns.com)`.\n`--allow-ips` takes a comma seperated list of IP addresses or CIDR ranges.\n\n## Estimated Cost\n\nBy default, `concourse-up` deploys to the AWS eu-west-1 (Ireland) region or the GCP europe-west1 (Belgium) region, and uses spot instances for large and xlarge Concourse VMs. The estimated monthly cost is as follows:\n\n### AWS\n\n| Component     | Size             | Count | Price (USD) |\n|---------------|------------------|-------|------------:|\n| BOSH director | t2.small         |     1 |       18.30 |\n| Web Server    | t2.small         |     1 |       18.30 |\n| Worker        | m4.xlarge (spot) |     1 |      ~50.00 |\n| RDS instance  | db.t2.small      |     1 |       28.47 |\n| NAT Gateway   |         -        |     1 |       35.15 |\n| gp2 storage   | 20GB (bosh, web) |     2 |        4.40 |\n| gp2 storage   | 200GB (worker)   |     1 |       22.00 |\n| **Total**     |                  |       |  **176.62** |\n\n### GCP\n\n| Component     | Size                              | Count | Price (USD) |\n|---------------|-----------------------------------|-------|------------:|\n| BOSH director | n1-standard-1                     |     1 |       26.73 |\n| Web Server    | n1-standard-1                     |     1 |       26.73 |\n| Worker        | n1-standard-4 (preemptible)       |     1 |       32.12 |\n| DB instance   | db-g1-small                       |     1 |       27.25 |\n| NAT Gateway   | n1-standard-1                     |     1 |       26.73 |\n| disk storage  | 20GB (bosh, web) + 200GB (worker) |   -   |       40.80 |\n| **Total**     |                                   |       |  **180.35** |\n\n## What it does\n\n`concourse-up` first creates an S3 or GCS bucket to store its own configuration and saves a `config.json` file there.\n\nIt then uses Terraform to deploy the following infrastructure:\n\n- AWS\n  - Key pair\n  - S3 bucket for the blobstore\n  - IAM user that can access the blobstore\n    - IAM access key\n    - IAM user policy\n  - IAM user that can deploy EC2 instances\n    - IAM access key\n    - IAM user policy\n  - VPC\n  - Internet gateway\n  - Route for internet_access\n  - NAT gateway\n  - Route table for private\n  - Subnet for public\n  - Subnet for private\n  - Route table association for private\n  - Route53 record for Concourse\n  - EIP for director, ATC, and NAT\n  - Security groups for director, vms, RDS, and ATC\n  - Route table for RDS\n  - Route table associations for RDS\n  - Subnets for RDS\n  - DB subnet group\n  - DB instance\n- GCP\n  - A DNS A record pointing to the ATC IP\n  - A Compute route for the nat instance\n  - A Compute instance for the nat\n  - A Compute network\n  - Public and Private Compute subnetworks\n  - Compute firewalls for director, nat, atc-one, atc-two, vms, atc-three, internal, and sql\n  - A Service account for for bosh\n  - A Service account key for bosh\n  - A Project iam member for bosh\n  - Compute addresses for the ATC and Director\n  - A Sql database instance\n  - A Sql database\n  - A Sql user\n\nOnce the terraform step is complete, `concourse-up` deploys a BOSH director on an t2.small/n1-standard-1 instance, and then uses that to deploy a Concourse with the following settings:\n\n- One t2.small/n1-standard-1 for the Concourse web server\n- One m4.xlarge [spot](https://aws.amazon.com/ec2/spot/)/n1-standard-4 [preemptible](https://cloud.google.com/preemptible-vms/) instance used as a Concourse worker\n- Access via over HTTP and HTTPS using a user-provided certificate, or an auto-generated self-signed certificate if one isn\'t provided.\n\n## Using a dedicated AWS IAM account\n\nIf you\'d like to run concourse-up with it\'s own IAM account, create a user with the following permissions:\n\n![](http://i.imgur.com/Q0mOUjv.png)\n\n## Using a dedicated GCP IAM member\n\nA IAM Primitive role of `roles/owner` for the target GCP Project is required\n\n## Project\n\n[CI Pipeline](https://ci.engineerbetter.com/teams/main/pipelines/concourse-up) (deployed with Concourse Up!)\n\n## Development\n\n### Pre-requisites\n\nTo build and test you\'ll need:\n\n- Golang 1.11+\n- to have installed `github.com/mattn/go-bindata`\n\n### Building locally\n\n`concourse-up` uses [golang compile-time variables](https://github.com/golang/go/wiki/GcToolchainTricks#including-build-information-in-the-executable) to set the release versions it uses. To build locally use the `build_local.sh` script, rather than running `go build`.\n\nYou will also need to clone [`concourse-up-ops`](https://github.com/EngineerBetter/concourse-up-ops) to the same level as `concourse-up` to get the manifest and ops files necessary for building. Check the latest release of `concourse-up` for the appropriate tag of `concourse-up-ops`\n\n### Tests\n\nTests use the [Ginkgo](https://onsi.github.io/ginkgo/) Go testing framework. The tests require you to have set up AWS authentication locally.\n\nInstall ginkgo and run the tests with:\n\n```sh\ngo get github.com/onsi/ginkgo/ginkgo\nginkgo -r\n```\n\n```sh\n$ go get github.com/onsi/ginkgo/ginkgo\n$ ginkgo -r\n```\n\nGo linting, shell linting, and unit tests can be run together in the same docker image CI uses with `./run_tests_local.sh`. This should be done before committing or raising a PR.\n\n### Bumping Manifest/Ops File versions\n\nThe pipeline listens for new patch or minor versions of `manifest.yml` and `ops/versions.json` coming from the `concourse-up-ops` repo. In order to pick up a new major version first make sure it exists in the repo then modify `tag_filter: X.*.*` in the `concourse-up-ops` resource where `X` is the major version you want to pin to.\n'