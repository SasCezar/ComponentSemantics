b'[terraform]: https://terraform.io\n[oci]: https://cloud.oracle.com/cloud-infrastructure\n[oci provider]: https://github.com/oracle/terraform-provider-oci/releases\n[API signing]: https://docs.us-phoenix-1.oraclecloud.com/Content/API/Concepts/apisigningkey.htm\n[Kubectl]: https://kubernetes.io/docs/tasks/tools/install-kubectl/\n\n# Terraform Kubernetes Installer for Oracle Cloud Infrastructure\n\n[![wercker status](https://app.wercker.com/status/7dd9fa20b980673dc0e252961950f590/s/master "wercker status")](https://app.wercker.com/project/byKey/7dd9fa20b980673dc0e252961950f590)\n\n## About\n\nThe Kubernetes Installer for Oracle Cloud Infrastructure provides a Terraform-based Kubernetes installation for Oracle \nCloud Infrastructure. It consists of a set of [Terraform][terraform] modules and an example base configuration that is \nused to provision and configure the resources needed to run a highly available and configurable Kubernetes cluster on [Oracle Cloud Infrastructure][oci] (OCI).\n\n\n## Cluster Overview\n\nTerraform is used to _provision_ the cloud infrastructure and any required local resources for the Kubernetes cluster including:\n\n#### OCI Infrastructure\n\n- Virtual Cloud Network (VCN) with dedicated subnets for etcd, masters, and workers in each availability domain\n- Dedicated compute instances for etcd, Kubernetes master and worker nodes in each availability domain\n- [Public or Private](./docs/input-variables.md#network-access-configuration) TCP/SSL OCI Load Balancer to distribute traffic to the Kubernetes Master(s)\n- [Public or Private](./docs/input-variables.md#network-access-configuration) TCP/SSL OCI Load Balancer to distribute traffic to the node(s) in the etcd cluster\n- [Optional](./docs/input-variables.md#private-network-access) NAT instance for Internet-bound traffic on any private subnets\n- 2048-bit SSH RSA Key-Pair for compute instances when not overridden by `ssh_private_key` and `ssh_public_key_openssh` [input variables](./docs/input-variables.md#tls-certificates--ssh-key-pair)\n- Self-signed CA and TLS cluster certificates when not overridden by the [input variables](./docs/input-variables.md#tls-certificates--ssh-key-pair) `ca_cert`, `ca_key`, etc.\n\n#### Cluster Configuration\n\nTerraform uses cloud-init scripts to handle the instance-level _configuration_ for instances in the Control Plane to \nconfigure:\n\n- Highly Available (HA) Kubernetes master configuration\n- Highly Available (HA) etcd cluster configuration\n- Optional [GPU support](./docs/gpu-workers.md) for worker nodes that need to run specific workloads\n- Kubernetes Dashboard and kube-DNS cluster add-ons\n- Kubernetes RBAC (role-based authorization control)\n- Integration with OCI [Cloud Controller Manager](https://github.com/oracle/oci-cloud-controller-manager) (CCM)\n- Integration with OCI [Flexvolume Driver](https://github.com/oracle/oci-flexvolume-driver)\n\nThe Terraform scripts also accept a number of other [input variables](./docs/input-variables.md) to choose instance shapes (including GPU) and how they are placed across the availability domain (ADs), etc. If your requirements extend beyond the base configuration, the modules can be used to form your own customized configuration.\n\n![](./docs/images/arch.jpg)\n\n## Prerequisites\n\n1. Download and install [Terraform][terraform] (v0.10.3 or later)\n2. Download and install the [OCI Terraform Provider][oci provider] (v2.0.0 or later)\n3. Create an Terraform configuration file at  `~/.terraformrc` that specifies the path to the OCI provider:\n```\nproviders {\n  oci = "<path_to_provider_binary>/terraform-provider-oci"\n}\n```\n4.  Ensure you have [Kubectl][Kubectl] installed if you plan to interact with the cluster locally\n\n###### Optionally create separate IAM resources for OCI plugins\n\nThe OCI [Cloud Controller Manager (CCM)](https://github.com/oracle/oci-cloud-controller-manager) and [Volume Provisioner (VP)](https://github.com/oracle/oci-volume-provisioner) enables Kubernetes to dynamically provision OCI resources such as Load Balancers and Block Volumes as a part of pod and service creation. In order to facilitate this, OCI credentials and OCID information are automatically stored in the cluster as a Kubernetes Secret.\n\nBy default, the credentials of the user creating the cluster is used. However, in some cases, it makes sense to use a more restricted set of credentials whose policies are limited to a particular set of resources within the compartment.\n\nTo Terraform separate IAM users, groups, and policy resources, run the `terraform plan` and `terraform apply` commands from the `identity` directory and set the appropriate [input variables](./docs/input-variables.md#mandatory-input-variables) relating to your custom users, fingerprints, and key paths.\n\n## Quick start\n\n### Customize the configuration\n\nCreate a _terraform.tfvars_ file in the project root that specifies your configuration.\n\n```bash\n# start from the included example\n$ cp terraform.example.tfvars terraform.tfvars\n```\n\n* Set [mandatory](./docs/input-variables.md#mandatory-input-variables) OCI input variables relating to your tenancy, user, and compartment.\n* Override [optional](./docs/input-variables.md#optional-input-variables) input variables to customize the default configuration.\n\n### Deploy the cluster\n\nInitialize Terraform:\n\n```\n$ terraform init\n``` \n\nView what Terraform plans do before actually doing it:\n\n```\n$ terraform plan\n```\n\nUse Terraform to Provision resources and stand-up k8s cluster on OCI:\n\n```\n$ terraform apply\n```\n\n### Access the cluster\n\nThe Kubernetes cluster will be running after the configuration is applied successfully and the cloud-init scripts have been given time to finish asynchronously. Typically, this takes around 5 minutes after `terraform apply` and will vary depending on the overall configuration, instance counts, and shapes.\n\nA working kubeconfig can be found in the `./generated` folder or generated on the fly using the `kubeconfig` Terraform output variable.\n\nYour network access settings determine whether your cluster is accessible from the outside. See [Accessing the Cluster](./docs/cluster-access.md) for more details.\n\n#### Verify the cluster:\n\nIf you\'ve chosen to configure a public cluster, you can do a quick and automated verification of your cluster from \nyour local machine by running the `cluster-check.sh` located in the `scripts` directory.  Note that this script requires your KUBECONFIG environment variable to be set (above), and SSH and HTTPs access to be open to etcd and worker nodes.\n\nTo temporarily open access SSH and HTTPs access for `cluster-check.sh`, add the following to your `terraform.tfvars` file:\n\n```bash\n# warning: 0.0.0.0/0 is wide open. remember to undo this.\netcd_ssh_ingress = "0.0.0.0/0"\nmaster_ssh_ingress = "0.0.0.0/0"\nworker_ssh_ingress = "0.0.0.0/0"\nmaster_https_ingress = "0.0.0.0/0"\nworker_nodeport_ingress = "0.0.0.0/0"\n```\n\n```bash\n$ scripts/cluster-check.sh\n```\n```\n[cluster-check.sh] Running some basic checks on Kubernetes cluster....\n[cluster-check.sh]   Checking ssh connectivity to each node...\n[cluster-check.sh]   Checking whether instance bootstrap has completed on each node...\n[cluster-check.sh]   Checking Flannel\'s etcd key from each node...\n[cluster-check.sh]   Checking whether expected system services are running on each node...\n[cluster-check.sh]   Checking status of /healthz endpoint at each k8s master node...\n[cluster-check.sh]   Checking status of /healthz endpoint at the LB...\n[cluster-check.sh]   Running \'kubectl get nodes\' a number of times through the master LB...\n\nThe Kubernetes cluster is up and appears to be healthy.\nKubernetes master is running at https://129.146.22.175:443\nKubeDNS is running at https://129.146.22.175:443/api/v1/proxy/namespaces/kube-system/services/kube-dns\nkubernetes-dashboard is running at https://129.146.22.175:443/ui\n```\n\n### Deploy a simple load-balanced application with shared volumes\n\nCheck out the [example application deployment](./docs/example-deployments.md) for a walk through of deploying a simple application that leverages both the Cloud Controller Manager and Flexvolume Driver plugins.\n\n### Scale, upgrade, or delete the cluster\n\nCheck out the [example cluster operations](./docs/examples.md) for details on how to use Terraform to scale, upgrade, replace, or delete your cluster.\n\n## Known issues and limitations\n\n* The OCI Load Balancers that gets created and attached to the VCN when a service of type `--type=LoadBalancer` is an out-of-band change to Terraform. As a result, the cluster\'s VCN will not be able to be destroyed until all services of type `LoadBalancer` have been deleted using `kubectl` or the OCI Console.\n* The OCI Block Volumes that gets created and attached to the workers when persistent volumes are create is also an out-of-band change to Terraform. As a result, the instances will not be able to be destroyed until all persistent volumes have been deleted using `kubectl` or the OCI Console.\n* Scaling or replacing etcd members in or out after the initial deployment is currently unsupported\n* Failover or HA configuration for NAT instance(s) is currently unsupported\n* Resizing the iSCSI volume will delete and recreate the volume\n* GPU Bare Metal instance shapes are currently only available in the Ashburn region and may be limited to specific availability domains\n* Provisioning a _mix_ of GPU-enabled and non-GPU-enabled worker node instance shapes is currently unsupported\n\n## Testing\n\nTests run _automatically_ on every commit to the main branch. Additionally, the tests should be run against any pull-request before it is merged.\n\nSee [Testing](tests/README.md) for details.\n\n## Contributing\n\nThis project is open source. Oracle appreciates any contributions that are made by the open source community.\n\nSee [Contributing](CONTRIBUTING.md) for details.\n'