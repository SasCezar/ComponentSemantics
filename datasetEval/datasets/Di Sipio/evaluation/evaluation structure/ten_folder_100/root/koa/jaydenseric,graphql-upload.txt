b"![graphql-upload logo](https://cdn.jsdelivr.net/gh/jaydenseric/graphql-upload@8.0.0/graphql-upload-logo.svg)\n\n# graphql-upload\n\n[![npm version](https://badgen.net/npm/v/graphql-upload)](https://npm.im/graphql-upload) [![CI status](https://github.com/jaydenseric/graphql-upload/workflows/CI/badge.svg)](https://github.com/jaydenseric/graphql-upload/actions)\n\nMiddleware and an [`Upload` scalar](#class-graphqlupload) to add support for [GraphQL multipart requests](https://github.com/jaydenseric/graphql-multipart-request-spec) (file uploads via queries and mutations) to various Node.js GraphQL servers.\n\n\xe2\x9a\xa0\xef\xb8\x8f Previously published as [`apollo-upload-server`](https://npm.im/apollo-upload-server).\n\n## Support\n\nThe following environments are known to be compatible:\n\n- [Node.js](https://nodejs.org)\n  - v8.10 - v11\n    - CJS\n    - ESM with [`--experimental-modules`](https://nodejs.org/docs/latest-v8.x/api/esm.html#esm_enabling)\n  - v12\n    - CJS\n    - ESM with [`--experimental-modules`](https://nodejs.org/docs/latest-v12.x/api/esm.html#esm_enabling) and [`--es-module-specifier-resolution=node`](https://nodejs.org/docs/latest-v12.x/api/esm.html#esm_customizing_esm_specifier_resolution_algorithm)\n  - v13\n    - CJS\n- [Koa](https://koajs.com)\n  - [`graphql-api-koa`](https://npm.im/graphql-api-koa)\n  - [`koa-graphql`](https://npm.im/koa-graphql)\n  - [`apollo-server-koa`](https://npm.im/apollo-server-koa) (inbuilt)\n- [Express](https://expressjs.com)\n  - [`express-graphql`](https://npm.im/express-graphql)\n  - [`apollo-server-express`](https://npm.im/apollo-server-express) (inbuilt)\n\nSee also [GraphQL multipart request spec server implementations](https://github.com/jaydenseric/graphql-multipart-request-spec#server).\n\n## Setup\n\nSetup is necessary if your environment doesn\xe2\x80\x99t feature this package inbuilt (see **_[Support](#support)_**).\n\nTo install [`graphql-upload`](https://npm.im/graphql-upload) and the [`graphql`](https://npm.im/graphql) peer dependency from [npm](https://npmjs.com) run:\n\n```shell\nnpm install graphql-upload graphql\n```\n\nUse the [`graphqlUploadKoa`](#function-graphqluploadkoa) or [`graphqlUploadExpress`](#function-graphqluploadexpress) middleware just before GraphQL middleware. Alternatively, use [`processRequest`](#function-processrequest) to create custom middleware.\n\nA schema built with separate SDL and resolvers (e.g. using [`makeExecutableSchema`](https://apollographql.com/docs/graphql-tools/generate-schema#makeExecutableSchema)) requires the [`Upload` scalar](#class-graphqlupload) to be setup.\n\n## Usage\n\n[Clients implementing the GraphQL multipart request spec](https://github.com/jaydenseric/graphql-multipart-request-spec#client) upload files as [`Upload` scalar](#class-graphqlupload) query or mutation variables. Their resolver values are promises that resolve [file upload details](#type-fileupload) for processing and storage. Files are typically streamed into cloud storage but may also be stored in the filesystem.\n\nSee the [example API and client](https://github.com/jaydenseric/apollo-upload-examples).\n\n### Tips\n\n- The process must have both read and write access to the directory identified by [`os.tmpdir()`](https://nodejs.org/api/os.html#os_os_tmpdir).\n- The device requires sufficient disk space to buffer the expected number of concurrent upload requests.\n- Promisify and await file upload streams in resolvers or the server will send a response to the client before uploads are complete, causing a disconnect.\n- Handle file upload promise rejection and stream errors; uploads sometimes fail due to network connectivity issues or impatient users disconnecting.\n- Process multiple uploads asynchronously with [`Promise.all`](https://developer.mozilla.org/docs/web/javascript/reference/global_objects/promise/all) or a more flexible solution where an error in one does not reject them all.\n- Only use [`createReadStream()`](#type-fileupload) _before_ the resolver returns; late calls (e.g. in an unawaited async function or callback) throw an error. Existing streams can still be used after a response is sent, although there are few valid reasons for not awaiting their completion.\n- Use [`stream.destroy()`](https://nodejs.org/api/stream.html#stream_readable_destroy_error) when an incomplete stream is no longer needed, or temporary files may not get cleaned up.\n\n## Architecture\n\nThe [GraphQL multipart request spec](https://github.com/jaydenseric/graphql-multipart-request-spec) allows a file to be used for multiple query or mutation variables (file deduplication), and for variables to be used in multiple places. GraphQL resolvers need to be able to manage independent file streams. As resolvers are executed asynchronously, it\xe2\x80\x99s possible they will try to process files in a different order than received in the multipart request.\n\n[`busboy`](https://npm.im/busboy) parses multipart request streams. Once the `operations` and `map` fields have been parsed, [`Upload` scalar](#class-graphqlupload) values in the GraphQL operations are populated with promises, and the operations are passed down the middleware chain to GraphQL resolvers.\n\n[`fs-capacitor`](https://npm.im/fs-capacitor) is used to buffer file uploads to the filesystem and coordinate simultaneous reading and writing. As soon as a file upload\xe2\x80\x99s contents begins streaming, its data begins buffering to the filesystem and its associated promise resolves. GraphQL resolvers can then create new streams from the buffer by calling [`createReadStream()`](#type-fileupload). The buffer is destroyed once all streams have ended or closed and the server has responded to the request. Any remaining buffer files will be cleaned when the process exits.\n\n## API\n\n### Table of contents\n\n- [class GraphQLUpload](#class-graphqlupload)\n- [function graphqlUploadExpress](#function-graphqluploadexpress)\n- [function graphqlUploadKoa](#function-graphqluploadkoa)\n- [function processRequest](#function-processrequest)\n- [type FileUpload](#type-fileupload)\n- [type GraphQLOperation](#type-graphqloperation)\n- [type ProcessRequestFunction](#type-processrequestfunction)\n- [type ProcessRequestOptions](#type-processrequestoptions)\n\n### class GraphQLUpload\n\nA GraphQL `Upload` scalar that can be used in a [`GraphQLSchema`](https://graphql.org/graphql-js/type/#graphqlschema). It\xe2\x80\x99s value in resolvers is a promise that resolves [file upload details](#type-fileupload) for processing and storage.\n\n#### Examples\n\n_Setup for a schema built with [`makeExecutableSchema`](https://apollographql.com/docs/graphql-tools/generate-schema#makeExecutableSchema)._\n\n> ```js\n> const { makeExecutableSchema } = require('graphql-tools')\n> const { GraphQLUpload } = require('graphql-upload')\n>\n> const schema = makeExecutableSchema({\n>   typeDefs: /* GraphQL */ `\n>     scalar Upload\n>   `,\n>   resolvers: {\n>     Upload: GraphQLUpload\n>   }\n> })\n> ```\n\n_A manually constructed schema with an image upload mutation._\n\n> ```js\n> const {\n>   GraphQLSchema,\n>   GraphQLObjectType,\n>   GraphQLBoolean\n> } = require('graphql')\n> const { GraphQLUpload } = require('graphql-upload')\n>\n> const schema = new GraphQLSchema({\n>   mutation: new GraphQLObjectType({\n>     name: 'Mutation',\n>     fields: {\n>       uploadImage: {\n>         description: 'Uploads an image.',\n>         type: GraphQLBoolean,\n>         args: {\n>           image: {\n>             description: 'Image file.',\n>             type: GraphQLUpload\n>           }\n>         },\n>         async resolve(parent, { image }) {\n>           const { filename, mimetype, createReadStream } = await image\n>           const stream = createReadStream()\n>           // Promisify the stream and store the file, then\xe2\x80\xa6\n>           return true\n>         }\n>       }\n>     }\n>   })\n> })\n> ```\n\n---\n\n### function graphqlUploadExpress\n\nCreates [Express](https://expressjs.com) middleware that processes [GraphQL multipart requests](https://github.com/jaydenseric/graphql-multipart-request-spec) using [`processRequest`](#function-processrequest), ignoring non-multipart requests. It sets the request body to be [similar to a conventional GraphQL POST request](#type-graphqloperation) for following GraphQL middleware to consume.\n\n| Parameter | Type | Description |\n| :-- | :-- | :-- |\n| `options` | [ProcessRequestOptions](#type-processrequestoptions) | Middleware options. Any [`ProcessRequestOptions`](#type-processrequestoptions) can be used. |\n| `options.processRequest` | [ProcessRequestFunction](#type-processrequestfunction)? = [processRequest](#function-processrequest) | Used to process [GraphQL multipart requests](https://github.com/jaydenseric/graphql-multipart-request-spec). |\n\n**Returns:** Function \xe2\x80\x94 Express middleware.\n\n#### Examples\n\n_Basic [`express-graphql`](https://npm.im/express-graphql) setup._\n\n> ```js\n> const express = require('express')\n> const graphqlHTTP = require('express-graphql')\n> const { graphqlUploadExpress } = require('graphql-upload')\n> const schema = require('./schema')\n>\n> express()\n>   .use(\n>     '/graphql',\n>     graphqlUploadExpress({ maxFileSize: 10000000, maxFiles: 10 }),\n>     graphqlHTTP({ schema })\n>   )\n>   .listen(3000)\n> ```\n\n---\n\n### function graphqlUploadKoa\n\nCreates [Koa](https://koajs.com) middleware that processes [GraphQL multipart requests](https://github.com/jaydenseric/graphql-multipart-request-spec) using [`processRequest`](#function-processrequest), ignoring non-multipart requests. It sets the request body to be [similar to a conventional GraphQL POST request](#type-graphqloperation) for following GraphQL middleware to consume.\n\n| Parameter | Type | Description |\n| :-- | :-- | :-- |\n| `options` | [ProcessRequestOptions](#type-processrequestoptions) | Middleware options. Any [`ProcessRequestOptions`](#type-processrequestoptions) can be used. |\n| `options.processRequest` | [ProcessRequestFunction](#type-processrequestfunction)? = [processRequest](#function-processrequest) | Used to process [GraphQL multipart requests](https://github.com/jaydenseric/graphql-multipart-request-spec). |\n\n**Returns:** Function \xe2\x80\x94 Koa middleware.\n\n#### Examples\n\n_Basic [`graphql-api-koa`](https://npm.im/graphql-api-koa) setup._\n\n> ```js\n> const Koa = require('koa')\n> const bodyParser = require('koa-bodyparser')\n> const { errorHandler, execute } = require('graphql-api-koa')\n> const { graphqlUploadKoa } = require('graphql-upload')\n> const schema = require('./schema')\n>\n> new Koa()\n>   .use(errorHandler())\n>   .use(bodyParser())\n>   .use(graphqlUploadKoa({ maxFileSize: 10000000, maxFiles: 10 }))\n>   .use(execute({ schema }))\n>   .listen(3000)\n> ```\n\n---\n\n### function processRequest\n\nProcesses a [GraphQL multipart request](https://github.com/jaydenseric/graphql-multipart-request-spec). Errors are created with [`http-errors`](https://npm.im/http-errors) to assist in sending responses with appropriate HTTP status codes. Used in [`graphqlUploadExpress`](#function-graphqluploadexpress) and [`graphqlUploadKoa`](#function-graphqluploadkoa) and can be used to create custom middleware.\n\n**Type:** [ProcessRequestFunction](#type-processrequestfunction)\n\n#### Examples\n\n_How to import._\n\n> ```js\n> const { processRequest } = require('graphql-upload')\n> ```\n\n---\n\n### type FileUpload\n\nFile upload details, resolved from an [`Upload` scalar](#class-graphqlupload) promise.\n\n**Type:** object\n\n| Property | Type | Description |\n| :-- | :-- | :-- |\n| `filename` | string | File name. |\n| `mimetype` | string | File MIME type. Provided by the client and can\xe2\x80\x99t be trusted. |\n| `encoding` | string | File stream transfer encoding. |\n| `createReadStream` | Function | Returns a Node.js readable stream of the file contents, for processing and storing the file. Multiple calls create independent streams. Throws if called after all resolvers have resolved, or after an error has interrupted the request. |\n\n---\n\n### type GraphQLOperation\n\nA GraphQL operation object in a shape that can be consumed and executed by most GraphQL servers.\n\n**Type:** object\n\n| Property | Type | Description |\n| :-- | :-- | :-- |\n| `query` | string | GraphQL document containing queries and fragments. |\n| `operationName` | string\xc2\xa0\\|\xc2\xa0`null`? | GraphQL document operation name to execute. |\n| `variables` | object\xc2\xa0\\|\xc2\xa0`null`? | GraphQL document operation variables and values map. |\n\n#### See\n\n- [GraphQL over HTTP spec](https://github.com/APIs-guru/graphql-over-http#request-parameters).\n- [Apollo Server POST requests](https://www.apollographql.com/docs/apollo-server/requests#postRequests).\n\n---\n\n### type ProcessRequestFunction\n\nProcesses a [GraphQL multipart request](https://github.com/jaydenseric/graphql-multipart-request-spec).\n\n**Type:** Function\n\n| Parameter | Type | Description |\n| :-- | :-- | :-- |\n| `request` | IncomingMessage | [Node.js HTTP server request instance](https://nodejs.org/api/http.html#http_class_http_incomingmessage). |\n| `response` | ServerResponse | [Node.js HTTP server response instance](https://nodejs.org/api/http.html#http_class_http_serverresponse). |\n| `options` | [ProcessRequestOptions](#type-processrequestoptions)? | Options for processing the request. |\n\n**Returns:** Promise&lt;[GraphQLOperation](#type-graphqloperation)\xc2\xa0|\xc2\xa0Array&lt;[GraphQLOperation](#type-graphqloperation)>> \xe2\x80\x94 GraphQL operation or batch of operations for a GraphQL server to consume (usually as the request body).\n\n---\n\n### type ProcessRequestOptions\n\nOptions for processing a [GraphQL multipart request](https://github.com/jaydenseric/graphql-multipart-request-spec); mostly relating to security, performance and limits.\n\n**Type:** object\n\n| Property | Type | Description |\n| :-- | :-- | :-- |\n| `maxFieldSize` | number? = `1000000` | Maximum allowed non-file multipart form field size in bytes; enough for your queries. |\n| `maxFileSize` | number? = Infinity | Maximum allowed file size in bytes. |\n| `maxFiles` | number? = Infinity | Maximum allowed number of files. |\n"