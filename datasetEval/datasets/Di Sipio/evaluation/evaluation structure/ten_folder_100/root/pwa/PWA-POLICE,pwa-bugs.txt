b'# PWA Bugs\nThis is a general repo for PWA bugs in all browsers, likely most of them will be about iOS (Web.app)\n\n- [Android WebView](#android-webview)\n  * [Problem: different User Agent for different request](#problem-different-user-agent-for-different-request)\n- [Firefox, Android](#firefox-android)\n  * [Problem: Cross-origin redirects for `<img />` tag cause Firefox to open Custom Tab browser](#problem-cross-origin-redirects-for-img--tag-cause-firefox-to-open-custom-tab-browser)\n- [iOS Safari](#ios-safari)\n  * [Problem: in iOS 12 cache in Cache Storage magically disappears](#problem-in-ios-12-cache-in-cache-storage-magically-disappears)\n  * [Problem: Cookie/Login isn\'t shared between Safari and standalone mode](#problem-cookielogin-isnt-shared-between-safari-and-standalone-mode)\n  * [Problem: Cross domain authorization in standalone mode doesn\'t work](#problem-cross-domain-authorization-in-standalone-mode-doesnt-work)\n  * [Problem: Sometimes PWA is added in normal mode and not standalone mode](#problem-sometimes-pwa-is-added-in-normal-mode-and-not-standalone-mode)\n  * [Problem: PWA is added without a splashscreen](#problem-pwa-is-added-without-a-splashscreen)\n  * [Problem: Navigation to a website has infinite loading](#problem-navigation-to-a-website-has-infinite-loading)\n  * [Problem: Push Notifications are not supported](#problem-push-notifications-are-not-supported)\n- [Android](#android)\n  * [Problem: No migration on new Android phone](#problem-no-migration-on-new-android-phone)\n  \n## Android WebView\n\n### Problem: different User Agent for different request\n\nIn some browsers with Android WebView, e.g. Opera Mini or UC Browser (Mini?), browser sends different User Agent strings for different request.\n\nTo be precise, when ServiceWorker is used and in `\'fetch\'` listener you do `e.respondWith(fetch(e.request))` for navigation requests, it send original WebView User Agent. But for all subsequent requests, it send custom User Agent which was set by the browser\'s code.\n\nDoing or not doing `e.respondWith(fetch(e.request))` for non-navigation requests doesn\'t change anything. The only solution is to stop handling navigation requests in ServiceWorker (or `\'fetch\'` event at all).\n\n## Firefox, Android\n\n### Problem: Cross-origin redirects for `<img />` tag cause Firefox to open Custom Tab browser\n\nBug Report: https://bugzilla.mozilla.org/show_bug.cgi?id=1515789\n\nStatus: Fix will be shipped in FF67\n\nCross-origin redirects for `<img />` tag cause Firefox to open Custom Tab browser, just like if Cross Origin navigation happen.\n\nSo for example if you have bunch of images request this way on a page, e.g. 100 image, Firefox will open 100 Custom Tabs for your PWA.\n\n## iOS Safari\n\nWeb App Manfest and ServiceWorker API are supported on iOS since 11.3.  \nReference: https://twitter.com/rmondello/status/956256845311590400\n\n### Problem: in iOS 12 cache in Cache Storage magically disappears\n\nWebKit Bug: https://bugs.webkit.org/show_bug.cgi?id=190269\n\n**Solution:**\n\nThis bug makes Cache Storage persist only until user closes Safari (or it\'s unloaded from memory).\nBasically, the cache is some temporary place and is erased when Safari is closed.\nThere is really no workaround around this. It causes this situation.\n\n- User visits a website\n- ServiceWorker caches everything\n- User closes Safari\n- User visits a website again while offline\n- Nothing loads\n\nIt also affects websites in standalone mode.\n**This bug also prevents Safari from sharing the cache between standalone mode and normal Safari mode.**\n\n\n### Problem: Cookie/Login isn\'t shared between Safari and standalone mode\n\nProblem is in all iOS version.\n\n**Solution:**\n\nAt the time of writing (iOS 12.0.1), there is only couple version of Safari where the workaround works.\n\nThe workaround is to transfer a session through Cache Storage API, which has shared cache in some Safari versions.  \nApproximately how the workaround works:\n\n- User visits a website\n- User opens the Share Popup to add website to the homescreen\n- When popup opens, Safari sends `destination=\'manifeset\'` request to the server\n- ServiceWorker intercepts the requests and send another to the server to generate temporary token\n- ServiceWorker stores the token in special cache in Cache Storage API\n- User taps "Add to Homescreen"\n- User opens website from the homescreen\n- ServiceWorker intercepts the opening and send another request to the server with the saved token\n- Server checks the token and authorizes the user\n- ServiceWorker allows navigation to finish\n- User is automatically authorized in standalone mode\n\nNow gotchas.\n\nIt works only in iOS 11.4.1 though. It\'s broken in iOS 12 and iOS 12.0.1, but supposed to be fixed in the next version.\nWebKit Bug for iOS 12: https://bugs.webkit.org/show_bug.cgi?id=190269\n\nEven though ServiceWorker was introduces in iOS 11.3, it\'s unknown if anything prior 11.4.1 can support this.\nIt either just doesn\'t work in iOS Emulator at all or doesn\'t work prioer 11.4.1 (latest 11 emulator version is 11.4.0).\n\nTested on real devices with these versions: \n- 11.4.1 -- works\n- 12.0.0 -- doesn\'t work\n- 12.0.1 -- doesn\'t work\n\n### Problem: Cross domain authorization in standalone mode doesn\'t work\n\nThis issue happens since 11.3 when Web App Manifest is used.  \niOS requires `scope` property in Web App Manifest to determine which URLs allowed to be opened in standalone mode and which are not. When user website navigates to any URL outside of the scope (this includes any URL with different domain) -- it drops the navigation from standalone mode and opens it in Safari. This makes cross-domain authorization impossible.\n\n**Solution:**\n\nUse the iframe. \n\nLet\'s suppose there is a foo.com website and its login is on login.foo.com  \nHere is approximately how this can be solved:\n\n- Authorization request is sent to `foo.com`\n- ServiceWorker intercepts this request and cloned request to the server, with `redirect: \'manual\'`\n- ServiceWorker tells the page to create `<iframe>` and request a fake url\n- ServiceWorker responds to the `<iframe>` fake url request with the response from syntetic request from the step 2\n- `<iframe>` handles the response. The response must have a redirect \n- ServiceWorker intercepts the redirect from `<iframe>` and send another cloned request with `redirect: \'manual\'`\n- If type of the response is `basic`, the send the response to original authorization from the step 1\n- If type of the response is `opaqueredirect`, repeat the steps from step 3\n\n### Problem: Sometimes PWA is added in normal mode and not standalone mode\n_(like there is no manifest at all)_\n\nReference: https://twitter.com/nekrtemplar/status/1040282198044291072\n\nSafari fetches the manifest only when user is about to add the website to homescreen.\nTo be preceice, manifest is fetched exactly when Share Popup is opened.\n\nSo if user performs all the steps very fast: 1) Open popup; 2) Tap "Add to Home Screen"; 3) Tap "Add" on the adding popup;\nThen in some cases the manifest might be fetched yet, so website will be added like there is no manifest.\n\n**Solution:**\n\nThankfully, when Safari fetches the manifest,\nthat request goes to the ServiceWorker with `request.destination` being `manifest`, as per spec.\nThis means that it\'s possible to intercept such request and return manifest contents from the cache.\nSo the solution would be to precache the manifest on ServiceWorker `install` and serve it to the browser from the cache.\n\n\n### Problem: PWA is added without a splashscreen\n\nEven if all correct splashscreen elements are added to the page, after adding the website to the home screen,\nit may not have the splashscreen. \n\n**Solution:**\n\nWhen website is added only with Web App Manifest, Safari doesn\'t not take splashscreen elements into the account. The solution would be adding `<meta name="apple-mobile-web-app-capable" content="yes">` element to the page alongside with the manifest.\n\n_**Note:** It might be better adding `apple-mobile-web-app-capable` dynamically and only when in browser mode.\nWhen in standalone mode, it may affects URLs behavior since Web App Manifest installed PWA and `apple-mobile-web-app-capable`\ninstalled PWA have different URL behavior on iOS._\n\n### Problem: Navigation to a website has infinite loading\n\nIf update of a ServiceWorker happens when there is a page navigation in-flight and ServiceWorker `install` event resolves\nsooner than the navigation page is finished loading, then Safari kills old ServiceWorker immediately even without calling `self.skipWaiting()` and that break loading on the page and hence it never loads.\n\n**Solution:**\n\nCheck for navigation requests when `install` event happens and do not resolve the promise if there are any. When page loads, send message to the installing ServiceWorker that it may try again to resolve the installation promise (check again for navigation request, repeat all the steps until no navigation requests, then resolve the promise).\n\n### Problem: Push Notifications are not supported\n\nBoth Push subscription (Push API) and displaying notifications (Notifications API) are not supported in iOS. There is no pushManager in ServiceWorker registration object - so don\'t forget to do a feature detection in your code.\n\n**Solution:**\n\nThere is no good workaround/polyfill as this feature fully depends on the 3rd party Messaging Service infrastructure (Apple Push Notifications Service in that case) which is not supporting the standartized (VAPID, Push API, Notifications API) way to subscribe for/receive/display notifications. There are no signals from Apple/Safari about this feature is under consideration/development. There is a Twitter thread with discussing the possible solution to have a kind of notifications on iOS: https://twitter.com/webmaxru/status/1034882612978966528. Some outcomes:\n- For Safari on Mac you can set up Push notifications using a proprietary implementation: https://developer.apple.com/notifications/safari-push-notifications/\n- The working (but cumbersome) solution is to wrap your PWA app into a native iOS one using, for example, Cordova.\n- The closest (but still not a "real") pure web solution is to set up a PassBook that can receive push. But this way your notifications are disconnected from the app itself.\n\n## Android\n\n### Problem: No migration on new Android phone\n\nWhen migrating to another Android device all native apps are moved to the new one but none of the PWAs. On the new device for the PWAs there where just empty icons and if clicked on them you could search for the PWA in the Play Store :( Even the top PWAs like Twitter Lite have this problem. \n'