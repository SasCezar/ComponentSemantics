b'= DeviseInvitable\n{<img src="https://badge.fury.io/rb/devise_invitable.svg"/>}[http://badge.fury.io/rb/devise_invitable] {<img src="https://travis-ci.org/scambra/devise_invitable.svg"/>}[https://travis-ci.org/scambra/devise_invitable] {<img src="https://codeclimate.com/github/scambra/devise_invitable/badges/gpa.svg"/>}[https://codeclimate.com/github/scambra/devise_invitable]\n\nIt adds support to Devise[https://github.com/plataformatec/devise] for sending invitations by email (it requires to be authenticated) and accept the invitation setting the password.\n\n== Requirements\n\nThe latest version of DeviseInvitable works with Devise >= 4.6.\n\nIf you want to use devise_invitable with earlier Devise releases (4.0 <= x < 4.6), use version 1.7.5.\n\n== Installation\n\nInstall DeviseInvitable gem:\n\n  gem install devise_invitable\n\nAdd DeviseInvitable to your Gemfile:\n\n  gem \'devise_invitable\', \'~> 2.0.0\'\n\n=== Automatic installation\n\nRun the following generator to add DeviseInvitable\xe2\x80\x99s configuration option in the Devise configuration file (<tt>config/initializers/devise.rb</tt>):\n\n  rails generate devise_invitable:install\n\nWhen you are done, you are ready to add DeviseInvitable to any of your Devise models using the following generator:\n\n  rails generate devise_invitable MODEL\n\nReplace MODEL by the class name you want to add DeviseInvitable, like <tt>User</tt>, <tt>Admin</tt>, etc. This will add the <tt>:invitable</tt> flag to your model\'s Devise modules. The generator will also create a migration file (if your ORM supports them).\n\n=== Manual installation\n\nFollow the walkthrough for Devise and after it\'s done, follow this walkthrough.\n\n== Devise Configuration\nAdd <tt>:invitable</tt> to the <tt>devise</tt> call in your model (we\xe2\x80\x99re assuming here you already have a User model with some Devise modules):\n\n  class User < ActiveRecord::Base\n    devise :database_authenticatable, :confirmable, :invitable\n  end\n\n== ActiveRecord Migration\nAdd <tt>t.invitable</tt> to your Devise model migration:\n\n  create_table :users do\n    ...\n      ## Invitable\n      t.string   :invitation_token\n      t.datetime :invitation_created_at\n      t.datetime :invitation_sent_at\n      t.datetime :invitation_accepted_at\n      t.integer  :invitation_limit\n      t.integer  :invited_by_id\n      t.string   :invited_by_type\n    ...\n  end\n  add_index :users, :invitation_token, unique: true\n\nor for a model that already exists, define a migration to add DeviseInvitable to your model:\n\n  def change\n      add_column :users, :invitation_token, :string\n      add_column :users, :invitation_created_at, :datetime\n      add_column :users, :invitation_sent_at, :datetime\n      add_column :users, :invitation_accepted_at, :datetime\n      add_column :users, :invitation_limit, :integer\n      add_column :users, :invited_by_id, :integer\n      add_column :users, :invited_by_type, :string\n      add_index :users, :invitation_token, unique: true\n  end\n\nIf you previously used devise_invitable with a <tt>:limit</tt> on <tt>:invitation_token</tt>, remove it:\n\n  def up\n    change_column :users, :invitation_token, :string, limit: nil\n  end\n\n  def down\n    change_column :users, :invitation_token, :string, limit: 60\n  end\n\n== Mongoid Field Definitions\nIf you are using Mongoid, define the following fields and indexes within your invitable model:\n\n  field :invitation_token, type: String\n  field :invitation_created_at, type: Time\n  field :invitation_sent_at, type: Time\n  field :invitation_accepted_at, type: Time\n  field :invitation_limit, type: Integer\n\n  index( { invitation_token: 1 }, { background: true} )\n  index( { invitation_by_id: 1 }, { background: true} )\n\nYou do not need to define a <tt>belongs_to</tt> relationship, as DeviseInvitable does this on your behalf:\n  belongs_to :invited_by, polymorphic: true\n\nRemember to create indexes within the MongoDB database after deploying your changes.\n  rake db:mongoid:create_indexes\n\n== Model configuration\n\nDeviseInvitable adds some new configuration options:\n\n* <tt>invite_for</tt>: The period the generated invitation token is valid. After this period, the invited resource won\'t be able to accept the invitation. When <tt>invite_for</tt> is <tt>0</tt> (the default), the invitation won\'t expire.\n\nYou can set this configuration option in the Devise initializer as follow:\n\n  # ==> Configuration for :invitable\n  # The period the generated invitation token is valid.\n  # After this period, the invited resource won\'t be able to accept the invitation.\n  # When invite_for is 0 (the default), the invitation won\'t expire.\n  # config.invite_for = 2.weeks\n\nor directly as parameters to the <tt>devise</tt> method:\n\n  devise :database_authenticatable, :confirmable, :invitable, invite_for: 2.weeks\n\n* <tt>invitation_limit</tt>: The number of invitations users can send. The default value of <tt>nil</tt> means users can send as many invites as they want, there is no limit for any user, <tt>invitation_limit</tt> column is not used.  A setting of <tt>0</tt> means they can\'t send invitations. A setting <tt>n > 0</tt> means they can send <tt>n</tt> invitations. You can change <tt>invitation_limit</tt> column for some users so they can send more or less invitations, even with global <tt>invitation_limit = 0</tt>.\n\n* <tt>invite_key</tt>: The key to be used to check existing users when sending an invitation. You can use multiple keys. This value must be a hash with the invite key as hash keys, and values that respond to the <tt>===</tt> operator (including procs and regexes). The default value is looking for users by email and validating with <tt>Devise.email_regexp</tt>.\n\n* <tt>validate_on_invite</tt>: force a record to be valid before being actually invited.\n\n* <tt>resend_invitation</tt>: resend invitation if user with invited status is invited again. Enabled by default.\n\n* <tt>invited_by_class_name</tt>: the class name of the inviting model. If this is <tt>nil</tt>, polymorphic association is used.\n\n* <tt>invited_by_foreign_key</tt>: the foreign key to the inviting model (only used if <tt>invited_by_class_name</tt> is set, otherwise <tt>:invited_by_id</tt>)\n\n* <tt>invited_by_counter_cache</tt>: the column name used for counter_cache column. If this is <tt>nil</tt> (default value), the <tt>invited_by</tt> association is declared without <tt>counter_cache</tt>.\n\n* <tt>allow_insecure_sign_in_after_accept</tt>: automatically sign in the user after they set a password. Enabled by default.\n\n* <tt>require_password_on_accepting</tt>: require password when user accepts the invitation. Enabled by default. Disable if you don\'t want to ask or enforce to set password while accepting, because is set when user is invited or it will be set later.\n\nFor more details, see <tt>config/initializers/devise.rb</tt> (after you invoked the <tt>devise_invitable:install</tt> generator described above).\n\n== Configuring views\n\nAll the views are packaged inside the gem. If you\'d like to customize the views, invoke the following generator and it will copy all the views to your application:\n\n  rails generate devise_invitable:views\n\nYou can also use the generator to generate scoped views:\n\n  rails generate devise_invitable:views users\n\nThen turn scoped views on in <tt>config/initializers/devise.rb</tt>:\n\n  config.scoped_views = true\n\nPlease refer to {Devise\'s README}[https://github.com/plataformatec/devise] for more information about views.\n\n== Configuring controllers\n\nTo change the controller\'s behavior, create a controller that inherits from <tt>Devise::InvitationsController</tt>. The available methods are: <tt>new</tt>, <tt>create</tt>, <tt>edit</tt>, and <tt>update</tt>. Refer to the {original controllers source}[https://github.com/scambra/devise_invitable/blob/master/app/controllers/devise/invitations_controller.rb] before editing any of these actions. Your controller might now look something like this:\n\n   class Users::InvitationsController < Devise::InvitationsController\n     def update\n       if some_condition\n         redirect_to root_path\n       else\n         super\n       end\n     end\n   end\n\nNow just tell Devise that you want to use your controller, the controller above is <tt>\'users/invitations\'</tt>, so our routes.rb would have this line:\n\n  devise_for :users, controllers: { invitations: \'users/invitations\' }\n\nbe sure that you generate the views and put them into the controller that you generated, so for this example it would be:\n\n  rails generate devise_invitable:views users\n\nTo change behaviour of inviting or accepting users, you can simply override two methods:\n\n  class Users::InvitationsController < Devise::InvitationsController\n    private\n\n      # this is called when creating invitation\n      # should return an instance of resource class\n      def invite_resource\n        # skip sending emails on invite\n        super { |user| user.skip_invitation = true }\n      end\n\n      # this is called when accepting invitation\n      # should return an instance of resource class\n      def accept_resource\n        resource = resource_class.accept_invitation!(update_resource_params)\n        # Report accepting invitation to analytics\n        Analytics.report(\'invite.accept\', resource.id)\n        resource\n      end\n  end\n\n== Strong Parameters\n\nWhen you customize your own views, you may end up adding new attributes to forms. Rails 4 moved the parameter sanitization from the model to the controller, causing DeviseInvitable to handle this concern at the controller as well. Read about it in {Devise README}[https://github.com/plataformatec/devise#strong-parameters]\n\nThere are just two actions in DeviseInvitable that allows any set of parameters to be passed down to the model, therefore requiring sanitization. Their names and the permited parameters by default are:\n\n* <tt>invite</tt> (Devise::InvitationsController#create) - Permits only the authentication keys (like <tt>email</tt>)\n* <tt>accept_invitation</tt> (Devise::InvitationsController#update) - Permits <tt>invitation_token</tt> plus <tt>password</tt> and <tt>password_confirmation</tt>.\n\nHere is an example of what your application controller might need to include in order to add these parameters to the invitation view:\n\n  before_action :configure_permitted_parameters, if: :devise_controller?\n\n  protected\n\n    def configure_permitted_parameters\n      devise_parameter_sanitizer.permit(:accept_invitation, keys: [:first_name, :last_name, :phone])\n    end\n\n\n== Usage\n\n=== Send an invitation\n\nTo send an invitation to a user, use the <tt>invite!</tt> class method. <b>Note: This will create a user, and send an email for the invite.</b> <tt>:email</tt> must be present in the parameters hash. You can also include other attributes in the hash. The record will not be validated.\n\n  User.invite!(email: \'new_user@example.com\', name: \'John Doe\')\n  # => an invitation email will be sent to new_user@example.com\n\nIf you want to create the invitation but not send it, you can set <tt>skip_invitation</tt> to <tt>true</tt>.\n\n  user = User.invite!(email: \'new_user@example.com\', name: \'John Doe\') do |u|\n    u.skip_invitation = true\n  end\n  # => the record will be created, but the invitation email will not be sent\n\nWhen generating the <tt>accept_user_invitation_url</tt> yourself, you must use the <tt>raw_invitation_token</tt>. \nThis value is temporarily available when you invite a user and will be decrypted when received.\n\n  accept_user_invitation_url(invitation_token: user.raw_invitation_token)\n\nWhen <tt>skip_invitation</tt> is used, you must also then set the <tt>invitation_sent_at</tt> field when the user is sent their token. Failure to do so will yield "Invalid invitation token" error when the user attempts to accept the invite.\nYou can set the column, or call <tt>deliver_invitation</tt> to send the invitation and set the column:\n\n  user.deliver_invitation\n\nYou can add <tt>:skip_invitation</tt> to attributes hash if <tt>skip_invitation</tt> is added to <tt>attr_accessible</tt>.\n\n  User.invite!(email: \'new_user@example.com\', name: \'John Doe\', skip_invitation: true)\n  # => the record will be created, but the invitation email will not be sent\n\n<tt>skip_invitation</tt> skips sending the email, but sets <tt>invitation_token</tt>, so <tt>invited_to_sign_up?</tt> on the\nresulting user returns <tt>true</tt>.\n\nTo check if a particular user is created by invitation, irrespective to state of invitation one can use <tt>created_by_invite?</tt>\n\n**Warning**\n\nWhen using <tt>skip_invitation</tt> you must send the email with the user object instance that generated the tokens, as <tt>user.raw_invitation_token</tt> is available only to the instance and is not persisted in the database.\n\nYou can also set <tt>invited_by</tt> when using the <tt>invite!</tt> class method:\n\n  User.invite!({ email: \'new_user@example.com\' }, current_user) # current_user will be set as invited_by\n\n=== Sending an invitation after user creation\n\nYou can send an invitation to an existing user if your workflow creates them separately:\n\n  user = User.find(42)\n  user.invite!(current_user)  # current user is optional to set the invited_by attribute\n\n=== Find by invitation token\n\nTo find by invitation token use the <tt>find_by_invitation_token</tt> class method.\n\n  user = User.find_by_invitation_token(params[:invitation_token], true)\n\n=== Accept an invitation\n\nTo accept an invitation with a token use the <tt>accept_invitation!</tt> class method. <tt>:invitation_token</tt> must be present in the parameters hash. You can also include other attributes in the hash.\n\n  User.accept_invitation!(invitation_token: params[:invitation_token], password: \'ad97nwj3o2\', name: \'John Doe\')\n\n=== Callbacks\n\nA callback event is fired before and after an invitation is created (User#invite!) or accepted (User#accept_invitation!). For example, in your resource model you can add:\n\n  before_invitation_created :email_admins\n  after_invitation_accepted :email_invited_by\n\n  def email_admins\n    # ...\n  end\n\n  def email_invited_by\n    # ...\n  end\n\nThe callbacks support all options and arguments available to the standard callbacks provided by ActiveRecord.\n\n=== Scopes\n\nA pair of scopes to find those users that have accepted, and those that have not accepted, invitations are defined:\n\n  User.invitation_accepted     # => returns all Users for whom the invitation_accepted_at attribute is not nil\n  User.invitation_not_accepted # => returns all Users for whom the invitation_accepted_at attribute is nil\n  User.created_by_invite       # => returns all Users who are created by invitations, irrespective to invitation status\n\n== Integration in a Rails application\n\nSince the invitations controller takes care of all the creation/acceptation of an invitation, in most cases you wouldn\'t call the <tt>invite!</tt> and <tt>accept_invitation!</tt> methods directly.\nInstead, in your views, put a link to <tt>new_user_invitation_path</tt> or <tt>new_invitation_path(:user)</tt> or even <tt>/users/invitation/new</tt> to prepare and send an invitation (to a user in this example).\n\nAfter an invitation is created and sent, the inviter will be redirected to <tt>after_invite_path_for(inviter, invitee)</tt>, which is the same path as <tt>signed_in_root_path</tt> by default.\n\nAfter an invitation is accepted, the invitee will be redirected to <tt>after_accept_path_for(resource)</tt>, which is the same path as <tt>signed_in_root_path</tt> by default. If you want to override the path, override invitations controller and define <tt>after_accept_path_for</tt> method. This is useful in the common case that a user is invited to a specific location in your application. More on {Devise\'s README}[https://github.com/plataformatec/devise], "Controller filters and helpers" section.\n\nThe invitation email includes a link to accept the invitation that looks like this: <tt>/users/invitation/accept?invitation_token=abcd123</tt>. When clicked, the invited must set a password in order to accept its invitation. Note that if the <tt>invitation_token</tt> is not present or not valid, the invited is redirected to <tt>after_sign_out_path_for(resource_name)</tt>.\n\nThe controller sets the <tt>invited_by_id</tt> attribute for the new user to the current user.  This will let you easily keep track of who invited whom.\n\n== Controller filter\n\nInvitationsController uses <tt>authenticate_inviter!</tt> filter to restrict who can send invitations. You can override this method in your <tt>ApplicationController</tt>.\n\nDefault behavior requires authentication of the same resource as the invited one. For example, if your model <tt>User</tt> is invitable, it will allow all authenticated users to send invitations to other users.\n\nYou would have a <tt>User</tt> model which is configured as invitable and an <tt>Admin</tt> model which is not. If you want to allow only admins to send invitations, simply overwrite the <tt>authenticate_inviter!</tt> method as follow:\n\n  class ApplicationController < ActionController::Base\n    protected\n\n      def authenticate_inviter!\n        authenticate_admin!(force: true)\n      end\n  end\n\nAnd include <tt>DeviseInvitable::Inviter</tt> module into <tt>Admin</tt> model:\n\n  class Admin < ActiveRecord::Base\n    devise :database_authenticatable, :validatable\n    include DeviseInvitable::Inviter\n  end\n\n== Has many invitations\n\nIf you want to get all records invited by a resource, you should define <tt>has_many</tt> association in the model allowed to send invitations.\n\nFor the default behavior, define it like this:\n\n  has_many :invitations, class_name: self.to_s, as: :invited_by\n\nFor the previous example, where admins send invitations to users, define it like this:\n\n  has_many :invitations, class_name: \'User\', as: :invited_by\n\n== I18n\n\nDeviseInvitable uses flash messages with I18n with the flash keys <tt>:send_instructions</tt>, <tt>:invitation_token_invalid</tt> and <tt>:updated</tt>. To customize your app, you can modify the generated locale file:\n\n  en:\n    devise:\n      invitations:\n        send_instructions: \'An invitation email has been sent to %{email}.\'\n        invitation_token_invalid: \'The invitation token provided is not valid!\'\n        updated: \'Your password was set successfully. You are now signed in.\'\n        updated_not_active: \'Your password was set successfully.\'\n\nYou can also create distinct messages based on the resource you\'ve configured using the singular name given in routes:\n\n  en:\n    devise:\n      invitations:\n        user:\n          send_instructions: \'A new user invitation has been sent to %{email}.\'\n          invitation_token_invalid: \'Your invitation token is not valid!\'\n          updated: \'Welcome on board! You are now signed in.\'\n          updated_not_active: \'Welcome on board! Sign in to continue.\'\n\nThe DeviseInvitable mailer uses the same pattern as Devise to create mail subject messages:\n\n  en:\n    devise:\n      mailer:\n        invitation_instructions:\n          subject: \'You got an invitation!\'\n          user_subject: \'You got a user invitation!\'\n\nTake a look at the {generated locale file}[https://github.com/scambra/devise_invitable/blob/master/config/locales/en.yml] to check all available messages.\n\nCheck out wiki[https://github.com/scambra/devise_invitable/wiki/I18n] for translations.\n\n=== Use with sub schema\nIf you are using sub schema in you application, you need to make sure that you are prioritizing your sub schema scheme over Warden in Rack.\nFor instance, if you are using the Apartment gem go inside your <tt>config/application.rb</tt> file, add the following lines:\n\n  module YourSite\n    class Application < Rails::Application\n      ...\n      Rails.application.config.middleware.insert_before Warden::Manager, Apartment::Elevators::Subdomain\n    end\n  end\n\n== Other ORMs\n\nDeviseInvitable supports ActiveRecord and Mongoid, like Devise.\n\n== Wiki\n\nIt\'s possible to find additional information about DeviseInvitable on the Wiki:\n\nhttps://github.com/scambra/devise_invitable/wiki\n\n== Testing\n\nTo run tests:\n\n  bundle install\n  bundle exec rake test\n\n== Contributors\n\nCheck them all at:\n\nhttps://github.com/scambra/devise_invitable/contributors\n\nSpecial thanks to rymai[https://github.com/rymai] for the Rails 3 support, his fork was a great help.\n\n== Note on Patches/Pull Requests\n\n* Fork the project.\n* Make your feature addition or bug fix.\n* Add tests for it. This is important so I don\'t break it in a future version unintentionally.\n* Commit, do not mess with rakefile, version, or history. (if you want to have your own version, that is fine but bump version in a commit by itself I can ignore when I pull)\n* Send me a pull request. Bonus points for topic branches.\n\n== Copyright\n\nCopyright (c) 2019 Sergio Cambra. See LICENSE for details.\n'