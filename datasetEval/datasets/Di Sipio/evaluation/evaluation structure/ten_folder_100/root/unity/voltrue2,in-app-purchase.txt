b'![Logo](https://user-images.githubusercontent.com/2267361/42299566-e25ee852-8046-11e8-9cc3-a776770fcc8e.png)\n\n\xc2\xa9Nobuyori Takahashi < <voltrue2@yahoo.com> >\n\n[![Build Status](https://travis-ci.org/voltrue2/in-app-purchase.svg?branch=master)](https://travis-ci.org/voltrue2/in-app-purchase)\n\nA node.js module for in-app purchase (in-app billing) and subscription for Apple, Google Play, Amazon Store, Roku, and Windows.\n\nIt supports Unity receipt also: [Unity Documentation](https://docs.unity3d.com/Manual/UnityIAPValidatingReceipts.html)\n\n**NOTE** Unity receipt supports the following: Apple, Google Play, and Amazon.\n\n## What is new\n\nAs of version `1.10.0`, The module lets you validate Google\'s receipts using Google Service Account also!\n\nThank you for the input [maxs15](https://github.com/maxs15)\n\n## Required node.js version\n\n`0.12.0 >=`\n\n## Online Demo and Documention\n\n<a href="http://iap.gracenode.org" target="_blank">Online Demo</a>\n\n## How to install\n\n```\nnpm install in-app-purchase\n```\n\n## How to use\n\nThe module supports both Promise and callbacks.\n\n```javascript\nvar iap = require(\'in-app-purchase\');\niap.config({\n\n    /* Configurations for HTTP request */\n    requestDefaults: { /* Please refer to the request module documentation here: https://www.npmjs.com/package/request#requestoptions-callback */ },\n\n    /* Configurations for Amazon Store */\n    amazonAPIVersion: 2, // tells the module to use API version 2\n    secret: \'abcdefghijklmnoporstuvwxyz\', // this comes from Amazon\n    // amazonValidationHost: http://localhost:8080/RVSSandbox, // Local sandbox URL for testing amazon sandbox receipts.\n\n    /* Configurations for Apple */\n    appleExcludeOldTransactions: true, // if you want to exclude old transaction, set this to true. Default is false\n    applePassword: \'abcdefg...\', // this comes from iTunes Connect (You need this to valiate subscriptions)\n\n    /* Configurations for Google Service Account validation: You can validate with just packageName, productId, and purchaseToken */\n    googleServiceAccount: {\n        clientEmail: \'<client email from Google API service account JSON key file>\',\n        privateKey: \'<private key string from Google API service account JSON key file>\'\n    },\n\n    /* Configurations for Google Play */\n    googlePublicKeyPath: \'path/to/public/key/directory/\', // this is the path to the directory containing iap-sanbox/iap-live files\n    googlePublicKeyStrSandBox: \'publicKeySandboxString\', // this is the google iap-sandbox public key string\n    googlePublicKeyStrLive: \'publicKeyLiveString\', // this is the google iap-live public key string\n    googleAccToken: \'abcdef...\', // optional, for Google Play subscriptions\n    googleRefToken: \'dddd...\', // optional, for Google Play subscritions\n    googleClientID: \'aaaa\', // optional, for Google Play subscriptions\n    googleClientSecret: \'bbbb\', // optional, for Google Play subscriptions\n\n    /* Configurations for Roku */\n    rokuApiKey: \'aaaa...\', // this comes from Roku Developer Dashboard\n\n    /* Configurations for Facebook (Payments Lite) */\n    facebookAppId: \'112233445566778\',\n    facebookAppSecret: \'cafebabedeadbeefabcdef0123456789\',\n\n    /* Configurations all platforms */\n    test: true, // For Apple and Googl Play to force Sandbox validation only\n    verbose: true // Output debug logs to stdout stream\n});\niap.setup()\n  .then(() => {\n    // iap.validate(...) automatically detects what type of receipt you are trying to validate\n    iap.validate(receipt).then(onSuccess).catch(onError);\n  })\n  .catch((error) => {\n    // error...\n  });\n\nfunction onSuccess(validatedData) {\n    // validatedData: the actual content of the validated receipt\n    // validatedData also contains the original receipt\n    var options = {\n        ignoreCanceled: true, // Apple ONLY (for now...): purchaseData will NOT contain cancceled items\n        ignoreExpired: true // purchaseData will NOT contain exipired subscription items\n    };\n    // validatedData contains sandbox: true/false for Apple and Amazon\n    var purchaseData = iap.getPurchaseData(validatedData, options);\n}\n\nfunction onError(error) {\n    // failed to validate the receipt...\n}\n```\n\n## Receipt data format\n\n### Apple\n\nAn Apple\'s receipt is a base64 encoded string.\n\n### Google Play\n\nA Google Play\'s receipt consists of two components.\n\n- Signed Data: A JSON data of what the end user purchased.\n\n- Signature: A base64 encoded string.\n\nThe module requires the above two compoents to be as a JSON object.\n\n```\n{\n    "data": {Signed Data JSON},\n    "signature": "Base 64 encoded signature string"\n}\n```\n\n`data` property in the receipt object can be either an object or a stringified JSON string.\n\n### Google Play Using Google Service Account\n\nIf you are using Google service account instead of OAuth for Google, the receipt should look like:\n\nThe API used is v3.\n\n```\n{\n    packageName: \'The packge name of the item purchased\',\n    productId: \'The product ID of the item purchased\',\n    purchaseToken: \'PurchaseToken of the receipt from Google\',\n    subscription: true/false // if the receipt is a subscription, then true\n}\n```\n\n### Google Play Using Google Service Account (with Unity receipt)\n\nIf you are using Google service account with unity receipt, you need to add a \'Subscription\' field to your unity receipt.\nThe receipt should look like:\n\n```\n{\n    Store: \'The name of the store in use, such as GooglePlay or AppleAppStore\',\n    TransactionID: \'This transaction\'s unique identifier, provided by the store\',\n    Payload: \'Varies by platform, see [Unity Receipt Documentation](https://docs.unity3d.com/Manual/UnityIAPPurchaseReceipts.html)\',\n    Subscription: true/false // if the receipt is a subscription, then true\n}\n```\n\n### Amazon\n\nAn Amazon\'s receipt contains the following:\n\n- User ID: A string of Amazon Store user ID.\n\n- Receipt ID: A string of Amazon receipt.\n\nThe module requires the above two components to be as a JSON object or a string\n\n```\n{\n    "userId": "User ID",\n    "receiptId": "Receipt ID"\n}\n```\n\n### Roku\n\nA Roku\'s receipt is a transaction ID string.\n\n### Windows\n\nA Windows\' receipt is an XML string.\n\n### Facebook (Payments Lite)\n\nA Facebook\'s receipt is signed_request string of payment response.\n\n## Validate Receipts From Multiple Applications\n\nYou may feed different Google public key or Apple password etc to validate receipts of different applications with the same code:\n\n### Windows is NOT Supported\n\n### Google Public Key\n\n```javascript\niap.config(configObject);\niap.setup()\n  .then(() => {\n    iap.validateOnce(receipt, pubKeyString).then(onSuccess).catch(onError);\n  })\n  .catch((error) => {\n    // error...\n  });\n```\n\n### Google Subscription\n\n```javascript\niap.config(configObject);\niap.setup()\n  .then(() => {\n    var credentials = {\n      clientId: \'xxxx\',\n      clientSecret: \'yyyy\',\n      refreshToken: \'zzzz\'\n    };\n    iap.validateOnce(receipt, credentials).then(onSuccess).catch(onError);\n  })\n```\n\n### Apple Subscription\n\n```javascript\niap.config(configObject);\niap.setup()\n  .then(() => {\n    iap.validateOnce(receipt, appleSecretString).then(onSuccess).catch(onError);\n  })\n  .catch((error) => {\n    // error...\n  });\n```\n\n### Amazon\n\n```javascript\niap.config(configObject);\niap.setup()\n  .then(() => {\n    iap.validateOnce(receipt, amazonSecretString).then(onSuccess).catch(onError);\n  })\n  .catch((error) => {\n    // error...\n  });\n```\n\n### Roku\n\n```javascript\niap.config(configObject);\niap.setup()\n  .then(() => {\n    iap.validateOnce(receipt, rokuApiKeyString).then(onSuccess).catch(onError);\n  })\n  .catch((error) => {\n    // error...\n  });\n```\n\n### Facebook (Payments Lite)\n\n```javascript\niap.config(configObject);\niap.setup()\n  .then(() => {\n    iap.validateOnce(receipt, appAccessToken).then(onSuccess).catch(onError);\n  })\n  .catch((error) => {\n    // error...\n  });\n```\n\n## Helper Methods\n\n### Array<[object]> getPurchaseData([object] response, [object] options)\n\nReturns an Array of objects that to be used by `isExpired` and `isCanceled`.\n\n#### [bool] options.ignoreCanceled\n\nIf `true`, the returned purchaseData excludes canceled item(s).\n\n#### [bool] options.ignoreExpired\n\nIf `true`, the returned purchaseData excludes expired item(s).\n\n### [bool] isValidated([object] response)\n\nReturns a boolean `true` if the given response of a receipt validation is a valid.\n\n```javascript\niap.validate(receipt)\n    .then((response) => {\n        if (iap.isValidated(response)) {\n            // valid receipt\n        }\n    })\n    .catch((error) => {\n        // error...\n    });\n```\n\n### [bool] isCanceled([object] purchaseData)\n\nReturns a boolean `true` if a canceled receipt is validated.\n\n```javascript\niap.validate(receipt)\n    .then((response) => {\n        var purchaseData = iap.getPurchaseData(response);\n        if (iap.isCanceled(purchaseData[0])) {\n            // receipt has been canceled\n        }\n    })\n    .catch((error) => {\n        // error...\n    });\n```\n\n### [bool] isExpired(object] purchaseData)\n\nReturns a boolean `true` if a canceled receipt is validated.\n\n**NOTE** This is subscription only.\n\n```javascript\niap.validate(receipt)\n    .then((response) => {\n        var purchaseData = iap.getPurchaseData(response);\n        if (iap.isExpired(purchaseData[0])) {\n            // receipt has been expired\n        }\n    })\n    .catch((error) => {\n        // error...\n    });\n```\n\n### [void] setAmazonValidationHost([string] host)\n\nAllows you to set custom validation host name for tests.\n\n### [void] resetAmazonValidationHost()\n\nResets to Amazon\'s validation host name.\n\n## Google Play Public Key With An Environment Variable\n\nYou may not want to keep the public key files on your server(s).\n\nThe module also supports environment variables for this.\n\nInstead of using `googlePublicKeyPath: \'path/to...\'` in your configurations, you the following:\n\n```\nexport=GOOGLE_IAB_PUBLICKEY_LIVE=PublicKeyHerePlz\nexport=GOOGLE_IAB_PUBLICKEY_SANDBOX=PublicKeyHerePlz\n```\n\n## Google In-app-Billing Set Up\n\nTo set up your server-side Android in-app-billing correctly, you must provide the public key string as a file from your Developer Console account.\n\n**Reference:** <a href="https://developer.android.com/google/play/billing/billing_integrate.html#billing-security">Implementing In-app Billing</a>\n\nOnce you copy the public key string from the Developer Console account for your application, you simply need to copy and paste it to a file and name it `iap-live` as shown in the example above.\n\n**NOTE:** The public key string you copy from the Developer Console account is actually a base64 string. You do NOT have to convert this to anything yourself. The module converts it to the public key automatically for you.\n\n### Google Play Store API\n\nTo check expiration date or auto renewal status of an Android subscription, you should first setup the access to the Google Play Store API. You should follow these steps:\n\n##### Part 1 - Get ClientID and ClientSecret\n1. Go to https://play.google.com/apps/publish/\n2. Click on `Settings`\n3. Click on `API Access`\n4. There should be a linked project already, if not, create one. If you have it, click it.\n* You should now be at: https://console.developers.google.com/apis/library?project=xxxx\n5. Under Mobile API\'s, make sure "Google Play Developer API is enabled".\n6. Go back, on the left click on `Credentials`\n7. Click `Create Credentials` button\n8. Choose `OAuth Client ID`\n9. Choose `Web Application`\n * Give it a name, skip the `Authorized JS origins`\n * Add this to `Authorized Redirect URIs`: https://developers.google.com/oauthplayground\n * Hit Save and copy the **clientID** and **clientSecret** somewhere safe.\n\n##### Part 2 - Get Access and Refresh Tokens\n1. Go to: https://developers.google.com/oauthplayground\n2. On the right, hit the gear/settings.\n3. Check the box: `Use your own OAuth credentials`\n    * Enter in clientID and clientSecret\n    * Close\n4. On the left, find "Google Play Developer API v3"\n * Select "https://www.googleapis.com/auth/androidpublisher"\n5. Hit Authorize Api\'s button\n6. Save `Authorization Code`\n * This is your: **googleAccToken**\n7. Hit `Exchange Authorization code for token`\n8. Grab: `Refresh Token`\n * This is your: **googleRefToken**\n\nNow you are able to query for Android subscription status!\n\n## Amazon App Store Reference\n\nhttps://developer.amazon.com/docs/in-app-purchasing/iap-rvs-for-android-apps.html\n\n## Windows Signed XML\n\nin-app-purchase module supports the following algorithms:\n\n### Canonicalization and Transformation Algorithms\n\n- Exclusive Canonicalization http://www.w3.org/2001/10/xml-exc-c14n#\n\n- Exclusive Canonicalization with comments http://www.w3.org/2001/10/xml-exc-c14n#WithComments\n\n- Enveloped Signature transform http://www.w3.org/2000/09/xmldsig#enveloped-signature\n\n### Hashing Algorithms\n\n- SHA1 digests http://www.w3.org/2000/09/xmldsig#sha1\n\n- SHA256 digests http://www.w3.org/2001/04/xmlenc#sha256\n\n- SHA512 digests http://www.w3.org/2001/04/xmlenc#sha512\n\n## Facebook Order Fulfillment and Signed Request Parsing\n\n- Facebook Payments Order Fulfillment: https://developers.facebook.com/docs/games_payments/fulfillment#orderfulfillment\n\n- Facebook Signed Request Parsing: https://developers.facebook.com/docs/games/gamesonfacebook/login#parsingsr\n\n- **NOTE:** Payments `Lite` does not support subscription.\n\n## HTTP Request Configurations\n\nThe module supports the same configurations as [npm request module] (https://www.npmjs.com/package/request#requestoptions-callback)\n\n'