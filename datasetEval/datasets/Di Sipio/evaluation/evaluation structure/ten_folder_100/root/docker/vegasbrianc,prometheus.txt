b'![](https://github.com/vegasbrianc/prometheus/workflows/prometheus%20test/badge.svg)\n\n# Contents\n\n- Introduction\n  - [Overview](#a-prometheus--grafana-docker-compose-stack)\n  - [Pre-requisites](#pre-requisites)\n  - [Installation & Configuration](#installation--configuration)\n    - [Add Datasources & Dashboards](#add-datasources-and-dashboards)\n    - [Install Dashboards the Old Way](#install-dashboards-the-old-way)\n  \t- [Alerting](#alerting)\n  \t- [Test Alerts](#test-alerts)\n    - [Add additional Datasources](#add-additional-datasources)\n  - [Deploy Prometheus stack with Traefik](#deploy-prometheus-stack-with-traefik)\n  - [Security Considerations](#security-considerations)\n  \t- [Production Security](#production-security)\n  - [Troubleshooting](#troubleshooting)\n  \t- [Mac Users](#mac-users)\n  - [Interesting Projects that use this Repo](#interesting-projects-that-use-this-repo)\n\n# A Prometheus & Grafana docker-compose stack\n\nHere\'s a quick start using Play-With-Docker (PWD) to start-up a [Prometheus](http://prometheus.io/) stack containing Prometheus, Grafana and Node scraper to monitor your Docker infrastructure. The Try in PWD below allows you to quickly deploy the entire Prometheus stack with a click of the button. This will allow you to quickly test the stack to see if it meets your needs.\n\n[![Try in PWD](https://github.com/play-with-docker/stacks/raw/master/assets/images/button.png)](https://labs.play-with-docker.com/?stack=https://raw.githubusercontent.com/vegasbrianc/prometheus/version-2/pwd-stack.yml)\n\n# Pre-requisites\nBefore we get started installing the Prometheus stack. Ensure you install the latest version of docker and [docker swarm](https://docs.docker.com/engine/swarm/swarm-tutorial/) on your Docker host machine. Docker Swarm is installed automatically when using Docker for Mac or Docker for Windows.\n\n# Installation & Configuration\nClone the project locally to your Docker host.\n\nIf you would like to change which targets should be monitored or make configuration changes edit the [/prometheus/prometheus.yml](prometheus/prometheus.yml) file. The targets section is where you define what should be monitored by Prometheus. The names defined in this file are actually sourced from the service name in the docker-compose file. If you wish to change names of the services you can add the "container_name" parameter in the `docker-compose.yml` file.\n\nOnce configurations are done let\'s start it up. From the /prometheus project directory run the following command:\n\n    $ HOSTNAME=$(hostname) docker stack deploy -c docker-stack.yml prom\n\n\nThat\'s it the `docker stack deploy\' command deploys the entire Grafana and Prometheus stack automagically to the Docker Swarm. By default cAdvisor and node-exporter are set to Global deployment which means they will propogate to every docker host attached to the Swarm.\n\nThe Grafana Dashboard is now accessible via: `http://<Host IP Address>:3000` for example http://192.168.10.1:3000\n\n\tusername - admin\n\tpassword - foobar (Password is stored in the `/grafana/config.monitoring` env file)\n\nIn order to check the status of the newly created stack:\n\n    $ docker stack ps prom\n\nView running services:\n\n    $ docker service ls\n\nView logs for a specific service\n\n    $ docker service logs prom_<service_name>\n\n## Add Datasources and Dashboards\nGrafana version 5.0.0 has introduced the concept of provisioning. This allows us to automate the process of adding Datasources & Dashboards. The `/grafana/provisioning/` directory contains the `datasources` and `dashboards` directories. These directories contain YAML files which allow us to specify which datasource or dashboards should be installed. \n\nIf you would like to automate the installation of additional dashboards just copy the Dashboard `JSON` file to `/grafana/provisioning/dashboards` and it will be provisioned next time you stop and start Grafana.\n\n## Install Dashboards the old way\n\nI created a Dashboard template which is available on [Grafana Docker Dashboard](https://grafana.net/dashboards/179). Simply select Import from the Grafana menu -> Dashboards -> Import and provide the Dashboard ID [#179](https://grafana.net/dashboards/179)\n\nThis dashboard is intended to help you get started with monitoring. If you have any changes you would like to see in the Dashboard let me know so I can update Grafana site as well.\n\nHere\'s the Dashboard Template\n\n![Grafana Dashboard](https://raw.githubusercontent.com/vegasbrianc/prometheus/master/images/Dashboard.png)\n\nGrafana Dashboard - `dashboards/Grana_Dashboad.json`\nAlerting Dashboard\n\n\n## Alerting\nAlerting has been added to the stack with Slack integration. 2 Alerts have been added and are managed\n\nAlerts              - `prometheus/alert.rules`\nSlack configuration - `alertmanager/config.yml`\n\nThe Slack configuration requires to build a custom integration.\n* Open your slack team in your browser `https://<your-slack-team>.slack.com/apps`\n* Click build in the upper right corner\n* Choose Incoming Web Hooks link under Send Messages\n* Click on the "incoming webhook integration" link\n* Select which channel\n* Click on Add Incoming WebHooks integration\n* Copy the Webhook URL into the `alertmanager/config.yml` URL section\n* Fill in Slack username and channel\n\nView Prometheus alerts `http://<Host IP Address>:9090/alerts`\nView Alert Manager `http://<Host IP Address>:9093`\n\n### Test Alerts\nA quick test for your alerts is to stop a service. Stop the node_exporter container and you should notice shortly the alert arrive in Slack. Also check the alerts in both the Alert Manager and Prometheus Alerts just to understand how they flow through the system.\n\nHigh load test alert - `docker run --rm -it busybox sh -c "while true; do :; done"`\n\nLet this run for a few minutes and you will notice the load alert appear. Then Ctrl+C to stop this container.\n\n### Add Additional Datasources\nNow we need to create the Prometheus Datasource in order to connect Grafana to Prometheus \n* Click the `Grafana` Menu at the top left corner (looks like a fireball)\n* Click `Data Sources`\n* Click the green button `Add Data Source`.\n\n<img src="https://raw.githubusercontent.com/vegasbrianc/prometheus/master/images/Add_Data_Source.png" width="400" heighth="400">\n\n# Security Considerations\nThis project is intended to be a quick-start to get up and running with Docker and Prometheus. Security has not been implemented in this project. It is the users responsability to implement Firewall/IpTables and SSL.\n\nSince this is a template to get started Prometheus and Alerting services are exposing their ports to allow for easy troubleshooting and understanding of how the stack works.\n\n## Deploy Prometheus stack with Traefik\n\nSame requirements as above. Swarm should be enabled and the Repo should be cloned to your Docker host.\n\nIn the `docker-traefik-prometheus`directory run the following:\n\n    docker stack deploy -c docker-traefik-stack.yml traefik\n\nVerify all the services have been provisioned. The Replica count for each service should be 1/1 \n**Note this can take a couple minutes**\n\n    docker service ls\n\n## Prometheus & Grafana now have hostnames\n\n* Grafana - http://grafana.localhost\n* Prometheus - http://prometheus.localhost\n\n\n## Check the Metrics\nOnce all the services are up we can open the Traefik Dashboard. The dashboard should show us our frontend and backends configured for both Grafana and Prometheus.\n\n    http://localhost:8080\n\n\nTake a look at the metrics which Traefik is now producing in Prometheus metrics format\n\n    http://localhost:8080/metrics\n\n\n## Login to Grafana and Visualize Metrics\n\nGrafana is an Open Source visualization tool for the metrics collected with Prometheus. Next, open Grafana to view the Traefik Dashboards.\n**Note: Firefox doesn\'t properly work with the below URLS please use Chrome**\n\n    http://grafana.localhost\n\nUsername: admin\nPassword: foobar\n\nOpen the Traefik Dashboard and select the different backends available\n\n**Note: Upper right-hand corner of Grafana switch the default 1 hour time range down to 5 minutes. Refresh a couple times and you should see data start flowing**\n\n# Production Security:\n\nHere are just a couple security considerations for this stack to help you get started.\n* Remove the published ports from Prometheus and Alerting servicesi and only allow Grafana to be accessed\n* Enable SSL for Grafana with a Proxy such as [jwilder/nginx-proxy](https://hub.docker.com/r/jwilder/nginx-proxy/) or [Traefik](https://traefik.io/) with Let\'s Encrypt\n* Add user authentication via a Reverse Proxy [jwilder/nginx-proxy](https://hub.docker.com/r/jwilder/nginx-proxy/) or [Traefik](https://traefik.io/) for services cAdvisor, Prometheus, & Alerting as they don\'t support user authenticaiton\n* Terminate all services/containers via HTTPS/SSL/TLS\n\n# Troubleshooting\n\nIt appears some people have reported no data appearing in Grafana. If this is happening to you be sure to check the time range being queried within Grafana to ensure it is using Today\'s date with current time.\n\n## Mac Users\n\n1. The node-exporter does not run the same as Mac and Linux. Node-Exporter is not designed to run on Mac and in fact cannot collect metrics from the Mac OS due to the differences between Mac and Linux OS\'s. I recommend you comment out the node-exporter section in the `docker-compose.yml` file and instead just use the cAdvisor.\n\n2. If you find after you deploy your project that the prometheus and alertmanager services are in pending status due to "no suitable node" this is due to file system permissions. Be sure to Open Docker for Mac Preferences -> File Sharing Menu and add the following:\n\n![Docker for Mac File Sharing Settings](https://github.com/vegasbrianc/prometheus/raw/master/images/mac-filesystem.png)\n\n# Interesting Projects that use this Repo\nSeveral projects utilize this Prometheus stack. Here\'s the list of projects:\n\n* [Docker Pulls](https://github.com/vegasbrianc/docker-pulls) - Visualize Docker-Hub pull statistics with Prometheus\n* [GitHub Monitoring](https://github.com/vegasbrianc/github-monitoring) - Monitor your GitHub projects with Prometheus\n* [Traefik Reverse Proxy/Load Balancer Monitoring](https://github.com/vegasbrianc/docker-traefik-prometheus) - Monitor the popular Reverse Proxy/Load Balancer Traefik with Prometheus\n* [internet monitoring](https://github.com/maxandersen/internet-monitoring) - Monitor your local network, internet connection and speed with Prometheus.\n* [Dockerize Your Dev](https://github.com/RiFi2k/dockerize-your-dev) - Docker compose a VM to get LetsEncrypt / NGINX proxy auto provisioning, ELK logging, Prometheus / Grafana monitoring, Portainer GUI, and more...\n\n*Have an intersting Project which use this Repo? Submit yours to the list*\n'