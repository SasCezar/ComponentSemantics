b'To Fix The Docker and UFW Security Flaw Without Disabling Iptables\n==================\n\n- [English](#tldr)\n- [\xe4\xb8\xad\xe6\x96\x87](#\xe5\xa4\xaa\xe9\x95\xbf\xe4\xb8\x8d\xe6\x83\xb3\xe8\xaf\xbb)\n\n## TL;DR\n\nPlease take a look at [Solving UFW and Docker issues](#solving-ufw-and-docker-issues).\n\n## Problem\n\nUFW is a popular iptables front end on Ubuntu that makes it easy to manage firewall rules. But when Docker is installed, Docker bypass the UFW rules and the published ports can be accessed from outside.\n\nThe issue is:\n\n1. UFW is enabled on a server that provides external services, and all incoming connections that are not allowed are blocked by default.\n2. Run a Docker container on the server and use the `-p` option to publish ports for that container on all IP addresses. \n   For example: `docker run -d --name httpd -p 0.0.0.0:8080:80 httpd:alpine`, this command will run an httpd service and publish port 80 of the container to port 8080 of the server.\n3. UFW will not block all external requests to visit port 8080. Even the command `ufw deny 8080` will not prevent external access to this port.\n4. This problem is actually quite serious, which means that a port that was originally intended to provide services internally is exposed to the public network.\n\nSearching for "ufw docker" on the web can find a lot of discussion:\n\n- https://github.com/moby/moby/issues/4737\n- https://forums.docker.com/t/running-multiple-docker-containers-with-ufw-and-iptables-false/8953\n- https://www.techrepublic.com/article/how-to-fix-the-docker-and-ufw-security-flaw/\n- https://blog.viktorpetersson.com/2014/11/03/the-dangers-of-ufw-docker.html\n- https://askubuntu.com/questions/652556/uncomplicated-firewall-ufw-is-not-blocking-anything-when-using-docker\n- https://chjdev.com/2016/06/08/docker-ufw/\n- https://askubuntu.com/questions/652556/uncomplicated-firewall-ufw-is-not-blocking-anything-when-using-docker\n- https://my.oschina.net/abcfy2/blog/539485\n- https://www.v2ex.com/amp/t/466666\n- https://blog.36web.rocks/2016/07/08/docker-behind-ufw.html\n- ...\n\nAlmost all of these solutions are similar. It requires to disable docker\'s iptables function first, but this also means that we give up docker\'s network management function. This causes containers will not be able to access the external network. It is also mentioned in some articles that you can manually add some rules in the UFW configuration file, such as `-A POSTROUTING ! -o docker0 -s 172.17.0.0/16 -j MASQUERADE`. But this only allows containers that belong to network `172.17.0.0/16` can access outside. If we create a new docker network, we must manually add such similar iptables rules for the new network.\n\n## Expected goal\n\nThe solutions that we can find on internet are very similar and not elegant, I hope a new solution can:\n\n- Don\'t need to disable Docker\'s iptables and let Docker to manage it\'s network. \n  We don\'t need to manually maintain iptables rules for any new Docker networks, and avoid potential side effects after disabling iptables in Docker.\n- The public network cannot access ports that published by Docker. Even if the port is published on all IP addresses using an option like `-p 8080:80`. Containers and internal networks can visit each other normally.\n  Although it is possible to have Docker publish a container\'s port to the server\'s private IP address, the port will not be accessed on the public network. But, this server may have multiple private IP addresses, and these private IP addresses may also change.\n- In a very convenient way to allow/deny public networks to access container ports without additional software and extra configurations. Just like using command `ufw allow 8080` to allow external access port 8080, then using command `ufw delete allow 8080` to deny public networks visit port 8080.\n\n## How to do?\n\n### Revoke the original modification\n\nIf you have modified your server according to the current solution that we find on the internet, please rollback these changes first, including:\n\n- Enable Docker\'s iptables feature.\n  Remove all changes like `--iptables=false` , including configuration file `/etc/docker/daemon.json`.\n- UFW\'s default FORWARD rule changes back to the default DROP instead of ACCEPT.\n- Remove the rules related to the Docker network in the UFW configuration file `/etc/ufw/after.rules`.\n- If you have modified Docker configuration files, restart Docker first. We will modify the UFW configuration later and we can restart it then.\n\n### Solving UFW and Docker issues\n\nThis solution needs to modify only one UFW configuration file, all Docker configurations and options remain the default.\n\nModify the UFW configuration file `/etc/ufw/after.rules` and add the following rules at the end of the file:\n\n    # BEGIN UFW AND DOCKER\n    *filter\n    :ufw-user-forward - [0:0]\n    :DOCKER-USER - [0:0]\n    -A DOCKER-USER -j RETURN -s 10.0.0.0/8\n    -A DOCKER-USER -j RETURN -s 172.16.0.0/12\n    -A DOCKER-USER -j RETURN -s 192.168.0.0/16\n\n    -A DOCKER-USER -p udp -m udp --sport 53 --dport 1024:65535 -j RETURN\n\n    -A DOCKER-USER -j ufw-user-forward\n\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 172.16.0.0/12\n\n    -A DOCKER-USER -j RETURN\n    COMMIT\n    # END UFW AND DOCKER\n\nUsing command `sudo systemctl restart ufw` or `sudo ufw reload` to restart UFW after changing the file. Now the public network can\'t access any published docker ports, the container and the private network can visit each other normally, and the containers can also access the external network from inside. **There may be some unknown reasons cause the UFW rules will not take effect after restart UFW, please reboot servers.**\n\nIf you want to allow public networks to access the services provided by the Docker container, for example, the service port of a container is `80`. Run the following command to allow the public networks to access this service:\n\n    ufw route allow proto tcp from any to any port 80\n\nThis allows the public network to access all published ports whose container port is `80`.\n\nNote: If we publish a port by using option `-p 8080:80`, we should use the container port `80`, not the host port `8080`.\n\nIf there are multiple containers with a service port of `80`, but we only want the external network to access a certain container. For example, if the private address of the container is `172.17.0.2`, use the following command:\n\n    ufw route allow proto tcp from any to 172.17.0.2 port 80\n\nIf the network protocol of a service is UDP, for example a DNS service, you can use the following command to allow the external network to access all published DNS services:\n\n    ufw route allow proto udp from any to any port 53\n\nSimilarly, if only for a specific container, such as IP address `172.17.0.2`:\n\n    ufw route allow proto udp from any to 172.17.0.2 port 53\n\n## How it works?\n\nThe following rules allow the private networks to be able to visit each other. Normally, private networks are more trusted than public networks.\n\n    -A DOCKER-USER -j RETURN -s 10.0.0.0/8\n    -A DOCKER-USER -j RETURN -s 172.16.0.0/12\n    -A DOCKER-USER -j RETURN -s 192.168.0.0/16\n\nThe following rules allow UFW to manage whether the public networks are allowed to visit the services provided by the Docker container. So that we can manage all firewall rules in one place.\n\n    -A DOCKER-USER -j ufw-user-forward\n\nThe following rules block connection requests initiated by all public networks, but allow internal networks to access external networks. For TCP protocol, it prevents from actively establishing a TCP connection from public networks. For UDP protocol, all accesses to ports which is less then 32767 are blocked. Why is this port? Since the UDP protocol is stateless, it is not possible to block the handshake signal that initiates the connection request as TCP does. For GNU/Linux we can find the local port range in the file `/proc/sys/net/ipv4/ip_local_port_range`. The default range is `32768 60999`. When accessing a UDP protocol service from a running container, the local port will be randomly selected one from the port range, and the server will return the data to this random port. Therefore, we can assume that the listening port of the UDP protocol inside all containers are less then `32768`. This is the reason that we don\'t want public networks to access the UDP ports that less then `32768`.\n\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 172.16.0.0/12\n\n    -A DOCKER-USER -j RETURN\n\nIf a docker container doesn\'t follow the OS\'s settings when receiving data, that is to say, the minimal port number less than `32768`. For example, we have a Dnsmasq container. The minimal port number that Dnsmasq uses for receiving data is `1024`. We can use the following command to allow a bigger port range used for receiving DNS packages.\n\n    ufw route allow proto udp from any port 53 to any port 1024:65535\n\nBecause DNS is a very common service, so there is already a firewall rule to allow a bigger port range to receive DNS packages.\n\n## The reason for choosing `ufw-user-forward`, not `ufw-user-input`\n\n### using `ufw-user-input`\n\nPro:\n\nEasy to use and understand, supports older versions of Ubuntu.\n\nFor example, to allow the public to visit a published port whose container port is `8080`, use the command:\n\n    ufw allow 8080\n\nCon:\n\nIt not only exposes ports of containers but also exposes ports of the host.\n\nFor example, if a service is running on the host, and the port is `8080`. The command `ufw allow 8080` allows the public network to visit the service and all published ports whose containers\' port is `8080`. But we just want to expose the service running on the host, or just the service running inside containers, not the both.\n\nTo avoid this problem, we may need to use a command similar to the following for all containers:\n\n    ufw allow proto tcp from any to 172.16.0.3 port 8080\n\n### using `ufw-user-forward`\n\nPro:\n\nCannot expose services running on hosts and containers at the same time by the same command.\n\nFor example, if we want to publish the port `8080` of containers, use the following command:\n\n    ufw route allow 8080\n\nThe public network can access all published ports whose container ports are `8080`.\n\nBut the port `8080` of the host is still not be accessed by the public network. If we want to do so, execute the following command to allow the public access the port on the host separately:\n\n    ufw allow 8080\n\n\nCon:\n\nDoesn\'t support older versions of Ubuntu, and the command is a bit more complicated. But you can use my script.\n\n\n### Conclusion\n\nIf we are using an older version of Ubuntu, we can use `ufw-user-input` chain. But be careful to avoid exposing services that should not be exposed\n\nIf we are using a newer version of Ubuntu which is support `ufw route` sub-command, we\'d better use `ufw-user-forward` chain, and use `ufw route` command to manage firewall rules for containers.\n\n## `ufw-docker` util\n\nThis script also supports Docker Swarm mode.\n\n### Install\n\nDownload `ufw-docker` script\n\n    sudo wget -O /usr/local/bin/ufw-docker \\\n      https://github.com/chaifeng/ufw-docker/raw/master/ufw-docker\n    chmod +x /usr/local/bin/ufw-docker\n\nThen using the following command to modify the `after.rules` file of `ufw`\n\n    ufw-docker install\n\nThis command does the following things:\n- Back up the file `/etc/ufw/after.rules`\n- Append the rules of UFW and Docker at the end of the file\n\n#### Install for Docker Swarm mode\n\nWe can only use this script on manager nodes to manage firewall rules when using in Swarm mode.\n\n- Modifying all `after.rules` files on all nodes, including managers and workers\n- Deploying this script on manager nodes\n\nRunning in Docker Swarm mode, this script will add a global service `ufw-docker-agent`. The image [chaifeng/ufw-docker-agent](https://hub.docker.com/r/chaifeng/ufw-docker-agent/) is also automatically built from this project.\n\n### Usage\n\nShow help\n\n    ufw-docker help\n\nCheck the installation of firewall rules in UFW configurations\n\n    ufw-docker check\n\nUpdate UFW configurations, add the necessary firewall rules\n\n    ufw-docker install\n\nShow the current firewall allowed forward rules\n\n    ufw-docker status\n\nList all firewall rules related to container `httpd`\n\n    ufw-docker list httpd\n\nExpose the port `80` of the container `httpd`\n\n    ufw-docker allow httpd 80\n\nExpose the `443` port of the container `httpd` and the protocol is `tcp`\n\n    ufw-docker allow httpd 443/tcp\n\nExpose all published ports of the container `httpd`\n\n    ufw-docker allow httpd\n\nRemove all rules related to the container `httpd`\n\n    ufw-docker delete allow httpd\n\nRemove the rule which port is `443` and protocol is `tcp` for the container `httpd`\n\n    ufw-docker delete allow httpd 443/tcp\n\nExpose the port `80` of the service `web`\n\n    docker service create --name web --publish 8080:80 httpd:alpine\n\n    ufw-docker service allow web 80\n    # or\n    ufw-docker service allow web 80/tcp\n\nRemove rules from all nodes related to the service `web`\n\n    ufw-docker service delete allow web\n\n### Try it out\n\nWe use [Vagrant](https://www.vagrantup.com/) to set up a local testing environment. \n\nRun the following command to create 1 master node and 2 worker nodes\n\n    vagrant up\n\nLog into the master node\n\n    vagrant ssh master\n\nAfter logging in, create a `web` service\n\n    docker service create --name web --publish 8080:80 httpd:alpine\n\nWe shouldn\'t visit this `web` service from our host\n\n    curl -v http://192.168.56.131:8080\n\nOn the master node, run the command to allow the public access port `80` of the `web` service.\n\n    sudo ufw-docker service allow web 80\n\nWe can access the `web` service from our host now\n\n    curl "http://192.168.56.13{0,1,2}:8080"\n\n## Discussions\n\n- [What is the best practice of docker + ufw under Ubuntu - Stack Overflow](https://stackoverflow.com/questions/30383845/what-is-the-best-practice-of-docker-ufw-under-ubuntu/51741599#comment91451547_51741599)\n- [docker and ufw serious problems \xc2\xb7 Issue #4737 \xc2\xb7 moby/moby](https://github.com/moby/moby/issues/4737#issuecomment-420112149)\n\n\n## \xe5\xa4\xaa\xe9\x95\xbf\xe4\xb8\x8d\xe6\x83\xb3\xe8\xaf\xbb\n\n\xe8\xaf\xb7\xe7\x9b\xb4\xe6\x8e\xa5\xe7\x9c\x8b[\xe8\xa7\xa3\xe5\x86\xb3 UFW \xe5\x92\x8c Docker \xe7\x9a\x84\xe9\x97\xae\xe9\xa2\x98](#\xe8\xa7\xa3\xe5\x86\xb3-ufw-\xe5\x92\x8c-docker-\xe7\x9a\x84\xe9\x97\xae\xe9\xa2\x98)\xe3\x80\x82\n\n## \xe9\x97\xae\xe9\xa2\x98\n\nUFW \xe6\x98\xaf Ubuntu \xe4\xb8\x8a\xe5\xbe\x88\xe6\xb5\x81\xe8\xa1\x8c\xe7\x9a\x84\xe4\xb8\x80\xe4\xb8\xaa iptables \xe5\x89\x8d\xe7\xab\xaf\xef\xbc\x8c\xe5\x8f\xaf\xe4\xbb\xa5\xe9\x9d\x9e\xe5\xb8\xb8\xe6\x96\xb9\xe4\xbe\xbf\xe7\x9a\x84\xe7\xae\xa1\xe7\x90\x86\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe7\x9a\x84\xe8\xa7\x84\xe5\x88\x99\xe3\x80\x82\xe4\xbd\x86\xe6\x98\xaf\xe5\xbd\x93\xe5\xae\x89\xe8\xa3\x85\xe4\xba\x86 Docker\xef\xbc\x8cUFW \xe6\x97\xa0\xe6\xb3\x95\xe7\xae\xa1\xe7\x90\x86 Docker \xe5\x8f\x91\xe5\xb8\x83\xe5\x87\xba\xe6\x9d\xa5\xe7\x9a\x84\xe7\xab\xaf\xe5\x8f\xa3\xe4\xba\x86\xe3\x80\x82\n\n\xe5\x85\xb7\xe4\xbd\x93\xe7\x8e\xb0\xe8\xb1\xa1\xe6\x98\xaf\xef\xbc\x9a\n\n1. \xe5\x9c\xa8\xe4\xb8\x80\xe4\xb8\xaa\xe5\xaf\xb9\xe5\xa4\x96\xe6\x8f\x90\xe4\xbe\x9b\xe6\x9c\x8d\xe5\x8a\xa1\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe4\xb8\x8a\xe5\x90\xaf\xe7\x94\xa8\xe4\xba\x86 UFW\xef\xbc\x8c\xe5\xb9\xb6\xe4\xb8\x94\xe9\xbb\x98\xe8\xae\xa4\xe9\x98\xbb\xe6\xad\xa2\xe6\x89\x80\xe6\x9c\x89\xe6\x9c\xaa\xe8\xa2\xab\xe5\x85\x81\xe8\xae\xb8\xe7\x9a\x84\xe4\xbc\xa0\xe5\x85\xa5\xe8\xbf\x9e\xe6\x8e\xa5\xe3\x80\x82\n2. \xe8\xbf\x90\xe8\xa1\x8c\xe4\xba\x86\xe4\xb8\x80\xe4\xb8\xaa Docker \xe5\xae\xb9\xe5\x99\xa8\xef\xbc\x8c\xe5\xb9\xb6\xe4\xb8\x94\xe4\xbd\xbf\xe7\x94\xa8 `-p` \xe9\x80\x89\xe9\xa1\xb9\xe6\x9d\xa5\xe6\x8a\x8a\xe8\xaf\xa5\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe6\x9f\x90\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe5\x8f\x91\xe5\xb8\x83\xe5\x88\xb0\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe7\x9a\x84\xe6\x89\x80\xe6\x9c\x89 IP \xe5\x9c\xb0\xe5\x9d\x80\xe4\xb8\x8a\xe3\x80\x82\xe6\xaf\x94\xe5\xa6\x82\xef\xbc\x9a`docker run -d --name httpd -p 0.0.0.0:8080:80 httpd:alpine` \xe5\xb0\x86\xe4\xbc\x9a\xe8\xbf\x90\xe8\xa1\x8c\xe4\xb8\x80\xe4\xb8\xaa httpd \xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe5\xb9\xb6\xe4\xb8\x94\xe5\xb0\x86\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84 `80` \xe7\xab\xaf\xe5\x8f\xa3\xe5\x8f\x91\xe5\xb8\x83\xe5\x88\xb0\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe7\x9a\x84 `8080` \xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\x8a\xe3\x80\x82\n3. UFW \xe5\xb0\x86\xe4\xb8\x8d\xe4\xbc\x9a\xe9\x98\xbb\xe6\xad\xa2\xe6\x89\x80\xe6\x9c\x89\xe5\xaf\xb9 `8080` \xe7\xab\xaf\xe5\x8f\xa3\xe8\xae\xbf\xe9\x97\xae\xe7\x9a\x84\xe8\xaf\xb7\xe6\xb1\x82\xef\xbc\x8c\xe7\x94\xa8\xe5\x91\xbd\xe4\xbb\xa4 `ufw deny 8080` \xe4\xb9\x9f\xe6\x97\xa0\xe6\xb3\x95\xe9\x98\xbb\xe6\xad\xa2\xe5\xa4\x96\xe9\x83\xa8\xe8\xae\xbf\xe9\x97\xae\xe8\xbf\x99\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe3\x80\x82\n\n\xe8\xbf\x99\xe4\xb8\xaa\xe9\x97\xae\xe9\xa2\x98\xe5\x85\xb6\xe5\xae\x9e\xe6\x8c\xba\xe4\xb8\xa5\xe9\x87\x8d\xe7\x9a\x84\xef\xbc\x8c\xe8\xbf\x99\xe6\x84\x8f\xe5\x91\xb3\xe7\x9d\x80\xe6\x9c\xac\xe6\x9d\xa5\xe5\x8f\xaa\xe6\x98\xaf\xe4\xb8\xba\xe4\xba\x86\xe5\x9c\xa8\xe5\x86\x85\xe9\x83\xa8\xe6\x8f\x90\xe4\xbe\x9b\xe6\x9c\x8d\xe5\x8a\xa1\xe7\x9a\x84\xe4\xb8\x80\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe8\xa2\xab\xe6\x9a\xb4\xe9\x9c\xb2\xe5\x9c\xa8\xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\x8a\xe3\x80\x82\n\n\xe5\x9c\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\x8a\xe6\x90\x9c\xe7\xb4\xa2 "ufw docker" \xe5\x8f\xaf\xe4\xbb\xa5\xe5\x8f\x91\xe7\x8e\xb0\xe5\xbe\x88\xe5\xa4\x9a\xe7\x9a\x84\xe8\xae\xa8\xe8\xae\xba\xef\xbc\x9a\n\n- https://github.com/moby/moby/issues/4737\n- https://forums.docker.com/t/running-multiple-docker-containers-with-ufw-and-iptables-false/8953\n- https://www.techrepublic.com/article/how-to-fix-the-docker-and-ufw-security-flaw/\n- https://blog.viktorpetersson.com/2014/11/03/the-dangers-of-ufw-docker.html\n- https://askubuntu.com/questions/652556/uncomplicated-firewall-ufw-is-not-blocking-anything-when-using-docker\n- https://chjdev.com/2016/06/08/docker-ufw/\n- https://askubuntu.com/questions/652556/uncomplicated-firewall-ufw-is-not-blocking-anything-when-using-docker\n- https://my.oschina.net/abcfy2/blog/539485\n- https://www.v2ex.com/amp/t/466666\n- https://blog.36web.rocks/2016/07/08/docker-behind-ufw.html\n- ...\n\n\xe5\x9f\xba\xe6\x9c\xac\xe4\xb8\x8a\xe5\x8f\xaf\xe4\xbb\xa5\xe6\x89\xbe\xe5\x88\xb0\xe7\x9a\x84\xe8\xa7\xa3\xe5\x86\xb3\xe5\x8a\x9e\xe6\xb3\x95\xe5\xb0\xb1\xe6\x98\xaf\xe9\xa6\x96\xe5\x85\x88\xe7\xa6\x81\xe7\x94\xa8 docker \xe7\x9a\x84 iptables \xe5\x8a\x9f\xe8\x83\xbd\xef\xbc\x8c\xe4\xbd\x86\xe8\xbf\x99\xe4\xb9\x9f\xe6\x84\x8f\xe5\x91\xb3\xe7\x9d\x80\xe6\x94\xbe\xe5\xbc\x83\xe4\xba\x86 docker \xe7\x9a\x84\xe7\xbd\x91\xe7\xbb\x9c\xe7\xae\xa1\xe7\x90\x86\xe5\x8a\x9f\xe8\x83\xbd\xef\xbc\x8c\xe5\xbe\x88\xe5\x85\xb8\xe5\x9e\x8b\xe7\x9a\x84\xe7\x8e\xb0\xe8\xb1\xa1\xe5\xb0\xb1\xe6\x98\xaf\xe5\xae\xb9\xe5\x99\xa8\xe5\xb0\x86\xe6\x97\xa0\xe6\xb3\x95\xe8\xae\xbf\xe9\x97\xae\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe3\x80\x82\xe5\x9c\xa8\xe6\x9c\x89\xe7\x9a\x84\xe6\x96\x87\xe7\xab\xa0\xe4\xb8\xad\xe4\xb9\x9f\xe6\x8f\x90\xe5\x88\xb0\xe4\xba\x86\xe5\x8f\xaf\xe4\xbb\xa5\xe5\x9c\xa8 UFW \xe7\x9a\x84\xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6\xe4\xb8\xad\xe6\x89\x8b\xe5\xb7\xa5\xe6\xb7\xbb\xe5\x8a\xa0\xe4\xb8\x80\xe6\x9d\xa1\xe8\xa7\x84\xe5\x88\x99\xef\xbc\x8c\xe6\xaf\x94\xe5\xa6\x82 `-A POSTROUTING ! -o docker0 -s 172.17.0.0/16 -j MASQUERADE`\xe3\x80\x82\xe4\xbd\x86\xe8\xbf\x99\xe4\xb9\x9f\xe5\x8f\xaa\xe6\x98\xaf\xe5\x85\x81\xe8\xae\xb8\xe4\xba\x86 `172.17.0.0/16` \xe8\xbf\x99\xe4\xb8\xaa\xe7\xbd\x91\xe7\xbb\x9c\xe3\x80\x82\xe5\xa6\x82\xe6\x9e\x9c\xe6\x9c\x89\xe4\xba\x86\xe6\x96\xb0\xe5\xa2\x9e\xe7\x9a\x84\xe7\xbd\x91\xe7\xbb\x9c\xef\xbc\x8c\xe6\x88\x91\xe4\xbb\xac\xe4\xb9\x9f\xe5\xbf\x85\xe9\xa1\xbb\xe6\x89\x8b\xe5\xb7\xa5\xe5\x86\x8d\xe4\xb8\xba\xe6\x96\xb0\xe5\xa2\x9e\xe7\x9a\x84\xe7\xbd\x91\xe7\xbb\x9c\xe6\xb7\xbb\xe5\x8a\xa0\xe8\xbf\x99\xe6\xa0\xb7\xe7\xb1\xbb\xe4\xbc\xbc\xe7\x9a\x84 iptables \xe8\xa7\x84\xe5\x88\x99\xe3\x80\x82\n\n## \xe6\x9c\x9f\xe6\x9c\x9b\xe7\x9a\x84\xe7\x9b\xae\xe6\xa0\x87\n\n\xe7\x9b\xae\xe5\x89\x8d\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\x8a\xe7\x9a\x84\xe8\xa7\xa3\xe5\x86\xb3\xe6\x96\xb9\xe6\xa1\x88\xe9\x83\xbd\xe9\x9d\x9e\xe5\xb8\xb8\xe7\xb1\xbb\xe4\xbc\xbc\xef\xbc\x8c\xe8\x80\x8c\xe4\xb8\x94\xe4\xb9\x9f\xe4\xb8\x8d\xe4\xbc\x98\xe9\x9b\x85\xef\xbc\x8c\xe6\x88\x91\xe5\xb8\x8c\xe6\x9c\x9b\xe4\xb8\x80\xe4\xb8\xaa\xe6\x96\xb0\xe7\x9a\x84\xe8\xa7\xa3\xe5\x86\xb3\xe6\x96\xb9\xe6\xa1\x88\xe5\x8f\xaf\xe4\xbb\xa5\xef\xbc\x9a\n\n1. \xe4\xb8\x8d\xe8\xa6\x81\xe7\xa6\x81\xe7\x94\xa8 Docker \xe7\x9a\x84 iptables\xef\xbc\x8c\xe5\x83\x8f\xe5\xbe\x80\xe5\xb8\xb8\xe4\xb8\x80\xe6\xa0\xb7\xe7\x94\xb1 Docker \xe6\x9d\xa5\xe7\xae\xa1\xe7\x90\x86\xe8\x87\xaa\xe5\xb7\xb1\xe7\x9a\x84\xe7\xbd\x91\xe7\xbb\x9c\xe3\x80\x82\xe8\xbf\x99\xe6\xa0\xb7\xe6\x9c\x89\xe4\xbb\xbb\xe4\xbd\x95\xe6\x96\xb0\xe5\xa2\x9e\xe7\x9a\x84 Docker \xe7\xbd\x91\xe7\xbb\x9c\xe6\x97\xb6\xe9\x83\xbd\xe6\x97\xa0\xe9\x9c\x80\xe6\x89\x8b\xe5\xb7\xa5\xe7\xbb\xb4\xe6\x8a\xa4 iptables \xe8\xa7\x84\xe5\x88\x99\xef\xbc\x8c\xe4\xb9\x9f\xe9\x81\xbf\xe5\x85\x8d\xe4\xba\x86\xe5\x9c\xa8 Docker \xe4\xb8\xad\xe7\xa6\x81\xe7\x94\xa8 iptables \xe4\xb9\x8b\xe5\x90\x8e\xe5\x8f\xaf\xe8\x83\xbd\xe5\xb8\xa6\xe6\x9d\xa5\xe7\x9a\x84\xe5\x89\xaf\xe4\xbd\x9c\xe7\x94\xa8\xe3\x80\x82\n2. \xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\x8d\xe5\x8f\xaf\xe4\xbb\xa5\xe8\xae\xbf\xe9\x97\xae Docker \xe5\x8f\x91\xe5\xb8\x83\xe5\x87\xba\xe6\x9d\xa5\xe7\x9a\x84\xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x8c\xe5\x8d\xb3\xe4\xbd\xbf\xe6\x98\xaf\xe4\xbd\xbf\xe7\x94\xa8\xe7\xb1\xbb\xe4\xbc\xbc `-p 0.0.0.0:8080:80` \xe7\x9a\x84\xe9\x80\x89\xe9\xa1\xb9\xe6\x8a\x8a\xe7\xab\xaf\xe5\x8f\xa3\xe5\x8f\x91\xe5\xb8\x83\xe5\x9c\xa8\xe6\x89\x80\xe6\x9c\x89\xe7\x9a\x84 IP \xe5\x9c\xb0\xe5\x9d\x80\xe4\xb8\x8a\xe3\x80\x82\xe5\xae\xb9\xe5\x99\xa8\xe4\xb9\x8b\xe9\x97\xb4\xe3\x80\x81\xe5\x86\x85\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb9\x8b\xe9\x97\xb4\xe9\x83\xbd\xe5\x8f\xaf\xe4\xbb\xa5\xe6\xad\xa3\xe5\xb8\xb8\xe4\xba\x92\xe7\x9b\xb8\xe8\xae\xbf\xe9\x97\xae\xef\xbc\x8c\xe5\x8f\xaa\xe6\x9c\x89\xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\x8d\xe5\x8f\xaf\xe4\xbb\xa5\xe8\xae\xbf\xe9\x97\xae\xe3\x80\x82\n   \xe8\x99\xbd\xe7\x84\xb6\xe5\x8f\xaf\xe4\xbb\xa5\xe8\xae\xa9 Docker \xe6\x8a\x8a\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe6\x9f\x90\xe4\xb8\x80\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe6\x98\xa0\xe5\xb0\x84\xe5\x88\xb0\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe7\x9a\x84\xe7\xa7\x81\xe6\x9c\x89 IP \xe5\x9c\xb0\xe5\x9d\x80\xe4\xb8\x8a\xef\xbc\x8c\xe8\xbf\x99\xe6\xa0\xb7\xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\x8a\xe5\xb0\x86\xe4\xb8\x8d\xe4\xbc\x9a\xe8\xae\xbf\xe9\x97\xae\xe5\x88\xb0\xe8\xbf\x99\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe3\x80\x82\xe4\xbd\x86\xe6\x98\xaf\xe8\xbf\x99\xe4\xb8\xaa\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe5\x8f\xaf\xe8\x83\xbd\xe6\x9c\x89\xe5\xa4\x9a\xe4\xb8\xaa\xe7\xa7\x81\xe6\x9c\x89 IP \xe5\x9c\xb0\xe5\x9d\x80\xef\xbc\x8c\xe8\xbf\x99\xe4\xba\x9b\xe7\xa7\x81\xe6\x9c\x89 IP \xe5\x9c\xb0\xe5\x9d\x80\xe5\x8f\xaf\xe8\x83\xbd\xe4\xb9\x9f\xe4\xbc\x9a\xe5\x8f\x91\xe7\x94\x9f\xe5\x8f\x98\xe5\x8c\x96\xe3\x80\x82\n3. \xe5\x8f\xaf\xe4\xbb\xa5\xe5\xbe\x88\xe6\x96\xb9\xe4\xbe\xbf\xe7\x9a\x84\xe5\x85\x81\xe8\xae\xb8\xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe7\x9b\xb4\xe6\x8e\xa5\xe8\xae\xbf\xe9\x97\xae\xe6\x9f\x90\xe4\xb8\xaa\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x8c\xe8\x80\x8c\xe6\x97\xa0\xe9\x9c\x80\xe9\xa2\x9d\xe5\xa4\x96\xe7\x9a\x84\xe8\xbd\xaf\xe4\xbb\xb6\xe5\x92\x8c\xe9\x85\x8d\xe7\xbd\xae\xe3\x80\x82\xe5\xb0\xb1\xe5\x83\x8f\xe6\x98\xaf\xe7\x94\xa8 `ufw allow 8080` \xe8\xbf\x99\xe6\xa0\xb7\xe5\x85\x81\xe8\xae\xb8\xe5\xa4\x96\xe9\x83\xa8\xe8\xae\xbf\xe9\x97\xae 8080 \xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x8c\xe7\x84\xb6\xe5\x90\x8e\xe7\x94\xa8 `ufw delete allow 8080` \xe5\xb0\xb1\xe4\xb8\x8d\xe5\x86\x8d\xe5\x85\x81\xe8\xae\xb8\xe5\xa4\x96\xe9\x83\xa8\xe8\xae\xbf\xe9\x97\xae\xe3\x80\x82\n\n## \xe5\xa6\x82\xe4\xbd\x95\xe5\x81\x9a\xef\xbc\x9f\n\n### \xe6\x92\xa4\xe9\x94\x80\xe5\x8e\x9f\xe5\x85\x88\xe7\x9a\x84\xe4\xbf\xae\xe6\x94\xb9\n\n\xe5\xa6\x82\xe6\x9e\x9c\xe5\xb7\xb2\xe7\xbb\x8f\xe6\x8c\x89\xe7\x85\xa7\xe7\x9b\xae\xe5\x89\x8d\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\x8a\xe6\x90\x9c\xe7\xb4\xa2\xe5\x88\xb0\xe8\xa7\xa3\xe5\x86\xb3\xe6\x96\xb9\xe6\xa1\x88\xe4\xbf\xae\xe6\x94\xb9\xe8\xbf\x87\xe4\xba\x86\xef\xbc\x8c\xe8\xaf\xb7\xe5\x85\x88\xe4\xbf\xae\xe6\x94\xb9\xe5\x9b\x9e\xe6\x9d\xa5\xef\xbc\x8c\xe5\x8c\x85\xe6\x8b\xac\xef\xbc\x9a\n\n1. \xe5\x90\xaf\xe7\x94\xa8 Docker \xe7\x9a\x84 iptables \xe5\x8a\x9f\xe8\x83\xbd\xef\xbc\x8c\xe5\x88\xa0\xe9\x99\xa4\xe6\x89\x80\xe6\x9c\x89\xe7\xb1\xbb\xe4\xbc\xbc `--iptables=false` \xe7\x9a\x84\xe4\xbf\xae\xe6\x94\xb9\xef\xbc\x8c\xe5\x8c\x85\xe6\x8b\xac `/etc/docker/daemon.json` \xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6\xe3\x80\x82\n2. UFW \xe7\x9a\x84\xe9\xbb\x98\xe8\xae\xa4 `FORWARD` \xe8\xa7\x84\xe5\x88\x99\xe6\x94\xb9\xe5\x9b\x9e\xe9\xbb\x98\xe8\xae\xa4\xe7\x9a\x84 `DROP`\xef\xbc\x8c\xe8\x80\x8c\xe9\x9d\x9e `ACCEPT`\xe3\x80\x82\n3. \xe5\x88\xa0\xe9\x99\xa4 UFW \xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6 `/etc/ufw/after.rules` \xe4\xb8\xad\xe4\xb8\x8e Docker \xe7\xbd\x91\xe7\xbb\x9c\xe7\x9b\xb8\xe5\x85\xb3\xe7\x9a\x84\xe8\xa7\x84\xe5\x88\x99\xe3\x80\x82\n4. \xe5\xa6\x82\xe6\x9e\x9c\xe4\xbf\xae\xe6\x94\xb9\xe4\xba\x86 Docker \xe7\x9b\xb8\xe5\x85\xb3\xe7\x9a\x84\xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6\xef\xbc\x8c\xe9\x87\x8d\xe5\x90\xaf Docker\xe3\x80\x82\xe7\xa8\x8d\xe5\x90\x8e\xe8\xbf\x98\xe8\xa6\x81\xe4\xbf\xae\xe6\x94\xb9 UFW \xe7\x9a\x84\xe9\x85\x8d\xe7\xbd\xae\xef\xbc\x8c\xe5\x8f\xaf\xe4\xbb\xa5\xe4\xb8\x80\xe5\xb9\xb6\xe9\x87\x8d\xe5\x90\xaf\xe3\x80\x82\n\n### \xe8\xa7\xa3\xe5\x86\xb3 UFW \xe5\x92\x8c Docker \xe7\x9a\x84\xe9\x97\xae\xe9\xa2\x98\n\n\xe7\x9b\xae\xe5\x89\x8d\xe6\x96\xb0\xe7\x9a\x84\xe8\xa7\xa3\xe5\x86\xb3\xe6\x96\xb9\xe6\xa1\x88\xe5\x8f\xaa\xe9\x9c\x80\xe8\xa6\x81\xe4\xbf\xae\xe6\x94\xb9\xe4\xb8\x80\xe4\xb8\xaa UFW \xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6\xe5\x8d\xb3\xe5\x8f\xaf\xef\xbc\x8cDocker \xe7\x9a\x84\xe6\x89\x80\xe6\x9c\x89\xe9\x85\x8d\xe7\xbd\xae\xe5\x92\x8c\xe9\x80\x89\xe9\xa1\xb9\xe9\x83\xbd\xe4\xbf\x9d\xe6\x8c\x81\xe9\xbb\x98\xe8\xae\xa4\xe3\x80\x82\n\n\xe4\xbf\xae\xe6\x94\xb9 UFW \xe7\x9a\x84\xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6 `/etc/ufw/after.rules`\xef\xbc\x8c\xe5\x9c\xa8\xe6\x9c\x80\xe5\x90\x8e\xe6\xb7\xbb\xe5\x8a\xa0\xe4\xb8\x8a\xe5\xa6\x82\xe4\xb8\x8b\xe8\xa7\x84\xe5\x88\x99\xef\xbc\x9a\n\n    # BEGIN UFW AND DOCKER\n    *filter\n    :ufw-user-forward - [0:0]\n    :DOCKER-USER - [0:0]\n    -A DOCKER-USER -j RETURN -s 10.0.0.0/8\n    -A DOCKER-USER -j RETURN -s 172.16.0.0/12\n    -A DOCKER-USER -j RETURN -s 192.168.0.0/16\n\n    -A DOCKER-USER -p udp -m udp --sport 53 --dport 1024:65535 -j RETURN\n\n    -A DOCKER-USER -j ufw-user-forward\n\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 172.16.0.0/12\n\n    -A DOCKER-USER -j RETURN\n    COMMIT\n    # END UFW AND DOCKER\n \n\xe7\x84\xb6\xe5\x90\x8e\xe9\x87\x8d\xe5\x90\xaf UFW\xef\xbc\x8c`sudo systemctl restart ufw`\xe3\x80\x82\xe7\x8e\xb0\xe5\x9c\xa8\xe5\xa4\x96\xe9\x83\xa8\xe5\xb0\xb1\xe5\xb7\xb2\xe7\xbb\x8f\xe6\x97\xa0\xe6\xb3\x95\xe8\xae\xbf\xe9\x97\xae Docker \xe5\x8f\x91\xe5\xb8\x83\xe5\x87\xba\xe6\x9d\xa5\xe7\x9a\x84\xe4\xbb\xbb\xe4\xbd\x95\xe7\xab\xaf\xe5\x8f\xa3\xe4\xba\x86\xef\xbc\x8c\xe4\xbd\x86\xe6\x98\xaf\xe5\xae\xb9\xe5\x99\xa8\xe5\x86\x85\xe9\x83\xa8\xe4\xbb\xa5\xe5\x8f\x8a\xe7\xa7\x81\xe6\x9c\x89\xe7\xbd\x91\xe7\xbb\x9c\xe5\x9c\xb0\xe5\x9d\x80\xe4\xb8\x8a\xe5\x8f\xaf\xe4\xbb\xa5\xe6\xad\xa3\xe5\xb8\xb8\xe4\xba\x92\xe7\x9b\xb8\xe8\xae\xbf\xe9\x97\xae\xef\xbc\x8c\xe8\x80\x8c\xe4\xb8\x94\xe5\xae\xb9\xe5\x99\xa8\xe4\xb9\x9f\xe5\x8f\xaf\xe4\xbb\xa5\xe6\xad\xa3\xe5\xb8\xb8\xe8\xae\xbf\xe9\x97\xae\xe5\xa4\x96\xe9\x83\xa8\xe7\x9a\x84\xe7\xbd\x91\xe7\xbb\x9c\xe3\x80\x82**\xe5\x8f\xaf\xe8\x83\xbd\xe7\x94\xb1\xe4\xba\x8e\xe6\x9f\x90\xe4\xba\x9b\xe6\x9c\xaa\xe7\x9f\xa5\xe5\x8e\x9f\xe5\x9b\xa0\xef\xbc\x8c\xe9\x87\x8d\xe5\x90\xaf UFW \xe4\xb9\x8b\xe5\x90\x8e\xe8\xa7\x84\xe5\x88\x99\xe4\xb9\x9f\xe6\x97\xa0\xe6\xb3\x95\xe7\x94\x9f\xe6\x95\x88\xef\xbc\x8c\xe8\xaf\xb7\xe9\x87\x8d\xe5\x90\xaf\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe3\x80\x82**\n\n\xe5\xa6\x82\xe6\x9e\x9c\xe5\xb8\x8c\xe6\x9c\x9b\xe5\x85\x81\xe8\xae\xb8\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae Docker \xe5\xae\xb9\xe5\x99\xa8\xe6\x8f\x90\xe4\xbe\x9b\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe6\xaf\x94\xe5\xa6\x82\xe6\x9c\x89\xe4\xb8\x80\xe4\xb8\xaa\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe7\xab\xaf\xe5\x8f\xa3\xe6\x98\xaf `80`\xe3\x80\x82\xe9\x82\xa3\xe5\xb0\xb1\xe5\x8f\xaf\xe4\xbb\xa5\xe7\x94\xa8\xe4\xbb\xa5\xe4\xb8\x8b\xe5\x91\xbd\xe4\xbb\xa4\xe6\x9d\xa5\xe5\x85\x81\xe8\xae\xb8\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae\xe8\xbf\x99\xe4\xb8\xaa\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x9a\n\n    ufw route allow proto tcp from any to any port 80\n\n\xe8\xbf\x99\xe4\xb8\xaa\xe5\x91\xbd\xe4\xbb\xa4\xe4\xbc\x9a\xe5\x85\x81\xe8\xae\xb8\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae\xe6\x89\x80\xe6\x9c\x89\xe7\x94\xa8 Docker \xe5\x8f\x91\xe5\xb8\x83\xe5\x87\xba\xe6\x9d\xa5\xe7\x9a\x84\xe5\xb9\xb6\xe4\xb8\x94\xe5\x86\x85\xe9\x83\xa8\xe6\x9c\x8d\xe5\x8a\xa1\xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\xba `80` \xe7\x9a\x84\xe6\x89\x80\xe6\x9c\x89\xe6\x9c\x8d\xe5\x8a\xa1\xe3\x80\x82\n\n\xe8\xaf\xb7\xe6\xb3\xa8\xe6\x84\x8f\xef\xbc\x8c\xe8\xbf\x99\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3 `80` \xe6\x98\xaf\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x8c\xe8\x80\x8c\xe9\x9d\x9e\xe4\xbd\xbf\xe7\x94\xa8 `-p 0.0.0.0:8080:80` \xe9\x80\x89\xe9\xa1\xb9\xe5\x8f\x91\xe5\xb8\x83\xe5\x9c\xa8\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe4\xb8\x8a\xe7\x9a\x84 `8080` \xe7\xab\xaf\xe5\x8f\xa3\xe3\x80\x82\n\n\xe5\xa6\x82\xe6\x9e\x9c\xe6\x9c\x89\xe5\xa4\x9a\xe4\xb8\xaa\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\xba 80\xef\xbc\x8c\xe4\xbd\x86\xe5\x8f\xaa\xe5\xb8\x8c\xe6\x9c\x9b\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae\xe6\x9f\x90\xe4\xb8\xaa\xe7\x89\xb9\xe5\xae\x9a\xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xe3\x80\x82\xe6\xaf\x94\xe5\xa6\x82\xe8\xaf\xa5\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe7\xa7\x81\xe6\x9c\x89\xe5\x9c\xb0\xe5\x9d\x80\xe4\xb8\xba `172.17.0.2`\xef\xbc\x8c\xe5\xb0\xb1\xe7\x94\xa8\xe7\xb1\xbb\xe4\xbc\xbc\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xef\xbc\x9a\n\n    ufw route allow proto tcp from any to 172.17.0.2 port 80\n\n\xe5\xa6\x82\xe6\x9e\x9c\xe4\xb8\x80\xe4\xb8\xaa\xe5\xae\xb9\xe5\x99\xa8\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe6\x98\xaf UDP \xe5\x8d\x8f\xe8\xae\xae\xef\xbc\x8c\xe5\x81\x87\xe5\xa6\x82\xe6\x98\xaf DNS \xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe5\x8f\xaf\xe4\xbb\xa5\xe7\x94\xa8\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xe6\x9d\xa5\xe5\x85\x81\xe8\xae\xb8\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae\xe6\x89\x80\xe6\x9c\x89\xe5\x8f\x91\xe5\xb8\x83\xe5\x87\xba\xe6\x9d\xa5\xe7\x9a\x84 DNS \xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x9a\n\n    ufw route allow proto udp from any to any port 53\n\n\xe5\x90\x8c\xe6\xa0\xb7\xe7\x9a\x84\xef\xbc\x8c\xe5\xa6\x82\xe6\x9e\x9c\xe5\x8f\xaa\xe9\x92\x88\xe5\xaf\xb9\xe4\xb8\x80\xe4\xb8\xaa\xe7\x89\xb9\xe5\xae\x9a\xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xef\xbc\x8c\xe6\xaf\x94\xe5\xa6\x82 IP \xe5\x9c\xb0\xe5\x9d\x80\xe4\xb8\xba `172.17.0.2`\xef\xbc\x9a\n\n    ufw route allow proto udp from any to 172.17.0.2 port 53\n\n### \xe8\xa7\xa3\xe9\x87\x8a\n\n\xe5\x9c\xa8\xe6\x96\xb0\xe5\xa2\x9e\xe7\x9a\x84\xe8\xbf\x99\xe6\xae\xb5\xe8\xa7\x84\xe5\x88\x99\xe4\xb8\xad\xef\xbc\x8c\xe4\xb8\x8b\xe9\x9d\xa2\xe8\xbf\x99\xe6\xae\xb5\xe8\xa7\x84\xe5\x88\x99\xe6\x98\xaf\xe4\xb8\xba\xe4\xba\x86\xe8\xae\xa9\xe7\xa7\x81\xe6\x9c\x89\xe7\xbd\x91\xe7\xbb\x9c\xe5\x9c\xb0\xe5\x9d\x80\xe5\x8f\xaf\xe4\xbb\xa5\xe4\xba\x92\xe7\x9b\xb8\xe8\xae\xbf\xe9\x97\xae\xe3\x80\x82\xe9\x80\x9a\xe5\xb8\xb8\xe6\x83\x85\xe5\x86\xb5\xe4\xb8\x8b\xef\xbc\x8c\xe7\xa7\x81\xe6\x9c\x89\xe7\xbd\x91\xe7\xbb\x9c\xe6\x98\xaf\xe6\xaf\x94\xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe6\x9b\xb4\xe4\xbf\xa1\xe4\xbb\xbb\xe7\x9a\x84\xe3\x80\x82\n\n    -A DOCKER-USER -j RETURN -s 10.0.0.0/8\n    -A DOCKER-USER -j RETURN -s 172.16.0.0/12\n    -A DOCKER-USER -j RETURN -s 192.168.0.0/16\n\n\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe8\xa7\x84\xe5\x88\x99\xe6\x98\xaf\xe4\xb8\xba\xe4\xba\x86\xe5\x8f\xaf\xe4\xbb\xa5\xe7\x94\xa8 UFW \xe6\x9d\xa5\xe7\xae\xa1\xe7\x90\x86\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe6\x98\xaf\xe5\x90\xa6\xe5\x85\x81\xe8\xae\xb8\xe8\xae\xbf\xe9\x97\xae Docker \xe5\xae\xb9\xe5\x99\xa8\xe6\x8f\x90\xe4\xbe\x9b\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe8\xbf\x99\xe6\xa0\xb7\xe6\x88\x91\xe4\xbb\xac\xe5\xb0\xb1\xe5\x8f\xaf\xe4\xbb\xa5\xe5\x9c\xa8\xe4\xb8\x80\xe4\xb8\xaa\xe5\x9c\xb0\xe6\x96\xb9\xe6\x9d\xa5\xe7\xae\xa1\xe7\x90\x86\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe7\x9a\x84\xe8\xa7\x84\xe5\x88\x99\xe4\xba\x86\xe3\x80\x82\n\n    -A DOCKER-USER -j ufw-user-forward\n\n\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe8\xa7\x84\xe5\x88\x99\xe9\x98\xbb\xe6\xad\xa2\xe4\xba\x86\xe6\x89\x80\xe6\x9c\x89\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe5\x8f\x91\xe8\xb5\xb7\xe7\x9a\x84\xe8\xbf\x9e\xe6\x8e\xa5\xe8\xaf\xb7\xe6\xb1\x82\xef\xbc\x8c\xe4\xbd\x86\xe6\x98\xaf\xe5\x85\x81\xe8\xae\xb8\xe5\x86\x85\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe3\x80\x82\xe5\xaf\xb9\xe4\xba\x8e TCP \xe5\x8d\x8f\xe8\xae\xae\xef\xbc\x8c\xe6\x98\xaf\xe9\x98\xbb\xe6\xad\xa2\xe4\xba\x86\xe4\xbb\x8e\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\xbb\xe5\x8a\xa8\xe5\xbb\xba\xe7\xab\x8b TCP \xe8\xbf\x9e\xe6\x8e\xa5\xe3\x80\x82\xe5\xaf\xb9\xe4\xba\x8e UDP\xef\xbc\x8c\xe6\x98\xaf\xe9\x98\xbb\xe6\xad\xa2\xe4\xba\x86\xe6\x89\x80\xe6\x9c\x89\xe5\xb0\x8f\xe4\xbd\x99\xe7\xab\xaf\xe5\x8f\xa3 `32767` \xe7\x9a\x84\xe8\xae\xbf\xe9\x97\xae\xe3\x80\x82\xe4\xb8\xba\xe4\xbb\x80\xe4\xb9\x88\xe6\x98\xaf\xe8\xbf\x99\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe7\x9a\x84\xef\xbc\x9f\xe7\x94\xb1\xe4\xba\x8e UDP \xe5\x8d\x8f\xe8\xae\xae\xe6\x98\xaf\xe6\x97\xa0\xe7\x8a\xb6\xe6\x80\x81\xe7\x9a\x84\xef\xbc\x8c\xe6\x97\xa0\xe6\xb3\x95\xe5\x83\x8f TCP \xe9\x82\xa3\xe6\xa0\xb7\xe9\x98\xbb\xe6\xad\xa2\xe5\x8f\x91\xe8\xb5\xb7\xe5\xbb\xba\xe7\xab\x8b\xe8\xbf\x9e\xe6\x8e\xa5\xe8\xaf\xb7\xe6\xb1\x82\xe7\x9a\x84\xe6\x8f\xa1\xe6\x89\x8b\xe4\xbf\xa1\xe5\x8f\xb7\xe3\x80\x82\xe5\x9c\xa8 GNU/Linux \xe4\xb8\x8a\xe6\x9f\xa5\xe7\x9c\x8b\xe6\x96\x87\xe4\xbb\xb6 `/proc/sys/net/ipv4/ip_local_port_range` \xe5\x8f\xaf\xe4\xbb\xa5\xe7\x9c\x8b\xe5\x88\xb0\xe5\x8f\x91\xe5\x87\xba TCP/UDP \xe6\x95\xb0\xe6\x8d\xae\xe5\x90\x8e\xef\xbc\x8c\xe6\x9c\xac\xe5\x9c\xb0\xe6\xba\x90\xe7\xab\xaf\xe5\x8f\xa3\xe7\x9a\x84\xe8\x8c\x83\xe5\x9b\xb4\xef\xbc\x8c\xe9\xbb\x98\xe8\xae\xa4\xe4\xb8\xba `32768 60999`\xe3\x80\x82\xe5\xbd\x93\xe4\xbb\x8e\xe4\xb8\x80\xe4\xb8\xaa\xe8\xbf\x90\xe8\xa1\x8c\xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xe5\xaf\xb9\xe5\xa4\x96\xe8\xae\xbf\xe9\x97\xae\xe4\xb8\x80\xe4\xb8\xaa UDP \xe5\x8d\x8f\xe8\xae\xae\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe6\x97\xb6\xef\xbc\x8c\xe6\x9c\xac\xe5\x9c\xb0\xe7\xab\xaf\xe5\x8f\xa3\xe5\xb0\x86\xe4\xbc\x9a\xe4\xbb\x8e\xe8\xbf\x99\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe8\x8c\x83\xe5\x9b\xb4\xe9\x87\x8c\xe9\x9d\xa2\xe9\x9a\x8f\xe6\x9c\xba\xe9\x80\x89\xe6\x8b\xa9\xe4\xb8\x80\xe4\xb8\xaa\xef\xbc\x8c\xe6\x9c\x8d\xe5\x8a\xa1\xe5\x99\xa8\xe5\xb0\x86\xe4\xbc\x9a\xe6\x8a\x8a\xe6\x95\xb0\xe6\x8d\xae\xe8\xbf\x94\xe5\x9b\x9e\xe5\x88\xb0\xe8\xbf\x99\xe4\xb8\xaa\xe9\x9a\x8f\xe6\x9c\xba\xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\x8a\xe3\x80\x82\xe6\x89\x80\xe4\xbb\xa5\xef\xbc\x8c\xe6\x88\x91\xe4\xbb\xac\xe5\x8f\xaf\xe4\xbb\xa5\xe5\x81\x87\xe5\xae\x9a\xe6\x89\x80\xe6\x9c\x89\xe5\xae\xb9\xe5\x99\xa8\xe5\x86\x85\xe9\x83\xa8\xe7\x9a\x84 UDP \xe5\x8d\x8f\xe8\xae\xae\xe7\x9a\x84\xe7\x9b\x91\xe5\x90\xac\xe7\xab\xaf\xe5\x8f\xa3\xe9\x83\xbd\xe5\xb0\x8f\xe4\xbd\x99 `32768`\xef\xbc\x8c\xe4\xb8\x8d\xe5\x85\x81\xe8\xae\xb8\xe5\xa4\x96\xe9\x83\xa8\xe7\xbd\x91\xe7\xbb\x9c\xe4\xb8\xbb\xe5\x8a\xa8\xe8\xbf\x9e\xe6\x8e\xa5\xe5\xb0\x8f\xe4\xbd\x99 `32768` \xe7\x9a\x84 UDP \xe7\xab\xaf\xe5\x8f\xa3\xe3\x80\x82\n\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -d 172.16.0.0/12\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 192.168.0.0/16\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 10.0.0.0/8\n    -A DOCKER-USER -j DROP -p udp -m udp --dport 0:32767 -d 172.16.0.0/12\n\n    -A DOCKER-USER -j RETURN\n\n\xe5\xa6\x82\xe6\x9e\x9c\xe4\xb8\x80\xe4\xb8\xaa\xe5\xae\xb9\xe5\x99\xa8\xe5\x9c\xa8\xe6\x8e\xa5\xe5\x8f\x97\xe6\x95\xb0\xe6\x8d\xae\xe7\x9a\x84\xe6\x97\xb6\xe5\x80\x99\xef\xbc\x8c\xe7\xab\xaf\xe5\x8f\xa3\xe5\x8f\xb7\xe6\xb2\xa1\xe6\x9c\x89\xe9\x81\xb5\xe5\xbe\xaa\xe6\x93\x8d\xe4\xbd\x9c\xe7\xb3\xbb\xe7\xbb\x9f\xe7\x9a\x84\xe8\xae\xbe\xe5\xae\x9a\xef\xbc\x8c\xe4\xb9\x9f\xe5\xb0\xb1\xe6\x98\xaf\xe8\xaf\xb4\xe6\x9c\x80\xe5\xb0\x8f\xe7\xab\xaf\xe5\x8f\xa3\xe5\x8f\xb7\xe8\xa6\x81\xe5\xb0\x8f\xe4\xbd\x99 `32768`\xe3\x80\x82\xe6\xaf\x94\xe5\xa6\x82\xe8\xbf\x90\xe8\xa1\x8c\xe4\xba\x86\xe4\xb8\x80\xe4\xb8\xaa Dnsmasq \xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xef\xbc\x8cDnsmasq \xe7\x94\xa8\xe4\xba\x8e\xe6\x8e\xa5\xe5\x8f\x97\xe6\x95\xb0\xe6\x8d\xae\xe7\x9a\x84\xe6\x9c\x80\xe5\xb0\x8f\xe7\xab\xaf\xe5\x8f\xa3\xe5\x8f\xb7\xe9\xbb\x98\xe8\xae\xa4\xe6\x98\xaf `1024`\xe3\x80\x82\xe9\x82\xa3\xe5\x8f\xaf\xe4\xbb\xa5\xe7\x94\xa8\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xe6\x9d\xa5\xe5\x85\x81\xe8\xae\xb8 Dnsmasq \xe8\xbf\x99\xe4\xb8\xaa\xe5\xae\xb9\xe5\x99\xa8\xe4\xbd\xbf\xe7\x94\xa8\xe4\xb8\x80\xe4\xb8\xaa\xe6\x9b\xb4\xe5\xa4\xa7\xe7\x9a\x84\xe7\xab\xaf\xe5\x8f\xa3\xe8\x8c\x83\xe5\x9b\xb4\xe6\x9d\xa5\xe6\x8e\xa5\xe5\x8f\x97\xe6\x95\xb0\xe6\x8d\xae\xe3\x80\x82\n\n    ufw route allow proto udp from any port 53 to any port 1024:65535\n\n\xe5\x9b\xa0\xe4\xb8\xba DNS \xe6\x98\xaf\xe4\xb8\x80\xe4\xb8\xaa\xe9\x9d\x9e\xe5\xb8\xb8\xe5\xb8\xb8\xe8\xa7\x81\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe6\x89\x80\xe4\xbb\xa5\xe5\xb7\xb2\xe7\xbb\x8f\xe6\x9c\x89\xe4\xb8\x80\xe6\x9d\xa1\xe8\xa7\x84\xe5\x88\x99\xe7\x94\xa8\xe4\xba\x8e\xe5\x85\x81\xe8\xae\xb8\xe4\xbd\xbf\xe7\x94\xa8\xe4\xb8\x80\xe4\xb8\xaa\xe6\x9b\xb4\xe5\xa4\xa7\xe7\x9a\x84\xe7\xab\xaf\xe5\x8f\xa3\xe8\x8c\x83\xe5\x9b\xb4\xe6\x9d\xa5\xe6\x8e\xa5\xe5\x8f\x97 DNS \xe6\x95\xb0\xe6\x8d\xae\xe5\x8c\x85\n\n### \xe9\x80\x89\xe6\x8b\xa9 `ufw-user-forward` \xe8\x80\x8c\xe4\xb8\x8d\xe6\x98\xaf `ufw-user-input` \xe7\x9a\x84\xe5\x8e\x9f\xe5\x9b\xa0\n\n#### \xe4\xbd\xbf\xe7\x94\xa8 `ufw-user-input`\n\n\xe4\xbc\x98\xe7\x82\xb9\xef\xbc\x9a\n\n\xe4\xbd\xbf\xe7\x94\xa8\xe7\x9a\x84 UFW \xe5\x91\xbd\xe4\xbb\xa4\xe6\xaf\x94\xe8\xbe\x83\xe7\xae\x80\xe5\x8d\x95\xef\xbc\x8c\xe4\xb9\x9f\xe6\xaf\x94\xe8\xbe\x83\xe5\xae\xb9\xe6\x98\x93\xe7\x90\x86\xe8\xa7\xa3\xef\xbc\x8c\xe8\x80\x8c\xe4\xb8\x94\xe4\xb9\x9f\xe6\x94\xaf\xe6\x8c\x81\xe8\x80\x81\xe7\x89\x88\xe6\x9c\xac\xe7\x9a\x84 Ubuntu\n\n\xe6\xaf\x94\xe5\xa6\x82\xef\xbc\x8c\xe5\x85\x81\xe8\xae\xb8\xe5\x85\xac\xe4\xbc\x97\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae\xe4\xb8\x80\xe4\xb8\xaa\xe5\xb7\xb2\xe7\xbb\x8f\xe5\x8f\x91\xe5\xb8\x83\xe5\x87\xba\xe6\x9d\xa5\xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xe7\xab\xaf\xe5\x8f\xa3 `8080`\xef\xbc\x8c\xe4\xbd\xbf\xe7\x94\xa8\xe5\x91\xbd\xe4\xbb\xa4\xef\xbc\x9a\n\n    ufw allow 8080\n\n\xe7\xbc\xba\xe7\x82\xb9\xef\xbc\x9a\n\n\xe4\xb8\x8d\xe4\xbb\x85\xe4\xbb\x85\xe6\x98\xaf\xe6\x9a\xb4\xe9\x9c\xb2\xe4\xba\x86\xe5\xb7\xb2\xe7\xbb\x8f\xe5\x8f\x91\xe5\xb8\x83\xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x8c\xe4\xb9\x9f\xe6\x9a\xb4\xe9\x9c\xb2\xe4\xba\x86\xe4\xb8\xbb\xe6\x9c\xba\xe4\xb8\x8a\xe7\x9a\x84\xe7\xab\xaf\xe5\x8f\xa3\xe3\x80\x82\n\n\xe6\xaf\x94\xe5\xa6\x82\xef\xbc\x8c\xe5\xa6\x82\xe6\x9e\x9c\xe5\x9c\xa8\xe4\xb8\xbb\xe6\x9c\xba\xe4\xb8\x8a\xe8\xbf\x90\xe8\xa1\x8c\xe4\xba\x86\xe4\xb8\x80\xe4\xb8\xaa\xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\xba `8080` \xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe3\x80\x82\xe5\x91\xbd\xe4\xbb\xa4 `ufw allow 8080` \xe5\x85\x81\xe8\xae\xb8\xe4\xba\x86\xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe8\xae\xbf\xe9\x97\xae\xe8\xbf\x99\xe4\xb8\xaa\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe4\xb9\x9f\xe5\x85\x81\xe8\xae\xb8\xe4\xba\x86\xe8\xae\xbf\xe9\x97\xae\xe6\x89\x80\xe6\x9c\x89\xe5\xb7\xb2\xe7\xbb\x8f\xe5\x8f\x91\xe5\xb8\x83\xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\xba `8080` \xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe3\x80\x82\xe4\xbd\x86\xe6\x98\xaf\xe6\x88\x91\xe4\xbb\xac\xe5\x8f\xaf\xe8\x83\xbd\xe5\x8f\xaa\xe6\x98\xaf\xe5\xb8\x8c\xe6\x9c\x9b\xe4\xbf\x9d\xe7\x95\x99\xe4\xb8\xbb\xe6\x9c\xba\xe4\xb8\x8a\xe7\x9a\x84\xe8\xbf\x99\xe4\xb8\xaa\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe6\x88\x96\xe8\x80\x85\xe6\x98\xaf\xe8\xbf\x90\xe8\xa1\x8c\xe5\x9c\xa8\xe5\xae\xb9\xe5\x99\xa8\xe9\x87\x8c\xe9\x9d\xa2\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe8\x80\x8c\xe4\xb8\x8d\xe6\x98\xaf\xe4\xb8\xa4\xe4\xb8\xaa\xe5\x90\x8c\xe6\x97\xb6\xe6\x9a\xb4\xe9\x9c\xb2\xe3\x80\x82\n\n\xe4\xb8\xba\xe4\xba\x86\xe9\x81\xbf\xe5\x85\x8d\xe8\xbf\x99\xe4\xb8\xaa\xe9\x97\xae\xe9\xa2\x98\xef\xbc\x8c\xe6\x88\x91\xe4\xbb\xac\xe5\x8f\xaf\xe8\x83\xbd\xe9\x9c\x80\xe8\xa6\x81\xe4\xbd\xbf\xe7\x94\xa8\xe7\xb1\xbb\xe4\xbc\xbc\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xe6\x9d\xa5\xe7\xae\xa1\xe7\x90\x86\xe5\xb7\xb2\xe7\xbb\x8f\xe5\x8f\x91\xe5\xb8\x83\xe7\x9a\x84\xe5\xae\xb9\xe5\x99\xa8\xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x9a\n\n    ufw allow proto tcp from any to 172.16.0.3 port 8080\n\n#### \xe4\xbd\xbf\xe7\x94\xa8 `ufw-user-forward`\n\n\xe4\xbc\x98\xe7\x82\xb9\xef\xbc\x9a\n\n\xe4\xb8\x8d\xe4\xbc\x9a\xe5\x9b\xa0\xe4\xb8\xba\xe5\x90\x8c\xe4\xb8\x80\xe6\x9d\xa1\xe5\x91\xbd\xe4\xbb\xa4\xe8\x80\x8c\xe5\x90\x8c\xe6\x97\xb6\xe6\x9a\xb4\xe9\x9c\xb2\xe4\xb8\xbb\xe6\x9c\xba\xe5\x92\x8c\xe5\xae\xb9\xe5\x99\xa8\xe9\x87\x8c\xe9\x9d\xa2\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe3\x80\x82\n\n\xe6\xaf\x94\xe5\xa6\x82\xef\xbc\x8c\xe5\xa6\x82\xe6\x9e\x9c\xe6\x88\x91\xe4\xbb\xac\xe5\xb8\x8c\xe6\x9c\x9b\xe6\x9a\xb4\xe9\x9c\xb2\xe6\x89\x80\xe6\x9c\x89\xe5\xae\xb9\xe5\x99\xa8\xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\xba `8080` \xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe4\xbd\xbf\xe7\x94\xa8\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xef\xbc\x9a\n\n    ufw route allow 8080\n\n\xe7\x8e\xb0\xe5\x9c\xa8\xe5\x85\xac\xe5\x85\xb1\xe7\xbd\x91\xe7\xbb\x9c\xe5\x8f\xaf\xe4\xbb\xa5\xe8\xae\xbf\xe9\x97\xae\xe6\x89\x80\xe6\x9c\x89\xe5\xae\xb9\xe5\x99\xa8\xe7\xab\xaf\xe5\x8f\xa3\xe4\xb8\xba `8080` \xe7\x9a\x84\xe5\xb7\xb2\xe7\xbb\x8f\xe5\x8f\x91\xe5\xb8\x83\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xef\xbc\x8c\xe4\xbd\x86\xe6\x98\xaf\xe8\xbf\x90\xe8\xa1\x8c\xe5\x9c\xa8\xe4\xb8\xbb\xe6\x9c\xba\xe4\xb8\x8a\xe7\x9a\x84 `8080` \xe6\x9c\x8d\xe5\x8a\xa1\xe4\xbb\x8d\xe7\x84\xb6\xe4\xb8\x8d\xe4\xbc\x9a\xe8\xa2\xab\xe5\x85\xac\xe5\xbc\x80\xe3\x80\x82\xe5\xa6\x82\xe6\x9e\x9c\xe6\x88\x91\xe4\xbb\xac\xe5\xb8\x8c\xe6\x9c\x9b\xe5\x85\xac\xe5\xbc\x80\xe4\xb8\xbb\xe6\x9c\xba\xe4\xb8\x8a\xe7\x9a\x84 `8080` \xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x8c\xe5\x8f\xaf\xe4\xbb\xa5\xe6\x89\xa7\xe8\xa1\x8c\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xef\xbc\x9a\n\n    ufw allow 8080\n\n\xe7\xbc\xba\xe7\x82\xb9\xef\xbc\x9a\n\n\xe4\xb8\x8d\xe6\x94\xaf\xe6\x8c\x81\xe8\x80\x81\xe7\x89\x88\xe6\x9c\xac\xe7\x9a\x84 Ubuntu\xef\xbc\x8c\xe8\x80\x8c\xe4\xb8\x94\xe5\x91\xbd\xe4\xbb\xa4\xe7\x9a\x84\xe4\xbd\xbf\xe7\x94\xa8\xe4\xb8\x8a\xe5\x8f\xaf\xe8\x83\xbd\xe4\xb9\x9f\xe4\xbc\x9a\xe6\xaf\x94\xe8\xbe\x83\xe5\xa4\x8d\xe6\x9d\x82\xe3\x80\x82\n\n#### \xe7\xbb\x93\xe8\xae\xba\n\n\xe5\xa6\x82\xe6\x9e\x9c\xe6\x88\x91\xe4\xbb\xac\xe6\xad\xa3\xe5\x9c\xa8\xe4\xbd\xbf\xe7\x94\xa8\xe8\x80\x81\xe7\x89\x88\xe6\x9c\xac\xe7\x9a\x84 Ubuntu\xef\xbc\x8c\xe6\x88\x91\xe4\xbb\xac\xe5\x8f\xaf\xe4\xbb\xa5\xe4\xbd\xbf\xe7\x94\xa8 `ufw-user-input`\xe3\x80\x82\xe4\xbd\x86\xe6\x98\xaf\xe8\xa6\x81\xe5\xb0\x8f\xe5\xbf\x83\xe9\x81\xbf\xe5\x85\x8d\xe6\x8a\x8a\xe4\xb8\x8d\xe8\xaf\xa5\xe6\x9a\xb4\xe9\x9c\xb2\xe7\x9a\x84\xe6\x9c\x8d\xe5\x8a\xa1\xe6\x9a\xb4\xe9\x9c\xb2\xe5\x87\xba\xe5\x8e\xbb\xe3\x80\x82\n\n\xe5\xa6\x82\xe6\x9e\x9c\xe6\xad\xa3\xe5\x9c\xa8\xe4\xbd\xbf\xe7\x94\xa8\xe6\x94\xaf\xe6\x8c\x81 `ufw route` \xe5\x91\xbd\xe4\xbb\xa4\xe7\x9a\x84\xe6\x96\xb0\xe7\x89\x88\xe6\x9c\xac\xe7\x9a\x84 Ubuntu\xef\xbc\x8c\xe6\x88\x91\xe4\xbb\xac\xe6\x9c\x80\xe5\xa5\xbd\xe4\xbd\xbf\xe7\x94\xa8 `ufw-user-forward`\xef\xbc\x8c\xe5\xb9\xb6\xe4\xb8\x94\xe4\xbd\xbf\xe7\x94\xa8 `ufw route` \xe6\x9d\xa5\xe7\xae\xa1\xe7\x90\x86\xe4\xb8\x8e\xe5\xae\xb9\xe5\x99\xa8\xe7\x9b\xb8\xe5\x85\xb3\xe7\x9a\x84\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe8\xa7\x84\xe5\x88\x99\xe3\x80\x82\n\n## `ufw-docker` \xe5\xb7\xa5\xe5\x85\xb7\n\n\xe7\x8e\xb0\xe5\x9c\xa8\xe8\xbf\x99\xe4\xb8\xaa\xe8\x84\x9a\xe6\x9c\xac\xe4\xb9\x9f\xe6\x94\xaf\xe6\x8c\x81 Docker Swarm\xe3\x80\x82\n\n### \xe5\xae\x89\xe8\xa3\x85\n\n\xe4\xb8\x8b\xe8\xbd\xbd `ufw-docker` \xe8\x84\x9a\xe6\x9c\xac\n\n    sudo wget -O /usr/local/bin/ufw-docker \\\n      https://github.com/chaifeng/ufw-docker/raw/master/ufw-docker\n    chmod +x /usr/local/bin/ufw-docker\n\n\xe4\xbd\xbf\xe7\x94\xa8\xe4\xb8\x8b\xe5\x88\x97\xe5\x91\xbd\xe4\xbb\xa4\xe6\x9d\xa5\xe4\xbf\xae\xe6\x94\xb9 ufw \xe7\x9a\x84 `after.rules` \xe6\x96\x87\xe4\xbb\xb6\n\n    ufw-docker install\n\n\xe8\xbf\x99\xe4\xb8\xaa\xe5\x91\xbd\xe4\xbb\xa4\xe5\x81\x9a\xe4\xba\x86\xe4\xbb\xa5\xe4\xb8\x8b\xe4\xba\x8b\xe6\x83\x85\xef\xbc\x9a\n- \xe5\xa4\x87\xe4\xbb\xbd\xe6\x96\x87\xe4\xbb\xb6 `/etc/ufw/after.rules`\n- \xe6\x8a\x8a UFW \xe5\x92\x8c Docker \xe7\x9a\x84\xe7\x9b\xb8\xe5\x85\xb3\xe8\xa7\x84\xe5\x88\x99\xe6\xb7\xbb\xe5\x8a\xa0\xe5\x88\xb0\xe6\x96\x87\xe4\xbb\xb6 `after.rules` \xe7\x9a\x84\xe6\x9c\xab\xe5\xb0\xbe\n\n#### \xe4\xb8\xba Docker Swarm \xe7\x8e\xaf\xe5\xa2\x83\xe5\xae\x89\xe8\xa3\x85\n\n\xe4\xbb\x85\xe4\xbb\x85\xe5\x8f\xaf\xe4\xbb\xa5\xe5\x9c\xa8\xe7\xae\xa1\xe7\x90\x86\xe8\x8a\x82\xe7\x82\xb9\xe4\xb8\x8a\xe4\xbd\xbf\xe7\x94\xa8 `ufw-docker` \xe8\xbf\x99\xe4\xb8\xaa\xe8\x84\x9a\xe6\x9c\xac\xe6\x9d\xa5\xe7\xae\xa1\xe7\x90\x86\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe8\xa7\x84\xe5\x88\x99\xe3\x80\x82\n\n- \xe5\x9c\xa8\xe6\x89\x80\xe6\x9c\x89\xe7\x9a\x84\xe8\x8a\x82\xe7\x82\xb9\xe4\xb8\x8a\xe4\xbf\xae\xe6\x94\xb9 `after.rules` \xe8\xbf\x99\xe4\xb8\xaa\xe6\x96\x87\xe4\xbb\xb6\xef\xbc\x8c\xe5\x8c\x85\xe6\x8b\xac\xe7\xae\xa1\xe7\x90\x86\xe8\x8a\x82\xe7\x82\xb9\xe5\x92\x8c\xe5\xb7\xa5\xe4\xbd\x9c\xe8\x8a\x82\xe7\x82\xb9\n- \xe5\x9c\xa8\xe7\xae\xa1\xe7\x90\x86\xe8\x8a\x82\xe7\x82\xb9\xe4\xb8\x8a\xe9\x83\xa8\xe7\xbd\xb2\xe8\xbf\x99\xe4\xb8\xaa\xe8\x84\x9a\xe6\x9c\xac\n\n\xe8\xbf\x90\xe8\xa1\x8c\xe5\x9c\xa8 Docker Swarm \xe6\xa8\xa1\xe5\xbc\x8f\xe4\xb8\x8b\xef\xbc\x8c\xe8\xbf\x99\xe4\xb8\xaa\xe8\x84\x9a\xe6\x9c\xac\xe5\xb0\x86\xe4\xbc\x9a\xe5\x88\x9b\xe5\xbb\xba\xe4\xb8\x80\xe4\xb8\xaa\xe5\x85\xa8\xe5\xb1\x80\xe6\x9c\x8d\xe5\x8a\xa1 `ufw-docker-agent`\xe3\x80\x82\xe8\xbf\x99\xe4\xb8\xaa\xe9\x95\x9c\xe5\x83\x8f [chaifeng/ufw-docker-agent](https://hub.docker.com/r/chaifeng/ufw-docker-agent/) \xe6\x98\xaf\xe7\x94\xb1\xe6\x9c\xac\xe9\xa1\xb9\xe7\x9b\xae\xe8\x87\xaa\xe5\x8a\xa8\xe6\x9e\x84\xe5\xbb\xba\xe7\x9a\x84\xe3\x80\x82\n\n### \xe4\xbd\xbf\xe7\x94\xa8\xe6\x96\xb9\xe6\xb3\x95\n\n\xe6\x98\xbe\xe7\xa4\xba\xe5\xb8\xae\xe5\x8a\xa9\n\n    ufw-docker help\n\n\xe6\xa3\x80\xe6\x9f\xa5 UFW \xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6\xe4\xb8\xad\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe8\xa7\x84\xe5\x88\x99\xe7\x9a\x84\xe5\xae\x89\xe8\xa3\x85\n\n    ufw-docker check\n\n\xe6\x9b\xb4\xe6\x96\xb0 UFW \xe7\x9a\x84\xe9\x85\x8d\xe7\xbd\xae\xe6\x96\x87\xe4\xbb\xb6\xef\xbc\x8c\xe6\xb7\xbb\xe5\x8a\xa0\xe5\xbf\x85\xe8\xa6\x81\xe7\x9a\x84\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe8\xa7\x84\xe5\x88\x99\n\n    ufw-docker install\n\n\xe6\x98\xbe\xe7\xa4\xba\xe5\xbd\x93\xe5\x89\x8d\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe5\x85\x81\xe8\xae\xb8\xe7\x9a\x84\xe8\xbd\xac\xe5\x8f\x91\xe8\xa7\x84\xe5\x88\x99\n\n    ufw-docker status\n\n\xe5\x88\x97\xe5\x87\xba\xe6\x89\x80\xe6\x9c\x89\xe5\x92\x8c\xe5\xae\xb9\xe5\x99\xa8 `httpd` \xe7\x9b\xb8\xe5\x85\xb3\xe7\x9a\x84\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe8\xa7\x84\xe5\x88\x99\n\n    ufw-docker list httpd\n\n\xe6\x9a\xb4\xe9\x9c\xb2\xe5\xae\xb9\xe5\x99\xa8 `httpd` \xe7\x9a\x84 `80` \xe7\xab\xaf\xe5\x8f\xa3\n\n    ufw-docker allow httpd 80\n\n\xe6\x9a\xb4\xe9\x9c\xb2\xe5\xae\xb9\xe5\x99\xa8 `httpd` \xe7\x9a\x84 `443` \xe7\xab\xaf\xe5\x8f\xa3\xef\xbc\x8c\xe4\xb8\x94\xe5\x8d\x8f\xe8\xae\xae\xe4\xb8\xba `tcp`\n\n    ufw-docker allow httpd 443/tcp\n\n\xe6\x8a\x8a\xe5\xae\xb9\xe5\x99\xa8 `httpd` \xe7\x9a\x84\xe6\x89\x80\xe6\x9c\x89\xe6\x98\xa0\xe5\xb0\x84\xe7\xab\xaf\xe5\x8f\xa3\xe9\x83\xbd\xe6\x9a\xb4\xe9\x9c\xb2\xe5\x87\xba\xe6\x9d\xa5\n\n    ufw-docker allow httpd\n\n\xe5\x88\xa0\xe9\x99\xa4\xe6\x89\x80\xe6\x9c\x89\xe5\x92\x8c\xe5\xae\xb9\xe5\x99\xa8 `httpd` \xe7\x9b\xb8\xe5\x85\xb3\xe7\x9a\x84\xe9\x98\xb2\xe7\x81\xab\xe5\xa2\x99\xe8\xa7\x84\xe5\x88\x99\n\n    ufw-docker delete allow httpd\n\n\xe5\x88\xa0\xe9\x99\xa4\xe5\xae\xb9\xe5\x99\xa8 `httpd` \xe7\x9a\x84 `tcp` \xe7\xab\xaf\xe5\x8f\xa3 `443` \xe7\x9a\x84\xe8\xa7\x84\xe5\x88\x99\n\n    ufw-docker delete allow httpd 443/tcp\n\n\xe6\x9a\xb4\xe9\x9c\xb2\xe6\x9c\x8d\xe5\x8a\xa1 `web` \xe7\x9a\x84 `80` \xe7\xab\xaf\xe5\x8f\xa3\n\n    docker service create --name web --publish 8080:80 httpd:alpine\n\n    ufw-docker service allow web 80\n    # \xe6\x88\x96\xe8\x80\x85\n    ufw-docker service allow web 80/tcp\n\n\xe5\x88\xa0\xe9\x99\xa4\xe4\xb8\x8e\xe6\x9c\x8d\xe5\x8a\xa1 `web` \xe7\x9b\xb8\xe5\x85\xb3\xe7\x9a\x84\xe8\xa7\x84\xe5\x88\x99\n\n    ufw-docker service delete allow web\n\n### \xe8\xaf\x95\xe8\xaf\x95\n\n\xe6\x88\x91\xe4\xbb\xac\xe4\xbd\xbf\xe7\x94\xa8 [Vagrant](https://www.vagrantup.com/) \xe6\x9d\xa5\xe5\x88\x9b\xe5\xbb\xba\xe4\xb8\x80\xe4\xb8\xaa\xe6\x9c\xac\xe5\x9c\xb0\xe7\x9a\x84\xe6\xb5\x8b\xe8\xaf\x95\xe7\x8e\xaf\xe5\xa2\x83\xe3\x80\x82\n\n\xe8\xbf\x90\xe8\xa1\x8c\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xe6\x9d\xa5\xe5\x88\x9b\xe5\xbb\xba 1 \xe4\xb8\xaa master \xe8\x8a\x82\xe7\x82\xb9\xe5\x92\x8c 2 \xe4\xb8\xaa workder \xe8\x8a\x82\xe7\x82\xb9\n\n    vagrant up\n\n\xe7\x99\xbb\xe5\xbd\x95\xe5\x88\xb0 master \xe8\x8a\x82\xe7\x82\xb9\n\n    vagrant ssh master\n\n\xe7\x99\xbb\xe5\xbd\x95\xe5\x90\x8e\xef\xbc\x8c\xe5\x88\x9b\xe5\xbb\xba `web`  \xe6\x9c\x8d\xe5\x8a\xa1\n\n    docker service create --name web --publish 8080:80 httpd:alpine\n\n\xe6\x88\x91\xe4\xbb\xac\xe5\xba\x94\xe8\xaf\xa5\xe6\x97\xa0\xe6\xb3\x95\xe4\xbb\x8e\xe6\x88\x91\xe4\xbb\xac\xe7\x9a\x84\xe4\xb8\xbb\xe6\x9c\xba\xe4\xb8\x8a\xe8\xae\xbf\xe9\x97\xae\xe8\xbf\x99\xe4\xb8\xaa `web` \xe6\x9c\x8d\xe5\x8a\xa1\n\n    curl -v http://192.168.56.131:8080\n\n\xe5\x9c\xa8 master \xe8\x8a\x82\xe7\x82\xb9\xe4\xb8\x8a\xef\xbc\x8c\xe8\xbf\x90\xe8\xa1\x8c\xe4\xb8\x8b\xe9\x9d\xa2\xe7\x9a\x84\xe5\x91\xbd\xe4\xbb\xa4\xe6\x9d\xa5\xe5\x85\x81\xe8\xae\xb8\xe5\x85\xac\xe5\x85\xb1\xe8\xae\xbf\xe9\x97\xae `web` \xe6\x9c\x8d\xe5\x8a\xa1\xe7\xab\xaf `80` \xe7\xab\xaf\xe5\x8f\xa3\xe3\x80\x82\n\n    sudo ufw-docker service allow web 80\n\n\xe7\x8e\xb0\xe5\x9c\xa8\xe6\x88\x91\xe4\xbb\xac\xe5\x8f\xaf\xe4\xbb\xa5\xe5\x9c\xa8\xe6\x88\x91\xe4\xbb\xac\xe7\x9a\x84\xe4\xb8\xbb\xe6\x9c\xba\xe4\xb8\x8a\xe8\xae\xbf\xe9\x97\xae\xe8\xbf\x99\xe4\xb8\xaa `web` \xe6\x9c\x8d\xe5\x8a\xa1\xe4\xba\x86\n\n    curl "http://192.168.56.13{0,1,2}:8080"\n\n## \xe8\xae\xa8\xe8\xae\xba\n\n- [What is the best practice of docker + ufw under Ubuntu - Stack Overflow](https://stackoverflow.com/questions/30383845/what-is-the-best-practice-of-docker-ufw-under-ubuntu/51741599#comment91451547_51741599)\n- [docker and ufw serious problems \xc2\xb7 Issue #4737 \xc2\xb7 moby/moby](https://github.com/moby/moby/issues/4737#issuecomment-420112149)\n'