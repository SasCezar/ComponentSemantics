b'# Raspberry Pi Turnkey\n\nHave you ever wanted to setup a Raspberry Pi *without having to SSH or attach a keyboard* to add your WiFi credentials? This is particularly useful when you are making a Raspberry Pi that needs to be deployed somewhere where supplying the credentials via SSH or attaching a keyboard isn\'t an option. Or it could be useful if you take your Pi to a friend\'s house and they don\'t have ethernet cables or extra keyboards+monitors to put your friend\'s WiFi credentials onto the Pi. With this image base you don\'t ever need to modify a `wpa_supplicant` with SSH/terminal/PiBakery again!\n\nYou can [follow the instructions below](#instructions-to-create-image) to create a turnkey image, or you can just download my latest one at [raspberry-pi-turnkey.schollz.com/2018-06-25-turnkey-1.3.zip](https://raspberry-pi-turnkey.schollz.com/2018-06-25-turnkey-1.3.img.zip) ([v1.3.0](https://github.com/schollz/raspberry-pi-turnkey/releases/tag/v1.3.0), 982MB) and [follow the typical flashing instructions](https://www.raspberrypi.org/documentation/installation/installing-images/README.md). \n\n[![Support](https://img.shields.io/badge/donate-$5-brown.svg)](https://www.paypal.me/ZackScholl/5.00)\n\n# Usage \n\nOnce you boot the Pi with this image, wait about 10 minutes for the Pi to reformat the drive and start up the web server. Then you will see a WiFi AP named "ConnectToConnect" (password same). Connect to it and your browser should automatically redirect you to a sign-in page. If not, navigate to `192.168.4.1` where you\'ll see a login form. \n\n<p align="center">\n  <img src="https://user-images.githubusercontent.com/6550035/36927004-9dd66774-1e2f-11e8-941a-aa192005b2d6.png"/>\n</p>\n\nWhen the WiFi credentials are entered onto the login form, the Pi will modify its internal `wpa_supplicant` to conform to them so that it will be connected to the net. The Pi will then reboot itself using those WiFi credentials. If the credentials are not correct, then the Pi will reboot back into the AP mode to allow you to re-enter them again.\n\nOnce connected, you can recieve a message with the LAN IP for your Pi at https://snaptext.live (the specific URL will be given to you when you enter in the credentials to the form).\n\n_Note:_ The Raspberry Pi is **not** a fast computer. When you see the AP and connect to it, it may take up to a minute for the page at `192.168.4.1` to appear. Also, if you enter the wrong WiFi credentials, it will have to reboot twice to reset the Pi to allow you to enter the credentials again. So try to enter them right the first time!\n\n# How does it work?\n\nWhen the Pi starts up it runs a Python script, `startup.py`. This script first checks if the Pi is online (by looking for an SSID in `iwconfig wlan0`). If the Pi is online, the script sets the status as "connected" (saved to disk in `status.json`).\n\nIf the Pi is not online, it will check the status. The initial status is "disconnected". When "disconnected" the Pi will uncomment the configuration files for `hostapd` and `dnsmasq`. The access point configuration is nearly identical [to as outlined in this tutorial](https://www.raspberrypi.org/documentation/configuration/wireless/access-point.md). Then the Pi sets the status as "hostapd" and reboots itself.\n\nWhen the status is "hostapd" then the script will bind to port 80 and serve a web form at `192.168.4.1`. Once you connect to the AP this web form will be available and it will recieve input. Once the server recieves input, it sets the credentials in `wpa_supplicant.conf` and comments out the configuration file for `hostapd` and `dnsmasq` so that the AP doesn\'t interfere, and then reboots. When it reboots it will see if it gets online and set the status as "connected" or "disconnected". Then it repeats the steps above (i.e. doing nothing if connected, or restarting the AP if disconnected).\n\n# Instructions to create image\n\nThe following are the step-by-step instructions for how I create the turnkey image. If you don\'t want to download the image I created above (I don\'t blame you), then follow these to make one exactly the same.\n\nThese instructions assume you are using Ubuntu. You can use Windows/OS X for most of these steps, except step #4 which requires resizing.\n\n## 1. Flash Raspbian Stretch Lite\n\nStarting from version [Raspbian Stretch Lite](https://www.raspberrypi.org/downloads/raspbian/) version 2017-11-29.\n\n```\n$ sudo dd bs=4M if=2017-11-29-raspbian-stretch-lite.img of=/dev/mmcblk0 conv=fsync status=progress\n```\n\nChange `/dev/mmcblk0` to whatever your SD card is (find it using `fdisk -l`).\n\nAfter flashing, for the first time use, just plug in ethernet and you can SSH into the Pi. To activate SSH on boot just do\n\n```\n$ touch /media/YOURUSER/boot/ssh\n```\n\n## 2. Install libraries onto the Raspberry Pi\n\nSSH into your Pi using Ethernet, as you will have to disable the WiFi connection when you install `hostapd`.\n\n### Basic libraries\n\n```\n$ sudo apt-get update\n$ sudo apt-get dist-upgrade -y\n$ sudo apt-get install -y dnsmasq hostapd vim python3-flask python3-requests git\n```\n\n### Install node (optional)\n\n```\n$ wget https://nodejs.org/dist/v8.9.4/node-v8.9.4-linux-armv6l.tar.xz\n$ sudo mkdir /usr/lib/nodejs\n$ sudo tar -xJvf node-v8.9.4-linux-armv6l.tar.xz -C /usr/lib/nodejs \n$ rm -rf node-v8.9.4-linux-armv6l.tar.xz\n$ sudo mv /usr/lib/nodejs/node-v8.9.4-linux-armv6l /usr/lib/nodejs/node-v8.9.4\n$ echo \'export NODEJS_HOME=/usr/lib/nodejs/node-v8.9.4\' >> ~/.profile\n$ echo \'export PATH=$NODEJS_HOME/bin:$PATH\' >> ~/.profile\n$ source ~/.profile\n```\n\n### Install Go (optional)\n\n```\n$ wget https://dl.google.com/go/go1.10.linux-armv6l.tar.gz\n$ sudo tar -C /usr/local -xzf go*gz\n$ rm go*gz\n$ echo \'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin\' >>  ~/.profile\n$ echo \'export GOPATH=$HOME/go\' >>  ~/.profile\n$ source ~/.profile\n```\n\n### Install turnkey\n\n```\n$ git clone https://github.com/schollz/raspberry-pi-turnkey.git\n```\n\n### Install Hostapd\n\n```\n$ sudo systemctl stop dnsmasq && sudo systemctl stop hostapd\n\n$ echo \'interface wlan0\nstatic ip_address=192.168.4.1/24\' | sudo tee --append /etc/dhcpcd.conf\n\n$ sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig  \n$ sudo systemctl daemon-reload\n$ sudo systemctl restart dhcpcd\n\n$ echo \'interface=wlan0\ndhcp-range=192.168.4.2,192.168.4.20,255.255.255.0,24h\' | sudo tee --append /etc/dnsmasq.conf\n\n$ echo \'interface=wlan0\ndriver=nl80211\nssid=ConnectToConnect\nhw_mode=g\nchannel=7\nwmm_enabled=0\nmacaddr_acl=0\nauth_algs=1\nignore_broadcast_ssid=0\nwpa=2\nwpa_passphrase=ConnectToConnect\nwpa_key_mgmt=WPA-PSK\nwpa_pairwise=TKIP\nrsn_pairwise=CCMP\' | sudo tee --append /etc/hostapd/hostapd.conf\n\n$ echo \'DAEMON_CONF="/etc/hostapd/hostapd.conf"\' | sudo tee --append /etc/default/hostapd\n\n$ sudo systemctl start hostapd && sudo systemctl start dnsmasq\n```\n\n### Add `pi` to sudoers\n\nAdd `pi` to the sudoers, so that you can run sudo commands without having to be root (so that all the paths to your programs are unchanged).\n\n```\n$ sudo visudo\n```\n\nThen add this line:\n\n```\npi      ALL=(ALL:ALL) ALL\n```\n\n(_Sidenote:_ I save an image `intermediate.img` at this point so its easy to go back)\n\n\n### Startup server on boot\n\nOpen up the `rc.local`\n\n```\n$ sudo nano /etc/rc.local\n```\n\nAnd add the following line before `exit 0`:\n\n```\nsu pi -c \'/usr/bin/sudo /usr/bin/python3 /home/pi/raspberry-pi-turnkey/startup.py &\'\n```\n\n### Shutdown the pi\n\nShutdown the Raspberry Pi and do not start it up until after you write the image. Otherwise the unique ID that is generated will be the same for all the images.\n\n```\n$ sudo shutdown now\n```\n\n## 3. Resize Raspberry Pi SD image\n\n\n\nIf you don\'t want to resize the image, you can just write the entire image file to your computer and use that from here on. If you do want to resize (especially useful if you are installing on a 16GB card and want to flash onto a smaller card), follow these instructions.\n\nPut the newly made image into Ubuntu and do\n\n```\n$ xhost +local:\n$ sudo gparted-pkexec\n```\n\nRight click on the SD card image and do "Unmount". Then right click on the image and do "Resize/Move" and change the size to `2400`. \n\nThen you can copy the image to your computer using the following command\n\n```\n$ sudo dd if=/dev/mmcblk0 of=/some/place/turnkey.img bs=1M count=2400 status=progress\n```\n\nAgain `/dev/mmcblk0` is your SD card which you can determine using `fdisk -l`.  The location of the image, `/some/place/`, should be set by you.\n\n## 4. Test the turnkey image\n\nThe new image will be in `/some/place/2018-turnkey.img` which you can use to flash other SD cards. To test it out, get a new SD card and do:\n\n```\n$ sudo dd bs=4M if=/some/place/turnkey.img of=/dev/mmcblk0 conv=fsync status=progress\n```\n\n# Roadmap\n\n- [x] ~~Add messaging system to send the LAN IP address once online~~ (uses https://github.com/schollz/snaptext)\n- [x] ~~Add startup hooks~~ (just edit `startup.sh`)\n- [ ] connect immediately to wifi and disable hostapd without rebooting\n\nIf you\'d like to contribute, please do send a PR!\n\n# Thanks\n\nThanks to [@ilirb](https://github.com/ilirb) for checking if passphrase is correct before rebooting!\n\n# License \n\nMIT\n'