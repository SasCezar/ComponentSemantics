b'# Elassandra [![Build Status](https://travis-ci.org/strapdata/elassandra.svg)](https://travis-ci.org/strapdata/elassandra)[![Documentation Status](https://readthedocs.org/projects/elassandra/badge/?version=latest)](https://elassandra.readthedocs.io/en/latest/?badge=latest)\n\n\n![Elassandra Logo](elassandra-logo.png)\n\n## [http://www.elassandra.io/](http://www.elassandra.io/)\n\nElassandra is a fork of [Elasticsearch](https://github.com/elastic/elasticsearch) modified to run as a plugin for [Apache Cassandra](http://cassandra.apache.org) in a scalable and resilient peer-to-peer architecture. Elasticsearch code is embedded in Cassanda nodes providing advanced search features on Cassandra tables and Cassandra serves as an Elasticsearch data and configuration store.\n\n![Elassandra architecture](/docs/elassandra/source/images/elassandra1.jpg)\n\nElassandra supports Cassandra vnodes and scales horizontally by adding more nodes.\n\nProject documentation is available at [doc.elassandra.io](http://doc.elassandra.io).\n\n## Benefits of Elassandra\n\nFor Cassandra users, elassandra provides Elasticsearch features :\n* Cassandra updates are indexed in Elasticsearch.\n* Full-text and spatial search on your Cassandra data.\n* Real-time aggregation (does not require Spark or Hadoop to GROUP BY)\n* Provide search on multiple keyspaces and tables in one query.\n* Provide automatic schema creation and support nested documents using [User Defined Types](https://docs.datastax.com/en/cql/3.1/cql/cql_using/cqlUseUDT.html).\n* Provide read/write JSON REST access to Cassandra data.\n* Numerous Elasticsearch plugins and products like [Kibana](https://www.elastic.co/guide/en/kibana/current/introduction.html).\n* Manage concurrent elasticsearch mappings changes and applies batched atomic CQL schema changes.\n* Support [Elasticsearch ingest processors](https://www.elastic.co/guide/en/elasticsearch/reference/master/ingest.html) allowing to transform input data.\n\nFor Elasticsearch users, elassandra provides useful features :\n* Elassandra is masterless. Cluster state is managed through [cassandra lightweight transactions](http://www.datastax.com/dev/blog/lightweight-transactions-in-cassandra-2-0).\n* Elassandra is a sharded multi-master database, where Elasticsearch is sharded master-slave. Thus, Elassandra has no Single Point Of Write, helping to achieve high availability.\n* Elassandra inherits Cassandra data repair mechanisms (hinted handoff, read repair and nodetool repair) providing support for **cross datacenter replication**.\n* When adding a node to an Elassandra cluster, only data pulled from existing nodes are re-indexed in Elasticsearch.\n* Cassandra could be your unique datastore for indexed and non-indexed data. It\'s easier to manage and secure. Source documents are now stored in Cassandra, reducing disk space if you need a NoSQL database and Elasticsearch.\n* Write operations are not restricted to one primary shard, but distributed across all Cassandra nodes in a virtual datacenter. The number of shards does not limit your write throughput. Adding elassandra nodes increases both read and write throughput.\n* Elasticsearch indices can be replicated among many Cassandra datacenters, allowing write to the closest datacenter and search globally.\n* The [cassandra driver](http://www.planetcassandra.org/client-drivers-tools/) is Datacenter and Token aware, providing automatic load-balancing and failover.\n* Elassandra efficiently stores Elasticsearch documents in binary SSTables without any JSON overhead.\n\n## Quick start\n\n* [Quick Start](http://doc.elassandra.io/en/latest/quickstart.html) guide to run a single node Elassandra cluster in docker.\n* [Deploy Elassandra by launching a Google Kubernetes Engine](./docs/google-kubernetes-tutorial.md):\n\n  [![Open in Cloud Shell](https://gstatic.com/cloudssh/images/open-btn.png)](https://console.cloud.google.com/cloudshell/open?git_repo=https://github.com/strapdata/elassandra-google-k8s-marketplace&tutorial=docs/google-kubernetes-tutorial.md)\n  \n## Upgrade Instructions\n\n#### Elassandra 6.2.3.21+\n\nBefore version 6.2.3.21, the Cassandra replication factor for the **elasic_admin** keyspace (and elastic_admin_[datacenter.group]) was automatically adjusted to the \nnumber of nodes of the datacenter. Since version 6.2.3.21 and because it has a performance impact on large clusters, it\'s now up to your Elassandra administrator to \nproperly adjust the replication factor for this keyspace. Keep in mind that Elasticsearch mapping updates rely on a PAXOS transaction that requires QUORUM nodes to succeed, \nso replication factor should be at least 3 on each datacenter.\n\n#### Elassandra 6.2.3.19+\n\nElassandra 6.2.3.19 metadata version now relies on the Cassandra table **elastic_admin.metadata_log** (that was **elastic_admin.metadata** from 6.2.3.8 to 6.2.3.18) \nto keep the elasticsearch mapping update history and automatically recover from a possible PAXOS write timeout issue. \n\nWhen upgrading the first node of a cluster, Elassandra automatically copy the current **metadata.version** into the new **elastic_admin.metadata_log** table.\nTo avoid Elasticsearch mapping inconsistency, you must avoid mapping update while the rolling upgrade is in progress. Once all nodes are upgraded,\nthe **elastic_admin.metadata** is not more used and can be removed. Then, you can get the mapping update history from the new **elastic_admin.metadata_log** and know\nwhich node has updated the mapping, when and for which reason.\n\n#### Elassandra 6.2.3.8+\n\nElassandra 6.2.3.8+ now fully manages the elasticsearch mapping in the CQL schema through the use of CQL schema extensions (see *system_schema.tables*, column *extensions*). These table extensions and the CQL schema updates resulting of elasticsearch index creation/modification are updated in batched atomic schema updates to ensure consistency when concurrent updates occurs. Moreover, these extensions are stored in binary and support partial updates to be more efficient. As the result, the elasticsearch mapping is not more stored in the *elastic_admin.metadata* table. \n\nWARNING: During the rolling upgrade, elasticserach mapping changes are not propagated between nodes running the new and the old versions, so don\'t change your mapping while you\'re upgrading. Once all your nodes have been upgraded to 6.2.3.8+ and validated, apply the following CQL statements to remove useless elasticsearch metadata:\n```bash\nALTER TABLE elastic_admin.metadata DROP metadata;\nALTER TABLE elastic_admin.metadata WITH comment = \'\';\n```\n\nWARNING: Due to CQL table extensions used by Elassandra, some old versions of **cqlsh** may lead to the following error message **"\'module\' object has no attribute \'viewkeys\'."**. This comes from the old python cassandra driver embedded in Cassandra and has been reported in [CASSANDRA-14942](https://issues.apache.org/jira/browse/CASSANDRA-14942). Possible workarounds:\n* Use the **cqlsh** embedded with Elassandra\n* Install a recent version of the  **cqlsh** utility (*pip install cqlsh*) or run it from a docker image:\n\n```bash\ndocker run -it --rm strapdata/cqlsh:0.1 node.example.com\n```\n\n#### Elassandra 6.x changes\n\n* Elasticsearch now supports only one document type per index backed by one Cassandra table. Unless you specify an elasticsearch type name in your mapping, data is stored in a cassandra table named **"_doc"**. If you want to search many cassandra tables, you now need to create and search many indices.\n* Elasticsearch 6.x manages shard consistency through several metadata fields (_primary_term, _seq_no, _version) that are not used in elassandra because replication is fully managed by cassandra.\n\n## Installation\n\nEnsure Java 8 is installed and `JAVA_HOME` points to the correct location.\n\n* [Download](https://github.com/strapdata/elassandra/releases) and extract the distribution tarball\n* Define the CASSANDRA_HOME environment variable : `export CASSANDRA_HOME=<extracted_directory>`\n* Run `bin/cassandra -e`\n* Run `bin/nodetool status`\n* Run `curl -XGET localhost:9200/_cluster/state`\n\n#### Example\n\nTry indexing a document on a non-existing index:\n\n```bash\ncurl -XPUT \'http://localhost:9200/twitter/_doc/1?pretty\' -H \'Content-Type: application/json\' -d \'{\n    "user": "Poulpy",\n    "post_date": "2017-10-04T13:12:00Z",\n    "message": "Elassandra adds dynamic mapping to Cassandra"\n}\'\n```\n\nThen look-up in Cassandra:\n\n```bash\nbin/cqlsh -e "SELECT * from twitter.\\"_doc\\""\n```\n\nBehind the scenes, Elassandra has created a new Keyspace `twitter` and table `_doc`.\n\n```CQL\nadmin@cqlsh>DESC KEYSPACE twitter;\n\nCREATE KEYSPACE twitter WITH replication = {\'class\': \'NetworkTopologyStrategy\', \'DC1\': \'1\'}  AND durable_writes = true;\n\nCREATE TABLE twitter."_doc" (\n    "_id" text PRIMARY KEY,\n    message list<text>,\n    post_date list<timestamp>,\n    user list<text>\n) WITH bloom_filter_fp_chance = 0.01\n    AND caching = {\'keys\': \'ALL\', \'rows_per_partition\': \'NONE\'}\n    AND comment = \'\'\n    AND compaction = {\'class\': \'org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy\', \'max_threshold\': \'32\', \'min_threshold\': \'4\'}\n    AND compression = {\'chunk_length_in_kb\': \'64\', \'class\': \'org.apache.cassandra.io.compress.LZ4Compressor\'}\n    AND crc_check_chance = 1.0\n    AND dclocal_read_repair_chance = 0.1\n    AND default_time_to_live = 0\n    AND gc_grace_seconds = 864000\n    AND max_index_interval = 2048\n    AND memtable_flush_period_in_ms = 0\n    AND min_index_interval = 128\n    AND read_repair_chance = 0.0\n    AND speculative_retry = \'99PERCENTILE\';\nCREATE CUSTOM INDEX elastic__doc_idx ON twitter."_doc" () USING \'org.elassandra.index.ExtendedElasticSecondaryIndex\';\n```\n\nBy default, multi valued Elasticsearch fields are mapped to Cassandra list.\nNow, insert a row with CQL :\n\n```CQL\nINSERT INTO twitter."_doc" ("_id", user, post_date, message)\nVALUES ( \'2\', [\'Jimmy\'], [dateof(now())], [\'New data is indexed automatically\']);\nSELECT * FROM twitter."_doc";\n\n _id | message                                          | post_date                           | user\n-----+--------------------------------------------------+-------------------------------------+------------\n   2 |            [\'New data is indexed automatically\'] | [\'2019-07-04 06:00:21.893000+0000\'] |  [\'Jimmy\']\n   1 | [\'Elassandra adds dynamic mapping to Cassandra\'] | [\'2017-10-04 13:12:00.000000+0000\'] | [\'Poulpy\']\n\n(2 rows)\n```\n\nThen search for it with the Elasticsearch API:\n\n```bash\ncurl "localhost:9200/twitter/_search?q=user:Jimmy&pretty"\n```\n\nAnd here is a sample response :\n\n```JSON\n{\n  "took" : 3,\n  "timed_out" : false,\n  "_shards" : {\n    "total" : 1,\n    "successful" : 1,\n    "skipped" : 0,\n    "failed" : 0\n  },\n  "hits" : {\n    "total" : 1,\n    "max_score" : 0.6931472,\n    "hits" : [\n      {\n        "_index" : "twitter",\n        "_type" : "_doc",\n        "_id" : "2",\n        "_score" : 0.6931472,\n        "_source" : {\n          "post_date" : "2019-07-04T06:00:21.893Z",\n          "message" : "New data is indexed automatically",\n          "user" : "Jimmy"\n        }\n      }\n    ]\n  }\n}\n```\n\n## Support\n\n * Commercial support is available through [Strapdata](http://www.strapdata.com/).\n * Community support available via [elassandra google groups](https://groups.google.com/forum/#!forum/elassandra).\n * Post feature requests and bugs on https://github.com/strapdata/elassandra/issues\n\n## License\n\n```\nThis software is licensed under the Apache License, version 2 ("ALv2"), quoted below.\n\nCopyright 2015-2018, Strapdata (contact@strapdata.com).\n\nLicensed under the Apache License, Version 2.0 (the "License"); you may not\nuse this file except in compliance with the License. You may obtain a copy of\nthe License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS, WITHOUT\nWARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\nLicense for the specific language governing permissions and limitations under\nthe License.\n```\n\n## Acknowledgments\n\n* Elasticsearch and Kibana are trademarks of Elasticsearch BV, registered in the U.S. and in other countries.\n* Apache Cassandra, Apache Lucene, Apache, Lucene and Cassandra are trademarks of the Apache Software Foundation.\n* Elassandra is a trademark of Strapdata SAS.\n'