b'# packer-windoze\n\nThis repo contains code that can generate Packer templates designed to build\nand package Windows templates for use with Vagrant boxes. The overall goal is\nto cover all supported Windows OS\' included Windows Server, Server Core,\nServer Nano and the Desktop OS\' but the main focus is on the Windows Server\nimages.\n\nEach image is designed to be;\n\n* Fully updated at the time of creation\n* As small as can be possible for a Windows image\n* Contain minimal tools useful for Windows development such as the sysinternals suite\n* Enable WinRM (HTTP and HTTPS) and RDP on creation in Vagrant allowing other tools to interact with a new image without manual interaction\n* Also include the latest [Win32-OpenSSH](https://github.com/PowerShell/Win32-OpenSSH) in the image that starts up automatically\n* Each image contain the maximum amount of time available on a Windows evaluation image (usually 180 days) without prompting for a key\n\nThe blog post [Using Packer to Create Windows Images](http://www.bloggingforlogging.com/2017/11/23/using-packer-to-create-windows-images/)\ncontain a more detailed guide on this process and how it all works. Feel free\nto read through it if you want to understand each component and how they fit\ntogether more.\n\n## Requirements\n\nTo use the scripts in this repo you will need the following;\n\n* [pywinrm](https://pypi.org/project/pywinrm)\n* [Packer](https://www.packer.io/docs/install/index.html) >= 1.0.0, 1.2.4 is required for Hyper-V with Server 2008 R2 support\n* [VirtualBox](https://www.virtualbox.org/wiki/Downloads) >= 5.1.12\n* [Hyper-V](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/hyper-v-on-windows-server) - Server 2008 is not supported with Hyper-V\n* [Ansible](https://github.com/ansible/ansible) >= 2.5.1\n* `mkisofs` for Windows this needs to be installed in WSL where Ansible is located\n\nWhen setting `man_packer_setup_host_type: 2008-x64`, Ansible will extract the\nevaluation ISO from a self extracting archive. This requires the `unrar`\npackage to be installed. If you don\'t want to install this package, manually\nextract the ISO on another box and specify the path under\n`opt_packer_setup_iso_path`.\n\nTo install `mkisofs` and `unrar`, you can run one of the commands below\ndepending on your distribution;\n\n```bash\n# for Debian/Ubuntu\nsudo apt-get install mkisofs unrar\n\n# for RHEL/CentOS\nsudo yum install mkisofs\n\nsudo yum localinstall --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm https://download1.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-7.noarch.rpm\nsudo yum install unrar\n\n# for Fedora\nsudo dnf install mkisofs\n\nsudo dnf install https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm\nsudo dnf install unrar\n\n# for MacOS (requires Homebrew)\nbrew install cdrtools unrar\n```\n\n## How to Run\n\nTo create an image, the process is split up into 2 phases\n\n1. Create the files required for Packer to build and provision an image\n2. Run Packer based on the files created above\n\n### Create Packer Files\n\nFor Packer to provision a Windows host it first needs an `Autounattend.xml`\nfile and bootstrapping script to configure the base host requirements needed by\nAnsible. Instead of having them already stored in the repo, they are\ndynamically created by Ansible based on the configuration provided.\n\nTo create the files for a particular host type run;\n\n```bash\nansible-playbook packer-setup.yml -e man_packer_setup_host_type=<host type>\n\n# see below what can be used for <host type> but to create the Packer files for a Server 2012 R2 image run\nansible-playbook packer-setup.yml -e man_packer_setup_host_type=2012r2\n\n# specify custom Chocolatey packages to install instead of vim and sysinternals on the image\nansible-playbook packer-setup.yml -e opt_packer_setup_packages=\'["pstools", "notepadplusplus"]\'\n\n# when running on Windows, you can run this from PowerShell like\nbash.exe -ic "ansible-playbook packer-setup.yml -e man_packer_setup_host_type=2012r2 -e opt_packer_setup_builder=hyperv"\n```\n\nAfter running the playbook, a folder which is named after the value of\n`man_packer_setup_host_type` will be created and it will contain the following\nfiles;\n\n* `iso/Autounattend.xml`: The answer file used by Windows during the initial install\n* `iso/bootstrap.ps1`: A PowerShell script that is run after the initial install to configure the host required by Ansible\n* `iso/*`: Other files used in the bootstrapping process like hotfixes and updates required to configure WinRM\n* `configure-hyperv-network.ps1`: Used in the Hyper-V builder to set the correct IP for Ansible\'s inventory file\n* `description.md`: The changelog description of that current build\n* `hosts.ini`: An Ansible inventory file containing the info required by Ansible during the provisioning phase\n* `packer.json`: The Packer definition file the contains all the info that Packer needs to build the image\n* `secondary.iso`: The secondary ISO file used to store the `Autounattend.xml`, `bootstrap.ps1`, and other files used in that process\n* `vagrantfile.template`: The templated Vagrantfile that is embedded in the Vagrant box produced\n\nWhen `opt_packer_setup_builder=hyperv`, this process will also create the\nHyper-V switch defined by `opt_packer_setup_hyperv_switch` if it does not\nexist. This switch is created as an External Network type with the host OS\nallowed to share with the guest. This type of switch is required for 2 reasons;\n\n1. Allows the Windows host to access the guest\n2. Allows the guest to access the internet for things like updates and downloading packages\n\nAn Internal Network type covers the first point but you need an External\nNetwork type to access the internet.\n\nThis switch is NOT cleaned up afterwards automatically.\n\n#### Mandatory Variables\n\nThe following parameters must be set using the `-e` arguments;\n\n* `man_packer_setup_host_type`: The host type string that tells packer what to build, see options below\n\nYou can set the host type to the following values\n\n* `2008-x86`: Windows Server 2008 Standard 32-bit\n* `2008-x64`: Windows Server 2008 Standard 64-bit\n* `2008r2`: Windows Server 2008 R2 Standard\n* `2012`: Windows Server 2012 Standard\n* `2012r2`: Windows Server 2012 R2 Standard\n* `2016`: Windows Server 2016 Standard\n* `2019`: Windows Server 2019 Standard\n\nThe following host types can also be used but it requires the ISO to be\nmanually downloaded and set with `opt_packager_setup_iso_path`. Microsoft does\nnot offer evaluation ISOs for these builds so it won\'t be part of the public\nfacing images\n\n* `1709`: Windows Server Build 1709 Standard\n* `1803`: Windows Server Build 1803 Standard\n\n#### Optional Variables\n\nThe following are optional parameters set using the `-e` argument and can\nchange the way Packer builds the images in the next step;\n\n* `opt_packer_setup_builder`: The Packer builder to use, defaults to `virtualbox` but can be `hyperv` when running on Windows.\n* `opt_packer_setup_iso_path`: The local path to the install Windows ISO, this means packer will use this instead of downloading the pre-set evaluation ISO from the internet.\n* `opt_packer_setup_iso_wim_label`: The WIM image name to use when installing Windows from an ISO, the process defaults to the Standard edition if not set.\n* `opt_packer_setup_username`: (Default: `vagrant`) The name of the user to create in the provisioning process, this is the only user that will available in the image created as the builtin Administrator account is disabled.\n* `opt_packer_setup_password`: (Default: `vagrant`) The password for `opt_packer_setup_username`, this password is also set for the builtin Administrator account even though it is disabled in the image.\n* `opt_packer_setup_product_key`: The product key to use when installing Windows, do not set this unless you know what you are doing.\n* `opt_packer_setup_hyperv_switch`: (Default: `packer-windoze`) The name of the Hyper-V switch to create. There shouldn\'t be a need to change this unless you know what you\'re doing.\n* `opt_packer_setup_packages`: (Default: `vim`, `sysinternals`) Override the default Chocolatey packages that are installed on each image. This should be a list of valid Chocolatey package names that are packes to the `win_chocolatey` module, see the examples for more details.\n\nTo add a post-processor to upload to Vagrant Cloud, add in the following 3\nvariables;\n\n* `opt_packer_setup_access_token`: The acces token for the Vagrant Cloud API, this is set to the `access_token` key in the packer build file.\n* `opt_packer_setup_box_tag`: The shorthand tag for the map that maps to Vagrant Cloud, this is set to the `box_tag` key in the packer build file.\n* `opt_packer_setup_version`: The version number for the box which is validated based on semantic versioning, this is set to the `version` key in the packer build file and if ommitted then the latest version in the changelog is used.\n\n### Create Images with Packer\n\nOnce the packer files have been created under it\'s own folder, Packer can now\nbe used to create the image. Run the following to start the process\n\n```bash\npacker build -force <host_type>/packer.json\n\n# replace <host_type> with the type to build, e.g. for Server 2012 R2\npacker build -force 2012r2/packer.json\n```\n\nThis process takes a looong time to finish as Packer will download the ISO,\ninstall Windows and finally configure Windows. The best thing to do is to run\nthis overnight or as a background process.\n\nOnce complete a file with the `.box` extension will be created in the same\nfolder the `packer.json` file is located in. This file can be added to Vagrant\nusing `vagrant box add <filename>.box` or can be shared with others using your own\nmethods. The filename is dependent on the builder that was used. When\n`opt_packer_setup_builder` is `virtualbox` then it will be `virtualbox.box`,\notherwise `hyperv` will be `hyperv.box`.\n\n## What It Does\n\nHere is a brief step by step overview of what actually happens with the images\n\n1. Packer start a VM under the hypervisor and attaches the ISO that contains the `Autounattend.xml`, `bootstrap.ps1`, and other bootstrap files\n2. Windows starts the install process and configures it according to the `Autounattend.xml` file\n3. After the install is complete Windows will auto login to the `vagrant` user and run the `bootstrap.ps1` script\n4. The bootstrap script will ensure that PowerShell v3 or greater is installed, WinRM is setup and other things\n5. Packer detects that WinRM is up and running and starts the provision process which is the Ansible playbook\n6. Ansible will then install all available updates and reboot accordingly (this step can take hours so be prepared to wait)\n7. Some personalisation tweaks occur such as showing hidden files and folders, file extensions and installing the sysinternals tools\n8. Will try to cleanup as much of the WinSXS folder as possible (older hosts are limited in how much it can do)\n9. Will remove all non enabled Features if Features on Demand is supported (Server 2012 and newer)\n10. Remove pagefile, temp files, log files that are not needed. Defrags the disk and 0\'s out empty space for the compression to work properly\n11. Setup the sysprep template files\n12. Remove the WinRM listeners and run the sysprep process to shutdown the host\n\nFrom this point Packer will create an image of the OS which can be used by\nVagrant. When Vagrant first starts up the image, it will automatically log on\nand, rearm the activation key and recreate the WinRM listeners.\n\n## Backlog/Future Work\n\n* Windows Server Core images\n* Windows Server Nano images\n* Windows 10 32 and 64 bit\n* Look at supporting parallel builds\n* Look at slipstreaming Windows updates into the evaluation ISO\'s instead of running the updates from scratch each time\n* Look at supporting local WSUS servers during the Update phase to save time and bandwidth\n'