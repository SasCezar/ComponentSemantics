b'![alt text](bless_logo.png "BLESS")\n# BLESS - Bastion\'s Lambda Ephemeral SSH Service\n[![Build Status](https://travis-ci.org/Netflix/bless.svg?branch=master)](https://travis-ci.org/Netflix/bless) [![Test coverage](https://coveralls.io/repos/github/Netflix/bless/badge.svg?branch=master)](https://coveralls.io/github/Netflix/bless) [![Join the chat at https://gitter.im/Netflix/bless](https://badges.gitter.im/Netflix/bless.svg)](https://gitter.im/Netflix/bless?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge) [![NetflixOSS Lifecycle](https://img.shields.io/osslifecycle/Netflix/bless.svg)]()\n\nBLESS is an SSH Certificate Authority that runs as an AWS Lambda function and is used to sign SSH\npublic keys.\n\nSSH Certificates are an excellent way to authorize users to access a particular SSH host,\nas they can be restricted for a single use case, and can be short lived.  Instead of managing the\nauthorized_keys of a host, or controlling who has access to SSH Private Keys, hosts just\nneed to be configured to trust an SSH CA.\n\nBLESS should be run as an AWS Lambda in an isolated AWS account.  Because BLESS needs access to a\nprivate key which is trusted by your hosts, an isolated AWS account helps restrict who can access\nthat private key, or modify the BLESS code you are running.\n\nAWS Lambda functions can use an AWS IAM Policy to limit which IAM Roles can invoke the Lambda\nFunction.  If properly configured, you can restrict which IAM Roles can request SSH Certificates.\nFor example, your SSH Bastion (aka SSH Jump Host) can run with the only IAM Role with access to\ninvoke a BLESS Lambda Function configured with the SSH CA key trusted by the instances accessible\nto that SSH Bastion.\n\n## Getting Started\nThese instructions are to get BLESS up and running in your local development environment.\n### Installation Instructions\nClone the repo:\n\n    $ git clone git@github.com:Netflix/bless.git\n\nCd to the bless repo:\n\n    $ cd bless\n\nCreate a virtualenv if you haven\'t already:\n\n    $ python3.7 -m venv venv\n\nActivate the venv:\n\n    $ source venv/bin/activate\n\nInstall package and test dependencies:\n\n    (venv) $ make develop\n\nRun the tests:\n\n    (venv) $ make test\n\n\n## Deployment\nTo deploy an AWS Lambda Function, you need to provide a .zip with the code and all dependencies.\nThe .zip must contain your lambda code and configurations at the top level of the .zip.  The BLESS\nMakefile includes a publish target to package up everything into a deploy-able .zip if they are in\nthe expected locations.  You will need to setup your own Python 3.7 lambda to deploy the .zip to.\n\nPreviously the AWS Lambda Handler needed to be set to `bless_lambda.lambda_handler`, and this would generate a user \ncert.  `bless_lambda.lambda_handler` still works for user certs.  `bless_lambda_user.lambda_handler_user` is a handler \nthat can also be used to issue user certificates.\n\nA new handler `bless_lambda_host.lambda_handler_host` has been created to allow for the creation of host SSH certs.\n\nAll three handlers exist in the published .zip.\n\n### Compiling BLESS Lambda Dependencies\nTo deploy code as a Lambda Function, you need to package up all of the dependencies.  You will need to\ncompile and include your dependencies before you can publish a working AWS Lambda.\n\nBLESS uses a docker container running [Amazon Linux 2](https://hub.docker.com/_/amazonlinux) to package everything up:\n- Execute ```make lambda-deps``` and this will run a container and save all the dependencies in ./aws_lambda_libs\n\n### Protecting the CA Private Key\n- Generate a password protected RSA Private Key in the PEM format:\n```\n$ ssh-keygen -t rsa -b 4096 -m PEM -f bless-ca- -C "SSH CA Key"\n```\n- **Note:** OpenSSH Private Key format is not supported.\n- Use KMS to encrypt your password.  You will need a KMS key per region, and you will need to\nencrypt your password for each region.  You can use the AWS Console to paste in a simple lambda\nfunction like this:\n```\nimport boto3\nimport base64\nimport os\n\n\ndef lambda_handler(event, context):\n    region = os.environ[\'AWS_REGION\']\n    client = boto3.client(\'kms\', region_name=region)\n    response = client.encrypt(\n    KeyId=\'alias/your_kms_key\',\n    Plaintext=\'Do not forget to delete the real plain text when done\'\n    )\n\n    ciphertext = response[\'CiphertextBlob\']\n    return base64.b64encode(ciphertext)\n```\n\n- Manage your Private Keys .pem files and passwords outside of this repo.\n- Update your bless_deploy.cfg with your Private Key\'s filename and encrypted passwords.\n- Provide your desired ./lambda_configs/ca_key_name.pem prior to Publishing a new Lambda .zip\n- Set the permissions of ./lambda_configs/ca_key_name.pem to 444.\n\nYou can now provide your private key and/or encrypted private key password via the lambda environment or config file.\nIn the `[Bless CA]` section, you can set `ca_private_key` instead of the `ca_private_key_file` with a base64 encoded\nversion of your .pem (e.g. `cat key.pem | base64` ).\n\nBecause every config file option is supported in the environment, you can also just set `bless_ca_default_password`\nand/or `bless_ca_ca_private_key`.  Due to limits on AWS Lambda environment variables, you\'ll need to compress RSA 4096\nprivate keys, which you can now do by setting `bless_ca_ca_private_key_compression`. For example, set \n`bless_ca_ca_private_key_compression = bz2` and `bless_ca_ca_private_key` to the output of \n`cat ca-key.pem | bzip2 | base64`.\n\n### BLESS Config File\n- Refer to the the [Example BLESS Config File](bless/config/bless_deploy_example.cfg) and its\nincluded documentation.\n- Manage your bless_deploy.cfg files outside of this repo.\n- Provide your desired ./lambda_configs/bless_deploy.cfg prior to Publishing a new Lambda .zip\n- The required [Bless CA] option values must be set for your environment.\n- Every option can be changed in the environment. The environment variable name is constructed\nas section_name_option_name (all lowercase, spaces replaced with underscores).\n\n### Publish Lambda .zip\n- Provide your desired ./lambda_configs/ca_key_name.pem prior to Publishing\n- Provide your desired [BLESS Config File](bless/config/bless_deploy_example.cfg) at\n./lambda_configs/bless_deploy.cfg prior to Publishing\n- Provide the [compiled dependencies](#compiling-bless-lambda-dependencies) at ./aws_lambda_libs\n- run:\n```\n(venv) $ make publish\n```\n\n- deploy ./publish/bless_lambda.zip to AWS via the AWS Console,\n[AWS SDK](http://boto3.readthedocs.io/en/latest/reference/services/lambda.html), or\n[S3](https://aws.amazon.com/blogs/compute/new-deployment-options-for-aws-lambda/)\n- remember to deploy it to all regions.\n\n\n### Lambda Requirements\nYou should deploy this function into its own AWS account to limit who has access to modify the\ncode, configs, or IAM Policies.  An isolated account also limits who has access to the KMS keys\nused to protect the SSH CA Key.\n\nThe BLESS Lambda function should run as its own IAM Role and will need access to an AWS KMS Key in\neach region where the function is deployed.  The BLESS IAMRole will also need permissions to obtain\nrandom from kms (kms:GenerateRandom) and permissions for logging to CloudWatch Logs\n(logs:CreateLogGroup,logs:CreateLogStream,logs:PutLogEvents).\n\n## Using BLESS\nAfter you have [deployed BLESS](#deployment) you can run the sample [BLESS Client](bless_client/bless_client.py)\nfrom a system with access to the required [AWS Credentials](http://boto3.readthedocs.io/en/latest/guide/configuration.html).\nThis client is really just a proof of concept to validate that you have a functional lambda being called with valid\nIAM credentials. \n\n    (venv) $ ./bless_client.py region lambda_function_name bastion_user bastion_user_ip remote_usernames bastion_source_ip bastion_command <id_rsa.pub to sign> <output id_rsa-cert.pub>\n\n\n## Verifying Certificates\nYou can inspect the contents of a certificate with ssh-keygen directly:\n\n    $ ssh-keygen -L -f your-cert.pub\n\n## Enabling BLESS Certificates On Servers\nAdd the following line to `/etc/ssh/sshd_config`:\n\n    TrustedUserCAKeys /etc/ssh/cas.pub\n\nAdd a new file, owned by and only writable by root, at `/etc/ssh/cas.pub` with the contents:\n\n    ssh-rsa AAAAB3NzaC1yc2EAAAADAQ\xe2\x80\xa6  #id_rsa.pub of an SSH CA\n    ssh-rsa AAAAB3NzaC1yc2EAAAADAQ\xe2\x80\xa6  #id_rsa.pub of an offline SSH CA\n    ssh-rsa AAAAB3NzaC1yc2EAAAADAQ\xe2\x80\xa6  #id_rsa.pub of an offline SSH CA 2\n\nTo simplify SSH CA Key rotation you should provision multiple CA Keys, and leave them offline until\nyou are ready to rotate them.\n\nAdditional information about the TrustedUserCAKeys file is [here](https://www.freebsd.org/cgi/man.cgi?sshd_config(5))\n\n## Project resources\n- Source code <https://github.com/netflix/bless>\n- Issue tracker <https://github.com/netflix/bless/issues>\n'