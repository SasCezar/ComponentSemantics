b'![superfly octokitty](https://user-images.githubusercontent.com/7375749/44759033-57b92780-aafd-11e8-880c-818b01c65ff3.png)\n\n\n# Fly\n\n[![npm version](https://img.shields.io/npm/v/@fly/fly.svg)](https://www.npmjs.com/package/@fly/fly)\n[![isc license](https://img.shields.io/npm/l/@fly/fly.svg)](https://github.com/superfly/fly/blob/master/LICENSE) \n[![Build Status](https://dev.azure.com/flydotio/fly/_apis/build/status/fly)](https://dev.azure.com/flydotio/fly/_build/latest?definitionId=1)\n[![Conventional Commits](https://img.shields.io/badge/Conventional%20Commits-1.0.0-yellow.svg)](https://conventionalcommits.org) \n[![FOSSA Status](https://app.fossa.io/api/projects/git%2Bgithub.com%2Fsuperfly%2Ffly.svg?type=shield)](https://app.fossa.io/projects/git%2Bgithub.com%2Fsuperfly%2Ffly?ref=badge_shield)\n![Gitter](https://img.shields.io/gitter/room/superfly/fly.svg?colorB=red)\n\nThe Fly runtime is an open source Javascript environment built to run Edge Applications. It gives developers powerful caching, content modification, and routing tools.\n\nThe runtime is based on v8, with a proxy-appropriate set of Javascript libraries. There are built in APIs for manipulating HTML and Image content, low level caching, and HTTP requests/responses. When possible, we use WhatWG standards (like `fetch`, `Request`, `Response`, `Cache`, `ReadableStream`).\n\nYou can [use it locally](#hello-world) for development and testing, and [deploy it to Fly\'s fleet](#deployment) of edge servers for production use.\n\n## Edge Applications: the in between\n\nYou can use Fly to build HTTP load balancers, caching services, etc, etc. Edge Applications are typically built to replace or augment infrastructure that runs between web apps and users.\n\nThis in-between is a great place to solve certain categories of problems. If you need to solve one of these, you might want to build an Edge Application:\n\n* A/B testing at the load balancer layer\n* Route traffic to different cloud providers\n* Cache personalization data geographically close to individual users\n* Route authenticated users to specific apps\n* Enforce backend SLAs, serve fallback content when backends are degraded\n* Load balancers across cloud storage providers\n* Per user rate limiting (for APIs or apps)\n\n## Installation\n\n#### macOS\n\nHomebrew is the quickest way to get started on macOS:\n\n```bash\nbrew tap superfly/brew && brew install superfly/brew/fly\n```\n\n#### Linux\n\nUse the [standalone installer](#standalone-install)\n\n#### Windows\n\nUse [npm](#npm)\n\n### Other installation methods\n\n#### Standalone Install\n\nThe standalone install is a tarball containing the Fly CLI, precompiled native extensions, and a nodejs binary. This is useful in containers or hosts with restricted access.\n\nTo quickly install into `/usr/local/lib/fly` and `/usr/local/bin/fly`, run this [script](https://github.com/superfly/fly/blob/master/install-standalone.sh) (requires sudo and not Windows compatible):\n\n```bash\ncurl https://get.fly.io/install.sh | sh\n```\n\nOtherwise, download one of the tarballs below and extract it yourself.\n\n#### Tarballs\n\n* [macOS](https://get.fly.io/tarballs/stable/fly-darwin-x64.tar.gz)\n* [Linux (x64)](https://get.fly.io/tarballs/stable/fly-linux-x64.tar.gz)\n\n#### npm\n\nThe Fly CLI and runtime is built on Node.js with native extensions. As a result, installing from npm requires a proper C/C++ compiler toolchain and takes significantly longer than the other methods. If you\'re on Windows or don\'t have XCode/gcc installed, follow the [node-gyp instructions](https://github.com/nodejs/node-gyp#installation) before continuing.\n\nInstall globally:\n\n```bash\nnpm install -g @fly/fly\n```\n\nor as a devDependency in your project:\n\n```bash\nnpm install --save-dev @fly/fly\n```\n\n## Usage\n\n### Hello World!\n\nWrite javascript code to a file (`index.js`):\n\n```js\nfly.http.respondWith((request) => {\n  return new Response("Hello! We support whirled peas.", { status: 200})\n})\n// if you\'d prefer to be service worker compatibility, this is also supported:\n// around addEventListener(\'fetch\', function(event){})\n```\n\nStart the fly server:\n\n```bash\nfly server\n```\n\nVisit your app:\n\n```bash\nopen http://localhost:3000\n```\n\nChange code and configuration, it\'s reloaded seamlessly.\n\n### How does it work?\n\nSimply put:\n\n- Uses a basic webpack configuration to bundle your javascript\n- Assumes the presence of `index.js` or `index.ts`\n- You can customize everything by creating a `webpack.fly.config.js` which will be loaded for you\n- Use npm packages compatible with the v8 javascript engine, you don\'t have access to node.js-specific concepts or packages.\n\n### Configuration\n\nBy default, fly will read your `.fly.yml` file in your current working directory.\n\n```yaml\n# .fly.yml\napp: my-app-name\nconfig:\n  foo: bar\nfiles:\n  - path/to/file\n```\n\nProperties:\n\n- `app` - the fly.io app name, can be ommitted, useful for deployment purposes\n- `config` - arbitrary settings for your applications, accessible in your code via the global variable `app.config`\n- `files` - array of files, relative to your `.fly.yml` to include in the deployment. Can be accessed via `fetch("file://path/to/file")`\n\n### Secrets\n\nYou can require secrets in your app.config like this:\n\n```yaml\n# .fly.yml\napp: my-app-name\nconfig:\n  secretThing:\n    fromSecret: secretKey\n```\n\nIn your code, you can seamlessly use this value like:\n\n```javascript\napp.config.secretThing\n```\n\nWhen deployed on fly.io, secrets are fetched from an encrypted store. You need to pre-define your secrets via `fly secrets:set <key> <value>`.\n\nLocally, you need to define them in a `.fly.secrets.yml` file, make sure you add it to your `.gitignore` as it can contain sensitive data. Example file.\n\n```yaml\n# .fly.secrets.yml\nsecretKey: <your secret value>\n```\n\n### Files\n\nBy specifying a `files` property in your `.fly.yml`, it\'s possible to use `fetch` to load files without having to bundle them in your javascript directly.\n\nLocally, these are fetched from your filesystem. Deployed, these are fetched from our distributed store.\n\nExample usage in your code: (given a `client/app.js` file)\n\n```javascript\n// index.js\n\naddEventListener(\'fetch\', function(event){\n  event.respondWith(async function(){\n    const res = await fetch("file://client/app.js")\n    res.status // 200\n    res.headers.set("content-type", "application/javascript")\n    return res\n  })\n})\n```\n\nNote that fetching with the `file:` protocol returns a very basic response.\n\n### Multiple environments\n\nDifferent environments (development, test, production) require different configurations. You can specify how each should behave by adding one level to your `.fly.yml` like:\n\n```yaml\nconfig: &config # your default config\n  foo: bar\n\ndefault: &default\n  app: your-app-name\n  config:\n    <<: *config\n\ndevelopment:\n  <<: *default\n\ntest:\n  <<: *default\n  config:\n    <<: *config\n    foo: not-bar\n\nproduction:\n  <<: *default\n  config:\n    <<: *config\n    foo:\n      fromSecret: fooSecret\n```\n\n## Testing\n\n`fly` comes with `mocha` as its default testing framework.\n\nYou can write unit tests and use `fly test` to run them within the fly environment:\n\n```javascript\n// ./test/index.spec.js\nimport { MyModule } from \'../my_module\' // load some code\nimport { expect } from \'chai\'\n\ndescribe("MyModule", ()=>{\n  it("works", function(){\n    expect(MyModule).to.be.instanceof(Function)\n  })\n})\n```\n\n## Deployment\n\nOnce you\'re happy with your app, you can deploy to [fly.io](https://fly.io).\n\n### 1. Login\n\nUse `fly login` to log into your fly.io account, if you don\'t have one, go create one!\n\n### 2. Create an app\n\nMake sure you\'ve created your fly app for your account with `fly apps:create [name]` (name is optional)\n\nSet your `app` property in your `.fly.yml`\n\n### 3. Deploy!\n\nUsing `fly deploy`, here\'s what happens:\n- Your code is bundled via webpack, it\'s also uglified to save space\n- Your code, source map and `files` are added to a simple tarball, gzipped and uploaded to the fly.io API using your token\n- We create a "release" for your app, those are immutable, changing anything (by using `fly deploy` or `fly secrets:set`) will trigger a new release which will be deployed automatically\n- Your code is distributed instantly(-ish) across our global fleet of servers\n\n## Logs\n\nTail production logs with:\n\n```bash\nfly logs\n```\n\n## Documentation\n\n- [Getting Started](https://fly.io/docs/apps/)\n- [API Reference](https://fly.io/docs/apps/api/index.html)\n- [Examples](https://github.com/superfly/edge/)\n\n## Open source\n\nWe develop fly in the open. We\'re [Apache licensed](https://github.com/superfly/fly/blob/master/LICENSE) and designed to run easily in local dev. You _can_ deploy our core software to production, but it takes a little elbow grease and a fair amount of infrastructure. If you want to give this a try, let us know and we can help (and we would love related pull requests!).\n\nOur commercial offering is built on top of this library, with additional code for managing certificates, distributed caching, and multi-tenant isolation. Over time we expect to extract many of these features, document them, and include them in our open source releases.\n\nWe support [Let\'s Encrypt](https://github.com/letsencrypt): We donate half our certificate management fees to Let\'s Encrypt every year.\n\n[![](https://img.shields.io/twitter/url/http/shields.io.svg?style=social)](https://twitter.com/flydotio)\n'