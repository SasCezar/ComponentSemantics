b'# homebridge-dafang\n\n[![NPM](https://nodei.co/npm/homebridge-dafang.png?downloads=true&downloadRank=true&stars=true)](https://nodei.co/npm/homebridge-dafang/)\n\n[![npm](https://img.shields.io/npm/dm/homebridge-dafang.svg)](https://www.npmjs.com/package/homebridge-dafang)\n[![npm](https://img.shields.io/npm/v/homebridge-dafang.svg)](https://www.npmjs.com/package/homebridge-dafang)\n[![CircleCI](https://circleci.com/gh/sahilchaddha/homebridge-dafang.svg?style=svg)](https://circleci.com/gh/sahilchaddha/homebridge-dafang)\n\n\nHomebridge Plugin for Xiaomi Dafang / Wyze Camera\n\n## Installation\n\n1. Install ffmpeg on your device\n\n```\n    $ brew install ffmpeg --with-openh264 --with-fdk-aac\n```\n\n2. Install the plugin using:\n\n```shell\n    $ npm install -g --unsafe-perm homebridge\n    $ npm install -g --unsafe-perm homebridge-dafang\n```\n\n3. Install CFW on camera and set up MQTT. Refer to [Setup Readme](https://github.com/sahilchaddha/homebridge-dafang/blob/master/Setup_MQTT.md)\n4. Edit config.json and add the plugin. Refer to `config-sample.json` in repository.\n5. Run Homebridge\n6. Add extra camera accessories in Home app. The setup code is the same as in homebridge.You can go into -> ` + -> Add New Accessory -> Add Manually -> Add Homebridge Pin -> Select Camera -> Add`\n\n\nSupported Cameras :\n\nName | Picture\n--- | ---\nXiaomi Dafang | ![Dafang](https://github.com/EliasKotlyar/Xiaomi-Dafang-Hacks/raw/master/dafang.png)\nXiaomi Xiaofang 1S | ![XiaoFang](https://github.com/EliasKotlyar/Xiaomi-Dafang-Hacks/raw/master/xiaofang.png)\nWyzecam Pan | ![Dafang](https://github.com/EliasKotlyar/Xiaomi-Dafang-Hacks/raw/master/dafang.png)\nWyzecam V2 | ![XiaoFang](https://github.com/EliasKotlyar/Xiaomi-Dafang-Hacks/raw/master/xiaofang.png)\nSannce I21AG, MixSight HX-I2110T2, WanScam HW0036, Escam G02, Digoo BB-M2 | ![XiaoFang](https://github.com/EliasKotlyar/Xiaomi-Dafang-Hacks/raw/master/sannce.jpg)\nAny other Device with Ingenic T10/T20 Device | ![T20](https://github.com/EliasKotlyar/Xiaomi-Dafang-Hacks/raw/master/t20.png)\n\n## Todo : \n\n- [ ] Timelapse Switch\n- [ ] Intercom 2 Way Audio **\n\n## Accessories : \n\n| Accessory                          | Type                | Description                                           | Config |\n|------------------------------------|---------------------|-------------------------------------------------------|--------|\n| Motion Sensor                      | `motionSensor`      | Alerts if Motion is Detected                          | `threshold(optional) => In ms.`|\n| Rich Motion Sensor                      | `richMotionSensor`      | Alerts if Motion is Detected (Rich Notifications)                          | `threshold(optional) => In ms.`|\n| Night Vision Sensor                | `nightVisionSensor` | Alerts if Night Mode is Detected                      | `threshold(optional) => In ms.`|\n| Night Vision Switch                | `nightVisionSwitch` | Toggles Night Mode on Camera => IR_LED ON IR_CUT OFF  | None   |\n| Brightness Lux Sensor                | `brightness` | Brightness Lux Sensor  | None   |\n| Automatic Night Mode Toggle Switch | `autoNightVisionSwitch` | Toggles Automatic Night Mode on Camera | None     |\n| Automatic Motion Tracking Switch   | `autoMotionTrackingSwitch` | Toggles Automatic Motion Tracking on Dafang    | None  |\n| Move/Rotate Camera Motor           | `moveCamera`              | Moves Dafang Camera Horizontal/Vertical right/left up/down Motor| `axis(required) => horizontal/vertical, direction(required) => left/right for horizontal and up/down for vertical`|\n| Record Video+Audio           | `recordVideo`              | Records Video + Audio Toggle Switch. Video(mp4) files are saved in local machine running homebridge| None|\n| Record Audio Only           | `recordAudio`              | Records Audio Toggle Switch. Audio(aac) files are saved in local machine running homebridge| None|\n| Capture Image           | `captureImage`              | Captures Image from Camera and saves to configured folder| None|\n| Recorded Media Storage Sensor           | `storageSensor`              | Alerts when recorded media folder storage is full on the system due to recordings. You can set custom disk space in MB in config| None|\n| Clear Storage Switch           | `clearStorage`              | Clears All Recordings| None|\n| Reset FFMEPG Switch           | `resetFFMPEG`              | Kills all FFMPEG Zombie Scripts. Audio/Video Recordings will restart recording.| None|\n| Motion Detection Switch           | `motionDetection`              | Enables/Disable Motion Detection. Turning off this switch will stop sending motion detection alerts.| None|\n| RTSP Server Switch           | `rtspSwitch`              | Debug Switch to turn on/off RTSP H264 Stream Server.| None|\n| MJPEG Server Switch           | `mjpegSwitch`              | Debug Switch to turn on/off MJPEG Server| None|\n| Recalibrate Motor Switch           | `recalibrateSwitch`              | Debug Switch to Re-Calibrate Camera Motor.| None|\n| Restart Camera Switch           | `restartSwitch`              | Debug Switch to restart Camera.| None|\n| Re-Mount SD Card RW Switch           | `remountSwitch`              | Debug Switch to re mount sd card with RW permission. It prevents SD Card Failures like stuck RTSP Stream.| None|\n\nThreshold => Lesser Threshold, More Accuracy. Dafang Motion detection is sensitive, and it toggles very quickly, to keep the state of sensor more stable little threshold will delay frequent alerts\n\n ## Demo :\n\n Sorry for crappy quality. Tested on Rpi + Slow Network\n\n### Advanced Demo : \n\n ![Advanced Demo](https://raw.githubusercontent.com/sahilchaddha/homebridge-dafang/master/demo-advanced.gif)\n\n### Simple Demo : \n\n ![Simple Demo](https://raw.githubusercontent.com/sahilchaddha/homebridge-dafang/master/demo-simple.gif)\n\n### Rich Notifications : \n\n<img src="https://raw.githubusercontent.com/sahilchaddha/homebridge-dafang/master/demo-rich-not.gif" width="300" height="600" />\n\n## Plugin Config : \n\n| Config                          | Type                | Description                                           | Config |\n|------------------------------------|---------------------|-------------------------------------------------------|--------|\n| mqtt.hostBroker                      | bool      | Set true to host MQTT Locally, set false to connect to external MQTT Broker.                          | Required|\n| cameras                      | Array (Object)      | Can add Multiple Cameras                          | Required|\n\n\n## Camera Config : \n\n| Config                          | Type                | Description                                           | Config |\n|------------------------------------|---------------------|-------------------------------------------------------|--------|\n| cameraRTSPStreamUrl                      | string      | RTSP Stream Url e.g. `rtsp://192.168.1.2:8554/unicast`                          | Required|\n| disableStream                | bool | Set true to stream camera, set false to disable camera view                      | Optional|\n| mqttTopic                | string | Each Dafang Device must have a unique topic. Topic should match for each corresponding camera accessory                      | Required|\n| folder                | string | Absolute path of directory where recordings/images will be saved                      | Required|\n| segmentLength                | number | Length of each video file. (in seconds). Each recording will be saved in segmented videos. Default : 60 (1 minute)                      | Optional|\n| maxDirSize                | number | Max Size of folder (in mb) where recordings will be saved. Default : 2048 (2GB)                      | Optional|\n| checkStorageSizeInterval                | number | Time in seconds to re check recording folder size for `storageSensor`. Default : 300 (5 min)                      | Optional|\n| recordingDirectoryPathFormat                | string | DateTime format for Recordings Directory Path. Default : `MMM-Do-YY`                      | Optional|\n| recordingFilenameFormat                | string | DateTime format for Recordings Filename. Default : `YYYY-M-D-h-mm-ss` | Optional|\n\nRefer to https://momentjscom.readthedocs.io/en/latest/moment/04-displaying/01-format/ for custom DirectoryPath/FileName formats for recordings..\n\n```json\n{\n    "platforms": [\n        {\n            "platform": "Dafang",\n            "mqtt": {\n                "hostBroker": true,\n                "port": 1883,\n                "host": "localhost",\n                "debug": true,\n                "mongoUrl": "mongodb://localhost:27017/mqtt"\n            },\n            "cameras": [{\n                "cameraName": "My Dafang",\n                "cameraRTSPStreamUrl": "rtsp://192.168.1.12:8554/unicast",\n                "mqttTopic": "myhome/dafang/#",\n                "folder": "/Users/sahilchaddha/Sahil/Recordings/",\n                "accessories": [\n                                    {\n                                        "name": "Living Room Motion Sensor",\n                                        "type": "richMotionSensor",\n                                        "threshold": 300000\n                                    },\n                                    {\n                                        "name": "Living Room Auto Motion Tracking Switch",\n                                        "type": "autoMotionTrackingSwitch"\n                                    },\n                                    {\n                                        "name": "Living Room Night Vision Sensor",\n                                        "type": "nightVisionSensor",\n                                        "threshold": 0\n                                    },\n                                    {\n                                        "name": "Living Room Night Vision Switch",\n                                        "type": "nightVisionSwitch"\n                                    },\n                                    {\n                                        "name": "Living Room Auto Night Vision Switch",\n                                        "type": "autoNightVisionSwitch"\n                                    },\n                                    {\n                                        "name": "Horizontal Left",\n                                        "type": "moveCamera",\n                                        "axis": "horizontal",\n                                        "direction": "left"\n                                    },\n                                    {\n                                        "name": "Horizontal Right",\n                                        "type": "moveCamera",\n                                        "axis": "horizontal",\n                                        "direction": "right"\n                                    },\n                                    {\n                                        "name": "Vertical Up",\n                                        "type": "moveCamera",\n                                        "axis": "vertical",\n                                        "direction": "up"\n                                    },\n                                    {\n                                        "name": "Vertical Down",\n                                        "type": "moveCamera",\n                                        "axis": "vertical",\n                                        "direction": "down"\n                                    },\n                                    {\n                                        "name": "Record Video",\n                                        "type": "recordVideo"\n                                    },\n                                    {\n                                        "name": "Record Audio",\n                                        "type": "recordAudio"\n                                    },\n                                    {\n                                        "name": "Capture Image",\n                                        "type": "captureImage"\n                                    },\n                                    {\n                                        "name": "RPi Storage Sensor",\n                                        "type": "storageSensor"\n                                    },\n                                    {\n                                        "name": "Clear Storage Switch",\n                                        "type": "clearStorage"\n                                    },\n                                    {\n                                        "name": "Reset Streaming",\n                                        "type": "resetFFMPEG"\n                                    },\n                                    {\n                                        "name": "Camera Brightness",\n                                        "type": "brightness"\n                                    }\n                    ]\n            }]\n        }\n    ]\n}\n```\n\n## Lint\n\n```shell\n    $ npm run lint\n```\n\n## Need Help ?\n\nGet Slack Invite => `https://slackin-znyruquwmv.now.sh/`\n\nSlack Channel => `https://homebridgeteam.slack.com/messages/homebridge-dafang`\n\nSlack User => `@sahilchaddha`\n\n### Author\n\nSahil Chaddha\n\nmail@sahilchaddha.com'