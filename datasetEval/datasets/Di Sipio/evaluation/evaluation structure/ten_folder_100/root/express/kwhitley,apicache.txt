b'# A simple API response caching middleware for Express/Node using plain-english durations.\n\n#### Supports Redis or built-in memory engine with auto-clearing.\n\n[![npm version](https://badge.fury.io/js/apicache.svg)](https://www.npmjs.com/package/apicache)\n[![node version support](https://img.shields.io/node/v/apicache.svg)](https://www.npmjs.com/package/apicache)\n[![Build Status via Travis CI](https://travis-ci.org/kwhitley/apicache.svg?branch=master)](https://travis-ci.org/kwhitley/apicache)\n[![Coverage Status](https://coveralls.io/repos/github/kwhitley/apicache/badge.svg?branch=master)](https://coveralls.io/github/kwhitley/apicache?branch=master)\n[![NPM downloads](https://img.shields.io/npm/dt/apicache.svg?style=flat-square)](https://www.npmjs.com/package/apicache)\n\n## Why?\n\nBecause route-caching of simple data/responses should ALSO be simple.\n\n## Usage\n\nTo use, simply inject the middleware (example: `apicache.middleware(\'5 minutes\', [optionalMiddlewareToggle])`) into your routes. Everything else is automagic.\n\n#### Cache a route\n\n```js\nimport express from \'express\'\nimport apicache from \'apicache\'\n\nlet app = express()\nlet cache = apicache.middleware\n\napp.get(\'/api/collection/:id?\', cache(\'5 minutes\'), (req, res) => {\n  // do some work... this will only occur once per 5 minutes\n  res.json({ foo: \'bar\' })\n})\n```\n\n#### Cache all routes\n\n```js\nlet cache = apicache.middleware\n\napp.use(cache(\'5 minutes\'))\n\napp.get(\'/will-be-cached\', (req, res) => {\n  res.json({ success: true })\n})\n```\n\n#### Use with Redis\n\n```js\nimport express from \'express\'\nimport apicache from \'apicache\'\nimport redis from \'redis\'\n\nlet app = express()\n\n// if redisClient option is defined, apicache will use redis client\n// instead of built-in memory store\nlet cacheWithRedis = apicache.options({ redisClient: redis.createClient() }).middleware\n\napp.get(\'/will-be-cached\', cacheWithRedis(\'5 minutes\'), (req, res) => {\n  res.json({ success: true })\n})\n```\n\n#### Cache grouping and manual controls\n\n```js\nimport apicache from \'apicache\'\nlet cache = apicache.middleware\n\napp.use(cache(\'5 minutes\'))\n\n// routes are automatically added to index, but may be further added\n// to groups for quick deleting of collections\napp.get(\'/api/:collection/:item?\', (req, res) => {\n  req.apicacheGroup = req.params.collection\n  res.json({ success: true })\n})\n\n// add route to display cache performance (courtesy of @killdash9)\napp.get(\'/api/cache/performance\', (req, res) => {\n  res.json(apicache.getPerformance())\n})\n\n// add route to display cache index\napp.get(\'/api/cache/index\', (req, res) => {\n  res.json(apicache.getIndex())\n})\n\n// add route to manually clear target/group\napp.get(\'/api/cache/clear/:target?\', (req, res) => {\n  res.json(apicache.clear(req.params.target))\n})\n\n/*\n\nGET /api/foo/bar --> caches entry at /api/foo/bar and adds a group called \'foo\' to index\nGET /api/cache/index --> displays index\nGET /api/cache/clear/foo --> clears all cached entries for \'foo\' group/collection\n\n*/\n```\n\n#### Use with middleware toggle for fine control\n\n```js\n// higher-order function returns false for responses of other status codes (e.g. 403, 404, 500, etc)\nconst onlyStatus200 = (req, res) => res.statusCode === 200\n\nconst cacheSuccesses = cache(\'5 minutes\', onlyStatus200)\n\napp.get(\'/api/missing\', cacheSuccesses, (req, res) => {\n  res.status(404).json({ results: \'will not be cached\' })\n})\n\napp.get(\'/api/found\', cacheSuccesses, (req, res) => {\n  res.json({ results: \'will be cached\' })\n})\n```\n\n#### Prevent cache-control header "max-age" from automatically being set to expiration age\n\n```js\nlet cache = apicache.options({\n  headers: {\n    \'cache-control\': \'no-cache\',\n  },\n}).middleware\n\nlet cache5min = cache(\'5 min\') // continue to use normally\n```\n\n## API\n\n- `apicache.options([globalOptions])` - getter/setter for global options. If used as a setter, this function is chainable, allowing you to do things such as... say... return the middleware.\n- `apicache.middleware([duration], [toggleMiddleware], [localOptions])` - the actual middleware that will be used in your routes. `duration` is in the following format "[length][unit]", as in `"10 minutes"` or `"1 day"`. A second param is a middleware toggle function, accepting request and response params, and must return truthy to enable cache for the request. Third param is the options that will override global ones and affect this middleware only.\n- `middleware.options([localOptions])` - getter/setter for middleware-specific options that will override global ones.\n- `apicache.getPerformance()` - returns current cache performance (cache hit rate)\n- `apicache.getIndex()` - returns current cache index [of keys]\n- `apicache.clear([target])` - clears cache target (key or group), or entire cache if no value passed, returns new index.\n- `apicache.newInstance([options])` - used to create a new ApiCache instance (by default, simply requiring this library shares a common instance)\n- `apicache.clone()` - used to create a new ApiCache instance with the same options as the current one\n\n#### Available Options (first value is default)\n\n```js\n{\n  debug:            false|true,     // if true, enables console output\n  defaultDuration:  \'1 hour\',       // should be either a number (in ms) or a string, defaults to 1 hour\n  enabled:          true|false,     // if false, turns off caching globally (useful on dev)\n  redisClient:      client,         // if provided, uses the [node-redis](https://github.com/NodeRedis/node_redis) client instead of [memory-cache](https://github.com/ptarjan/node-cache)\n  appendKey:        fn(req, res),   // appendKey takes the req/res objects and returns a custom value to extend the cache key\n  headerBlacklist:  [],             // list of headers that should never be cached\n  statusCodes: {\n    exclude:        [],             // list status codes to specifically exclude (e.g. [404, 403] cache all responses unless they had a 404 or 403 status)\n    include:        [],             // list status codes to require (e.g. [200] caches ONLY responses with a success/200 code)\n  },\n  trackPerformance: false,          // enable/disable performance tracking... WARNING: super cool feature, but may cause memory overhead issues\n  headers: {\n    // \'cache-control\':  \'no-cache\' // example of header overwrite\n  }\n}\n```\n\n##### \\*Optional: Typescript Types (courtesy of [@danielsogl](https://github.com/danielsogl))\n\n```bash\n$ npm install -D @types/apicache\n```\n\n## Custom Cache Keys\n\nSometimes you need custom keys (e.g. save routes per-session, or per method).\nWe\'ve made it easy!\n\n**Note:** All req/res attributes used in the generation of the key must have been set\npreviously (upstream). The entire route logic block is skipped on future cache hits\nso it can\'t rely on those params.\n\n```js\napicache.options({\n  appendKey: (req, res) => req.method + res.session.id,\n})\n```\n\n## Cache Key Groups\n\nOftentimes it benefits us to group cache entries, for example, by collection (in an API). This\nwould enable us to clear all cached "post" requests if we updated something in the "post" collection\nfor instance. Adding a simple `req.apicacheGroup = [somevalue];` to your route enables this. See example below:\n\n```js\nvar apicache = require(\'apicache\')\nvar cache = apicache.middleware\n\n// GET collection/id\napp.get(\'/api/:collection/:id?\', cache(\'1 hour\'), function(req, res, next) {\n  req.apicacheGroup = req.params.collection\n  // do some work\n  res.send({ foo: \'bar\' })\n})\n\n// POST collection/id\napp.post(\'/api/:collection/:id?\', function(req, res, next) {\n  // update model\n  apicache.clear(req.params.collection)\n  res.send(\'added a new item, so the cache has been cleared\')\n})\n```\n\nAdditionally, you could add manual cache control to the previous project with routes such as these:\n\n```js\n// GET apicache index (for the curious)\napp.get(\'/api/cache/index\', function(req, res, next) {\n  res.send(apicache.getIndex())\n})\n\n// GET apicache index (for the curious)\napp.get(\'/api/cache/clear/:key?\', function(req, res, next) {\n  res.send(200, apicache.clear(req.params.key || req.query.key))\n})\n```\n\n## Debugging/Console Out\n\n#### Using Node environment variables (plays nicely with the hugely popular [debug](https://www.npmjs.com/package/debug) module)\n\n```\n$ export DEBUG=apicache\n$ export DEBUG=apicache,othermoduleThatDebugModuleWillPickUp,etc\n```\n\n#### By setting internal option\n\n```js\nimport apicache from \'apicache\'\n\napicache.options({ debug: true })\n```\n\n## Client-Side Bypass\n\nWhen sharing `GET` routes between admin and public sites, you\'ll likely want the\nroutes to be cached from your public client, but NOT cached when from the admin client. This\nis achieved by sending a `"x-apicache-bypass": true` header along with the requst from the admin.\nThe presence of this header flag will bypass the cache, ensuring you aren\'t looking at stale data.\n\n## Contributors\n\nSpecial thanks to all those that use this library and report issues, but especially to the following active users that have helped add to the core functionality!\n\n- [@killdash9](https://github.com/killdash9) - restify support, performance/stats system, and too much else at this point to list\n- [@svozza](https://github.com/svozza) - added restify tests, test suite refactor, and fixed header issue with restify. Node v7 + Restify v5 conflict resolution, etag/if-none-match support, etcetc, etc. Triple thanks!!!\n- [@andredigenova](https://github.com/andredigenova) - Added header blacklist as options, correction to caching checks\n- [@peteboere](https://github.com/peteboere) - Node v7 headers update\n- [@rutgernation](https://github.com/rutgernation) - JSONP support\n- [@enricsangra](https://github.com/enricsangra) - added x-apicache-force-fetch header\n- [@tskillian](https://github.com/tskillian) - custom appendKey path support\n- [@agolden](https://github.com/agolden) - Content-Encoding preservation (for gzip, etc)\n- [@davidyang](https://github.com/davidyang) - express 4+ compatibility\n- [@nmors](https://github.com/nmors) - redis support\n- [@maytis](https://github.com/maytis), [@ashwinnaidu](https://github.com/ashwinnaidu) - redis expiration\n- [@ubergesundheit](https://github.com/ubergesundheit) - Corrected buffer accumulation using res.write with Buffers\n- [@danielsogl](https://github.com/danielsogl) - Keeping dev deps up to date, Typescript Types\n- [@vectart](https://github.com/vectart) - Added middleware local options support\n- [@davebaol](https://github.com/davebaol) - Added string support to defaultDuration option (previously just numeric ms)\n- [@Rauttis](https://github.com/rauttis) - Added ioredis support\n- [@fernandolguevara](https://github.com/fernandolguevara) - Added opt-out for performance tracking, great emergency fix, thank you!!\n\n### Bugfixes, tweaks, documentation, etc.\n\n- @Amhri, @Webcascade, @conmarap, @cjfurelid, @scambier, @lukechilds, @Red-Lv, @gesposito, @viebel, @RowanMeara, @GoingFast, @luin, @keithws, @daveross, @apascal\n\n### Changelog\n\n- **v1.5.2** - multiple fixes: Buffer deprecation and \\_headers deprecation, { trackPerformance: false } by default per discussion (sorry semver...)\n- **v1.5.1** - adds { trackPerformance } option to enable/disable performance tracking (thanks @fernandolguevara)\n- **v1.5.0** - exposes apicache.getPerformance() for per-route cache metrics (@killdash9 continues to deliver)\n- **v1.4.0** - cache-control header now auto-decrements in cached responses (thanks again, @killdash9)\n- **v1.3.0** - [securityfix] apicache headers no longer embedded in cached responses when NODE_ENV === \'production\' (thanks for feedback @satya-jugran, @smddzcy, @adamelliotfields). Updated deps, now requiring Node v6.00+.\n- **v1.2.6** - middlewareToggle() now prevents response block on cache hit + falsy toggle (thanks @apascal)\n- **v1.2.5** - uses native Node setHeader() rather than express.js header() (thanks @keithws and @daveross)\n- **v1.2.4** - force content type to Buffer, using old and new Buffer creation syntax\n- **v1.2.3** - add etag to if-none-match 304 support (thanks for the test/issue @svozza)\n- **v1.2.2** - bugfix: ioredis.expire params (thanks @GoingFast and @luin)\n- **v1.2.1** - Updated deps\n- **v1.2.0** - Supports ioredis (thanks @Rauttis)\n- **v1.1.1** - bugfixes in expiration timeout clearing and content header preservation under compression (thanks @RowanMeara and @samimakicc).\n- **v1.1.0** - added the much-requested feature of a custom appendKey function (previously only took a path to a single request attribute). Now takes (request, response) objects and returns some value to be appended to the cache key.\n- **v1.0.0** - stamping v0.11.2 into official production version, will now begin developing on branch v2.x (redesign)\n- **v0.11.2** - dev-deps update, courtesy of @danielsogl\n- **v0.11.1** - correction to status code caching, and max-age headers are no longer sent when not cached. middlewareToggle now works as intended with example of statusCode checking (checks during shouldCacheResponse cycle)\n- **v0.11.0** - Added string support to defaultDuration option, previously just numeric ms - thanks @davebaol\n- **v0.10.0** - added ability to blacklist headers (prevents caching) via options.headersBlacklist (thanks @andredigenova)\n- **v0.9.1** - added eslint in prep for v1.x branch, minor ES6 to ES5 in master branch tests\n- **v0.9.0** - corrected Node v7.7 & v8 conflicts with restify (huge thanks to @svozza\n  for chasing this down and fixing upstream in restify itself). Added coveralls. Added\n  middleware.localOptions support (thanks @vectart). Added ability to overwrite/embed headers\n  (e.g. "cache-control": "no-cache") through options.\n- **v0.8.8** - corrected to use node v7+ headers (thanks @peteboere)\n- **v0.8.6, v0.8.7** - README update\n- **v0.8.5** - dev dependencies update (thanks @danielsogl)\n- **v0.8.4** - corrected buffer accumulation, with test support (thanks @ubergesundheit)\n- **v0.8.3** - added tests for x-apicache-bypass and x-apicache-force-fetch (legacy) and fixed a bug in the latter (thanks @Red-Lv)\n- **v0.8.2** - test suite and mock API refactor (thanks @svozza)\n- **v0.8.1** - fixed restify support and added appropriate tests (thanks @svozza)\n- **v0.8.0** - modifies response accumulation (thanks @killdash9) to support res.write + res.end accumulation, allowing integration with restify. Adds gzip support (Node v4.3.2+ now required) and tests.\n- **v0.7.0** - internally sets cache-control/max-age headers of response object\n- **v0.6.0** - removed final dependency (debug) and updated README\n- **v0.5.0** - updated internals to use res.end instead of res.send/res.json/res.jsonp, allowing for any response type, adds redis tests\n- **v0.4.0** - dropped lodash and memory-cache external dependencies, and bumped node version requirements to 4.0.0+ to allow Object.assign native support\n'