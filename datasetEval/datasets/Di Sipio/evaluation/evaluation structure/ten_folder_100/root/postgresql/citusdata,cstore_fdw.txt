b'cstore_fdw\n==========\n\n[![Build Status](https://travis-ci.org/citusdata/cstore_fdw.svg?branch=master)][status]\n[![Coverage](http://img.shields.io/coveralls/citusdata/cstore_fdw/master.svg)][coverage]\n\nCstore_fdw is an open source columnar store extension for PostgreSQL. Columnar stores provide notable benefits for analytics use cases where data is loaded in batches. Cstore_fdw\xe2\x80\x99s columnar nature delivers performance by only reading relevant data from disk, and it may compress data 6x-10x to reduce space requirements for data archival.\n\nCstore_fdw is developed by [Citus Data](https://www.citusdata.com) and can be used in combination with [Citus](https://github.com/citusdata/citus), a postgres extension that intelligently distributes your data and queries across many nodes so your database can scale and your queries are fast. If you have any questions about how Citus can help you scale or how to use Citus in combination with cstore_fdw, [please let us know](https://www.citusdata.com/about/contact_us/).\n\nJoin the [Mailing List][mailing-list] to stay on top of the latest developments for Cstore_fdw.\n\n\nIntroduction\n------------\n\nThis extension uses a format for its data layout that is inspired by ORC,\nthe Optimized Row Columnar format. Like ORC, the cstore format improves\nupon RCFile developed at Facebook, and brings the following benefits:\n\n* Compression: Reduces in-memory and on-disk data size by 2-4x. Can be extended\n  to support different codecs.\n* Column projections: Only reads column data relevant to the query. Improves\n  performance for I/O bound queries.\n* Skip indexes: Stores min/max statistics for row groups, and uses them to skip\n  over unrelated rows.\n\nFurther, we used the Postgres foreign data wrapper APIs and type representations\nwith this extension. This brings:\n\n* Support for 40+ Postgres data types. The user can also create new types and\n  use them.\n* Statistics collection. PostgreSQL\'s query optimizer uses these stats to\n  evaluate different query plans and pick the best one.\n* Simple setup. Create foreign table and copy data. Run SQL.\n\n\nBuilding\n--------\n\ncstore\\_fdw depends on protobuf-c for serializing and deserializing table metadata.\nSo we need to install these packages first:\n\n    # Fedora 17+, CentOS, and Amazon Linux\n    sudo yum install protobuf-c-devel\n\n    # Ubuntu 10.4+\n    sudo apt-get install protobuf-c-compiler\n    sudo apt-get install libprotobuf-c0-dev\n\n    # Mac OS X\n    brew install protobuf-c\n\n**Note.** In CentOS 5, 6, and 7, you may need to install or update EPEL 5, 6, or 7 repositories.\n See [this page](https://support.rackspace.com/how-to/install-epel-and-additional-repositories-on-centos-and-red-hat/)\nfor instructions.\n\n**Note.** In Amazon Linux, the EPEL repository is installed by default, but not\nenabled. See [these instructions](http://aws.amazon.com/amazon-linux-ami/faqs/#epel)\nfor how to enable it.\n\nOnce you have protobuf-c installed on your machine, you are ready to build\ncstore\\_fdw.  For this, you need to include the pg\\_config directory path in\nyour make command. This path is typically the same as your PostgreSQL\ninstallation\'s bin/ directory path. For example:\n\n    PATH=/usr/local/pgsql/bin/:$PATH make\n    sudo PATH=/usr/local/pgsql/bin/:$PATH make install\n\n**Note.** cstore_fdw requires PostgreSQL 9.3, 9.4, 9.5, 9.6, 10 or 11. It doesn\'t\nsupport earlier versions of PostgreSQL.\n\n\nUsage\n-----\n\nBefore using cstore\\_fdw, you need to add it to ```shared_preload_libraries```\nin your ```postgresql.conf``` and restart Postgres:\n\n    shared_preload_libraries = \'cstore_fdw\'    # (change requires restart)\n\nThe following parameters can be set on a cstore foreign table object.\n\n* filename (optional): The absolute path to the location for storing table data.\n  If you don\'t specify the filename option, cstore\\_fdw will automatically\n  choose the $PGDATA/cstore\\_fdw directory to store the files. If specified the \n  value of this parameter will be used as a prefix for all files created to\n  store table data. For example, the value ```/cstore_fdw/my_table``` could result in\n  the files ```/cstore_fdw/my_table``` and ```/cstore_fdw/my_table.footer``` being used\n  to manage table data.\n* compression (optional): The compression used for compressing value streams.\n  Valid options are ```none``` and ```pglz```. The default is ```none```.\n* stripe\\_row\\_count (optional): Number of rows per stripe. The default is\n  ```150000```. Reducing this decreases the amount memory used for loading data\n  and querying, but also decreases the performance.\n* block\\_row\\_count (optional): Number of rows per column block. The default is\n ```10000```. cstore\\_fdw compresses, creates skip indexes, and reads from disk\n  at the block granularity. Increasing this value helps with compression and results\n  in fewer reads from disk. However, higher values also reduce the probability of\n  skipping over unrelated row blocks.\n\n\nTo load or append data into a cstore table, you have two options:\n\n* You can use the [```COPY``` command][copy-command] to load or append data from\n  a file, a program, or STDIN.\n* You can use the ```INSERT INTO cstore_table SELECT ...``` syntax to load or\n  append data from another table.\n\nYou can use the [```ANALYZE``` command][analyze-command] to collect statistics\nabout the table. These statistics help the query planner to help determine the\nmost efficient execution plan for each query.\n\n**Note.** We currently don\'t support updating table using DELETE, and UPDATE\ncommands. We also don\'t support single row inserts.\n\n\nUpdating from earlier versions to 1.6\n---------------------------------------\n\nTo update an existing cstore_fdw installation from versions earlier than 1.6\nyou can take the following steps:\n\n* Download and install cstore_fdw version 1.6 using instructions from the "Building"\n  section,\n* Restart the PostgreSQL server,\n* Run ```ALTER EXTENSION cstore_fdw UPDATE;```\n\n\nExample\n-------\n\nAs an example, we demonstrate loading and querying data to/from a column store\ntable from scratch here. Let\'s start with downloading and decompressing the data\nfiles.\n\n    wget http://examples.citusdata.com/customer_reviews_1998.csv.gz\n    wget http://examples.citusdata.com/customer_reviews_1999.csv.gz\n\n    gzip -d customer_reviews_1998.csv.gz\n    gzip -d customer_reviews_1999.csv.gz\n\nThen, let\'s log into Postgres, and run the following commands to create a column\nstore foreign table:\n\n```SQL\n-- load extension first time after install\nCREATE EXTENSION cstore_fdw;\n\n-- create server object\nCREATE SERVER cstore_server FOREIGN DATA WRAPPER cstore_fdw;\n\n-- create foreign table\nCREATE FOREIGN TABLE customer_reviews\n(\n    customer_id TEXT,\n    review_date DATE,\n    review_rating INTEGER,\n    review_votes INTEGER,\n    review_helpful_votes INTEGER,\n    product_id CHAR(10),\n    product_title TEXT,\n    product_sales_rank BIGINT,\n    product_group TEXT,\n    product_category TEXT,\n    product_subcategory TEXT,\n    similar_product_ids CHAR(10)[]\n)\nSERVER cstore_server\nOPTIONS(compression \'pglz\');\n```\n\nNext, we load data into the table:\n\n```SQL\nCOPY customer_reviews FROM \'/home/user/customer_reviews_1998.csv\' WITH CSV;\nCOPY customer_reviews FROM \'/home/user/customer_reviews_1999.csv\' WITH CSV;\n```\n\n**Note.** If you are getting ```ERROR: cannot copy to foreign table\n"customer_reviews"``` when trying to run the COPY commands, double check that you\nhave added cstore\\_fdw to ```shared_preload_libraries``` in ```postgresql.conf```\nand restarted Postgres.\n\nNext, we collect data distribution statistics about the table. This is optional,\nbut usually very helpful:\n\n```SQL\nANALYZE customer_reviews;\n```\n\nFinally, let\'s run some example SQL queries on the column store table.\n\n```SQL\n-- Find all reviews a particular customer made on the Dune series in 1998.\nSELECT\n    customer_id, review_date, review_rating, product_id, product_title\nFROM\n    customer_reviews\nWHERE\n    customer_id =\'A27T7HVDXA3K2A\' AND\n    product_title LIKE \'%Dune%\' AND\n    review_date >= \'1998-01-01\' AND\n    review_date <= \'1998-12-31\';\n\n-- Do we have a correlation between a book\'s title\'s length and its review ratings?\nSELECT\n    width_bucket(length(product_title), 1, 50, 5) title_length_bucket,\n    round(avg(review_rating), 2) AS review_average,\n    count(*)\nFROM\n   customer_reviews\nWHERE\n    product_group = \'Book\'\nGROUP BY\n    title_length_bucket\nORDER BY\n    title_length_bucket;\n```\n\n\nUsage with Citus\n----------------\n\nThe example above illustrated how to load data into a PostgreSQL database running\non a single host. However, sometimes your data is too large to analyze effectively\non a single host. Citus is a product built by Citus Data that allows you to run\na distributed PostgreSQL database to analyze your data using the power of multiple\nhosts.  You can easily install and run other PostgreSQL extensions and foreign data\nwrappers\xe2\x80\x94including cstore_fdw\xe2\x80\x94alongside Citus.\n\nYou can create a cstore_fdw table and distribute it using the\n```master_create_distributed_table()``` UDF just like any other table. You can load data\nusing the ```copy``` command as you would do in single node PostgreSQL.\n\nUsing Skip Indexes\n------------------\n\ncstore_fdw partitions each column into multiple blocks. Skip indexes store minimum\nand maximum values for each of these blocks. While scanning the table, if min/max\nvalues of the block contradict the WHERE clause, then the block is completely\nskipped. This way, the query processes less data and hence finishes faster.\n\nTo use skip indexes more efficiently, you should load the data after sorting it\non a column that is commonly used in the WHERE clause. This ensures that there is\na minimum overlap between blocks and the chance of them being skipped is higher.\n\nIn practice, the data generally has an inherent dimension (for example a time field)\non which it is naturally sorted. Usually, the queries also have a filter clause on\nthat column (for example you want to query only the last week\'s data), and hence you\ndon\'t need to sort the data in such cases.\n\n\nUninstalling cstore_fdw\n-----------------------\n\nBefore uninstalling the extension, first you need to drop all the cstore tables:\n\n    postgres=# DROP FOREIGN TABLE cstore_table_1;\n    ...\n    postgres=# DROP FOREIGN TABLE cstore_table_n;\n\nThen, you should drop the cstore server and extension:\n\n    postgres=# DROP SERVER cstore_server;\n    postgres=# DROP EXTENSION cstore_fdw;\n\ncstore\\_fdw automatically creates some directories inside the PostgreSQL\'s data\ndirectory to store its files. To remove them, you can run:\n\n    $ rm -rf $PGDATA/cstore_fdw\n\nThen, you should remove cstore\\_fdw from ```shared_preload_libraries``` in\nyour ```postgresql.conf```:\n\n    shared_preload_libraries = \'\'    # (change requires restart)\n\nFinally, to uninstall the extension you can run the following command in the\nextension\'s source code directory. This will clean up all the files copied during\nthe installation:\n\n    $ sudo PATH=/usr/local/pgsql/bin/:$PATH make uninstall\n\n\nChangeset\n---------\n### Version 1.6.2\n* (Fix) Add support for PostgreSQL 11\n### Version 1.6.1\n* (Fix) Fix crash during truncate (Cstore crashing server when enabled, not used)\n* (Fix) No such file or directory warning when attempting to drop database\n### Version 1.6\n* (Feature) Added support for PostgreSQL 10.\n* (Fix) Removed table files when a schema, extension or database is dropped.\n* (Fix) Removed unused code fragments.\n* (Fix) Fixed incorrect initialization of stripe buffers.\n* (Fix) Checked user access rights when executing truncate.\n* (Fix) Made copy command cancellable.\n* (Fix) Fixed namespace issue regarding drop table.\n\n### Version 1.5.1\n* (Fix) Verify cstore_fdw server on CREATE FOREIGN TABLE command\n\n### Version 1.5\n* (Feature) Added support for PostgreSQL 9.6.\n* (Fix) Removed table data when cstore_fdw table is indirectly dropped.\n* (Fix) Removed unused code fragments.\n* (Fix) Fixed column selection logic to return columns used in expressions.\n* (Fix) Prevented alter table command from changinf column type to incompatible types.\n\n### Version 1.4.1\n\n* (Fix) Compatibility fix for Citus [copy command][copy-command].\n\n### Version 1.4\n\n* (Feature) Added support for ```TRUNCATE TABLE```\n* (Fix) Added support for PostgreSQL 9.5\n\n### Version 1.3\n\n* (Feature) Added support for ```ALTER TABLE ADD COLUMN``` and ```ALTER TABLE DROP COLUMN```.\n* (Feature) Added column list support in ```COPY FROM```.\n* (Optimization) Improve row count estimation, which results in better plans.\n* (Fix) Fix the deadlock issue during concurrent inserts.\n* (Fix) Return correct result when using whole row references.\n\n### Version 1.2\n\n* (Feature) Added support for ```COPY TO```.\n* (Feature) Added support for ```INSERT INTO cstore_table SELECT ...```.\n* (Optimization) Improved memory usage.\n* (Fix) Dropping multiple cstore tables in a single command cleans-up files\n  of all them.\n\n### Version 1.1\n\n* (Feature) Make filename option optional, and use a default directory inside\n  $PGDATA to manage cstore tables.\n* (Feature) Automatically delete files on DROP FOREIGN TABLE.\n* (Fix) Return empty table if no data has been loaded. Previously, cstore_fdw\n  errored out.\n* (Fix) Fix overestimating relation column counts when planning.\n* (Feature) Added cstore\\_table\\_size(tablename) for getting the size of a cstore\n  table in bytes.\n\n\nCopyright\n---------\n\nCopyright (c) 2017 Citus Data, Inc.\n\nThis module is free software; you can redistribute it and/or modify it under the\nApache v2.0 License.\n\nFor all types of questions and comments about the wrapper, please contact us at\nengage @ citusdata.com.\n\n[status]: https://travis-ci.org/citusdata/cstore_fdw\n[mailing-list]: https://groups.google.com/forum/#!forum/cstore-users\n[coverage]: https://coveralls.io/r/citusdata/cstore_fdw\n[copy-command]: http://www.postgresql.org/docs/current/static/sql-copy.html\n[analyze-command]: http://www.postgresql.org/docs/current/static/sql-analyze.html\n'